%!PS-Adobe-2.0
%%Creator: dvips(k) 5.78 Copyright 1998 Radical Eye Software (www.radicaleye.com)
%%Title: mpg.dvi
%%Pages: 130
%%PageOrder: Ascend
%%BoundingBox: 0 0 504 648
%%DocumentFonts: Helvetica Times-Roman Courier Times-Italic Times-Bold
%%EndComments
%DVIPSCommandLine: dvips -o mpg.ps mpg.dvi
%DVIPSParameters: dpi=600, compressed
%DVIPSSource:  TeX output 1999.04.26:1917
%%BeginProcSet: texc.pro
%!
/TeXDict 300 dict def TeXDict begin /N{def}def /B{bind def}N /S{exch}N
/X{S N}B /TR{translate}N /isls false N /vsize 11 72 mul N /hsize 8.5 72
mul N /landplus90{false}def /@rigin{isls{[0 landplus90{1 -1}{-1 1}
ifelse 0 0 0]concat}if 72 Resolution div 72 VResolution div neg scale
isls{landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div
hsize mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul
TR[matrix currentmatrix{dup dup round sub abs 0.00001 lt{round}if}
forall round exch round exch]setmatrix}N /@landscape{/isls true N}B
/@manualfeed{statusdict /manualfeed true put}B /@copies{/#copies X}B
/FMat[1 0 0 -1 0 0]N /FBB[0 0 0 0]N /nn 0 N /IE 0 N /ctr 0 N /df-tail{
/nn 8 dict N nn begin /FontType 3 N /FontMatrix fntrx N /FontBBox FBB N
string /base X array /BitMaps X /BuildChar{CharBuilder}N /Encoding IE N
end dup{/foo setfont}2 array copy cvx N load 0 nn put /ctr 0 N[}B /df{
/sf 1 N /fntrx FMat N df-tail}B /dfs{div /sf X /fntrx[sf 0 0 sf neg 0 0]
N df-tail}B /E{pop nn dup definefont setfont}B /ch-width{ch-data dup
length 5 sub get}B /ch-height{ch-data dup length 4 sub get}B /ch-xoff{
128 ch-data dup length 3 sub get sub}B /ch-yoff{ch-data dup length 2 sub
get 127 sub}B /ch-dx{ch-data dup length 1 sub get}B /ch-image{ch-data
dup type /stringtype ne{ctr get /ctr ctr 1 add N}if}B /id 0 N /rw 0 N
/rc 0 N /gp 0 N /cp 0 N /G 0 N /sf 0 N /CharBuilder{save 3 1 roll S dup
/base get 2 index get S /BitMaps get S get /ch-data X pop /ctr 0 N ch-dx
0 ch-xoff ch-yoff ch-height sub ch-xoff ch-width add ch-yoff
setcachedevice ch-width ch-height true[1 0 0 -1 -.1 ch-xoff sub ch-yoff
.1 sub]/id ch-image N /rw ch-width 7 add 8 idiv string N /rc 0 N /gp 0 N
/cp 0 N{rc 0 ne{rc 1 sub /rc X rw}{G}ifelse}imagemask restore}B /G{{id
gp get /gp gp 1 add N dup 18 mod S 18 idiv pl S get exec}loop}B /adv{cp
add /cp X}B /chg{rw cp id gp 4 index getinterval putinterval dup gp add
/gp X adv}B /nd{/cp 0 N rw exit}B /lsh{rw cp 2 copy get dup 0 eq{pop 1}{
dup 255 eq{pop 254}{dup dup add 255 and S 1 and or}ifelse}ifelse put 1
adv}B /rsh{rw cp 2 copy get dup 0 eq{pop 128}{dup 255 eq{pop 127}{dup 2
idiv S 128 and or}ifelse}ifelse put 1 adv}B /clr{rw cp 2 index string
putinterval adv}B /set{rw cp fillstr 0 4 index getinterval putinterval
adv}B /fillstr 18 string 0 1 17{2 copy 255 put pop}for N /pl[{adv 1 chg}
{adv 1 chg nd}{1 add chg}{1 add chg nd}{adv lsh}{adv lsh nd}{adv rsh}{
adv rsh nd}{1 add adv}{/rc X nd}{1 add set}{1 add clr}{adv 2 chg}{adv 2
chg nd}{pop nd}]dup{bind pop}forall N /D{/cc X dup type /stringtype ne{]
}if nn /base get cc ctr put nn /BitMaps get S ctr S sf 1 ne{dup dup
length 1 sub dup 2 index S get sf div put}if put /ctr ctr 1 add N}B /I{
cc 1 add D}B /bop{userdict /bop-hook known{bop-hook}if /SI save N @rigin
0 0 moveto /V matrix currentmatrix dup 1 get dup mul exch 0 get dup mul
add .99 lt{/QV}{/RV}ifelse load def pop pop}N /eop{SI restore userdict
/eop-hook known{eop-hook}if showpage}N /@start{userdict /start-hook
known{start-hook}if pop /VResolution X /Resolution X 1000 div /DVImag X
/IE 256 array N 2 string 0 1 255{IE S dup 360 add 36 4 index cvrs cvn
put}for pop 65781.76 div /vsize X 65781.76 div /hsize X}N /p{show}N
/RMat[1 0 0 -1 0 0]N /BDot 260 string N /rulex 0 N /ruley 0 N /v{/ruley
X /rulex X V}B /V{}B /RV statusdict begin /product where{pop false[
(Display)(NeXT)(LaserWriter 16/600)]{dup length product length le{dup
length product exch 0 exch getinterval eq{pop true exit}if}{pop}ifelse}
forall}{false}ifelse end{{gsave TR -.1 .1 TR 1 1 scale rulex ruley false
RMat{BDot}imagemask grestore}}{{gsave TR -.1 .1 TR rulex ruley scale 1 1
false RMat{BDot}imagemask grestore}}ifelse B /QV{gsave newpath transform
round exch round exch itransform moveto rulex 0 rlineto 0 ruley neg
rlineto rulex neg 0 rlineto fill grestore}B /a{moveto}B /delta 0 N /tail
{dup /delta X 0 rmoveto}B /M{S p delta add tail}B /b{S p tail}B /c{-4 M}
B /d{-3 M}B /e{-2 M}B /f{-1 M}B /g{0 M}B /h{1 M}B /i{2 M}B /j{3 M}B /k{
4 M}B /w{0 rmoveto}B /l{p -4 w}B /m{p -3 w}B /n{p -2 w}B /o{p -1 w}B /q{
p 1 w}B /r{p 2 w}B /s{p 3 w}B /t{p 4 w}B /x{0 S rmoveto}B /y{3 2 roll p
a}B /bos{/SS save N}B /eos{SS restore}B end

%%EndProcSet
%%BeginProcSet: 8r.enc
% @@psencodingfile@{
%   author = "S. Rahtz, P. MacKay, Alan Jeffrey, B. Horn, K. Berry",
%   version = "0.6",
%   date = "22 June 1996",
%   filename = "8r.enc",
%   email = "kb@@mail.tug.org",
%   address = "135 Center Hill Rd. // Plymouth, MA 02360",
%   codetable = "ISO/ASCII",
%   checksum = "119     662    4424",
%   docstring = "Encoding for TrueType or Type 1 fonts to be used with TeX."
% @}
% 
% Idea is to have all the characters normally included in Type 1 fonts
% available for typesetting. This is effectively the characters in Adobe
% Standard Encoding + ISO Latin 1 + extra characters from Lucida.
% 
% Character code assignments were made as follows:
% 
% (1) the Windows ANSI characters are almost all in their Windows ANSI
% positions, because some Windows users cannot easily reencode the
% fonts, and it makes no difference on other systems. The only Windows
% ANSI characters not available are those that make no sense for
% typesetting -- rubout (127 decimal), nobreakspace (160), softhyphen
% (173). quotesingle and grave are moved just because it's such an
% irritation not having them in TeX positions.
% 
% (2) Remaining characters are assigned arbitrarily to the lower part
% of the range, avoiding 0, 10 and 13 in case we meet dumb software.
% 
% (3) Y&Y Lucida Bright includes some extra text characters; in the
% hopes that other PostScript fonts, perhaps created for public
% consumption, will include them, they are included starting at 0x12.
% 
% (4) Remaining positions left undefined are for use in (hopefully)
% upward-compatible revisions, if someday more characters are generally
% available.
% 
% (5) hyphen appears twice for compatibility with both ASCII and Windows.
% 
/TeXBase1Encoding [
% 0x00 (encoded characters from Adobe Standard not in Windows 3.1)
  /.notdef /dotaccent /fi /fl
  /fraction /hungarumlaut /Lslash /lslash
  /ogonek /ring /.notdef
  /breve /minus /.notdef 
% These are the only two remaining unencoded characters, so may as
% well include them.
  /Zcaron /zcaron 
% 0x10
 /caron /dotlessi 
% (unusual TeX characters available in, e.g., Lucida Bright)
 /dotlessj /ff /ffi /ffl 
 /.notdef /.notdef /.notdef /.notdef
 /.notdef /.notdef /.notdef /.notdef
 % very contentious; it's so painful not having quoteleft and quoteright
 % at 96 and 145 that we move the things normally found there down to here.
 /grave /quotesingle 
% 0x20 (ASCII begins)
 /space /exclam /quotedbl /numbersign
 /dollar /percent /ampersand /quoteright
 /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
% 0x30
 /zero /one /two /three /four /five /six /seven
 /eight /nine /colon /semicolon /less /equal /greater /question
% 0x40
 /at /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O
% 0x50
 /P /Q /R /S /T /U /V /W
 /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
% 0x60
 /quoteleft /a /b /c /d /e /f /g /h /i /j /k /l /m /n /o
% 0x70
 /p /q /r /s /t /u /v /w
 /x /y /z /braceleft /bar /braceright /asciitilde
 /.notdef % rubout; ASCII ends
% 0x80
 /.notdef /.notdef /quotesinglbase /florin
 /quotedblbase /ellipsis /dagger /daggerdbl
 /circumflex /perthousand /Scaron /guilsinglleft
 /OE /.notdef /.notdef /.notdef
% 0x90
 /.notdef /.notdef /.notdef /quotedblleft
 /quotedblright /bullet /endash /emdash
 /tilde /trademark /scaron /guilsinglright
 /oe /.notdef /.notdef /Ydieresis
% 0xA0
 /.notdef % nobreakspace
 /exclamdown /cent /sterling
 /currency /yen /brokenbar /section
 /dieresis /copyright /ordfeminine /guillemotleft
 /logicalnot
 /hyphen % Y&Y (also at 45); Windows' softhyphen
 /registered
 /macron
% 0xD0
 /degree /plusminus /twosuperior /threesuperior
 /acute /mu /paragraph /periodcentered
 /cedilla /onesuperior /ordmasculine /guillemotright
 /onequarter /onehalf /threequarters /questiondown
% 0xC0
 /Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla
 /Egrave /Eacute /Ecircumflex /Edieresis
 /Igrave /Iacute /Icircumflex /Idieresis
% 0xD0
 /Eth /Ntilde /Ograve /Oacute
 /Ocircumflex /Otilde /Odieresis /multiply
 /Oslash /Ugrave /Uacute /Ucircumflex
 /Udieresis /Yacute /Thorn /germandbls
% 0xE0
 /agrave /aacute /acircumflex /atilde
 /adieresis /aring /ae /ccedilla
 /egrave /eacute /ecircumflex /edieresis
 /igrave /iacute /icircumflex /idieresis
% 0xF0
 /eth /ntilde /ograve /oacute
 /ocircumflex /otilde /odieresis /divide
 /oslash /ugrave /uacute /ucircumflex
 /udieresis /yacute /thorn /ydieresis
] def

%%EndProcSet
%%BeginProcSet: texps.pro
%!
TeXDict begin /rf{findfont dup length 1 add dict begin{1 index /FID ne 2
index /UniqueID ne and{def}{pop pop}ifelse}forall[1 index 0 6 -1 roll
exec 0 exch 5 -1 roll VResolution Resolution div mul neg 0 0]/Metrics
exch def dict begin Encoding{exch dup type /integertype ne{pop pop 1 sub
dup 0 le{pop}{[}ifelse}{FontMatrix 0 get div Metrics 0 get div def}
ifelse}forall Metrics /Metrics currentdict end def[2 index currentdict
end definefont 3 -1 roll makefont /setfont cvx]cvx def}def /ObliqueSlant
{dup sin S cos div neg}B /SlantFont{4 index mul add}def /ExtendFont{3 -1
roll mul exch}def /ReEncodeFont{/Encoding exch def}def end

%%EndProcSet
TeXDict begin 33154002 42626574 1000 600 600 (mpg.dvi)
@start /Fa 134[45 1[45 45 45 45 45 45 1[45 45 45 45 45
2[45 45 45 45 45 45 45 45 45 7[45 1[45 1[45 45 45 45
2[45 45 1[45 4[45 1[45 1[45 45 45 5[45 1[45 2[45 4[45
2[45 1[45 2[45 45 40[{TeXBase1Encoding ReEncodeFont}43
74.7198 /Courier rf /Fb 134[42 1[60 42 42 23 32 28 1[42
42 42 65 23 2[23 42 42 28 37 42 1[42 37 12[51 16[55 20[21
6[28 39[{.167 SlantFont TeXBase1Encoding ReEncodeFont}24
83.022 /Times-Roman rf /Fc 134[33 4[22 31[44 84[{
TeXBase1Encoding ReEncodeFont}3 66.4176 /Times-Bold rf
/Fd 138[40 40 40 40 40 40 40 40 40 40 40 1[40 2[40 40
40 40 40 40 51[40 45[{TeXBase1Encoding ReEncodeFont}19
66.4176 /Courier rf /Fe 145[33 4[18 1[33 5[33 97[{
TeXBase1Encoding ReEncodeFont}4 66.4176 /Times-Italic
rf
%DVIPSBitmapFont: Ff cmr10 10 2
/Ff 2 51 df<15301578B3A6007FB812F8B912FCA26C17F8C80078C8FCB3A6153036367B
AF41>43 D<EB0FF0EB7FFE48B57E3903E03FE0390F000FF0000E6D7E486D7E486D7E1230
00706D7E126012FCB4EC7F807FA56CC7FC121CC8FCEDFF00A34A5A5D14035D4A5A5D140F
4A5A4A5A92C7FC147C5C495A495A495A495A91C8FC011EEB01805B5B4913034848140048
5A485A000EC75A000FB6FC5A5A485CB6FCA321387CB72A>50 D E
%EndDVIPSBitmapFont
/Fg 134[37 37 55 37 42 23 32 32 1[42 42 42 60 23 37 1[23
42 42 23 37 42 37 42 42 12[46 3[51 3[46 2[28 1[60 2[60
55 8[28 11[21 6[28 5[28 33[{TeXBase1Encoding ReEncodeFont}34
83.022 /Times-Italic rf /Fh 104[66 33 27[29 33 33 48
33 33 18 26 22 1[33 33 33 52 18 33 18 18 33 33 22 29
33 29 33 29 7[48 48 63 1[48 41 37 44 1[37 48 48 59 41
2[22 48 48 1[41 48 44 44 48 14[33 1[33 1[17 1[17 4[22
36[37 2[{TeXBase1Encoding ReEncodeFont}53 66.4176 /Times-Roman
rf
%DVIPSBitmapFont: Fi cmr6 6 3
/Fi 3 52 df<13E01201120712FF12F91201B3A7487EB512C0A212217AA01E>49
D<EA01FC3807FF80381C0FC0383003E0386001F0EB00F812F86C13FCA2147C1278003013
FCC7FC14F8A2EB01F0EB03E014C0EB0780EB0F00131E13385B5B3801C00CEA0380380600
185A5A383FFFF85AB512F0A216217CA01E>I<13FF000313C0380F03E0381C00F014F800
3E13FC147CA2001E13FC120CC712F8A2EB01F0EB03E0EB0FC03801FF00A2380003E0EB00
F01478147C143E143F1230127812FCA2143E48137E0060137C003813F8381E03F0380FFF
C00001130018227DA01E>I E
%EndDVIPSBitmapFont
%DVIPSBitmapFont: Fj cmmi10 10 5
/Fj 5 100 df<EF0380EF0FC0173FEFFF80933803FE00EE0FF8EE3FE0EEFF80DB03FEC7
FCED0FF8ED3FE0EDFF80DA03FEC8FCEC0FF8EC3FE0ECFF80D903FEC9FCEB0FF8EB3FE0EB
FF80D803FECAFCEA0FF8EA3FE0EA7F8000FECBFCA2EA7F80EA3FE0EA0FF8EA03FEC66C7E
EB3FE0EB0FF8EB03FE903800FF80EC3FE0EC0FF8EC03FE913800FF80ED3FE0ED0FF8ED03
FE923800FF80EE3FE0EE0FF8EE03FE933800FF80EF3FC0170FEF0380323279AD41>60
D<126012FCB4FCEA7FC0EA1FF0EA07FCEA01FF38007FC0EB1FF0EB07FCEB01FF9038007F
C0EC1FF0EC07FCEC01FF9138007FC0ED1FF0ED07FCED01FF9238007FC0EE1FF0EE07FCEE
01FF9338007F80EF1FC0A2EF7F80933801FF00EE07FCEE1FF0EE7FC04B48C7FCED07FCED
1FF0ED7FC04A48C8FCEC07FCEC1FF0EC7FC04948C9FCEB07FCEB1FF0EB7FC04848CAFCEA
07FCEA3FF0EA7FC048CBFC12FC1270323279AD41>62 D<147E903803FF8090390FC1C380
90391F00EFC0017E137F49133F485A4848EB1F8012075B000F143F48481400A2485A5D00
7F147E90C7FCA215FE485C5AA214015D48150CA21403EDF01C16181407007C1538007E01
0F1330003E131F027B13706C01E113E03A0F83C0F9C03A03FF007F80D800FCEB1F002626
7DA42C>97 D<133FEA1FFFA3C67E137EA313FE5BA312015BA312035BA31207EBE0FCEBE3
FF9038E707C0390FFE03E09038F801F001F013F8EBE000485A15FC5BA2123F90C7FCA214
015A127EA2140312FE4814F8A2140715F05AEC0FE0A215C0EC1F80143F00781400007C13
7E5C383C01F86C485A380F07C06CB4C7FCEA01FC1E3B7CB924>I<EC3FC0903801FFF090
3807E03C90380F800E90383F0007017E131F49137F484813FF485A485A120F4913FE001F
143848481300A2127F90C8FCA35A5AA45AA315031507007E1406150E003E143C003F1470
6C14E0390F8007C03907C03F003801FFF838003FC020267DA424>I
E
%EndDVIPSBitmapFont
%DVIPSBitmapFont: Fk cmr7 7 5
/Fk 5 57 df<13381378EA01F8121F12FE12E01200B3AB487EB512F8A215267BA521>49
D<13FF000313E0380E03F0381800F848137C48137E00787F12FC6CEB1F80A4127CC7FC15
005C143E147E147C5C495A495A5C495A010EC7FC5B5B903870018013E0EA018039030003
0012065A001FB5FC5A485BB5FCA219267DA521>I<13FF000313E0380F01F8381C007C00
30137E003C133E007E133FA4123CC7123E147E147C5C495AEB07E03801FF8091C7FC3800
01E06D7E147C80143F801580A21238127C12FEA21500485B0078133E00705B6C5B381F01
F03807FFC0C690C7FC19277DA521>I<EB0FE0EB3FF8EBF81C3801E0063803C01F48485A
EA0F005A121E003E131E91C7FC5AA21304EB3FC038FCFFF038FDC078B4C67E143E48131E
141FA2481480A4127CA4003C1400123E001E131E143E6C133C6C6C5A3803C1F03801FFC0
6C6CC7FC19277DA521>54 D<137F3803FFE0380781F8380E007C48131E5A801278A3127C
007E131EEA3F80EBE03C6C6C5A380FFCF03807FFC06C5BC613E0487F38079FFC380F07FE
EA1E0348C67E48133FEC1F8048130FA21407A315001278140E6C5B6C5B380F80F03803FF
E0C66CC7FC19277DA521>56 D E
%EndDVIPSBitmapFont
/Fl 134[50 1[72 50 1[33 39 44 1[55 50 55 83 28 55 1[28
55 1[33 44 55 44 1[50 18[72 94 6[61 17[50 50 50 50 50
1[25 43[55 2[{TeXBase1Encoding ReEncodeFont}29 99.6264
/Times-Bold rf /Fm 134[60 1[86 1[66 40 47 53 1[66 60
66 100 33 66 1[33 66 60 40 53 66 53 66 60 9[120 86 1[80
66 86 1[73 1[86 113 1[93 1[47 1[93 73 2[86 80 86 12[60
60 60 60 60 1[30 43[66 2[{TeXBase1Encoding ReEncodeFont}43
119.552 /Times-Bold rf /Fn 135[86 3[57 1[76 1[96 1[96
4[48 96 2[76 96 2[86 11[124 1[96 124 1[105 1[124 1[115
2[67 1[134 1[115 124 124 115 124 7[86 86 86 86 86 86
86 86 86 86 48[{TeXBase1Encoding ReEncodeFont}33 172.188
/Times-Bold rf /Fo 105[42 28[42 42 60 42 46 28 32 37
46 46 42 46 69 23 46 28 23 46 42 28 37 46 37 46 42 28
5[55 60 1[83 1[60 55 46 60 65 51 65 60 78 55 65 42 32
65 65 51 55 60 60 55 60 1[42 4[28 42 42 42 42 42 42 42
42 42 42 23 21 1[21 2[28 28 28 36[46 2[{TeXBase1Encoding ReEncodeFont}
70 83.022 /Times-Bold rf /Fp 105[103 28[103 103 149 103
115 69 80 92 1[115 103 115 172 57 115 1[57 115 103 69
92 115 92 115 103 7[149 1[207 1[149 138 115 149 1[126
161 149 195 138 2[80 161 161 126 1[149 149 138 149 1[103
12[103 1[103 57 52 1[52 2[69 69 69 39[{TeXBase1Encoding ReEncodeFont}52
206.559 /Times-Bold rf /Fq 190[36 65[{TeXBase1Encoding ReEncodeFont}1
49.8132 /Times-Roman rf /Fr 134[37 1[54 1[42 25 1[33
2[37 42 4[21 42 6[37 97[{TeXBase1Encoding ReEncodeFont}10
74.7198 /Times-Bold rf /Fs 135[33 2[37 21 29 29 2[37
37 54 21 2[21 1[37 1[33 37 2[37 16[46 2[62 42 50 3[54
71[{TeXBase1Encoding ReEncodeFont}19 74.7198 /Times-Italic
rf /Ft 133[33 37 37 54 37 37 21 29 25 37 37 37 37 58
21 37 21 21 37 37 25 33 37 33 37 33 8[54 1[54 54 46 42
2[42 54 54 1[46 2[25 1[54 42 46 54 50 1[54 5[21 8[37
2[21 19 1[19 2[25 25 37[42 2[{TeXBase1Encoding ReEncodeFont}50
74.7198 /Times-Roman rf /Fu 103[50 26[50 50 50 50 50
50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50
50 50 50 50 50 50 1[50 1[50 50 50 50 50 50 50 50 50 50
50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50
50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 50
50 50 50 50 50 50 50 50 50 50 50 50 50 50 50 33[{
TeXBase1Encoding ReEncodeFont}92 83.022 /Courier rf
%DVIPSBitmapFont: Fv cmsy10 10 2
/Fv 2 16 df<923803FFC0033F13FC4AB67E020715E0913A1FFE007FF8DA7FE0EB07FE4A
C87ED903FCED3FC0D907F0ED0FE0D90FC0ED03F049486F7E49CA7E017E177E4983498348
48EF0F80000319C04917074848EF03E0000F19F049170148CC12F8A2001E1978003E197C
A2003C193C007C193EA20078191EA300F8191FA248190FAA6C191FA20078191EA3007C19
3EA2003C193C003E197CA2001E1978001F19F8A26C6CEF01F06D1703000719E06C6CEF07
C06D170F000119806C6CEF1F006D5F017E177E6D5F6D6C4B5A6D6C4B5AD907F0ED0FE0D9
03FCED3FC0D900FF03FFC7FCDA7FE0EB07FEDA1FFEEB7FF80207B612E002011580DA003F
01FCC8FC030313C0484E7BBB53>13 D<EB0FE0EB7FFC497E0003EBFF804814C04814E048
14F04814F8A24814FCA3B612FEA86C14FCA36C14F8A26C14F06C14E06C14C06C1480C6EB
FE006D5AEB0FE01F207BA42A>15 D E
%EndDVIPSBitmapFont
/Fw 104[83 29[42 42 60 1[46 23 42 28 46 46 46 46 69 18
42 18 18 46 46 23 46 46 42 46 46 18 6[55 2[55 1[51 3[55
2[69 46 55 1[23 60 4[60 1[55 7[46 2[46 3[46 46 46 1[23
28 23 4[18 36[42 2[{TeXBase1Encoding ReEncodeFont}47
83.022 /Helvetica rf /Fx 133[44 5[28 1[33 2[50 50 78
3[28 3[44 3[44 16[55 72 79[{TeXBase1Encoding ReEncodeFont}11
99.6264 /Times-Roman rf /Fy 104[83 42 27[37 42 42 60
42 42 23 32 28 42 42 42 42 65 23 42 23 23 42 42 28 37
42 37 42 37 28 6[60 60 78 60 60 51 46 55 60 46 60 60
74 51 60 32 28 60 60 46 51 60 55 55 60 1[37 3[23 23 42
42 42 42 42 42 42 42 42 42 23 21 28 21 2[28 28 28 3[42
31[46 46 2[{TeXBase1Encoding ReEncodeFont}77 83.022 /Times-Roman
rf /Fz 135[86 2[96 2[57 2[96 96 143 38 2[38 1[96 1[96
96 2[96 16[115 2[143 96 115 3[134 71[{TeXBase1Encoding ReEncodeFont}17
172.188 /Helvetica rf end
%%EndProlog
%%BeginSetup
%%Feature: *Resolution 600dpi
TeXDict begin
%%PaperSize: A4

%%EndSetup
%%Page: 0 1
0 0 bop -150 894 a Fz(Lin)n(ux)167 b(K)-7 b(er)t(nel)167
b(Module)f(Prog)n(r)n(amming)-150 1068 y(Guide)p -150
1181 3000 24 v 1980 1295 a Fy(1999)68 b Fx(Ori)25 b(Pomerantz)-150
1972 y Fw(V)-7 b(ersion)24 b(1.1.0,)g(26)f(Apr)q(il)h(1999.)-25
2243 y(This)f(book)h(is)g(about)h(wr)q(iting)g(Lin)o(ux)g(K)m(er)r(nel)
f(Modules)o(.)32 b(It)24 b(is)o(,)g(hopefully)-8 b(,)26
b(useful)e(f)n(or)f(pro-)-150 2356 y(g)o(r)o(ammers)f(who)h(kno)o(w)f
(C)h(and)g(w)o(ant)g(to)f(lear)r(n)i(ho)o(w)e(to)h(wr)q(ite)g(k)n(er)r
(nel)g(modules)o(.)29 b(It)23 b(is)f(wr)q(itten)-150
2470 y(as)c(an)g(`Ho)o(w-T)-10 b(o')19 b(instr)q(uction)g(man)o(ual,)h
(with)f(e)n(xamples)f(of)h(all)g(of)f(the)h(impor)s(tant)h(techniques)o
(.)-25 2740 y(Although)k(this)e(book)h(touches)f(on)h(man)o(y)f(points)
h(of)g(k)n(er)r(nel)g(design,)g(it)g(is)f(not)h(supposed)-150
2854 y(to)i(ful\002ll)h(that)f(need)h(\227)f(there)g(are)g(other)g
(books)f(on)i(this)f(subject,)g(both)h(in)f(pr)q(int)h(and)f(in)h(the)
-150 2968 y(Lin)o(ux)e(documentation)g(project.)-25 3238
y(Y)-12 b(ou)22 b(ma)n(y)e(freely)h(cop)n(y)f(and)h(redistr)q(ib)n(ute)
h(this)f(book)g(under)g(cer)s(tain)h(conditions)o(.)28
b(Please)-150 3352 y(see)23 b(the)g(cop)n(yr)q(ight)g(and)h(distr)q(ib)
n(ution)h(statement.)p eop
%%Page: 0 2
0 1 bop -150 -167 3000 5 v -150 162 a Fy(Names)23 b(of)f(all)i
(products)d(herein)g(are)i(used)g(for)f(identi\002cation)f(purposes)g
(only)h(and)h(are)f(trademarks)-150 275 y(and/or)g(re)o(gistered)g
(trademarks)g(of)h(their)g(respecti)n(v)o(e)g(o)n(wners.)34
b(I)23 b(mak)o(e)g(no)g(claim)h(of)f(o)n(wnership)f(or)-150
389 y(corporate)c(association)i(with)g(the)h(products)d(or)i(companies)
f(that)h(o)n(wn)g(them.)-150 556 y(Cop)o(yright)230 553
y(c)207 556 y Fv(\015)g Fy(1999)f(Ori)i(Pomerantz)-150
715 y(Ori)f(Pomerantz)-150 819 y(Apt.)25 b(#1032)-150
923 y(2355)19 b(N)h(Hwy)h(360)-150 1027 y(Grand)e(Prairie)-150
1131 y(TX)h(75050)-150 1235 y(USA)-150 1339 y(E-mail:)25
b Fu(mpg@simple-tech.com)-25 1547 y Ft(The)17 b Fs(Linux)h(K)m(ernel)h
(Module)g(Pr)m(o)o(gr)o(amming)f(Guide)h Ft(is)e(a)h(free)g(book;)h
(you)g(may)f(reproduce)i(and/or)e(modify)-150 1652 y(it)26
b(under)i(the)f(terms)f(of)h(v)o(ersion)h(2)f(\(or)m(,)h(at)f(your)g
(option,)j(an)o(y)d(later)f(v)o(ersion\))i(of)f(the)f(GNU)h(General)g
(Public)-150 1756 y(License)21 b(as)g(published)i(by)f(the)f(Free)f
(Softw)o(are)h(F)o(oundation.)31 b(V)-8 b(ersion)21 b(2)h(is)e
(enclosed)j(with)e(this)f(document)j(at)-150 1860 y(Appendix)d(E.)-25
1964 y(This)i(book)h(is)g(distrib)o(uted)f(in)g(the)h(hope)h(it)e(will)
f(be)i(useful,)g(b)o(ut)g Fr(without)e(any)i(warranty)p
Ft(;)h(without)f(e)n(v)o(en)-150 2068 y(the)c(implied)g(w)o(arranty)g
(of)g(merchantability)h(or)f(\002tness)g(for)f(a)h(particular)g
(purpose.)-25 2172 y(The)j(author)h(encourages)h(wide)e(distrib)o
(ution)g(of)g(this)g(book)h(for)f(personal)i(or)e(commercial)g(use,)h
(pro)o(vided)-150 2276 y(the)29 b(abo)o(v)o(e)i(cop)o(yright)f(notice)g
(remains)f(intact)g(and)h(the)g(method)g(adheres)g(to)f(the)g(pro)o
(visions)i(of)e(the)g(GNU)-150 2380 y(General)22 b(Public)g(License)g
(\(see)f(Appendix)j(E\).)31 b(In)21 b(summary)-5 b(,)24
b(you)e(may)g(cop)o(y)i(and)e(distrib)o(ute)f(this)h(book)h(free)-150
2484 y(of)e(char)o(ge)h(or)g(for)f(a)g(pro\002t.)31 b(No)21
b(e)o(xplicit)g(permission)h(is)f(required)h(from)g(the)f(author)h(for)
g(reproduction)h(of)e(this)-150 2588 y(book)f(in)f(an)o(y)g(medium,)h
(physical)f(or)g(electronic.)-25 2693 y(Note,)f(deri)n(v)n(ati)n(v)o(e)
h(w)o(orks)g(and)g(translations)f(of)g(this)g(document)i
Fs(must)g Ft(be)e(placed)h(under)g(the)g(GNU)f(General)-150
2797 y(Public)24 b(License,)i(and)g(the)e(original)h(cop)o(yright)h
(notice)f(must)g(remain)g(intact.)40 b(If)24 b(you)h(ha)o(v)o(e)g
(contrib)o(uted)g(ne)n(w)-150 2901 y(material)16 b(to)g(this)g(book,)i
(you)f(must)g(mak)o(e)g(the)g(source)g(code)g(\(e.g.,)f(L)1624
2884 y Fq(A)1649 2901 y Ft(T)1683 2918 y(E)1718 2901
y(X)g(source\))h(a)o(v)n(ailable)g(for)f(your)h(re)n(visions.)-150
3005 y(Please)e(mak)o(e)g(re)n(visions)h(and)g(updates)g(a)o(v)n
(ailable)f(directly)g(to)g(the)g(document)h(maintainer)m(,)g(Ori)e
(Pomerantz.)22 b(This)-150 3109 y(will)c(allo)n(w)h(for)g(the)g(mer)o
(ging)g(of)g(updates)h(and)f(pro)o(vide)h(consistent)g(re)n(visions)f
(to)g(the)g(Linux)g(community)-5 b(.)-25 3223 y(If)18
b(you)j(plan)e(to)h(publish)g(and)g(distrib)o(ute)f(this)g(book)h
(commercially)-5 b(,)20 b(donations,)h(ro)o(yalties,)e(and/or)h
(printed)-150 3336 y(copies)j(are)g(greatly)g(appreciated)g(by)g(the)g
(author)g(and)g(the)g(Linux)g(Documentation)h(Project.)33
b(Contrib)o(uting)23 b(in)-150 3450 y(this)i(w)o(ay)h(sho)n(ws)g(your)g
(support)g(for)f(free)h(softw)o(are)f(and)h(the)f(Linux)h
(Documentation)h(Project.)42 b(If)24 b(you)j(ha)o(v)o(e)-150
3563 y(questions)20 b(or)f(comments,)g(please)h(contact)f(the)g
(address)h(abo)o(v)o(e.)p eop
%%Page: 1 3
1 2 bop 150 861 a Fp(Contents)150 1414 y Fo(0)83 b(Intr)o(oduction)2381
b(2)275 1532 y Fy(0.1)85 b(Who)21 b(Should)e(Read)h(This)49
b(.)41 b(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)
g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114 b(2)275
1650 y(0.2)85 b(Note)21 b(on)e(the)i(Style)60 b(.)41
b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114
b(3)275 1769 y(0.3)85 b(Changes)41 b(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114 b(3)465 1887
y(0.3.1)98 b(Ne)n(w)21 b(in)f(v)o(ersion)f(1.0.1)54 b(.)42
b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g
(.)g(.)h(.)f(.)g(.)g(.)h(.)114 b(3)465 2006 y(0.3.2)98
b(Ne)n(w)21 b(in)f(v)o(ersion)f(1.1.0)54 b(.)42 b(.)f(.)g(.)g(.)h(.)f
(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)
h(.)114 b(3)275 2124 y(0.4)85 b(Ackno)n(wledgements)41
b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114
b(4)465 2242 y(0.4.1)98 b(F)o(or)20 b(v)o(ersion)f(1.0.1)56
b(.)41 b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)
g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114 b(4)465 2361
y(0.4.2)98 b(F)o(or)20 b(v)o(ersion)f(1.1.0)56 b(.)41
b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114 b(4)150 2582 y
Fo(1)83 b(Hello,)19 b(w)o(orld)2396 b(5)275 2700 y Fy(hello.c)44
b(.)e(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f
(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)
h(.)f(.)g(.)g(.)h(.)114 b(5)275 2818 y(1.1)85 b(Mak)o(e\002les)21
b(for)e(K)n(ernel)h(Modules)74 b(.)41 b(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114
b(6)275 2937 y(Mak)o(e\002le)37 b(.)k(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)114 b(7)275
3055 y(1.2)85 b(Multiple)20 b(File)h(K)n(ernel)f(Modules)f(.)42
b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g
(.)g(.)h(.)f(.)g(.)g(.)h(.)114 b(8)275 3174 y(start.c)68
b(.)42 b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)h(.)114 b(9)275 3292 y(stop.c)72 b(.)42
b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)
f(.)g(.)g(.)h(.)73 b(10)275 3410 y(Mak)o(e\002le)37 b(.)k(.)g(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)
g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73
b(11)150 3631 y Fo(2)83 b(Character)19 b(De)o(vice)g(Files)1987
b(12)275 3750 y Fy(charde)n(v)-5 b(.c)78 b(.)41 b(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)
g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73
b(14)275 3868 y(2.1)85 b(Multiple)20 b(K)n(ernel)g(V)-9
b(ersions)20 b(Source)f(Files)54 b(.)41 b(.)g(.)g(.)h(.)f(.)g(.)h(.)f
(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73 b(23)150
4089 y Fo(3)83 b(The)21 b(/pr)o(oc)e(File)i(System)2021
b(25)275 4207 y Fy(procfs.c)65 b(.)41 b(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73 b(26)1638
4456 y(i)p eop
%%Page: 2 4
2 3 bop -150 -167 3000 5 v -150 -200 a Fy(ii)2497 b Fo(CONTENTS)-150
162 y(4)83 b(Using)20 b(/pr)o(oc)g(F)n(or)g(Input)2019
b(32)-25 277 y Fy(procfs.c)65 b(.)41 b(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73 b(33)-150
482 y Fo(5)83 b(T)-8 b(alking)21 b(to)e(De)o(vice)h(Files)h(\(writes)f
(and)h(IOCTLs\))1224 b(43)-25 597 y Fy(charde)n(v)-5
b(.c)78 b(.)41 b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)h(.)73 b(44)-25 712 y(charde)n(v)-5
b(.h)73 b(.)41 b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)h(.)73 b(55)-25 827 y(ioctl.c)63 b(.)42
b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)
f(.)g(.)g(.)h(.)73 b(57)-150 1032 y Fo(6)83 b(Startup)19
b(P)o(arameters)2089 b(61)-25 1147 y Fy(param.c)65 b(.)41
b(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)
g(.)g(.)h(.)73 b(61)-150 1352 y Fo(7)83 b(System)20 b(Calls)2338
b(65)-25 1468 y Fy(syscall.c)48 b(.)41 b(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)
f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73
b(67)-150 1672 y Fo(8)83 b(Blocking)20 b(Pr)o(ocesses)2122
b(73)-25 1788 y Fy(sleep.c)40 b(.)i(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73 b(74)-150
1992 y Fo(9)83 b(Replacing)19 b(printk')m(s)2134 b(86)-25
2108 y Fy(printk.c)74 b(.)41 b(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)
g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73 b(86)-150
2312 y Fo(10)41 b(Scheduling)20 b(T)-8 b(asks)2181 b(90)-25
2428 y Fy(sched.c)21 b(.)42 b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g
(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)
g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73 b(91)-150
2633 y Fo(11)41 b(Interrupt)20 b(Handlers)2107 b(97)-25
2748 y Fy(11.1)43 b(K)n(e)o(yboards)19 b(on)g(the)i(Intel)e
(Architecture)69 b(.)42 b(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)73 b(98)-25 2863 y(intrpt.c)30
b(.)42 b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)
f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)h(.)73 b(99)-150 3068 y Fo(12)41 b(Symmetrical)19
b(Multi\226Pr)o(ocessing)1660 b(104)-150 3273 y(13)41
b(Common)20 b(Pitfalls)2152 b(106)-150 3477 y(A)65 b(Changes)20
b(between)g(2.0)g(and)g(2.2)1730 b(107)-150 3682 y(B)70
b(Wher)o(e)20 b(Fr)o(om)f(Her)o(e?)2057 b(109)-150 3887
y(C)65 b(Goods)19 b(and)i(Ser)o(vices)2059 b(110)-25
4002 y Fy(C.1)72 b(Getting)20 b(this)h(Book)f(in)g(Print)30
b(.)41 b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)h(.)f(.)g(.)
g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)31 b(110)-150
4207 y Fo(D)65 b(Sho)o(wing)20 b(Y)-9 b(our)20 b(A)n(ppr)o(eciation)
1766 b(111)p eop
%%Page: 1 5
1 4 bop 150 162 a Fo(E)70 b(The)21 b(GNU)f(General)g(Public)g(License)
1566 b(113)150 358 y(Index)2672 b(120)p eop
%%Page: 2 6
2 5 bop -150 813 a Fn(Chapter)44 b(0)-150 1263 y Fp(Intr)l(oduction)-25
1709 y Fy(So,)17 b(you)f(w)o(ant)h(to)g(write)g(a)g(k)o(ernel)f
(module.)22 b(Y)-9 b(ou)17 b(kno)n(w)e(C,)j(you')l(v)o(e)c(written)j(a)
g(number)e(of)i(normal)-150 1823 y(programs)g(to)i(run)f(as)i
(processes,)f(and)f(no)n(w)g(you)g(w)o(ant)h(to)h(get)f(to)g(where)f
(the)h(real)g(action)f(is,)i(to)f(where)-150 1936 y(a)i(single)f(wild)g
(pointer)f(can)h(wipe)g(out)g(your)f(\002le)i(system)f(and)g(a)g(core)g
(dump)f(means)h(a)g(reboot.)-25 2050 y(W)-7 b(ell,)20
b(welcome)e(to)h(the)g(club)m(.)24 b(I)19 b(once)f(had)g(a)i(wild)f
(pointer)f(wipe)h(an)f(important)g(directory)f(under)-150
2163 y(DOS)i(\(thankfully)-5 b(,)16 b(no)n(w)j(it)g(stands)g(for)f(the)
h Fo(D)p Fy(ead)f Fo(O)p Fy(perating)f Fo(S)p Fy(ystem\),)i(and)f(I)h
(don')o(t)e(see)i(why)f(li)n(ving)-150 2277 y(under)h(Linux)g(should)g
(be)h(an)o(y)g(safer)-5 b(.)-25 2391 y Fo(W)g(ar)o(ning:)24
b Fy(I)c(wrote)g(this)h(and)f(check)o(ed)f(the)h(program)e(under)h(v)o
(ersions)g(2.0.35)g(and)h(2.2.3)f(of)h(the)-150 2504
y(k)o(ernel)e(running)e(on)j(a)g(Pentium.)k(F)o(or)c(the)f(most)h
(part,)f(it)i(should)d(w)o(ork)h(on)g(other)g(CPUs)i(and)e(on)g(other)
-150 2618 y(v)o(ersions)h(of)i(the)f(k)o(ernel,)g(as)h(long)e(as)j(the)
o(y)d(are)i(2.0.x)e(or)h(2.2.x,)f(b)n(ut)h(I)h(can')o(t)f(promise)f(an)
o(ything.)24 b(One)-150 2731 y(e)o(xception)18 b(is)j(chapter)f(11,)f
(which)h(should)f(not)h(w)o(ork)f(on)h(an)o(y)f(architecture)g(e)o
(xcept)g(for)h(x86.)-150 3088 y Fm(0.1)119 b(Who)30 b(Should)h(Read)g
(This)-25 3299 y Fy(This)22 b(document)e(is)j(for)e(people)g(who)g(w)o
(ant)i(to)f(write)g(k)o(ernel)f(modules.)29 b(Although)21
b(I)h(will)h(touch)-150 3412 y(on)h(ho)n(w)g(things)g(are)h(done)e(in)i
(the)g(k)o(ernel)f(in)g(se)n(v)o(eral)g(places,)i(that)e(is)i(not)e(my)
g(purpose.)37 b(There)24 b(are)-150 3526 y(enough)18
b(good)h(sources)h(which)f(do)h(a)h(better)f(job)f(than)h(I)h(could)e
(ha)n(v)o(e)g(done.)-25 3639 y(This)h(document)f(is)j(also)f(for)f
(people)f(who)h(kno)n(w)g(ho)n(w)g(to)h(write)g(k)o(ernel)f(modules,)f
(b)n(ut)i(ha)n(v)o(e)f(not)-150 3753 y(yet)27 b(adapted)e(to)i(v)o
(ersion)e(2.2)h(of)h(the)f(k)o(ernel.)44 b(If)26 b(you)g(are)h(such)f
(a)h(person,)g(I)g(suggest)f(you)g(look)g(at)-150 3866
y(appendix)16 b(A)i(to)h(see)f(all)h(the)f(dif)n(ferences)e(I)i
(encountered)e(while)i(updating)e(the)i(e)o(xamples.)23
b(The)18 b(list)h(is)-150 3980 y(no)n(where)h(near)h(comprehensi)n(v)o
(e,)e(b)n(ut)j(I)g(think)f(it)i(co)o(v)o(ers)d(most)i(of)g(the)g(basic)
g(functionality)e(and)h(will)-150 4094 y(be)f(enough)e(to)j(get)f(you)f
(started.)-25 4207 y(The)d(k)o(ernel)h(is)h(a)f(great)g(piece)g(of)g
(programming,)d(and)j(I)g(belie)n(v)o(e)f(that)i(programmers)c(should)i
(read)1329 4456 y(2)p eop
%%Page: 3 7
3 6 bop 150 162 a Fy(at)25 b(least)h(some)e(k)o(ernel)g(source)g
(\002les)i(and)e(understand)f(them.)38 b(Ha)n(ving)25
b(said)g(that,)h(I)f(also)g(belie)n(v)o(e)e(in)150 275
y(the)i(v)n(alue)e(of)i(playing)e(with)h(the)h(system)g(\002rst)g(and)f
(asking)g(questions)f(later)-5 b(.)39 b(When)24 b(I)h(learn)f(a)h(ne)n
(w)150 389 y(programming)20 b(language,)j(I)h(don')o(t)e(start)i(with)g
(reading)f(the)g(library)g(code,)h(b)n(ut)f(by)h(writing)f(a)h(small)
150 502 y(`hello,)19 b(w)o(orld')g(program.)k(I)e(don')o(t)d(see)j(why)
e(playing)g(with)h(the)h(k)o(ernel)e(should)g(be)h(an)o(y)g(dif)n
(ferent.)150 813 y Fm(0.2)119 b(Note)30 b(on)g(the)g(Style)275
1015 y Fy(I)18 b(lik)o(e)h(to)g(put)f(as)h(man)o(y)f(jok)o(es)g(as)i
(possible)e(into)g(my)h(documentation.)i(I'm)d(writing)g(this)h
(because)150 1128 y(I)j(enjo)o(y)f(it,)i(and)f(I)g(assume)g(most)g(of)g
(you)f(are)h(reading)e(this)j(for)e(the)h(same)g(reason.)30
b(If)22 b(you)f(just)h(w)o(ant)150 1242 y(to)f(get)g(to)g(the)g(point,)
f(ignore)g(all)h(the)g(normal)f(te)o(xt)g(and)h(read)f(the)h(source)f
(code.)26 b(I)21 b(promise)f(to)h(put)g(all)150 1355
y(the)f(important)f(details)h(in)h(remarks.)150 1666
y Fm(0.3)119 b(Changes)150 1886 y Fl(0.3.1)99 b(New)25
b(in)g(v)o(ersion)g(1.0.1)254 2058 y Fy(1.)41 b Fo(Changes)20
b(section)p Fy(,)g(0.3.)254 2247 y(2.)41 b Fo(Ho)o(w)20
b(to)f(\002nd)j(the)e(minor)h(de)o(vice)e(number)p Fy(,)i(2.)254
2435 y(3.)41 b Fo(Fixed)20 b(the)g(explanation)f(of)h(the)g(differ)o
(ence)g(between)g(character)f(and)h(de)o(vice)g(\002les)p
Fy(,)h(2)254 2624 y(4.)41 b Fo(Mak)o(e\002les)21 b(f)n(or)e(K)n(er)o
(nel)h(Modules)p Fy(,)h(1.1.)254 2812 y(5.)41 b Fo(Symmetrical)19
b(Multipr)o(ocessing)p Fy(,)h(12.)254 3001 y(6.)41 b
Fo(A)20 b(`Bad)h(Ideas')f(Chapter)p Fy(,)g(13.)150 3264
y Fl(0.3.2)99 b(New)25 b(in)g(v)o(ersion)g(1.1.0)254
3436 y Fy(1.)41 b Fo(Support)20 b(f)n(or)g(v)o(ersion)g(2.2)f(of)h(the)
h(k)o(er)o(nel)p Fy(,)f(all)h(o)o(v)o(er)e(the)h(place.)254
3625 y(2.)41 b Fo(Multi)21 b(k)o(er)o(nel)f(v)o(ersion)h(sour)o(ce)e
(\002les)p Fy(,)i(2.1.)254 3813 y(3.)41 b Fo(Changes)20
b(between)g(2.0)g(and)g(2.2)p Fy(,)f(A.)254 4002 y(4.)41
b Fo(K)n(er)o(nel)19 b(Modules)j(in)f(Multiple)g(Sour)o(ce)e(Files)p
Fy(,)i(1.2.)254 4190 y(5.)41 b Fo(Suggestion)19 b(not)h(to)g(let)h
(modules)g(which)f(mess)i(with)e(system)h(calls)g(be)f(rmmod'ed)p
Fy(,)g(7.)p eop
%%Page: 4 8
4 7 bop -150 162 a Fm(0.4)119 b(Ackno)o(wledgements)-25
361 y Fy(I')l(d)29 b(lik)o(e)h(to)g(thank)f(Y)-9 b(oa)n(v)30
b(W)-7 b(eiss)32 b(for)d(man)o(y)g(helpful)g(ideas)h(and)g
(discussions,)i(as)f(well)f(as)h(for)-150 475 y(\002nding)d(mistak)o
(es)h(within)g(this)h(document)d(before)g(its)j(publication.)50
b(Of)29 b(course,)h(an)o(y)e(remaining)-150 588 y(mistak)o(es)20
b(are)h(purely)d(my)i(f)o(ault.)-25 702 y(The)d(T)159
721 y(E)199 702 y(X)i(sk)o(eleton)e(for)g(this)i(book)d(w)o(as)j
(shamelessly)f(stolen)g(from)f(the)h(`Linux)e(Installation)h(and)-150
815 y(Getting)j(Started')f(guide,)g(where)h(the)g(T)1012
834 y(E)1052 815 y(X)h(w)o(ork)f(w)o(as)h(done)e(by)h(Matt)g(W)-7
b(elsh.)-25 929 y(My)19 b(gratitude)f(to)i(Linus)f(T)-7
b(orv)n(alds,)18 b(Richard)h(Stallman)g(and)g(all)h(the)g(other)f
(people)f(who)h(made)g(it)-150 1043 y(possible)i(for)g(me)h(to)f(run)g
(a)h(high)f(quality)f(operating)g(system)i(on)f(my)g(computer)e(and)i
(get)h(the)f(source)-150 1156 y(code)f(goes)f(without)h(saying)f
(\(yeah,)g(right)h(\227)h(then)e(why)h(did)g(I)g(say)g(it?\).)-150
1410 y Fl(0.4.1)99 b(F)n(or)24 b(v)o(ersion)h(1.0.1)-25
1580 y Fy(I)d(couldn')o(t)f(list)i(e)n(v)o(erybody)c(who)k(e-mailed)e
(me)i(here,)f(and)g(if)h(I')l(v)o(e)e(left)i(you)f(out)g(I)h(apologize)
d(in)-150 1693 y(adv)n(ance.)j(The)d(follo)n(wing)f(people)g(were)h
(specially)g(helpful:)-25 1890 y Fv(\017)41 b Fo(Fr)o(odo)17
b(Looijaard)g(fr)o(om)g(the)i(Netherlands)f Fy(F)o(or)g(a)h(host)f(of)h
(useful)e(suggestions,)h(and)g(infor)n(-)58 2003 y(mation)h(about)g
(the)h(2.1.x)f(k)o(ernels.)-25 2183 y Fv(\017)41 b Fo(Stephen)20
b(J)o(udd)h(fr)o(om)e(New)i(Zealand)f Fy(Spelling)g(corrections.)-25
2363 y Fv(\017)41 b Fo(Magnus)25 b(Ahltor)o(p)f(fr)o(om)g(Sweden)h
Fy(Correcting)e(a)i(mistak)o(e)f(of)h(mine)f(about)f(the)i(dif)n
(ference)58 2477 y(between)19 b(character)g(and)h(block)f(de)n(vices.)
-150 2731 y Fl(0.4.2)99 b(F)n(or)24 b(v)o(ersion)h(1.1.0)-25
2901 y Fv(\017)41 b Fo(Emmanuel)31 b(P)o(apirakis)f(fr)o(om)g(Quebec,)i
(Canada)e Fy(F)o(or)g(porting)e(all)j(of)f(the)g(e)o(xamples)f(to)58
3014 y(v)o(ersion)18 b(2.2)i(of)g(the)g(k)o(ernel.)-25
3194 y Fv(\017)41 b Fo(Fr)o(odo)17 b(Looijaard)h(fr)o(om)g(the)h
(Netherlands)g Fy(F)o(or)g(telling)f(me)h(ho)n(w)g(to)g(create)f(a)i
(multiple)e(\002le)58 3308 y(k)o(ernel)h(module)g(\(1.2\).)-25
3504 y(Of)24 b(course,)h(an)o(y)f(remaining)f(mistak)o(es)i(are)g(my)g
(o)n(wn,)g(and)f(if)h(you)f(think)g(the)o(y)g(mak)o(e)g(the)h(book)-150
3618 y(unusable)19 b(you')l(re)f(welcome)i(to)g(apply)f(for)h(a)g(full)
g(refund)f(of)h(the)g(mone)o(y)f(you)g(paid)h(me)g(for)f(it.)p
eop
%%Page: 5 9
5 8 bop 150 813 a Fn(Chapter)44 b(1)150 1263 y Fp(Hello,)52
b(w)n(orld)275 1709 y Fy(When)20 b(the)h(\002rst)h(ca)n(v)o(eman)e
(programmer)e(chiseled)i(the)h(\002rst)h(program)d(on)h(the)h(w)o(alls)
h(of)f(the)g(\002rst)150 1823 y(ca)n(v)o(e)27 b(computer)m(,)h(it)g(w)o
(as)h(a)f(program)e(to)h(paint)h(the)g(string)f(`Hello,)i(w)o(orld')e
(in)h(Antelope)e(pictures.)150 1936 y(Roman)31 b(programming)e(te)o
(xtbooks)g(be)o(gan)h(with)i(the)g(`Salut,)j(Mundi')30
b(program.)58 b(I)31 b(don')o(t)g(kno)n(w)150 2050 y(what)20
b(happens)f(to)h(people)f(who)g(break)g(with)h(this)h(tradition,)e(and)
g(I)h(think)g(it')-5 b(s)21 b(safer)f(not)g(to)g(\002nd)f(out.)275
2163 y(A)28 b(k)o(ernel)e(module)h(has)g(to)h(ha)n(v)o(e)f(at)h(least)h
(tw)o(o)e(functions:)39 b Fu(init)p 2286 2163 25 4 v
29 w(module)27 b Fy(which)g(is)i(called)150 2277 y(when)23
b(the)h(module)f(is)i(inserted)e(into)h(the)g(k)o(ernel,)g(and)f
Fu(cleanup)p 2153 2277 V 29 w(module)g Fy(which)g(is)i(called)f(just)
150 2391 y(before)i(it)i(is)g(remo)o(v)o(ed.)43 b(T)-7
b(ypically)i(,)27 b Fu(init)p 1463 2391 V 29 w(module)g
Fy(either)g(re)o(gisters)f(a)i(handler)e(for)g(something)150
2504 y(with)f(the)h(k)o(ernel,)f(or)g(it)h(replaces)f(one)g(of)g(the)g
(k)o(ernel)f(function)g(with)h(its)i(o)n(wn)d(code)h(\(usually)f(code)
150 2618 y(to)g(do)f(something)f(and)h(then)g(call)h(the)f(original)f
(function\).)33 b(The)23 b Fu(cleanup)p 2447 2618 V 29
w(module)g Fy(function)f(is)150 2731 y(supposed)d(to)h(undo)f(whate)n
(v)o(er)g Fu(init)p 1279 2731 V 29 w(module)g Fy(did,)h(so)h(the)f
(module)f(can)h(be)g(unloaded)e(safely)-5 b(.)275 2920
y Fl(hello.c)150 3185 y Fu(/*)49 b(hello.c)200 3299 y(*)g(Copyright)g
(\(C\))g(1998)g(by)g(Ori)h(Pomerantz)200 3412 y(*)200
3526 y(*)f("Hello,)g(world")g(-)g(the)h(kernel)e(module)h(version.)200
3639 y(*/)150 3866 y(/*)g(The)h(necessary)e(header)h(files)f(*/)150
4094 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)150
4207 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)1629 4456 y Fy(5)p eop
%%Page: 6 10
6 9 bop -150 162 a Fu(#include)48 b(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)-150 616 y(/*)g(Deal)h(with)f
(CONFIG_MODVERSIONS)d(*/)-150 730 y(#if)j(CONFIG_MODVERSIONS==1)-150
843 y(#define)g(MODVERSIONS)-150 957 y(#include)f
(<linux/modversions.h>)-150 1070 y(#endif)-150 1525 y(/*)h(Initialize)f
(the)i(module)e(*/)-150 1638 y(int)h(init_module\(\))-150
1752 y({)-50 1865 y(printk\("Hello,)e(world)i(-)g(this)g(is)h(the)f
(kernel)g(speaking\\n"\);)-50 2092 y(/*)g(If)h(we)f(return)g(a)g(non)h
(zero)f(value,)f(it)i(means)f(that)-1 2206 y(*)h(init_module)e(failed)h
(and)g(the)g(kernel)g(module)-1 2320 y(*)h(can't)f(be)g(loaded)g(*/)-50
2433 y(return)f(0;)-150 2547 y(})-150 2887 y(/*)h(Cleanup)g(-)h(undid)e
(whatever)h(init_module)f(did)h(*/)-150 3001 y(void)g
(cleanup_module\(\))-150 3115 y({)-50 3228 y(printk\("Short)e(is)i(the)
h(life)f(of)g(a)h(kernel)f(module\\n"\);)-150 3342 y(})-150
3777 y Fm(1.1)119 b(Mak)o(e\002les)30 b(f)m(or)g(K)m(er)n(nel)h
(Modules)-25 3980 y Fy(A)g(k)o(ernel)e(module)h(is)h(not)f(an)h
(independant)d(e)o(x)o(ecutable,)j(b)n(ut)f(an)h(object)f(\002le)h
(which)f(will)i(be)-150 4094 y(link)o(ed)25 b(into)g(the)g(k)o(ernel)g
(in)h(runtime.)39 b(As)27 b(a)f(result,)g(the)o(y)f(should)f(be)i
(compiled)e(with)i(the)f Fu(-c)h Fy(\003ag.)-150 4207
y(Also,)20 b(all)h(k)o(ernel)f(modules)f(ha)n(v)o(e)g(to)i(be)f
(compiled)e(with)j(certain)e(symbols)h(de\002ned.)p eop
%%Page: 7 11
7 10 bop 275 162 a Fv(\017)p 363 162 25 4 v 392 162 V
100 w Fu(KERNEL)p 722 162 V 751 162 V 82 w Fy(\227)23
b(This)g(tells)h(the)e(header)g(\002les)h(that)g(this)g(code)f(will)i
(be)e(run)g(in)h(k)o(ernel)f(mode,)358 275 y(not)d(as)i(part)f(of)g(a)h
(user)f(process.)275 461 y Fv(\017)41 b Fu(MODULE)19
b Fy(\227)i(This)f(tells)h(the)f(header)f(\002les)i(to)f(gi)n(v)o(e)f
(the)i(appropriate)c(de\002nitions)i(for)h(a)g(k)o(ernel)358
574 y(module.)275 760 y Fv(\017)41 b Fu(LINUX)26 b Fy(\227)h(T)-6
b(echnically)25 b(speaking,)i(this)g(is)h(not)e(necessary)-5
b(.)43 b(Ho)n(we)n(v)o(er)m(,)26 b(if)h(you)f(e)n(v)o(er)f(w)o(ant)358
873 y(to)30 b(write)g(a)h(serious)f(k)o(ernel)f(module)g(which)h(will)h
(compile)e(on)h(more)f(than)h(one)f(operating)358 987
y(system,)23 b(you')o(ll)e(be)i(happ)o(y)e(you)g(did.)32
b(This)23 b(will)g(allo)n(w)f(you)g(to)h(do)f(conditional)e
(compilation)358 1100 y(on)f(the)i(parts)f(which)f(are)h(OS)h
(dependant.)275 1301 y(There)g(are)h(other)f(symbols)h(which)g(ha)n(v)o
(e)f(to)h(be)h(included,)d(or)i(not,)g(depending)e(on)i(the)g(\003ags)h
(the)150 1414 y(k)o(ernel)h(w)o(as)i(compiled)e(with.)40
b(If)25 b(you')l(re)e(not)i(sure)g(ho)n(w)f(the)i(k)o(ernel)e(w)o(as)i
(compiled,)f(look)f(it)i(up)e(in)150 1528 y Fu
(/usr/include/linux/config.h)275 1729 y Fv(\017)p 363
1729 V 392 1729 V 100 w Fu(SMP)p 572 1729 V 602 1729
V 85 w Fy(\227)h(Symmetrical)f(MultiProcessing.)37 b(This)25
b(has)g(to)g(be)g(de\002ned)f(if)h(the)g(k)o(ernel)f(w)o(as)358
1842 y(compiled)i(to)i(support)f(symmetrical)g(multiprocessing)f(\(e)n
(v)o(en)h(if)h(it')-5 b(s)29 b(running)d(just)j(on)e(one)358
1956 y(CPU\).)f(If)f(you)g(use)h(Symmetrical)e(MultiProcessing,)i
(there)f(are)h(other)f(things)g(you)f(need)h(to)358 2069
y(do)19 b(\(see)i(chapter)e(12\).)275 2255 y Fv(\017)41
b Fu(CONFIG)p 663 2255 V 28 w(MODVERSIONS)49 b Fy(\227)h(If)g(CONFIG)p
1838 2255 V 30 w(MOD)m(VERSIONS)g(w)o(as)h(enabled,)k(you)358
2368 y(need)37 b(to)h(ha)n(v)o(e)g(it)h(de\002ned)e(when)h(compiling)e
(the)j(k)o(ernel)e(module)g(and)h(and)f(to)i(include)358
2482 y Fu(/usr/include/linux/modversions.h)p Fy(.)28
b(This)23 b(can)g(also)g(be)g(done)f(by)h(the)g(code)358
2595 y(itself.)275 2871 y Fl(Mak)o(e\002le)150 3071 y
Fu(#)50 b(Makefile)e(for)h(a)h(basic)f(kernel)f(module)150
3299 y(CC=gcc)150 3412 y(MODCFLAGS)g(:=)i(-Wall)e(-DMODULE)h
(-D__KERNEL__)e(-DLINUX)150 3639 y(hello.o:)h(hello.c)h
(/usr/include/linux/version.h)150 3753 y($\(CC\))g($\(MODCFLAGS\))e(-c)
j(hello.c)150 3866 y(echo)f(insmod)g(hello.o)f(to)i(turn)f(it)g(on)150
3980 y(echo)g(rmmod)g(hello)g(to)g(turn)g(if)h(off)150
4094 y(echo)150 4207 y(echo)f(X)h(and)f(kernel)g(programming)e(do)j
(not)f(mix.)p eop
%%Page: 8 12
8 11 bop -150 162 a Fu(echo)49 b(Do)h(the)f(insmod)f(and)i(rmmod)f
(from)g(outside)f(X.)-25 455 y Fy(So,)25 b(no)n(w)f(the)g(only)g(thing)
f(left)i(is)g(to)f Fu(su)h Fy(to)f(root)g(\(you)f(didn')o(t)g(compile)g
(this)i(as)g(root,)g(did)f(you?)-150 568 y(Li)n(ving)g(on)h(the)h(edge)
490 538 y Fk(1)526 568 y Fy(.)12 b(.)g(.)g(\),)27 b(and)e(then)g
Fu(insmod)49 b(hello)25 b Fy(and)g Fu(rmmod)49 b(hello)25
b Fy(to)g(your)g(heart')-5 b(s)-150 682 y(content.)24
b(While)d(you)e(do)h(it,)g(notice)g(your)f(ne)n(w)h(k)o(ernel)f(module)
g(in)h Fu(/proc/modules)p Fy(.)-25 795 y(By)i(the)h(w)o(ay)-5
b(,)22 b(the)h(reason)e(why)h(the)g(Mak)o(e\002le)h(recommends)d
(against)i(doing)f Fu(insmod)h Fy(from)f(X)-150 909 y(is)h(because)d
(when)h(the)h(k)o(ernel)f(has)g(a)h(message)g(to)g(print)f(with)g
Fu(printk)p Fy(,)g(it)h(sends)g(it)g(to)g(the)g(console.)-150
1022 y(When)h(you)e(don')o(t)g(use)i(X,)g(it)h(just)f(goes)g(to)g(the)f
(virtual)g(terminal)g(you')l(re)f(using)i(\(the)f(one)g(you)g(chose)
-150 1136 y(with)29 b(Alt-F)p Fj(<)p Fy(n)p Fj(>)p Fy(\))f(and)h(you)f
(see)i(it.)53 b(When)29 b(you)f(do)h(use)g(X,)h(on)f(the)g(other)f
(hand,)i(there)f(are)g(tw)o(o)-150 1250 y(possibilities.)42
b(Either)25 b(you)g(ha)n(v)o(e)g(a)h(console)f(open)g(with)h
Fu(xterm)49 b(-C)p Fy(,)26 b(in)g(which)f(case)h(the)g(output)-150
1363 y(will)19 b(be)g(sent)g(there,)f(or)g(you)g(don')o(t,)f(in)h
(which)g(case)h(the)g(output)e(will)i(go)f(to)h(virtual)f(terminal)g(7)
g(\227)i(the)-150 1477 y(one)g(`co)o(v)o(ered')d(by)j(X.)-25
1590 y(If)k(your)g(k)o(ernel)g(becomes)g(unstable)g(you')l(re)f(lik)o
(elier)i(to)g(get)g(the)f(deb)n(ug)g(messages)h(without)f(X.)-150
1704 y(Outside)16 b(of)g(X,)g Fu(printk)f Fy(goes)h(directly)g(from)f
(the)h(k)o(ernel)f(to)h(the)g(console.)23 b(In)16 b(X,)g(on)g(the)g
(other)f(hand,)-150 1817 y Fu(printk)p Fy(')-5 b(s)18
b(go)g(to)g(a)h(user)f(mode)f(process)h(\()p Fu(xterm)49
b(-C)p Fy(\).)18 b(When)g(that)g(process)g(recei)n(v)o(es)f(CPU)j
(time,)-150 1931 y(it)f(is)g(supposed)e(to)h(send)g(it)g(to)h(the)f(X)g
(serv)o(er)g(process.)23 b(Then,)18 b(when)f(the)h(X)h(serv)o(er)e
(recei)n(v)o(es)h(the)g(CPU,)-150 2045 y(it)i(is)h(supposed)d(to)h
(display)g(it)i(\227)f(b)n(ut)f(an)h(unstable)e(k)o(ernel)h(usually)g
(means)g(that)h(the)f(system)h(is)h(about)-150 2158 y(to)i(crash)g(or)g
(reboot,)f(so)h(you)g(don')o(t)e(w)o(ant)i(to)g(delay)g(the)g(error)f
(messages,)i(which)e(might)h(e)o(xplain)e(to)-150 2272
y(you)e(what)h(went)h(wrong,)d(for)i(longer)f(than)g(you)h(ha)n(v)o(e)f
(to.)-150 2570 y Fm(1.2)119 b(Multiple)31 b(File)g(K)m(er)n(nel)g
(Modules)-25 2769 y Fy(Sometimes)25 b(it)h(mak)o(es)f(sense)h(to)f(di)n
(vide)g(a)h(k)o(ernel)e(module)g(between)h(se)n(v)o(eral)g(source)f
(\002les.)42 b(In)-150 2883 y(this)21 b(case,)f(you)f(need)h(to)g(do)g
(the)g(follo)n(wing:)-46 3062 y(1.)41 b(In)18 b(all)h(the)g(source)f
(\002les)i(b)n(ut)f(one,)f(add)g(the)h(line)g Fu(#define)p
1854 3062 25 4 v 1884 3062 V 108 w(NO)p 2014 3062 V 30
w(VERSION)p 2394 3062 V 2422 3062 V 58 w Fy(.)25 b(This)19
b(is)h(im-)58 3176 y(portant)14 b(because)i Fu(module.h)f
Fy(normally)f(includes)h(the)h(de\002nition)f(of)h Fu(kernel)p
2457 3176 V 29 w(version)p Fy(,)58 3289 y(a)28 b(global)f(v)n(ariable)g
(with)h(the)g(k)o(ernel)f(v)o(ersion)g(the)h(module)e(is)j(compiled)d
(for)-5 b(.)48 b(If)28 b(you)f(need)58 3403 y Fu(version.h)p
Fy(,)e(you)g(need)f(to)i(include)f(it)h(yourself,)f(because)g
Fu(module.h)f Fy(w)o(on')o(t)h(do)g(it)h(for)58 3516
y(you)19 b(with)p 376 3516 V 406 3516 V 80 w Fu(NO)p
536 3516 V 30 w(VERSION)p 916 3516 V 944 3516 V 58 w
Fy(.)-46 3689 y(2.)41 b(Compile)19 b(all)i(the)f(source)g(\002les)h(as)
g(usual.)-46 3862 y(3.)41 b(Combine)698 b(all)i(the)g(object)58
3976 y(\002les)22 b(into)f(a)h(single)g(one.)28 b(Under)21
b(x86,)g(do)g(it)h(with)g Fu(ld)49 b(-m)h(elf)p 2014
3976 V 29 w(i386)f(-r)h(-o)f Fj(<)p Fu(name)p -150 4040
1200 4 v -65 4094 a Fi(1)-30 4117 y Fh(The)15 b(reason)h(I)f(prefer)h
(not)g(to)f(compile)i(as)e(root)h(is)f(that)h(the)g(least)h(done)e(as)h
(root)f(the)h(safer)g(the)g(box)f(is.)20 b(I)15 b(w)o(ork)h(in)f
(computer)-150 4207 y(security)l(,)j(so)f(I'm)f(paranoid)p
eop
%%Page: 9 13
9 12 bop 358 162 a Fu(of)49 b(module)p Fj(>)p Fu(.o)f
Fj(<)p Fu(1st)h(source)f(file)p Fj(>)p Fu(.o)h Fj(<)p
Fu(2nd)f(source)h(file)p Fj(>)p Fu(.o)p Fy(.)275 330
y(Here')-5 b(s)20 b(an)g(e)o(xample)f(of)h(such)g(a)g(k)o(ernel)g
(module.)275 518 y Fl(start.c)150 686 y Fu(/*)49 b(start.c)200
800 y(*)g(Copyright)g(\(C\))g(1999)g(by)g(Ori)h(Pomerantz)200
914 y(*)200 1027 y(*)f("Hello,)g(world")g(-)g(the)h(kernel)e(module)h
(version.)200 1141 y(*)g(This)h(file)f(includes)f(just)h(the)g(start)g
(routine)200 1254 y(*/)150 1481 y(/*)g(The)h(necessary)e(header)h
(files)f(*/)150 1709 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)150
1822 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)150 1936 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)150 2390 y(/*)g(Deal)h(with)f
(CONFIG_MODVERSIONS)d(*/)150 2504 y(#if)j(CONFIG_MODVERSIONS==1)150
2617 y(#define)g(MODVERSIONS)150 2731 y(#include)f
(<linux/modversions.h>)150 2844 y(#endif)150 3299 y(/*)h(Initialize)f
(the)i(module)e(*/)150 3412 y(int)h(init_module\(\))150
3526 y({)250 3639 y(printk\("Hello,)e(world)i(-)g(this)g(is)h(the)f
(kernel)g(speaking\\n"\);)250 3866 y(/*)g(If)h(we)f(return)g(a)g(non)h
(zero)f(value,)f(it)i(means)f(that)299 3980 y(*)h(init_module)e(failed)
h(and)g(the)g(kernel)g(module)299 4094 y(*)h(can't)f(be)g(loaded)g(*/)
250 4207 y(return)f(0;)p eop
%%Page: 10 14
10 13 bop -150 162 a Fu(})-25 745 y Fl(stop.c)-150 914
y Fu(/*)49 b(stop.c)-100 1027 y(*)g(Copyright)g(\(C\))g(1999)g(by)g
(Ori)h(Pomerantz)-100 1141 y(*)-100 1254 y(*)f("Hello,)g(world")g(-)g
(the)h(kernel)e(module)h(version.)f(This)-100 1368 y(*)h(file)h
(includes)e(just)h(the)g(stop)g(routine.)-100 1481 y(*/)-150
1709 y(/*)g(The)h(necessary)e(header)h(files)f(*/)-150
1936 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)-150
2049 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)-150 2276 y(#define)g(__NO_VERSION__)296
b(/*)49 b(This)g(isn't)g("the")g(file)1295 2390 y(*)g(of)h(the)f
(kernel)g(module)f(*/)-150 2504 y(#include)g(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)-150 2731 y(#include)f
(<linux/version.h>)147 b(/*)49 b(Not)g(included)g(by)1344
2844 y(*)h(module.h)e(because)1344 2958 y(*)i(of)f(the)h
(__NO_VERSION__)d(*/)-150 3412 y(/*)i(Deal)h(with)f(CONFIG_MODVERSIONS)
d(*/)-150 3526 y(#if)j(CONFIG_MODVERSIONS==1)-150 3639
y(#define)g(MODVERSIONS)-150 3753 y(#include)f(<linux/modversions.h>)
-150 3866 y(#endif)p eop
%%Page: 11 15
11 14 bop 150 275 a Fu(/*)49 b(Cleanup)g(-)h(undid)e(whatever)h
(init_module)f(did)h(*/)150 389 y(void)g(cleanup_module\(\))150
502 y({)250 616 y(printk\("Short)e(is)i(the)h(life)f(of)g(a)h(kernel)f
(module\\n"\);)150 730 y(})275 1342 y Fl(Mak)o(e\002le)150
1538 y Fu(#)h(Makefile)e(for)h(a)h(multifile)e(kernel)h(module)150
1765 y(CC=gcc)150 1879 y(MODCFLAGS)f(:=)i(-Wall)e(-DMODULE)h
(-D__KERNEL__)e(-DLINUX)150 2106 y(hello.o:)h(start.o)h(stop.o)150
2220 y(ld)g(-m)h(elf_i386)e(-r)i(-o)f(hello.o)g(start.o)f(stop.o)150
2447 y(start.o:)g(start.c)h(/usr/include/linux/version.h)150
2560 y($\(CC\))g($\(MODCFLAGS\))e(-c)j(start.c)150 2788
y(stop.o:)f(stop.c)f(/usr/include/linux/version.h)150
2901 y($\(CC\))h($\(MODCFLAGS\))e(-c)j(stop.c)p eop
%%Page: 12 16
12 15 bop -150 813 a Fn(Chapter)44 b(2)-150 1263 y Fp(Character)51
b(De)m(vice)g(Files)-25 1709 y Fy(So,)22 b(no)n(w)f(we')l(re)h(bold)f
(k)o(ernel)g(programmers)f(and)h(we)h(kno)n(w)f(ho)n(w)h(to)g(write)g
(k)o(ernel)f(modules)g(to)-150 1823 y(do)h(nothing.)30
b(W)-7 b(e)23 b(feel)g(proud)d(of)i(ourselv)o(es)g(and)g(we)g(hold)g
(our)g(heads)g(up)f(high.)31 b(But)23 b(someho)n(w)e(we)-150
1936 y(get)f(the)g(feeling)g(that)g(something)f(is)i(missing.)k
(Catatonic)20 b(modules)f(are)h(not)g(much)f(fun.)-25
2050 y(There)27 b(are)i(tw)o(o)g(major)f(w)o(ays)h(for)f(a)h(k)o(ernel)
e(module)h(to)g(talk)h(to)g(processes.)50 b(One)28 b(is)i(through)-150
2163 y(de)n(vice)24 b(\002les)i(\(lik)o(e)f(the)f(\002les)i(in)f(the)g
Fu(/dev)g Fy(directory\),)f(the)g(other)g(is)i(to)f(use)g(the)g(proc)f
(\002le)i(system.)-150 2277 y(Since)21 b(one)g(of)f(the)h(major)g
(reasons)f(to)i(write)f(something)e(in)j(the)f(k)o(ernel)f(is)i(to)f
(support)f(some)h(kind)f(of)-150 2391 y(hardw)o(are)f(de)n(vice,)g(we')
o(ll)h(be)o(gin)f(with)i(de)n(vice)e(\002les.)-25 2504
y(The)j(original)g(purpose)g(of)h(de)n(vice)f(\002les)i(is)g(to)g(allo)
n(w)f(processes)g(to)g(communicate)e(with)i(de)n(vice)-150
2618 y(dri)n(v)o(ers)j(in)h(the)h(k)o(ernel,)g(and)e(through)f(them)i
(with)h(physical)e(de)n(vices)g(\(modems,)i(terminals,)g(etc.\).)-150
2731 y(The)20 b(w)o(ay)g(this)h(is)g(implemented)d(is)j(the)g(follo)n
(wing.)-25 2845 y(Each)39 b(de)n(vice)f(dri)n(v)o(er)m(,)43
b(which)c(is)h(responsible)f(for)g(some)g(type)g(of)h(hardw)o(are,)j
(is)d(assigned)-150 2958 y(its)i(o)n(wn)e(major)g(number)-5
b(.)84 b(The)41 b(list)g(of)g(dri)n(v)o(ers)e(and)h(their)h(major)f
(numbers)f(is)i(a)n(v)n(ailable)f(in)-150 3072 y Fu(/proc/devices)p
Fy(.)k(Each)27 b(physical)f(de)n(vice)g(managed)g(by)h(a)g(de)n(vice)g
(dri)n(v)o(er)e(is)j(assigned)f(a)h(mi-)-150 3186 y(nor)21
b(number)-5 b(.)29 b(The)22 b Fu(/dev)g Fy(directory)e(is)j(supposed)d
(to)i(include)f(a)i(special)f(\002le,)h(called)f(a)g(de)n(vice)f
(\002le,)-150 3299 y(for)f(each)f(of)h(those)g(de)n(vices,)g(whether)f
(or)h(not)g(it')-5 b(s)21 b(really)f(installed)g(on)g(the)g(system.)-25
3413 y(F)o(or)i(e)o(xample,)g(if)h(you)e(do)i Fu(ls)49
b(-l)g(/dev/hd[ab]*)p Fy(,)22 b(you')o(ll)g(see)h(all)g(of)g(the)f(IDE)
h(hard)f(disk)-150 3526 y(partitions)k(which)g(might)g(be)g(connected)f
(to)i(a)g(machine.)42 b(Notice)27 b(that)f(all)i(of)e(them)g(use)h(the)
f(same)-150 3640 y(major)g(number)m(,)f(3,)j(b)n(ut)e(the)g(minor)f
(number)g(changes)g(from)g(one)h(to)h(the)f(other)f Fg(Disclaimer:)38
b(This)-150 3753 y(assumes)23 b(you')n(r)m(e)f(using)h(a)g(PC)h(ar)m(c)
o(hitectur)m(e)o(.)32 b(I)23 b(don')n(t)e(know)i(about)f(de)o(vices)g
(on)h(Linux)f(running)g(on)-150 3867 y(other)e(ar)m(c)o(hitectur)m(es)p
Fy(.)-25 3981 y(When)27 b(the)h(system)g(w)o(as)h(installed,)g(all)g
(of)e(those)h(de)n(vice)f(\002les)i(were)f(created)f(by)g(the)h
Fu(mknod)-150 4094 y Fy(command.)c(There')-5 b(s)20 b(no)g(technical)f
(reason)h(why)g(the)o(y)f(ha)n(v)o(e)h(to)h(be)f(in)h(the)f
Fu(/dev)g Fy(directory)-5 b(,)19 b(it')-5 b(s)21 b(just)1308
4456 y(12)p eop
%%Page: 13 17
13 16 bop 150 162 a Fy(a)23 b(useful)f(con)m(v)o(ention.)28
b(When)22 b(creating)f(a)i(de)n(vice)e(\002le)i(for)f(testing)g
(purposes,)g(as)h(with)f(the)h(e)o(x)o(ercise)150 275
y(here,)18 b(it)i(w)o(ould)e(probably)f(mak)o(e)h(more)g(sense)h(to)g
(place)g(it)g(in)g(the)g(directory)e(where)i(you)f(compile)g(the)150
389 y(k)o(ernel)h(module.)275 502 y(De)n(vices)d(are)h(di)n(vided)f
(into)g(tw)o(o)i(types:)23 b(character)16 b(de)n(vices)g(and)h(block)f
(de)n(vices.)23 b(The)17 b(dif)n(ference)150 616 y(is)33
b(that)f(block)f(de)n(vices)g(ha)n(v)o(e)g(a)i(b)n(uf)n(fer)d(for)i
(requests,)i(so)e(the)o(y)f(can)h(choose)f(by)g(which)h(order)e(to)150
730 y(respond)21 b(to)i(them.)31 b(This)23 b(is)g(important)e(in)i(the)
f(case)h(of)f(storage)g(de)n(vices,)g(where)g(it')-5
b(s)24 b(f)o(aster)e(to)h(read)150 843 y(or)k(write)h(sectors)f(which)g
(are)g(close)h(to)g(each)f(other)m(,)g(rather)g(than)g(those)g(which)g
(are)g(further)f(apart.)150 957 y(Another)21 b(dif)n(ference)g(is)i
(that)g(block)f(de)n(vices)g(can)g(only)g(accept)h(input)e(and)i
(return)e(output)g(in)i(blocks)150 1070 y(\(whose)17
b(size)h(can)f(v)n(ary)g(according)e(to)j(the)f(de)n(vice\),)g(whereas)
g(character)f(de)n(vices)h(are)h(allo)n(wed)f(to)g(use)150
1184 y(as)k(man)o(y)d(or)i(as)g(fe)n(w)g(bytes)g(as)g(the)o(y)g(lik)o
(e.)25 b(Most)20 b(de)n(vices)f(in)h(the)g(w)o(orld)f(are)h(character)m
(,)e(because)h(the)o(y)150 1297 y(don')o(t)j(need)h(this)h(type)f(of)g
(b)n(uf)n(fering,)f(and)h(the)o(y)g(don')o(t)f(operate)h(with)g(a)h
(\002x)o(ed)f(block)g(size.)36 b(Y)-9 b(ou)23 b(can)150
1411 y(tell)h(whether)e(a)i(de)n(vice)e(\002le)i(is)g(for)f(a)h(block)e
(de)n(vice)g(or)h(a)h(character)e(de)n(vice)g(by)h(looking)f(at)i(the)f
(\002rst)150 1525 y(character)d(in)h(the)g(output)e(of)i
Fu(ls)49 b(-l)p Fy(.)28 b(If)21 b(it')-5 b(s)22 b(`b')e(then)g(it')-5
b(s)22 b(a)g(block)e(de)n(vice,)g(and)g(if)h(it')-5 b(s)22
b(`c')f(then)f(it')-5 b(s)150 1638 y(a)21 b(character)e(de)n(vice.)275
1752 y(This)44 b(module)f(is)j(di)n(vided)d(into)h(tw)o(o)g(separate)g
(parts:)74 b(The)44 b(module)f(part)h(which)g(re)o(gis-)150
1865 y(ters)38 b(the)g(de)n(vice)e(and)i(the)f(de)n(vice)g(dri)n(v)o
(er)f(part.)77 b(The)37 b Fu(init)p 2084 1865 25 4 v
29 w(module)g Fy(function)f(calls)j Fu(mod-)150 1979
y(ule)p 305 1979 V 29 w(register)p 734 1979 V 29 w(chrdev)22
b Fy(to)h(add)f(the)h(de)n(vice)f(dri)n(v)o(er)f(to)i(the)f(k)o(ernel')
-5 b(s)23 b(character)e(de)n(vice)h(dri)n(v)o(er)150
2092 y(table.)32 b(It)23 b(also)g(returns)e(the)i(major)f(number)e(to)j
(be)g(used)f(for)g(the)g(dri)n(v)o(er)-5 b(.)31 b(The)23
b Fu(cleanup)p 2828 2092 V 28 w(module)150 2206 y Fy(function)18
b(dere)o(gisters)i(the)g(de)n(vice.)275 2320 y(This)26
b(\(re)o(gistering)f(something)g(and)i(unre)o(gistering)d(it\))j(is)g
(the)g(general)f(functionality)e(of)j(those)150 2433
y(tw)o(o)g(functions.)43 b(Things)26 b(in)h(the)f(k)o(ernel)g(don')o(t)
f(run)h(on)h(their)f(o)n(wn)g(initiati)n(v)o(e,)i(lik)o(e)f(processes,)
h(b)n(ut)150 2547 y(are)20 b(called,)f(by)g(processes)g(via)h(system)g
(calls,)g(or)f(by)h(hardw)o(are)e(de)n(vices)h(via)h(interrupts,)e(or)h
(by)g(other)150 2660 y(parts)k(of)h(the)f(k)o(ernel)g(\(simply)f(by)h
(calling)g(speci\002c)h(functions\).)33 b(As)24 b(a)g(result,)g(when)f
(you)f(add)h(code)150 2774 y(to)i(the)h(k)o(ernel,)f(you')l(re)e
(supposed)h(to)h(re)o(gister)g(it)h(as)g(the)f(handler)e(for)i(a)h
(certain)e(type)h(of)g(e)n(v)o(ent)f(and)150 2887 y(when)c(you)f(remo)o
(v)o(e)f(it,)j(you')l(re)d(supposed)h(to)h(unre)o(gister)f(it.)275
3001 y(The)27 b(de)n(vice)f(dri)n(v)o(er)g(proper)g(is)i(composed)e(of)
h(the)h(four)e(de)n(vice)p 2204 3001 V 28 w Fj(<)p Fy(action)p
Fj(>)h Fy(functions,)g(which)150 3115 y(are)g(called)h(when)e(somebody)
g(tries)i(to)f(do)g(something)f(with)i(a)f(de)n(vice)g(\002le)h(which)f
(has)h(our)e(major)150 3228 y(number)-5 b(.)27 b(The)21
b(w)o(ay)h(the)f(k)o(ernel)g(kno)n(ws)g(to)g(call)h(them)f(is)i(via)e
(the)g Fu(file)p 2294 3228 V 30 w(operations)f Fy(structure,)150
3342 y Fu(Fops)p Fy(,)j(which)g(w)o(as)h(gi)n(v)o(en)e(when)g(the)i(de)
n(vice)e(w)o(as)i(re)o(gistered,)e(which)h(includes)f(pointers)g(to)i
(those)150 3455 y(four)19 b(functions.)275 3569 y(Another)24
b(point)g(we)i(need)f(to)g(remember)f(here)h(is)h(that)g(we)f(can')o(t)
g(allo)n(w)g(the)h(k)o(ernel)e(module)g(to)150 3682 y(be)f
Fu(rmmod)p Fy(ed)g(whene)n(v)o(er)e(root)h(feels)i(lik)o(e)g(it.)35
b(The)23 b(reason)f(is)i(that)g(if)f(the)h(de)n(vice)e(\002le)i(is)g
(opened)e(by)150 3796 y(a)j(process)f(and)g(then)g(we)h(remo)o(v)o(e)e
(the)i(k)o(ernel)e(module,)h(using)g(the)h(\002le)g(w)o(ould)f(cause)h
(a)g(call)g(to)g(the)150 3910 y(memory)18 b(location)g(where)h(the)h
(appropriate)d(function)h(\(read/write\))g(used)h(to)h(be.)25
b(If)19 b(we')l(re)g(luck)o(y)-5 b(,)18 b(no)150 4023
y(other)f(code)g(w)o(as)i(loaded)e(there,)h(and)f(we')o(ll)h(get)g(an)g
(ugly)f(error)g(message.)24 b(If)18 b(we')l(re)f(unluck)o(y)-5
b(,)16 b(another)150 4137 y(k)o(ernel)22 b(module)g(w)o(as)h(loaded)f
(into)h(the)g(same)g(location,)f(which)g(means)h(a)g(jump)f(into)h(the)
g(middle)f(of)p eop
%%Page: 14 18
14 17 bop -150 162 a Fy(another)21 b(function)g(within)h(the)h(k)o
(ernel.)31 b(The)22 b(results)h(of)f(this)h(w)o(ould)f(be)g(impossible)
g(to)h(predict,)f(b)n(ut)-150 275 y(the)o(y)d(can')o(t)h(be)g(positi)n
(v)o(e.)-25 389 y(Normally)-5 b(,)14 b(when)h(you)g(don')o(t)f(w)o(ant)
i(to)g(allo)n(w)g(something,)e(you)h(return)g(an)g(error)g(code)g(\(a)h
(ne)o(gati)n(v)o(e)-150 502 y(number\))25 b(from)h(the)h(function)e
(which)i(is)h(supposed)d(to)i(do)g(it.)46 b(W)m(ith)27
b Fu(cleanup)p 2292 502 25 4 v 29 w(module)g Fy(that)g(is)-150
616 y(impossible)20 b(because)g(it')-5 b(s)22 b(a)f(v)n(oid)g
(function.)k(Once)20 b Fu(cleanup)p 1740 616 V 29 w(module)g
Fy(is)i(called,)e(the)h(module)f(is)-150 730 y(dead.)41
b(Ho)n(we)n(v)o(er)m(,)25 b(there)g(is)h(a)g(use)g(counter)f(which)g
(counts)g(ho)n(w)g(man)o(y)f(other)h(k)o(ernel)g(modules)g(are)-150
843 y(using)g(this)h(k)o(ernel)f(module,)g(called)g(the)h(reference)e
(count)h(\(that')-5 b(s)25 b(the)h(last)g(number)e(of)h(the)h(line)f
(in)-150 957 y Fu(/proc/modules)p Fy(\).)38 b(If)25 b(this)g(number)f
(isn')o(t)h(zero,)g Fu(rmmod)g Fy(will)h(f)o(ail.)40
b(The)25 b(module')-5 b(s)24 b(reference)-150 1070 y(count)h(is)j(a)n
(v)n(ailable)e(in)g(the)h(v)n(ariable)e Fu(mod)p 1134
1070 V 30 w(use)p 1314 1070 V 29 w(count)p 1593 1070
V 29 w Fy(.)44 b(Since)27 b(there)f(are)g(macros)g(de\002ned)f(for)-150
1184 y(handling)d(this)i(v)n(ariable)f(\()p Fu(MOD)p
782 1184 V 29 w(INC)p 961 1184 V 29 w(USE)p 1140 1184
V 29 w(COUNT)h Fy(and)f Fu(MOD)p 1737 1184 V 29 w(DEC)p
1916 1184 V 30 w(USE)p 2096 1184 V 29 w(COUNT)p Fy(\),)g(we)h(prefer)e
(to)-150 1297 y(use)27 b(them,)h(rather)d(than)i Fu(mod)p
750 1297 V 29 w(use)p 929 1297 V 29 w(count)p 1208 1297
V 57 w Fy(directly)-5 b(,)26 b(so)i(we')o(ll)f(be)f(safe)h(if)g(the)g
(implementation)-150 1411 y(changes)19 b(in)i(the)f(future.)-25
1599 y Fl(charde)o(v)-7 b(.c)-150 1822 y Fu(/*)49 b(chardev.c)-100
1936 y(*)g(Copyright)g(\(C\))g(1998-1999)f(by)h(Ori)h(Pomerantz)-100
2049 y(*)-100 2163 y(*)f(Create)g(a)h(character)e(device)h(\(read)f
(only\))-100 2276 y(*/)-150 2504 y(/*)h(The)h(necessary)e(header)h
(files)f(*/)-150 2731 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)-150
2844 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)-150 2958 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)-150 3185 y(/*)g(Deal)h(with)
f(CONFIG_MODVERSIONS)d(*/)-150 3299 y(#if)j(CONFIG_MODVERSIONS==1)-150
3412 y(#define)g(MODVERSIONS)-150 3526 y(#include)f
(<linux/modversions.h>)-150 3639 y(#endif)-150 3866 y(/*)h(For)h
(character)e(devices)g(*/)-150 3980 y(#include)g(<linux/fs.h>)347
b(/*)49 b(The)g(character)g(device)1295 4094 y(*)g(definitions)f(are)h
(here)g(*/)-150 4207 y(#include)f(<linux/wrapper.h>)97
b(/*)49 b(A)h(wrapper)e(which)h(does)p eop
%%Page: 15 19
15 18 bop 1595 162 a Fu(*)49 b(next)g(to)h(nothing)e(at)1595
275 y(*)h(at)h(present,)e(but)h(may)1595 389 y(*)g(help)g(for)h
(compatibility)1595 502 y(*)f(with)g(future)g(versions)1595
616 y(*)g(of)h(Linux)f(*/)150 957 y(/*)g(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)200 1070
y(*)49 b(a)h(macro)f(for)g(this,)g(but)g(2.0.35)g(doesn't)g(-)g(so)h(I)
f(add)200 1184 y(*)g(it)h(here)f(if)g(necessary.)f(*/)150
1297 y(#ifndef)h(KERNEL_VERSION)150 1411 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))150
1525 y(#endif)150 1865 y(/*)k(Conditional)f(compilation.)g
(LINUX_VERSION_CODE)e(is)200 1979 y(*)j(the)h(code)f(\(as)g(per)g
(KERNEL_VERSION\))e(of)j(this)f(version.)f(*/)150 2092
y(#if)h(LINUX_VERSION_CODE)e(>)i(KERNEL_VERSION\(2,2,0\))150
2206 y(#include)f(<asm/uaccess.h>)97 b(/*)50 b(for)f(put_user)f(*/)150
2320 y(#endif)150 2774 y(#define)h(SUCCESS)f(0)150 3115
y(/*)h(Device)g(Declarations)f(****************************)c(*/)150
3342 y(/*)49 b(The)h(name)f(for)g(our)g(device,)g(as)g(it)h(will)f
(appear)200 3455 y(*)g(in)h(/proc/devices)d(*/)150 3569
y(#define)i(DEVICE_NAME)e("char_dev")150 3910 y(/*)i(The)h(maximum)e
(length)h(of)g(the)h(message)e(from)h(the)g(device)g(*/)150
4023 y(#define)g(BUF_LEN)f(80)p eop
%%Page: 16 20
16 19 bop -150 162 a Fu(/*)49 b(Is)h(the)f(device)g(open)g(right)g
(now?)g(Used)g(to)g(prevent)-100 275 y(*)g(concurent)g(access)f(into)h
(the)h(same)f(device)f(*/)-150 389 y(static)h(int)g(Device_Open)f(=)h
(0;)-150 616 y(/*)g(The)h(message)e(the)h(device)g(will)g(give)g(when)g
(asked)g(*/)-150 730 y(static)g(char)g(Message[BUF_LEN];)-150
957 y(/*)g(How)h(far)f(did)g(the)g(process)g(reading)f(the)i(message)
-100 1070 y(*)f(get?)h(Useful)e(if)i(the)f(message)f(is)i(larger)f
(than)g(the)g(size)-100 1184 y(*)g(of)h(the)f(buffer)g(we)g(get)h(to)f
(fill)g(in)g(device_read.)f(*/)-150 1297 y(static)h(char)g
(*Message_Ptr;)-150 1638 y(/*)g(This)h(function)e(is)h(called)g
(whenever)f(a)i(process)-100 1752 y(*)f(attempts)g(to)g(open)g(the)h
(device)e(file)h(*/)-150 1865 y(static)g(int)g(device_open\(struct)d
(inode)j(*inode,)199 1979 y(struct)f(file)h(*file\))-150
2092 y({)-50 2206 y(static)f(int)i(counter)e(=)i(0;)-150
2433 y(#ifdef)f(DEBUG)-50 2547 y(printk)f
(\("device_open\(\045p,\045p\)\\n",)e(inode,)i(file\);)-150
2660 y(#endif)-50 2887 y(/*)h(This)g(is)h(how)f(you)g(get)g(the)h
(minor)e(device)h(number)g(in)-1 3001 y(*)h(case)f(you)g(have)g(more)h
(than)f(one)g(physical)f(device)h(using)-1 3115 y(*)h(the)f(driver.)g
(*/)-50 3228 y(printk\("Device:)e(\045d.\045d\\n",)-100
3342 y(inode->i_rdev)g(>>)j(8,)f(inode->i_rdev)e(&)j(0xFF\);)-50
3569 y(/*)f(We)h(don't)e(want)h(to)h(talk)f(to)g(two)h(processes)e(at)h
(the)-1 3682 y(*)h(same)f(time)g(*/)-50 3796 y(if)g(\(Device_Open\))49
3910 y(return)g(-EBUSY;)-50 4137 y(/*)g(If)h(this)f(was)g(a)g(process,)
g(we)g(would)g(have)g(had)g(to)h(be)p eop
%%Page: 17 21
17 20 bop 299 162 a Fu(*)50 b(more)f(careful)g(here.)299
275 y(*)299 389 y(*)h(In)g(the)f(case)g(of)g(processes,)f(the)h(danger)
g(would)g(be)299 502 y(*)h(that)f(one)g(process)g(might)g(have)g(check)
g(Device_Open)299 616 y(*)h(and)f(then)g(be)h(replaced)e(by)i(the)f
(schedualer)f(by)h(another)299 730 y(*)h(process)f(which)f(runs)i(this)
f(function.)f(Then,)h(when)g(the)299 843 y(*)h(first)f(process)f(was)i
(back)f(on)g(the)g(CPU,)h(it)f(would)g(assume)299 957
y(*)h(the)f(device)g(is)g(still)g(not)h(open.)299 1070
y(*)299 1184 y(*)g(However,)e(Linux)h(guarantees)f(that)h(a)h(process)e
(won't)h(be)299 1297 y(*)h(replaced)e(while)h(it)h(is)f(running)g(in)g
(kernel)g(context.)299 1411 y(*)299 1525 y(*)h(In)g(the)f(case)g(of)g
(SMP,)g(one)h(CPU)f(might)g(increment)299 1638 y(*)h(Device_Open)e
(while)h(another)f(CPU)h(is)h(here,)f(right)g(after)299
1752 y(*)h(the)f(check.)g(However,)f(in)i(version)e(2.0)i(of)f(the)299
1865 y(*)h(kernel)f(this)g(is)g(not)h(a)f(problem)g(because)f(there's)h
(a)g(lock)299 1979 y(*)h(to)g(guarantee)e(only)h(one)g(CPU)g(will)g(be)
h(kernel)e(module)h(at)299 2092 y(*)h(the)f(same)g(time.)g(This)g(is)h
(bad)f(in)99 b(terms)49 b(of)299 2206 y(*)h(performance,)e(so)h
(version)g(2.2)g(changed)f(it.)299 2320 y(*)i(Unfortunately,)d(I)j
(don't)f(have)g(access)g(to)g(an)g(SMP)h(box)299 2433
y(*)g(to)g(check)e(how)i(it)f(works)g(with)g(SMP.)299
2547 y(*/)250 2774 y(Device_Open++;)250 3001 y(/*)g(Initialize)f(the)h
(message.)g(*/)250 3115 y(sprintf\(Message,)349 3228
y("If)h(I)f(told)g(you)g(once,)g(I)h(told)f(you)g(\045d)h(times)f(-)g
(\045s",)349 3342 y(counter++,)349 3455 y("Hello,)g(world\\n"\);)250
3569 y(/*)g(The)g(only)g(reason)g(we're)g(allowed)f(to)i(do)f(this)g
(sprintf)299 3682 y(*)h(is)g(because)e(the)h(maximum)g(length)f(of)i
(the)f(message)299 3796 y(*)h(\(assuming)e(32)i(bit)f(integers)f(-)i
(up)f(to)h(10)f(digits)299 3910 y(*)h(with)f(the)g(minus)g(sign\))g(is)
h(less)f(than)g(BUF_LEN,)f(which)299 4023 y(*)i(is)g(80.)f(BE)g
(CAREFUL)g(NOT)g(TO)g(OVERFLOW)g(BUFFERS,)299 4137 y(*)h(ESPECIALLY)e
(IN)h(THE)h(KERNEL!!!)p eop
%%Page: 18 22
18 21 bop -1 162 a Fu(*/)-50 389 y(Message_Ptr)47 b(=)j(Message;)-50
616 y(/*)f(Make)g(sure)g(that)g(the)h(module)e(isn't)h(removed)g(while)
-1 730 y(*)h(the)f(file)g(is)h(open)f(by)g(incrementing)f(the)h(usage)g
(count)-1 843 y(*)h(\(the)f(number)g(of)g(opened)g(references)f(to)h
(the)h(module,)e(if)-1 957 y(*)i(it's)f(not)g(zero)g(rmmod)g(will)g
(fail\))-1 1070 y(*/)-50 1184 y(MOD_INC_USE_COUNT;)-50
1411 y(return)f(SUCCESS;)-150 1525 y(})-150 1865 y(/*)h(This)h
(function)e(is)h(called)g(when)g(a)h(process)e(closes)h(the)-100
1979 y(*)g(device)g(file.)g(It)g(doesn't)g(have)g(a)h(return)e(value)h
(in)-100 2092 y(*)g(version)g(2.0.x)g(because)f(it)i(can't)f(fail)g
(\(you)g(must)g(ALWAYS)-100 2206 y(*)g(be)h(able)f(to)g(close)g(a)h
(device\).)e(In)i(version)e(2.2.x)h(it)g(is)-100 2320
y(*)g(allowed)g(to)g(fail)g(-)h(but)f(we)h(won't)f(let)g(it.)-100
2433 y(*/)-150 2547 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))-150 2660 y(static)g(int)g
(device_release\(struct)d(inode)j(*inode,)-50 2774 y(struct)f(file)h
(*file\))-150 2887 y(#else)-150 3001 y(static)g(void)g
(device_release\(struct)d(inode)j(*inode,)-1 3115 y(struct)g(file)g
(*file\))-150 3228 y(#endif)-150 3342 y({)-150 3455 y(#ifdef)g(DEBUG)
-50 3569 y(printk)f(\("device_release\(\045p,\045p\)\\n",)d(inode,)k
(file\);)-150 3682 y(#endif)-50 3910 y(/*)g(We're)g(now)g(ready)g(for)g
(our)h(next)f(caller)f(*/)-50 4023 y(Device_Open)f(--;)p
eop
%%Page: 19 23
19 22 bop 250 162 a Fu(/*)49 b(Decrement)f(the)h(usage)g(count,)g
(otherwise)f(once)h(you)299 275 y(*)h(opened)f(the)g(file)g(you'll)g
(never)g(get)g(rid)g(of)h(the)f(module.)299 389 y(*/)250
502 y(MOD_DEC_USE_COUNT;)150 730 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))250 843 y(return)f(0;)150 957
y(#endif)150 1070 y(})150 1411 y(/*)h(This)h(function)e(is)h(called)g
(whenever)f(a)i(process)e(which)200 1525 y(*)h(have)h(already)e(opened)
h(the)g(device)g(file)g(attempts)f(to)200 1638 y(*)h(read)h(from)f(it.)
g(*/)150 1979 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))150 2092 y(static)g(ssize_t)f
(device_read\(struct)f(file)i(*file,)349 2206 y(char)g(*buffer,)198
b(/*)50 b(The)f(buffer)f(to)i(fill)f(with)g(data)g(*/)349
2320 y(size_t)g(length,)148 b(/*)50 b(The)f(length)f(of)i(the)f(buffer)
g(*/)349 2433 y(loff_t)g(*offset\))98 b(/*)50 b(Our)f(offset)f(in)i
(the)f(file)g(*/)150 2547 y(#else)150 2660 y(static)g(int)g
(device_read\(struct)d(inode)j(*inode,)1296 2774 y(struct)f(file)h
(*file,)349 2887 y(char)g(*buffer,)148 b(/*)50 b(The)f(buffer)g(to)g
(fill)g(with)399 3001 y(*)h(the)f(data)g(*/)349 3115
y(int)h(length\))247 b(/*)50 b(The)f(length)g(of)g(the)g(buffer)1196
3228 y(*)h(\(mustn't)e(write)h(beyond)g(that!\))f(*/)150
3342 y(#endif)150 3455 y({)250 3569 y(/*)h(Number)g(of)g(bytes)g
(actually)f(written)h(to)g(the)h(buffer)e(*/)250 3682
y(int)h(bytes_read)f(=)h(0;)250 3910 y(/*)g(If)h(we're)e(at)i(the)f
(end)g(of)h(the)f(message,)f(return)h(0)299 4023 y(*)h(\(which)f
(signifies)f(end)h(of)h(file\))e(*/)250 4137 y(if)h(\(*Message_Ptr)e
(==)j(0\))p eop
%%Page: 20 24
20 23 bop 49 162 a Fu(return)49 b(0;)-50 389 y(/*)g(Actually)f(put)i
(the)f(data)g(into)g(the)g(buffer)g(*/)-50 502 y(while)g(\(length)f(&&)
h(*Message_Ptr\))98 b({)49 730 y(/*)50 b(Because)e(the)h(buffer)g(is)h
(in)f(the)g(user)g(data)g(segment,)99 843 y(*)h(not)f(the)g(kernel)g
(data)g(segment,)f(assignment)g(wouldn't)99 957 y(*)i(work.)f(Instead,)
f(we)h(have)g(to)h(use)f(put_user)f(which)99 1070 y(*)i(copies)e(data)h
(from)h(the)f(kernel)f(data)i(segment)e(to)h(the)99 1184
y(*)h(user)f(data)g(segment.)f(*/)49 1297 y
(put_user\(*\(Message_Ptr++\),)d(buffer++\);)49 1638
y(length)k(--;)49 1752 y(bytes_read)f(++;)-50 1865 y(})-150
2092 y(#ifdef)h(DEBUG)-1 2206 y(printk)g(\("Read)g(\045d)g(bytes,)g
(\045d)g(left\\n",)99 2320 y(bytes_read,)f(length\);)-150
2433 y(#endif)-1 2660 y(/*)i(Read)f(functions)f(are)h(supposed)g(to)g
(return)g(the)g(number)49 2774 y(*)h(of)f(bytes)g(actually)g(inserted)f
(into)h(the)g(buffer)g(*/)-50 2887 y(return)f(bytes_read;)-150
3001 y(})-150 3569 y(/*)h(This)h(function)e(is)h(called)g(when)g
(somebody)f(tries)h(to)h(write)-100 3682 y(*)f(into)h(our)f(device)f
(file)i(-)f(unsupported)f(in)h(this)g(example.)g(*/)-150
3796 y(#if)g(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))-150
3910 y(static)g(ssize_t)f(device_write\(struct)e(file)k(*file,)49
4023 y(const)f(char)g(*buffer,)198 b(/*)49 b(The)h(buffer)e(*/)49
4137 y(size_t)h(length,)148 b(/*)50 b(The)f(length)f(of)i(the)f(buffer)
g(*/)p eop
%%Page: 21 25
21 24 bop 349 162 a Fu(loff_t)49 b(*offset\))98 b(/*)50
b(Our)f(offset)f(in)i(the)f(file)g(*/)150 275 y(#else)150
389 y(static)g(int)g(device_write\(struct)d(inode)j(*inode,)1346
502 y(struct)f(file)h(*file,)1346 616 y(const)f(char)h(*buffer,)1346
730 y(int)g(length\))150 843 y(#endif)150 957 y({)250
1070 y(return)f(-EINVAL;)150 1184 y(})150 1752 y(/*)h(Module)g
(Declarations)f(*****************************)c(*/)150
1979 y(/*)49 b(The)h(major)f(device)f(number)h(for)g(the)g(device.)g
(This)g(is)200 2092 y(*)g(global)g(\(well,)g(static,)f(which)h(in)h
(this)f(context)f(is)i(global)200 2206 y(*)f(within)g(this)g(file\))g
(because)g(it)g(has)g(to)h(be)f(accessible)200 2320 y(*)g(both)h(for)f
(registration)e(and)j(for)f(release.)f(*/)150 2433 y(static)h(int)g
(Major;)150 2660 y(/*)g(This)h(structure)e(will)h(hold)g(the)g
(functions)f(to)i(be)200 2774 y(*)f(called)g(when)g(a)h(process)e(does)
h(something)g(to)g(the)g(device)200 2887 y(*)g(we)h(created.)e(Since)h
(a)h(pointer)e(to)i(this)f(structure)f(is)200 3001 y(*)h(kept)h(in)f
(the)g(devices)g(table,)f(it)i(can't)f(be)g(local)g(to)200
3115 y(*)g(init_module.)f(NULL)h(is)h(for)f(unimplemented)e(functions.)
h(*/)150 3455 y(struct)h(file_operations)e(Fops)i(=)g({)250
3569 y(NULL,)148 b(/*)50 b(seek)f(*/)250 3682 y(device_read,)250
3796 y(device_write,)250 3910 y(NULL,)148 b(/*)50 b(readdir)e(*/)250
4023 y(NULL,)148 b(/*)50 b(select)e(*/)250 4137 y(NULL,)148
b(/*)50 b(ioctl)e(*/)p eop
%%Page: 22 26
22 25 bop -50 162 a Fu(NULL,)148 b(/*)50 b(mmap)f(*/)-50
275 y(device_open,)-150 389 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))-50 502 y(NULL,)148 b(/*)50
b(flush)e(*/)-150 616 y(#endif)-50 730 y(device_release)97
b(/*)49 b(a.k.a.)g(close)g(*/)-150 843 y(};)-150 1184
y(/*)g(Initialize)f(the)i(module)e(-)i(Register)e(the)i(character)e
(device)g(*/)-150 1297 y(int)h(init_module\(\))-150 1411
y({)-50 1525 y(/*)g(Register)f(the)i(character)e(device)g(\(atleast)h
(try\))g(*/)-50 1638 y(Major)g(=)g(module_register_chrdev\(0,)1494
1752 y(DEVICE_NAME,)1494 1865 y(&Fops\);)-50 2092 y(/*)g(Negative)f
(values)h(signify)g(an)g(error)g(*/)-50 2206 y(if)g(\(Major)g(<)g(0\))h
({)49 2320 y(printk)f(\("\045s)g(device)g(failed)f(with)h(\045d\\n",)49
2433 y("Sorry,)g(registering)f(the)h(character",)49 2547
y(Major\);)49 2660 y(return)g(Major;)-50 2774 y(})-50
3001 y(printk)f(\("\045s)h(The)h(major)f(device)f(number)h(is)g
(\045d.\\n",)348 3115 y("Registeration)e(is)j(a)f(success.",)348
3228 y(Major\);)-50 3342 y(printk)f(\("If)h(you)h(want)f(to)g(talk)g
(to)h(the)f(device)g(driver,\\n"\);)-50 3455 y(printk)f(\("you'll)h
(have)g(to)g(create)g(a)g(device)g(file.)g(\\n"\);)-50
3569 y(printk)f(\("We)h(suggest)g(you)g(use:\\n"\);)-50
3682 y(printk)f(\("mknod)h(<name>)g(c)g(\045d)h(<minor>\\n",)d
(Major\);)-50 3796 y(printk)h(\("You)h(can)g(try)h(different)e(minor)h
(numbers)f(\045s",)348 3910 y("and)h(see)g(what)h(happens.\\n"\);)-50
4137 y(return)e(0;)p eop
%%Page: 23 27
23 26 bop 150 162 a Fu(})150 502 y(/*)49 b(Cleanup)g(-)h(unregister)e
(the)h(appropriate)f(file)h(from)g(/proc)g(*/)150 616
y(void)g(cleanup_module\(\))150 730 y({)250 843 y(int)g(ret;)250
1070 y(/*)g(Unregister)f(the)h(device)g(*/)250 1184 y(ret)g(=)h
(module_unregister_chrdev\(Major,)44 b(DEVICE_NAME\);)250
1411 y(/*)49 b(If)h(there's)e(an)h(error,)g(report)g(it)g(*/)250
1525 y(if)g(\(ret)g(<)h(0\))349 1638 y(printk\("Error)e(in)h
(unregister_chrdev:)e(\045d\\n",)h(ret\);)150 1752 y(})150
2300 y Fm(2.1)119 b(Multiple)31 b(K)m(er)n(nel)g(V)-12
b(ersions)30 b(Sour)n(ce)h(Files)275 2504 y Fy(The)h(system)h(calls,)j
(which)c(are)h(the)g(major)e(interf)o(ace)h(the)h(k)o(ernel)f(sho)n(ws)
h(to)f(the)h(processes,)150 2617 y(generally)21 b(stay)h(the)g(same)g
(across)g(v)o(ersions.)30 b(A)23 b(ne)n(w)e(system)i(call)f(may)g(be)g
(added,)f(b)n(ut)h(usually)g(the)150 2731 y(old)17 b(ones)f(will)i
(beha)n(v)o(e)e(e)o(xactly)g(lik)o(e)h(the)o(y)f(used)g(to.)24
b(This)18 b(is)f(necessary)g(for)f(backw)o(ard)f(compatibility)150
2844 y(\227)29 b(a)h(ne)n(w)e(k)o(ernel)g(v)o(ersion)g(is)h
Fo(not)g Fy(supposed)e(to)i(break)f(re)o(gular)f(processes.)51
b(In)28 b(most)h(cases,)j(the)150 2958 y(de)n(vice)19
b(\002les)i(will)g(also)f(remain)g(the)g(same.)25 b(On)20
b(the)g(other)f(hand,)g(the)h(internal)f(interf)o(aces)h(within)g(the)
150 3071 y(k)o(ernel)f(can)h(and)g(do)g(change)f(between)g(v)o
(ersions.)275 3185 y(The)55 b(Linux)f(k)o(ernel)h(v)o(ersions)g(are)h
(di)n(vided)e(between)h(the)g(stable)h(v)o(ersions)f(\(n.)p
Fj(<)p Fy(e)n(v)o(en)150 3299 y(number)p Fj(>)p Fy(.m\))20
b(and)k(the)f(de)n(v)o(elopment)e(v)o(ersions)i(\(n.)p
Fj(<)p Fy(odd)e(number)p Fj(>)p Fy(.m\).)32 b(The)23
b(de)n(v)o(elopment)e(v)o(er)n(-)150 3412 y(sions)k(include)f(all)h
(the)g(cool)f(ne)n(w)h(ideas,)h(including)d(those)h(which)g(will)i(be)f
(considered)e(a)i(mistak)o(e,)150 3526 y(or)f(reimplemented,)e(in)i
(the)g(ne)o(xt)g(v)o(ersion.)35 b(As)25 b(a)f(result,)h(you)e(can')o(t)
g(trust)h(the)g(interf)o(ace)f(to)h(remain)150 3639 y(the)g(same)g(in)g
(those)g(v)o(ersions)f(\(which)g(is)i(why)e(I)h(don')o(t)f(bother)f(to)
i(support)f(them)h(in)g(this)g(book,)f(it')-5 b(s)150
3753 y(too)18 b(much)f(w)o(ork)h(and)g(it)h(w)o(ould)f(become)f(dated)h
(too)g(quickly\).)k(In)c(the)h(stable)f(v)o(ersions,)g(on)g(the)g
(other)150 3866 y(hand,)i(we)h(can)g(e)o(xpect)f(the)h(interf)o(ace)f
(to)h(remain)f(the)h(same)g(re)o(gardless)e(of)i(the)g(b)n(ug)f(\002x)h
(v)o(ersion)f(\(the)150 3980 y(m)g(number\).)275 4094
y(This)32 b(v)o(ersion)f(of)h(the)g(MPG)h(includes)e(support)g(for)g
(both)h(v)o(ersion)f(2.0.x)f(and)i(v)o(ersion)f(2.2.x)150
4207 y(of)h(the)h(Linux)e(k)o(ernel.)61 b(Since)33 b(there)f(are)h(dif)
n(ferences)d(between)i(the)h(tw)o(o,)i(this)e(requires)f(condi-)p
eop
%%Page: 24 28
24 27 bop -150 162 a Fy(tional)25 b(compilation)e(depending)f(on)i(the)
h(k)o(ernel)f(v)o(ersion.)38 b(The)24 b(w)o(ay)h(to)g(do)f(this)i(to)f
(use)g(the)g(macro)-150 275 y Fu(LINUX)p 105 275 25 4
v 29 w(VERSION)p 484 275 V 29 w(CODE)p Fy(.)30 b(In)g(v)o(ersion)f(a.b)
m(.c)h(of)g(the)h(k)o(ernel,)h(the)e(v)n(alue)g(of)h(this)g(macro)e(w)o
(ould)-150 389 y(be)d Ff(2)-3 359 y Fk(16)67 389 y Fj(a)d
Ff(+)g(2)264 359 y Fk(8)301 389 y Fj(b)g Ff(+)f Fj(c)p
Fy(.)45 b(T)-7 b(o)26 b(get)h(the)f(v)n(alue)g(for)g(a)h(speci\002c)g
(k)o(ernel)f(v)o(ersion,)g(we)h(can)f(use)h(the)g Fu(KER-)-150
502 y(NEL)p 5 502 V 29 w(VERSION)19 b Fy(macro.)24 b(Since)c(it')-5
b(s)20 b(not)f(de\002ned)g(in)h(2.0.35,)d(we)j(de\002ne)f(it)i(ourselv)
o(es)d(if)i(necessary)-5 b(.)p eop
%%Page: 25 29
25 28 bop 150 813 a Fn(Chapter)44 b(3)150 1263 y Fp(The)51
b(/pr)l(oc)h(File)g(System)275 1709 y Fy(In)25 b(Linux)g(there)g(is)i
(an)e(additional)g(mechanism)f(for)h(the)h(k)o(ernel)f(and)g(k)o(ernel)
g(modules)g(to)h(send)150 1823 y(information)i(to)j(processes)g(\227)g
(the)g Fu(/proc)g Fy(\002le)g(system.)57 b(Originally)30
b(designed)g(to)h(allo)n(w)f(easy)150 1936 y(access)23
b(to)f(information)d(about)i(processes)h(\(hence)f(the)h(name\),)f(it)i
(is)f(no)n(w)g(used)g(by)f(e)n(v)o(ery)g(bit)h(of)g(the)150
2050 y(k)o(ernel)17 b(which)f(has)i(something)e(interesting)g(to)i
(report,)e(such)i(as)g Fu(/proc/modules)d Fy(which)i(has)h(the)150
2163 y(list)j(of)f(modules)f(and)h Fu(/proc/meminfo)e
Fy(which)i(has)g(memory)f(usage)h(statistics.)275 2277
y(The)30 b(method)g(to)h(use)g(the)g(proc)f(\002le)h(system)h(is)f(v)o
(ery)f(similar)h(to)g(the)g(one)g(used)f(with)h(de)n(vice)150
2391 y(dri)n(v)o(ers)26 b(\227)h(you)f(create)h(a)g(structure)f(with)h
(all)h(the)f(information)d(needed)i(for)g(the)h Fu(/proc)g
Fy(\002le,)i(in-)150 2504 y(cluding)g(pointers)h(to)g(an)o(y)g(handler)
f(functions)g(\(in)h(our)g(case)g(there)g(is)i(only)d(one,)j(the)f(one)
f(called)150 2618 y(when)c(somebody)f(attempts)i(to)h(read)e(from)g
(the)h Fu(/proc)g Fy(\002le\).)46 b(Then,)27 b Fu(init)p
2519 2618 25 4 v 29 w(module)g Fy(re)o(gisters)150 2731
y(the)20 b(structure)f(with)i(the)f(k)o(ernel)f(and)h
Fu(cleanup)p 1597 2731 V 29 w(module)f Fy(unre)o(gisters)g(it.)275
2845 y(The)k(reason)h(we)h(use)f Fu(proc)p 1132 2845
V 29 w(register)p 1561 2845 V 29 w(dynamic)1935 2815
y Fk(1)1995 2845 y Fy(is)i(because)d(we)i(don')o(t)d(w)o(ant)j(to)f
(deter)n(-)150 2958 y(mine)d(the)g(inode)f(number)g(used)h(for)f(our)h
(\002le)h(in)f(adv)n(ance,)f(b)n(ut)h(to)h(allo)n(w)f(the)g(k)o(ernel)g
(to)g(determine)f(it)150 3072 y(to)25 b(pre)n(v)o(ent)d(clashes.)38
b(Normal)24 b(\002le)h(systems)f(are)h(located)e(on)h(a)h(disk,)g
(rather)f(than)g(just)h(in)f(memory)150 3186 y(\(which)f(is)h(where)f
Fu(/proc)g Fy(is\),)i(and)e(in)g(that)h(case)g(the)f(inode)g(number)e
(is)k(a)f(pointer)e(to)i(a)g(disk)f(loca-)150 3299 y(tion)16
b(where)h(the)f(\002le')-5 b(s)18 b(inde)o(x-node)c(\(inode)h(for)h
(short\))g(is)i(located.)23 b(The)16 b(inode)g(contains)g(information)
150 3413 y(about)g(the)h(\002le,)h(for)f(e)o(xample)f(the)h(\002le')-5
b(s)18 b(permissions,)f(together)e(with)j(a)f(pointer)f(to)h(the)g
(disk)h(location)150 3526 y(or)i(locations)f(where)h(the)g(\002le')-5
b(s)21 b(data)g(can)f(be)g(found.)275 3640 y(Because)i(we)h(don')o(t)d
(get)j(called)f(when)f(the)i(\002le)g(is)g(opened)e(or)h(closed,)g
(there')-5 b(s)22 b(no)g(where)g(for)f(us)150 3753 y(to)27
b(put)f Fu(MOD)p 530 3753 V 30 w(INC)p 710 3753 V 29
w(USE)p 889 3753 V 29 w(COUNT)h Fy(and)f Fu(MOD)p 1492
3753 V 29 w(DEC)p 1671 3753 V 30 w(USE)p 1851 3753 V
29 w(COUNT)h Fy(in)g(this)g(module,)g(and)f(if)h(the)g(\002le)150
3867 y(is)f(opened)c(and)i(then)h(the)f(module)f(is)j(remo)o(v)o(ed,)d
(there')-5 b(s)24 b(no)g(w)o(ay)h(to)g(a)n(v)n(oid)f(the)h
(consequences.)36 b(In)150 3981 y(the)26 b(ne)o(xt)g(chapter)f(we')o
(ll)h(see)h(a)g(harder)e(to)h(implement,)g(b)n(ut)h(more)e(\003e)o
(xible,)i(w)o(ay)f(of)g(dealing)f(with)p 150 4123 1200
4 v 235 4184 a Fi(1)270 4207 y Fh(In)16 b(v)o(ersion)j(2.0,)d(in)h(v)o
(ersion)h(2.2)f(this)g(is)g(done)h(for)f(us)g(automatically)k(if)c(we)g
(set)h(the)f(inode)i(to)e(zero.)1608 4456 y Fy(25)p eop
%%Page: 26 30
26 29 bop -150 162 a Fu(/proc)20 b Fy(\002les)h(which)f(will)h(allo)n
(w)f(us)g(to)h(protect)e(against)g(this)i(problem)e(as)i(well.)-25
350 y Fl(pr)n(ocfs.c)-150 573 y Fu(/*)49 b(procfs.c)g(-)99
b(create)49 b(a)h("file")e(in)i(/proc)-100 686 y(*)f(Copyright)g(\(C\))
g(1998-1999)f(by)h(Ori)h(Pomerantz)-100 800 y(*/)-150
1141 y(/*)f(The)h(necessary)e(header)h(files)f(*/)-150
1368 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)-150
1481 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)-150 1595 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)-150 1822 y(/*)g(Deal)h(with)
f(CONFIG_MODVERSIONS)d(*/)-150 1936 y(#if)j(CONFIG_MODVERSIONS==1)-150
2049 y(#define)g(MODVERSIONS)-150 2163 y(#include)f
(<linux/modversions.h>)-150 2276 y(#endif)-150 2617 y(/*)h(Necessary)g
(because)f(we)i(use)f(the)g(proc)g(fs)h(*/)-150 2731
y(#include)e(<linux/proc_fs.h>)-150 3185 y(/*)h(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)49 b(a)-100
3299 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e(doesn't)h(-)h(so)f(I)h
(add)f(it)-100 3412 y(*)g(here)h(if)f(necessary.)f(*/)-150
3526 y(#ifndef)h(KERNEL_VERSION)-150 3639 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))-150
3753 y(#endif)-150 4207 y(/*)k(Put)h(data)f(into)g(the)g(proc)g(fs)h
(file.)p eop
%%Page: 27 31
27 30 bop 299 275 a Fu(Arguments)299 389 y(=========)299
502 y(1.)50 b(The)f(buffer)g(where)g(the)g(data)g(is)g(to)h(be)f
(inserted,)f(if)449 616 y(you)h(decide)g(to)g(use)h(it.)299
730 y(2.)g(A)g(pointer)e(to)h(a)h(pointer)f(to)g(characters.)f(This)h
(is)449 843 y(useful)g(if)g(you)g(don't)g(want)g(to)h(use)f(the)g
(buffer)449 957 y(allocated)f(by)h(the)h(kernel.)299
1070 y(3.)g(The)f(current)g(position)f(in)h(the)h(file.)299
1184 y(4.)g(The)f(size)g(of)h(the)f(buffer)g(in)g(the)g(first)g
(argument.)299 1297 y(5.)h(Zero)f(\(for)g(future)g(use?\).)299
1638 y(Usage)g(and)h(Return)e(Value)299 1752 y(======================)
299 1865 y(If)i(you)f(use)g(your)g(own)h(buffer,)e(like)h(I)h(do,)f
(put)g(its)299 1979 y(location)g(in)g(the)g(second)g(argument)f(and)i
(return)e(the)299 2092 y(number)h(of)h(bytes)e(used)i(in)f(the)g
(buffer.)299 2320 y(A)h(return)f(value)g(of)g(zero)g(means)g(you)g
(have)g(no)h(further)299 2433 y(information)e(at)i(this)f(time)g(\(end)
g(of)g(file\).)g(A)h(negative)299 2547 y(return)f(value)g(is)g(an)h
(error)f(condition.)299 2887 y(For)h(More)f(Information)299
3001 y(====================)299 3115 y(The)h(way)f(I)h(discovered)e
(what)h(to)g(do)g(with)h(this)f(function)299 3228 y(wasn't)g(by)h
(reading)e(documentation,)f(but)j(by)f(reading)f(the)299
3342 y(code)i(which)e(used)h(it.)h(I)f(just)g(looked)g(to)h(see)f(what)
g(uses)299 3455 y(the)h(get_info)e(field)h(of)g(proc_dir_entry)f
(struct)g(\(I)i(used)f(a)299 3569 y(combination)f(of)i(find)f(and)g
(grep,)g(if)g(you're)g(interested\),)299 3682 y(and)h(I)f(saw)h(that)98
b(it)50 b(is)f(used)g(in)h(<kernel)e(source)299 3796
y(directory>/fs/proc/array.c.)299 4023 y(If)i(something)e(is)h(unknown)
g(about)g(the)g(kernel,)g(this)g(is)299 4137 y(usually)g(the)g(way)g
(to)h(go.)f(In)h(Linux)e(we)i(have)f(the)g(great)p eop
%%Page: 28 32
28 31 bop -1 162 a Fu(advantage)49 b(of)g(having)g(the)g(kernel)g
(source)f(code)h(for)-1 275 y(free)h(-)f(use)g(it.)-100
389 y(*/)-150 502 y(int)g(procfile_read\(char)e(*buffer,)-50
616 y(char)i(**buffer_location,)-50 730 y(off_t)g(offset,)-50
843 y(int)g(buffer_length,)-50 957 y(int)g(zero\))-150
1070 y({)-50 1184 y(int)g(len;)99 b(/*)49 b(The)g(number)g(of)h(bytes)e
(actually)h(used)g(*/)-50 1411 y(/*)g(This)g(is)h(static)e(so)i(it)f
(will)g(still)g(be)h(in)f(memory)-1 1525 y(*)h(when)f(we)h(leave)e
(this)i(function)e(*/)-50 1638 y(static)g(char)h(my_buffer[80];)-50
1865 y(static)f(int)i(count)e(=)i(1;)-50 2092 y(/*)f(We)h(give)f(all)g
(of)g(our)h(information)d(in)j(one)f(go,)g(so)h(if)f(the)-1
2206 y(*)h(user)f(asks)g(us)h(if)f(we)h(have)f(more)g(information)e
(the)-1 2320 y(*)j(answer)f(should)f(always)h(be)h(no.)-1
2433 y(*)-1 2547 y(*)g(This)f(is)h(important)e(because)g(the)h
(standard)g(read)-1 2660 y(*)h(function)e(from)h(the)h(library)e(would)
h(continue)f(to)i(issue)-1 2774 y(*)g(the)f(read)g(system)g(call)g
(until)g(the)g(kernel)g(replies)-1 2887 y(*)h(that)f(it)h(has)f(no)g
(more)g(information,)f(or)h(until)g(its)-1 3001 y(*)h(buffer)f(is)g
(filled.)-1 3115 y(*/)-50 3228 y(if)g(\(offset)g(>)g(0\))49
3342 y(return)g(0;)-50 3569 y(/*)g(Fill)g(the)g(buffer)g(and)g(get)h
(its)f(length)g(*/)-50 3682 y(len)g(=)h(sprintf\(my_buffer,)49
3796 y("For)f(the)h(\045d\045s)f(time,)g(go)g(away!\\n",)f(count,)49
3910 y(\(count)h(\045)h(100)f(>)g(10)h(&&)f(count)g(\045)h(100)f(<)h
(14\))f(?)h("th")f(:)149 4023 y(\(count)g(\045)g(10)h(==)f(1\))h(?)f
("st")g(:)249 4137 y(\(count)f(\045)i(10)f(==)h(2\))f(?)h("nd")f(:)p
eop
%%Page: 29 33
29 32 bop 648 162 a Fu(\(count)49 b(\045)g(10)h(==)f(3\))h(?)f("rd")g
(:)h("th")f(\);)250 275 y(count++;)250 502 y(/*)g(Tell)g(the)g
(function)g(which)g(called)f(us)i(where)f(the)299 616
y(*)h(buffer)f(is)g(*/)250 730 y(*buffer_location)d(=)k(my_buffer;)250
957 y(/*)f(Return)g(the)g(length)g(*/)250 1070 y(return)f(len;)150
1184 y(})150 1525 y(struct)h(proc_dir_entry)e(Our_Proc_File)g(=)250
1638 y({)349 1752 y(0,)j(/*)f(Inode)g(number)g(-)g(ignore,)g(it)g(will)
g(be)h(filled)e(by)549 1865 y(*)h(proc_register[_dynamic])d(*/)349
1979 y(4,)k(/*)f(Length)g(of)g(the)h(file)f(name)g(*/)349
2092 y("test",)g(/*)g(The)g(file)h(name)f(*/)349 2206
y(S_IFREG)g(|)g(S_IRUGO,)g(/*)g(File)g(mode)g(-)h(this)f(is)g(a)h
(regular)1346 2320 y(*)f(file)g(which)g(can)g(be)h(read)f(by)g(its)1346
2433 y(*)g(owner,)g(its)g(group,)g(and)g(everybody)1346
2547 y(*)g(else)g(*/)349 2660 y(1,)h(/*)f(Number)g(of)g(links)g
(\(directories)f(where)h(the)598 2774 y(*)h(file)f(is)g(referenced\))f
(*/)349 2887 y(0,)i(0,)99 b(/*)49 b(The)h(uid)f(and)g(gid)g(for)h(the)f
(file)g(-)h(we)f(give)g(it)748 3001 y(*)g(to)h(root)f(*/)349
3115 y(80,)h(/*)f(The)g(size)g(of)h(the)f(file)g(reported)f(by)i(ls.)f
(*/)349 3228 y(NULL,)g(/*)h(functions)e(which)h(can)g(be)g(done)g(on)h
(the)f(inode)698 3342 y(*)h(\(linking,)e(removing,)g(etc.\))h(-)g(we)h
(don't)698 3455 y(*)g(support)e(any.)h(*/)349 3569 y(procfile_read,)e
(/*)j(The)f(read)g(function)g(for)g(this)g(file,)1146
3682 y(*)h(the)f(function)f(called)h(when)g(somebody)1146
3796 y(*)h(tries)f(to)g(read)g(something)f(from)h(it.)h(*/)349
3910 y(NULL)f(/*)h(We)f(could)g(have)g(here)g(a)h(function)e(to)i(fill)
f(the)648 4023 y(*)h(file's)e(inode,)h(to)h(enable)e(us)i(to)f(play)g
(with)648 4137 y(*)h(permissions,)d(ownership,)h(etc.)h(*/)p
eop
%%Page: 30 34
30 33 bop -50 162 a Fu(};)-150 843 y(/*)49 b(Initialize)f(the)i(module)
e(-)i(register)e(the)i(proc)f(file)g(*/)-150 957 y(int)g
(init_module\(\))-150 1070 y({)-50 1184 y(/*)g(Success)g(if)g
(proc_register[_dynamic])d(is)j(a)h(success,)-1 1297
y(*)g(failure)f(otherwise.)f(*/)-150 1411 y(#if)h(LINUX_VERSION_CODE)e
(>)i(KERNEL_VERSION\(2,2,0\))-50 1525 y(/*)g(In)h(version)e(2.2,)h
(proc_register)e(assign)i(a)h(dynamic)-1 1638 y(*)g(inode)f(number)g
(automatically)e(if)i(it)h(is)f(zero)g(in)h(the)-1 1752
y(*)g(structure)e(,)i(so)f(there's)g(no)g(more)g(need)g(for)-1
1865 y(*)h(proc_register_dynamic)-1 1979 y(*/)-50 2092
y(return)e(proc_register\(&proc_root,)d(&Our_Proc_File\);)-150
2206 y(#else)-50 2320 y(return)j(proc_register_dynamic\(&proc_root,)c
(&Our_Proc_File\);)-150 2433 y(#endif)-50 2660 y(/*)49
b(proc_root)f(is)i(the)f(root)g(directory)f(for)h(the)h(proc)-1
2774 y(*)g(fs)g(\(/proc\).)e(This)h(is)g(where)g(we)h(want)f(our)g
(file)g(to)g(be)-1 2887 y(*)h(located.)-1 3001 y(*/)-150
3115 y(})-150 3455 y(/*)f(Cleanup)g(-)h(unregister)e(our)h(file)g(from)
g(/proc)g(*/)-150 3569 y(void)g(cleanup_module\(\))-150
3682 y({)-50 3796 y(proc_unregister\(&proc_root,)44 b
(Our_Proc_File.low_ino\);)-150 3910 y(})p eop
%%Page: 31 35
31 34 bop eop
%%Page: 32 36
32 35 bop -150 813 a Fn(Chapter)44 b(4)-150 1263 y Fp(Using)53
b(/pr)l(oc)f(F)-5 b(or)51 b(Input)-25 1709 y Fy(So)27
b(f)o(ar)g(we)g(ha)n(v)o(e)f(tw)o(o)i(w)o(ays)f(to)g(generate)f(output)
g(from)g(k)o(ernel)g(modules:)38 b(we)27 b(can)g(re)o(gister)f(a)-150
1823 y(de)n(vice)i(dri)n(v)o(er)f(and)g Fu(mknod)h Fy(a)h(de)n(vice)f
(\002le,)j(or)d(we)h(can)f(create)g(a)h Fu(/proc)f Fy(\002le.)50
b(This)29 b(allo)n(ws)g(the)-150 1936 y(k)o(ernel)18
b(module)g(to)h(tell)h(us)f(an)o(ything)e(it)j(lik)o(es.)25
b(The)18 b(only)g(problem)g(is)i(that)f(there)f(is)i(no)f(w)o(ay)g(for)
f(us)h(to)-150 2050 y(talk)k(back.)31 b(The)22 b(\002rst)i(w)o(ay)e
(we')o(ll)h(send)g(input)f(to)g(k)o(ernel)g(modules)g(will)h(be)g(by)f
(writing)g(back)g(to)h(the)-150 2163 y Fu(/proc)d Fy(\002le.)-25
2277 y(Because)j(the)h(proc)f(\002lesystem)g(w)o(as)i(written)e(mainly)
g(to)h(allo)n(w)f(the)h(k)o(ernel)f(to)h(report)e(its)j(situa-)-150
2391 y(tion)d(to)g(processes,)g(there)g(are)g(no)g(special)g(pro)o
(visions)f(for)g(input.)30 b(The)22 b Fu(proc)p 2190
2391 25 4 v 29 w(dir)p 2369 2391 V 30 w(entry)g Fy(struct)-150
2504 y(doesn')o(t)j(include)h(a)h(pointer)f(to)h(an)g(input)f
(function,)h(the)f(w)o(ay)h(it)h(includes)e(a)h(pointer)f(to)h(an)g
(output)-150 2618 y(function.)c(Instead,)c(to)h(write)g(into)f(a)h
Fu(/proc)f Fy(\002le,)i(we)f(need)f(to)g(use)h(the)g(standard)f
(\002lesystem)h(mech-)-150 2731 y(anism.)-25 2845 y(In)27
b(Linux)g(there)g(is)h(a)h(standard)d(mechanism)h(for)g(\002le)h
(system)g(re)o(gistration.)46 b(Since)28 b(e)n(v)o(ery)e(\002le)-150
2958 y(system)20 b(has)g(to)f(ha)n(v)o(e)g(its)i(o)n(wn)e(functions)f
(to)i(handle)f(inode)f(and)h(\002le)i(operations)2225
2928 y Fk(1)2260 2958 y Fy(,)f(there)f(is)h(a)g(special)-150
3072 y(structure)k(to)g(hold)g(pointers)f(to)i(all)g(those)g
(functions,)e Fu(struct)49 b(inode)p 2078 3072 V 29 w(operations)p
Fy(,)24 b(which)-150 3186 y(includes)29 b(a)h(pointer)e(to)i
Fu(struct)49 b(file)p 1138 3186 V 29 w(operations)p Fy(.)j(In)30
b(/proc,)h(whene)n(v)o(er)c(we)j(re)o(gister)f(a)-150
3299 y(ne)n(w)18 b(\002le,)g(we')l(re)f(allo)n(wed)g(to)h(specify)f
(which)h Fu(struct)48 b(inode)p 1798 3299 V 29 w(operations)17
b Fy(will)h(be)g(used)f(for)-150 3413 y(access)23 b(to)g(it.)33
b(This)22 b(is)i(the)e(mechanism)g(we)h(use,)g(a)g Fu(struct)49
b(inode)p 1987 3413 V 28 w(operations)22 b Fy(which)g(in-)-150
3526 y(cludes)d(a)g(pointer)f(to)i(a)f Fu(struct)49 b(file)p
1088 3526 V 29 w(operations)18 b Fy(which)g(includes)h(pointers)f(to)h
(our)g Fu(mod-)-150 3640 y(ule)p 5 3640 V 29 w(input)h
Fy(and)g Fu(module)p 745 3640 V 29 w(output)f Fy(functions.)-25
3753 y(It')-5 b(s)18 b(important)e(to)i(note)g(that)g(the)g(standard)e
(roles)i(of)g(read)f(and)g(write)i(are)e(re)n(v)o(ersed)g(in)h(the)g(k)
o(ernel.)-150 3867 y(Read)j(functions)d(are)j(used)f(for)f(output,)g
(whereas)h(write)h(functions)e(are)h(used)g(for)g(input.)k(The)c
(reason)p -150 4040 1200 4 v -65 4094 a Fi(1)-30 4117
y Fh(The)d(dif)n(ference)k(between)e(the)g(tw)o(o)f(is)f(that)i(\002le)
f(operations)i(deal)f(with)f(the)g(\002le)h(itself,)f(and)g(inode)h
(operations)h(deal)f(with)-150 4207 y(w)o(ays)e(of)g(referencing)j(the)
e(\002le,)f(such)h(as)e(creating)k(links)e(to)f(it.)1308
4456 y Fy(32)p eop
%%Page: 33 37
33 36 bop 150 162 a Fy(for)15 b(that)h(is)h(that)e(read)g(and)h(write)f
(refer)g(to)h(the)g(user')-5 b(s)16 b(point)f(of)g(vie)n(w)h(\227)g(if)
g(a)g(process)g(reads)f(something)150 275 y(from)k(the)i(k)o(ernel,)e
(then)h(the)g(k)o(ernel)f(needs)h(to)h(output)e(it,)i(and)e(if)i(a)g
(process)f(writes)g(something)f(to)i(the)150 389 y(k)o(ernel,)e(then)h
(the)g(k)o(ernel)f(recei)n(v)o(es)h(it)h(as)g(input.)275
502 y(Another)h(interesting)h(point)h(here)f(is)i(the)f
Fu(module)p 1820 502 25 4 v 29 w(permission)e Fy(function.)35
b(This)24 b(function)150 616 y(is)g(called)f(whene)n(v)o(er)e(a)j
(process)f(tries)h(to)f(do)g(something)f(with)h(the)g
Fu(/proc)g Fy(\002le,)i(and)d(it)i(can)f(decide)150 730
y(whether)15 b(to)h(allo)n(w)f(access)i(or)e(not.)23
b(Right)16 b(no)n(w)f(it)i(is)f(only)f(based)h(on)f(the)h(operation)e
(and)h(the)h(uid)f(of)h(the)150 843 y(current)h(used)i(\(as)g(a)n(v)n
(ailable)f(in)h Fu(current)p Fy(,)f(a)h(pointer)e(to)i(a)g(structure)f
(which)g(includes)g(information)150 957 y(on)k(the)g(currently)e
(running)g(process\),)h(b)n(ut)h(it)h(could)e(be)g(based)h(on)g(an)o
(ything)d(we)k(lik)o(e,)f(such)g(as)h(what)150 1070 y(other)c
(processes)g(are)h(doing)e(with)i(the)f(same)h(\002le,)g(the)g(time)g
(of)f(day)-5 b(,)19 b(or)g(the)g(last)i(input)e(we)h(recei)n(v)o(ed.)
275 1297 y(The)27 b(reason)g(for)g Fu(put)p 957 1297
V 29 w(user)h Fy(and)f Fu(get)p 1512 1297 V 29 w(user)g
Fy(is)i(that)f(Linux)e(memory)g(\(under)g(Intel)h(archi-)150
1411 y(tecture,)h(it)f(may)f(be)h(dif)n(ferent)e(under)h(some)g(other)g
(processors\))f(is)j(se)o(gmented.)43 b(This)27 b(means)f(that)150
1525 y(a)h(pointer)m(,)f(by)f(itself,)k(does)c(not)h(reference)f(a)i
(unique)d(location)i(in)g(memory)-5 b(,)25 b(only)h(a)g(location)g(in)g
(a)150 1638 y(memory)21 b(se)o(gment,)h(and)h(you)f(need)g(to)h(kno)n
(w)f(which)g(memory)f(se)o(gment)h(it)i(is)f(to)g(be)g(able)g(to)g(use)
g(it.)150 1752 y(There)c(is)i(one)f(memory)f(se)o(gment)g(for)g(the)i
(k)o(ernel,)e(and)g(one)h(of)g(each)g(of)g(the)g(processes.)275
1865 y(The)j(only)f(memory)g(se)o(gment)g(accessible)i(to)g(a)f
(process)g(is)i(its)f(o)n(wn,)g(so)f(when)g(writing)g(re)o(gular)150
1979 y(programs)d(to)h(run)g(as)h(processes,)f(there')-5
b(s)21 b(no)g(need)g(to)g(w)o(orry)g(about)f(se)o(gments.)28
b(When)21 b(you)g(write)g(a)150 2092 y(k)o(ernel)e(module,)f(normally)f
(you)i(w)o(ant)g(to)h(access)g(the)f(k)o(ernel)g(memory)f(se)o(gment,)g
(which)h(is)h(handled)150 2206 y(automatically)i(by)i(the)g(system.)36
b(Ho)n(we)n(v)o(er)m(,)23 b(when)g(the)h(content)f(of)h(a)g(memory)e(b)
n(uf)n(fer)h(needs)h(to)g(be)150 2320 y(passed)g(between)e(the)i
(currently)e(running)f(process)j(and)f(the)g(k)o(ernel,)h(the)g(k)o
(ernel)e(function)g(recei)n(v)o(es)150 2433 y(a)33 b(pointer)e(to)h
(the)g(memory)f(b)n(uf)n(fer)g(which)h(is)h(in)f(the)h(process)f(se)o
(gment.)60 b(The)32 b Fu(put)p 2774 2433 V 29 w(user)g
Fy(and)150 2547 y Fu(get)p 305 2547 V 29 w(user)20 b
Fy(macros)g(allo)n(w)g(you)f(to)i(access)f(that)h(memory)-5
b(.)275 2735 y Fl(pr)n(ocfs.c)150 2958 y Fu(/*)49 b(procfs.c)g(-)99
b(create)49 b(a)h("file")e(in)i(/proc,)e(which)h(allows)200
3071 y(*)g(both)h(input)e(and)i(output.)e(*/)150 3299
y(/*)h(Copyright)g(\(C\))g(1998-1999)f(by)h(Ori)h(Pomerantz)e(*/)150
3639 y(/*)h(The)h(necessary)e(header)h(files)f(*/)150
3866 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)150
3980 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)150 4094 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)p eop
%%Page: 34 38
34 37 bop -150 162 a Fu(/*)49 b(Deal)h(with)f(CONFIG_MODVERSIONS)d(*/)
-150 275 y(#if)j(CONFIG_MODVERSIONS==1)-150 389 y(#define)g
(MODVERSIONS)-150 502 y(#include)f(<linux/modversions.h>)-150
616 y(#endif)-150 843 y(/*)h(Necessary)g(because)f(we)i(use)f(proc)g
(fs)g(*/)-150 957 y(#include)f(<linux/proc_fs.h>)-150
1297 y(/*)h(In)h(2.2.3)f(/usr/include/linux/version.h)44
b(includes)49 b(a)-100 1411 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e
(doesn't)h(-)h(so)f(I)h(add)f(it)-100 1525 y(*)g(here)h(if)f
(necessary.)f(*/)-150 1638 y(#ifndef)h(KERNEL_VERSION)-150
1752 y(#define)g(KERNEL_VERSION\(a,b,c\))c
(\(\(a\)*65536+\(b\)*256+\(c\)\))-150 1865 y(#endif)-150
2320 y(#if)k(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))-150
2433 y(#include)f(<asm/uaccess.h>)97 b(/*)50 b(for)f(get_user)f(and)h
(put_user)g(*/)-150 2547 y(#endif)-150 2774 y(/*)g(The)h(module's)e
(file)h(functions)f(**********************)e(*/)-150
3115 y(/*)j(Here)h(we)f(keep)g(the)g(last)g(message)g(received,)f(to)h
(prove)-100 3228 y(*)g(that)h(we)f(can)g(process)g(our)g(input)g(*/)
-150 3342 y(#define)g(MESSAGE_LENGTH)e(80)-150 3455 y(static)i(char)g
(Message[MESSAGE_LENGTH];)-150 3796 y(/*)g(Since)g(we)h(use)f(the)g
(file)g(operations)f(struct,)h(we)g(can't)-100 3910 y(*)g(use)h(the)f
(special)f(proc)i(output)e(provisions)g(-)i(we)f(have)g(to)-100
4023 y(*)g(use)h(a)f(standard)g(read)g(function,)f(which)h(is)g(this)g
(function)g(*/)-150 4137 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))p eop
%%Page: 35 39
35 38 bop 150 162 a Fu(static)49 b(ssize_t)f(module_output\()349
275 y(struct)h(file)g(*file,)148 b(/*)50 b(The)f(file)g(read)g(*/)349
389 y(char)g(*buf,)g(/*)h(The)f(buffer)g(to)g(put)g(data)g(to)h(\(in)f
(the)947 502 y(*)h(user)f(segment\))f(*/)349 616 y(size_t)h(len,)99
b(/*)49 b(The)h(length)e(of)i(the)f(buffer)g(*/)349 730
y(loff_t)g(*offset\))f(/*)i(Offset)e(in)i(the)f(file)g(-)h(ignore)e(*/)
150 843 y(#else)150 957 y(static)h(int)g(module_output\()349
1070 y(struct)g(inode)g(*inode,)f(/*)i(The)f(inode)g(read)g(*/)349
1184 y(struct)g(file)g(*file,)148 b(/*)50 b(The)f(file)g(read)g(*/)349
1297 y(char)g(*buf,)g(/*)h(The)f(buffer)g(to)g(put)g(data)g(to)h(\(in)f
(the)947 1411 y(*)h(user)f(segment\))f(*/)349 1525 y(int)i(len\))98
b(/*)50 b(The)f(length)g(of)g(the)g(buffer)g(*/)150 1638
y(#endif)150 1752 y({)250 1865 y(static)f(int)i(finished)e(=)i(0;)250
1979 y(int)f(i;)250 2092 y(char)g(message[MESSAGE_LENGTH+30];)250
2320 y(/*)g(We)h(return)e(0)i(to)f(indicate)g(end)g(of)g(file,)g(that)g
(we)h(have)299 2433 y(*)g(no)g(more)f(information.)e(Otherwise,)h
(processes)g(will)299 2547 y(*)i(continue)e(to)i(read)f(from)g(us)g(in)
h(an)f(endless)g(loop.)g(*/)250 2660 y(if)g(\(finished\))f({)349
2774 y(finished)h(=)g(0;)349 2887 y(return)g(0;)250 3001
y(})250 3228 y(/*)g(We)h(use)f(put_user)f(to)i(copy)f(the)g(string)g
(from)g(the)g(kernel's)299 3342 y(*)h(memory)f(segment)f(to)i(the)f
(memory)g(segment)f(of)i(the)f(process)299 3455 y(*)h(that)f(called)g
(us.)g(get_user,)f(BTW,)h(is)299 3569 y(*)h(used)f(for)g(the)h
(reverse.)e(*/)250 3682 y(sprintf\(message,)e("Last)j(input:\045s",)f
(Message\);)250 3796 y(for\(i=0;)g(i<len)h(&&)g(message[i];)f(i++\))349
3910 y(put_user\(message[i],)e(buf+i\);)p eop
%%Page: 36 40
36 39 bop -50 162 a Fu(/*)49 b(Notice,)g(we)g(assume)g(here)g(that)g
(the)g(size)g(of)h(the)f(message)-1 275 y(*)h(is)g(below)e(len,)h(or)h
(it)f(will)g(be)h(received)e(cut.)h(In)h(a)f(real)-1
389 y(*)h(life)f(situation,)f(if)i(the)f(size)g(of)g(the)h(message)e
(is)h(less)-1 502 y(*)h(than)f(len)g(then)g(we'd)h(return)e(len)h(and)h
(on)f(the)g(second)g(call)-1 616 y(*)h(start)f(filling)f(the)i(buffer)e
(with)h(the)h(len+1'th)e(byte)h(of)-1 730 y(*)h(the)f(message.)g(*/)-50
843 y(finished)f(=)i(1;)-50 1070 y(return)e(i;)100 b(/*)49
b(Return)g(the)g(number)g(of)g(bytes)g("read")g(*/)-150
1184 y(})-150 1525 y(/*)g(This)h(function)e(receives)g(input)h(from)g
(the)g(user)g(when)g(the)-100 1638 y(*)g(user)h(writes)e(to)i(the)f
(/proc)g(file.)g(*/)-150 1752 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))-150 1865 y(static)g(ssize_t)f(module_input\()
49 1979 y(struct)h(file)g(*file,)148 b(/*)50 b(The)f(file)g(itself)g
(*/)49 2092 y(const)g(char)g(*buf,)248 b(/*)50 b(The)f(buffer)g(with)g
(input)g(*/)49 2206 y(size_t)g(length,)347 b(/*)50 b(The)f(buffer's)f
(length)h(*/)49 2320 y(loff_t)g(*offset\))297 b(/*)50
b(offset)e(to)i(file)f(-)h(ignore)e(*/)-150 2433 y(#else)-150
2547 y(static)h(int)g(module_input\()49 2660 y(struct)g(inode)g
(*inode,)f(/*)i(The)f(file's)g(inode)g(*/)49 2774 y(struct)g(file)g
(*file,)148 b(/*)50 b(The)f(file)g(itself)g(*/)49 2887
y(const)g(char)g(*buf,)248 b(/*)50 b(The)f(buffer)g(with)g(the)g(input)
g(*/)49 3001 y(int)h(length\))496 b(/*)50 b(The)f(buffer's)f(length)h
(*/)-150 3115 y(#endif)-150 3228 y({)-50 3342 y(int)g(i;)-50
3569 y(/*)g(Put)g(the)h(input)e(into)i(Message,)e(where)h
(module_output)-1 3682 y(*)h(will)f(later)g(be)g(able)h(to)f(use)g(it)h
(*/)-50 3796 y(for\(i=0;)e(i<MESSAGE_LENGTH-1)e(&&)k(i<length;)e(i++\))
-150 3910 y(#if)h(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))49
4023 y(get_user\(Message[i],)d(buf+i\);)-50 4137 y(/*)j(In)h(version)e
(2.2)h(the)h(semantics)e(of)h(get_user)f(changed,)p eop
%%Page: 37 41
37 40 bop 299 162 a Fu(*)50 b(it)g(not)f(longer)f(returns)h(a)h
(character,)e(but)h(expects)f(a)299 275 y(*)i(variable)e(to)i(fill)f
(up)g(as)h(its)f(first)g(argument)f(and)h(a)299 389 y(*)h(user)f
(segment)g(pointer)f(to)i(fill)f(it)g(from)g(as)h(the)f(its)299
502 y(*)h(second.)299 616 y(*)299 730 y(*)g(The)f(reason)g(for)g(this)g
(change)g(is)g(that)h(the)f(version)f(2.2)299 843 y(*)i(get_user)e(can)
i(also)f(read)g(an)g(short)g(or)h(an)f(int.)g(The)g(way)299
957 y(*)h(it)g(knows)e(the)i(type)f(of)g(the)g(variable)g(it)g(should)g
(read)299 1070 y(*)h(is)g(by)f(using)g(sizeof,)f(and)i(for)f(that)g(it)
g(needs)g(the)299 1184 y(*)h(variable)e(itself.)299 1297
y(*/)150 1411 y(#else)349 1525 y(Message[i])g(=)i(get_user\(buf+i\);)
150 1638 y(#endif)250 1752 y(Message[i])e(=)h('\\0';)99
b(/*)49 b(we)h(want)f(a)g(standard,)g(zero)1296 1865
y(*)g(terminated)f(string)h(*/)250 2092 y(/*)g(We)h(need)f(to)g(return)
g(the)g(number)g(of)g(input)g(characters)299 2206 y(*)h(used)f(*/)250
2320 y(return)f(i;)150 2433 y(})150 2887 y(/*)h(This)h(function)e
(decides)g(whether)h(to)g(allow)g(an)h(operation)200
3001 y(*)f(\(return)g(zero\))g(or)g(not)h(allow)e(it)i(\(return)e(a)i
(non-zero)200 3115 y(*)f(which)g(indicates)f(why)i(it)f(is)h(not)f
(allowed\).)200 3228 y(*)200 3342 y(*)g(The)h(operation)e(can)h(be)h
(one)f(of)g(the)g(following)g(values:)200 3455 y(*)g(0)h(-)g(Execute)e
(\(run)h(the)h("file")e(-)i(meaningless)e(in)h(our)g(case\))200
3569 y(*)g(2)h(-)g(Write)f(\(input)f(to)i(the)f(kernel)g(module\))200
3682 y(*)g(4)h(-)g(Read)f(\(output)f(from)h(the)h(kernel)e(module\))200
3796 y(*)200 3910 y(*)h(This)h(is)f(the)g(real)g(function)g(that)g
(checks)f(file)200 4023 y(*)h(permissions.)f(The)h(permissions)f
(returned)g(by)i(ls)f(-l)h(are)200 4137 y(*)f(for)h(referece)e(only,)h
(and)g(can)g(be)h(overridden)e(here.)p eop
%%Page: 38 42
38 41 bop -100 162 a Fu(*/)-150 275 y(static)49 b(int)g
(module_permission\(struct)c(inode)k(*inode,)g(int)g(op\))-150
389 y({)-50 502 y(/*)g(We)h(allow)e(everybody)h(to)g(read)g(from)g(our)
g(module,)g(but)-1 616 y(*)h(only)f(root)g(\(uid)g(0\))h(may)f(write)g
(to)g(it)h(*/)-50 730 y(if)f(\(op)g(==)h(4)f(||)h(\(op)f(==)h(2)f(&&)h
(current->euid)d(==)i(0\)\))49 843 y(return)g(0;)-50
1070 y(/*)g(If)h(it's)f(anything)f(else,)h(access)f(is)i(denied)f(*/)
-50 1184 y(return)f(-EACCES;)-150 1297 y(})-150 1865
y(/*)h(The)h(file)f(is)g(opened)g(-)h(we)f(don't)g(really)g(care)g
(about)-100 1979 y(*)g(that,)g(but)h(it)f(does)g(mean)g(we)h(need)f(to)
g(increment)f(the)-100 2092 y(*)h(module's)g(reference)f(count.)h(*/)
-150 2206 y(int)g(module_open\(struct)e(inode)i(*inode,)f(struct)h
(file)g(*file\))-150 2320 y({)-50 2433 y(MOD_INC_USE_COUNT;)-50
2660 y(return)f(0;)-150 2774 y(})-150 3115 y(/*)h(The)h(file)f(is)g
(closed)g(-)h(again,)e(interesting)g(only)h(because)-100
3228 y(*)g(of)h(the)f(reference)f(count.)h(*/)-150 3342
y(#if)g(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))-150
3455 y(int)g(module_close\(struct)e(inode)h(*inode,)h(struct)g(file)g
(*file\))-150 3569 y(#else)-150 3682 y(void)g(module_close\(struct)d
(inode)j(*inode,)g(struct)f(file)h(*file\))-150 3796
y(#endif)-150 3910 y({)-50 4023 y(MOD_DEC_USE_COUNT;)p
eop
%%Page: 39 43
39 42 bop 150 162 a Fu(#if)49 b(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))250 275 y(return)f(0;)100 b(/*)49
b(success)g(*/)150 389 y(#endif)150 502 y(})150 843 y(/*)g(Structures)f
(to)i(register)e(as)i(the)f(/proc)g(file,)g(with)200
957 y(*)g(pointers)g(to)g(all)g(the)h(relevant)e(functions.)g
(**********)g(*/)150 1411 y(/*)h(File)h(operations)d(for)j(our)f(proc)g
(file.)g(This)g(is)g(where)g(we)200 1525 y(*)g(place)g(pointers)g(to)g
(all)g(the)h(functions)e(called)g(when)200 1638 y(*)h(somebody)g(tries)
g(to)g(do)h(something)e(to)h(our)g(file.)g(NULL)200 1752
y(*)g(means)g(we)h(don't)f(want)g(to)g(deal)g(with)g(something.)f(*/)
150 1865 y(static)h(struct)f(file_operations)f
(File_Ops_4_Our_Proc_File)f(=)250 1979 y({)349 2092 y(NULL,)99
b(/*)49 b(lseek)g(*/)349 2206 y(module_output,)97 b(/*)50
b("read")e(from)h(the)h(file)f(*/)349 2320 y(module_input,)147
b(/*)50 b("write")e(to)i(the)f(file)g(*/)349 2433 y(NULL,)99
b(/*)49 b(readdir)g(*/)349 2547 y(NULL,)99 b(/*)49 b(select)g(*/)349
2660 y(NULL,)99 b(/*)49 b(ioctl)g(*/)349 2774 y(NULL,)99
b(/*)49 b(mmap)g(*/)349 2887 y(module_open,)197 b(/*)50
b(Somebody)e(opened)h(the)g(file)g(*/)150 3001 y(#if)g
(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))349
3115 y(NULL,)149 b(/*)49 b(flush,)g(added)g(here)g(in)g(version)g(2.2)g
(*/)150 3228 y(#endif)349 3342 y(module_close,)197 b(/*)50
b(Somebody)e(closed)h(the)g(file)g(*/)349 3455 y(/*)h(etc.)f(etc.)g
(etc.)g(\(they)g(are)g(all)g(given)g(in)399 3569 y(*)h
(/usr/include/linux/fs.h\).)45 b(Since)k(we)g(don't)g(put)399
3682 y(*)h(anything)e(here,)h(the)g(system)g(will)g(keep)g(the)g
(default)399 3796 y(*)h(data,)f(which)f(in)i(Unix)f(is)g(zeros)g
(\(NULLs)g(when)g(taken)g(as)399 3910 y(*)h(pointers\).)e(*/)250
4023 y(};)p eop
%%Page: 40 44
40 43 bop -150 389 a Fu(/*)49 b(Inode)g(operations)f(for)i(our)f(proc)g
(file.)g(We)g(need)g(it)h(so)-100 502 y(*)f(we'll)g(have)g(some)g
(place)g(to)h(specify)e(the)i(file)f(operations)-100
616 y(*)g(structure)g(we)g(want)g(to)h(use,)f(and)g(the)g(function)f
(we)i(use)f(for)-100 730 y(*)g(permissions.)f(It's)h(also)g(possible)f
(to)i(specify)e(functions)-100 843 y(*)h(to)h(be)f(called)g(for)g
(anything)g(else)g(which)g(could)f(be)i(done)f(to)-100
957 y(*)g(an)h(inode)f(\(although)f(we)h(don't)g(bother,)g(we)g(just)g
(put)-100 1070 y(*)g(NULL\).)g(*/)-150 1184 y(static)g(struct)f
(inode_operations)f(Inode_Ops_4_Our_Proc_File)e(=)-50
1297 y({)49 1411 y(&File_Ops_4_Our_Proc_File,)49 1525
y(NULL,)k(/*)h(create)e(*/)49 1638 y(NULL,)h(/*)h(lookup)e(*/)49
1752 y(NULL,)h(/*)h(link)f(*/)49 1865 y(NULL,)g(/*)h(unlink)e(*/)49
1979 y(NULL,)h(/*)h(symlink)e(*/)49 2092 y(NULL,)h(/*)h(mkdir)e(*/)49
2206 y(NULL,)h(/*)h(rmdir)e(*/)49 2320 y(NULL,)h(/*)h(mknod)e(*/)49
2433 y(NULL,)h(/*)h(rename)e(*/)49 2547 y(NULL,)h(/*)h(readlink)e(*/)49
2660 y(NULL,)h(/*)h(follow_link)d(*/)49 2774 y(NULL,)i(/*)h(readpage)e
(*/)49 2887 y(NULL,)h(/*)h(writepage)e(*/)49 3001 y(NULL,)h(/*)h(bmap)f
(*/)49 3115 y(NULL,)g(/*)h(truncate)e(*/)49 3228 y(module_permission)f
(/*)i(check)g(for)g(permissions)f(*/)-50 3342 y(};)-150
3682 y(/*)h(Directory)g(entry)f(*/)-150 3796 y(static)h(struct)f
(proc_dir_entry)g(Our_Proc_File)f(=)-50 3910 y({)49 4023
y(0,)j(/*)f(Inode)g(number)g(-)g(ignore,)g(it)g(will)g(be)h(filled)e
(by)249 4137 y(*)h(proc_register[_dynamic])d(*/)p eop
%%Page: 41 45
41 44 bop 349 162 a Fu(7,)50 b(/*)f(Length)g(of)g(the)h(file)f(name)g
(*/)349 275 y("rw_test",)f(/*)i(The)f(file)g(name)g(*/)349
389 y(S_IFREG)g(|)g(S_IRUGO)g(|)h(S_IWUSR,)349 502 y(/*)g(File)f(mode)g
(-)g(this)h(is)f(a)h(regular)e(file)h(which)399 616 y(*)h(can)f(be)g
(read)g(by)h(its)f(owner,)g(its)g(group,)g(and)g(everybody)399
730 y(*)h(else.)f(Also,)f(its)i(owner)f(can)g(write)g(to)g(it.)399
843 y(*)399 957 y(*)h(Actually,)e(this)h(field)g(is)g(just)g(for)h
(reference,)d(it's)399 1070 y(*)j(module_permission)c(that)j(does)g
(the)h(actual)e(check.)h(It)399 1184 y(*)h(could)f(use)g(this)g(field,)
g(but)g(in)g(our)h(implementation)d(it)399 1297 y(*)j(doesn't,)e(for)h
(simplicity.)f(*/)349 1411 y(1,)100 b(/*)49 b(Number)g(of)g(links)g
(\(directories)f(where)g(the)598 1525 y(*)i(file)f(is)g(referenced\))f
(*/)349 1638 y(0,)i(0,)99 b(/*)49 b(The)h(uid)f(and)g(gid)g(for)h(the)f
(file)g(-)748 1752 y(*)g(we)h(give)f(it)g(to)h(root)f(*/)349
1865 y(80,)h(/*)f(The)g(size)g(of)h(the)f(file)g(reported)f(by)i(ls.)f
(*/)349 1979 y(&Inode_Ops_4_Our_Proc_File,)349 2092 y(/*)h(A)f(pointer)
g(to)g(the)h(inode)e(structure)h(for)399 2206 y(*)h(the)f(file,)g(if)g
(we)h(need)f(it.)g(In)g(our)h(case)f(we)399 2320 y(*)h(do,)f(because)f
(we)i(need)f(a)h(write)e(function.)h(*/)349 2433 y(NULL)349
2547 y(/*)h(The)f(read)g(function)f(for)i(the)f(file.)g(Irrelevant,)399
2660 y(*)h(because)e(we)i(put)f(it)g(in)h(the)f(inode)g(structure)f
(above)h(*/)250 2774 y(};)150 3228 y(/*)g(Module)g(initialization)e
(and)j(cleanup)e(*******************)e(*/)150 3455 y(/*)j(Initialize)f
(the)i(module)e(-)i(register)e(the)i(proc)f(file)g(*/)150
3569 y(int)g(init_module\(\))150 3682 y({)250 3796 y(/*)g(Success)g(if)
g(proc_register[_dynamic])d(is)j(a)h(success,)299 3910
y(*)g(failure)f(otherwise)f(*/)150 4023 y(#if)h(LINUX_VERSION_CODE)e
(>=)i(KERNEL_VERSION\(2,2,0\))250 4137 y(/*)g(In)h(version)e(2.2,)h
(proc_register)e(assign)i(a)h(dynamic)p eop
%%Page: 42 46
42 45 bop -1 162 a Fu(*)50 b(inode)f(number)g(automatically)e(if)i(it)h
(is)f(zero)g(in)h(the)-1 275 y(*)g(structure)e(,)i(so)f(there's)g(no)g
(more)g(need)g(for)-1 389 y(*)h(proc_register_dynamic)-1
502 y(*/)-50 616 y(return)e(proc_register\(&proc_root,)d
(&Our_Proc_File\);)-150 730 y(#else)-50 843 y(return)j
(proc_register_dynamic\(&proc_root,)c(&Our_Proc_File\);)-150
957 y(#endif)-150 1070 y(})-150 1411 y(/*)49 b(Cleanup)g(-)h
(unregister)e(our)h(file)g(from)g(/proc)g(*/)-150 1525
y(void)g(cleanup_module\(\))-150 1638 y({)-50 1752 y
(proc_unregister\(&proc_root,)44 b(Our_Proc_File.low_ino\);)-150
1865 y(})p eop
%%Page: 43 47
43 46 bop 150 813 a Fn(Chapter)44 b(5)150 1263 y Fp(T)-19
b(alking)53 b(to)e(De)m(vice)h(Files)g(\(writes)150 1547
y(and)g(IOCTLs\))275 1993 y Fy(De)n(vice)18 b(\002les)h(are)f(supposed)
f(to)i(represent)e(physical)g(de)n(vices.)24 b(Most)18
b(physical)g(de)n(vices)g(are)g(used)150 2107 y(for)26
b(output)g(as)h(well)h(as)f(input,)h(so)f(there)f(has)h(to)g(be)g(some)
f(mechanism)g(for)g(de)n(vice)g(dri)n(v)o(ers)g(in)h(the)150
2220 y(k)o(ernel)22 b(to)g(get)h(the)f(output)f(to)i(send)f(to)g(the)h
(de)n(vice)e(from)h(processes.)31 b(This)22 b(is)i(done)d(by)h(opening)
f(the)150 2334 y(de)n(vice)f(\002le)i(for)e(output)g(and)h(writing)f
(to)i(it,)f(just)h(lik)o(e)f(writing)g(to)g(a)h(\002le.)28
b(In)21 b(the)g(follo)n(wing)e(e)o(xample,)150 2447 y(this)i(is)g
(implemented)d(by)i Fu(device)p 1230 2447 25 4 v 29 w(write)p
Fy(.)275 2561 y(This)h(is)h(not)g(al)o(w)o(ays)f(enough.)27
b(Imagine)20 b(you)h(had)g(a)g(serial)h(port)f(connected)e(to)j(a)g
(modem)e(\(e)n(v)o(en)150 2674 y(if)30 b(you)e(ha)n(v)o(e)g(an)i
(internal)e(modem,)i(it)g(is)g(still)g(implemented)e(from)g(the)h(CPU')
-5 b(s)31 b(perspecti)n(v)o(e)c(as)j(a)150 2788 y(serial)19
b(port)e(connected)f(to)j(a)f(modem,)f(so)i(you)e(don')o(t)g(ha)n(v)o
(e)g(to)i(tax)f(your)f(imagination)f(too)i(hard\).)23
b(The)150 2902 y(natural)c(thing)g(to)h(do)f(w)o(ould)g(be)h(to)f(use)h
(the)g(de)n(vice)f(\002le)h(to)g(write)g(things)f(to)h(the)g(modem)e
(\(either)h(mo-)150 3015 y(dem)g(commands)f(or)h(data)g(to)h(be)f(sent)
h(through)d(the)j(phone)e(line\))h(and)g(read)g(things)g(from)f(the)i
(modem)150 3129 y(\(either)d(responses)g(for)g(commands)f(or)i(the)g
(data)f(recei)n(v)o(ed)f(through)g(the)i(phone)e(line\).)24
b(Ho)n(we)n(v)o(er)m(,)16 b(this)150 3242 y(lea)n(v)o(es)25
b(open)f(the)h(question)f(of)g(what)h(to)g(do)g(when)f(you)g(need)g(to)
h(talk)g(to)g(the)g(serial)h(port)e(itself,)i(for)150
3356 y(e)o(xample)19 b(to)h(send)g(the)g(rate)g(at)h(which)f(data)g(is)
h(sent)g(and)e(recei)n(v)o(ed.)275 3469 y(The)24 b(answer)h(in)g(Unix)g
(is)h(to)f(use)h(a)f(special)h(function)d(called)i Fu(ioctl)g
Fy(\(short)f(for)g Fo(i)p Fy(nput)h Fo(o)p Fy(utput)150
3583 y Fo(c)p Fy(on)p Fo(t)p Fy(ro)p Fo(l)p Fy(\).)35
b(Ev)o(ery)23 b(de)n(vice)h(can)g(ha)n(v)o(e)g(its)h(o)n(wn)f
Fu(ioctl)g Fy(commands,)f(which)h(can)g(be)h(read)f Fu(ioctl)p
Fy(')-5 b(s)150 3697 y(\(to)25 b(send)g(information)e(from)h(a)i
(process)f(to)g(the)h(k)o(ernel\),)f(write)g Fu(ioctl)p
Fy(')-5 b(s)26 b(\(to)f(return)f(information)150 3810
y(to)f(a)f(process\),)618 3780 y Fk(1)679 3810 y Fy(both)g(or)g
(neither)-5 b(.)31 b(The)22 b(ioctl)g(function)f(is)i(called)g(with)f
(three)g(parameters:)28 b(the)23 b(\002le)150 3924 y(descriptor)17
b(of)g(the)i(appropriate)c(de)n(vice)j(\002le,)h(the)f(ioctl)g(number)m
(,)e(and)i(a)g(parameter)m(,)f(which)g(is)i(of)f(type)p
150 4040 1200 4 v 235 4094 a Fi(1)270 4117 y Fh(Notice)h(that)h(here)f
(the)g(roles)f(of)h(read)g(and)f(write)h(are)g(re)n(v)o(ersed)h
Fe(a)o(gain)p Fh(,)g(so)d(in)i Fd(ioctl)p Fh(')l(s)e(read)i(is)f(to)g
(send)h(information)h(to)150 4207 y(the)e(k)o(ernel)h(and)e(write)h(is)
f(to)g(recei)n(v)o(e)j(information)f(from)e(the)h(k)o(ernel.)1608
4456 y Fy(43)p eop
%%Page: 44 48
44 47 bop -150 162 a Fy(long)19 b(so)i(you)e(can)h(use)h(a)f(cast)h(to)
f(use)h(it)g(to)f(pass)h(an)o(ything.)1602 132 y Fk(2)-25
275 y Fy(The)c(ioctl)i(number)d(encodes)h(the)i(major)e(de)n(vice)h
(number)m(,)e(the)i(type)g(of)g(the)g(ioctl,)h(the)f(command,)-150
389 y(and)24 b(the)g(type)f(of)h(the)g(parameter)-5 b(.)36
b(This)24 b(ioctl)h(number)d(is)j(usually)f(created)f(by)h(a)g(macro)g
(call)g(\()p 2705 389 25 4 v 30 w Fu(IO)p Fy(,)p -150
502 V -125 502 a Fu(IOR)p Fy(,)p 74 502 V 53 w Fu(IOW)g
Fy(or)p 371 502 V 53 w Fu(IOWR)f Fy(\227)h(depending)d(on)i(the)h
(type\))f(in)g(a)h(header)f(\002le.)35 b(This)24 b(header)e(\002le)j
(should)-150 616 y(then)e(be)h Fu(#include)p Fy(')l(d)d(both)i(by)g
(the)h(programs)e(which)h(will)h(use)g Fu(ioctl)f Fy(\(so)h(the)o(y)e
(can)i(generate)-150 730 y(the)16 b(appropriate)e Fu(ioctl)p
Fy(')-5 b(s\))15 b(and)h(by)f(the)h(k)o(ernel)f(module)g(\(so)h(it)h
(can)f(understand)d(it\).)24 b(In)16 b(the)g(e)o(xample)-150
843 y(belo)n(w)-5 b(,)19 b(the)h(header)f(\002le)i(is)g
Fu(chardev.h)e Fy(and)h(the)g(program)e(which)i(uses)g(it)h(is)h
Fu(ioctl.c)p Fy(.)-25 957 y(If)d(you)f(w)o(ant)i(to)g(use)g
Fu(ioctl)p Fy(')-5 b(s)19 b(in)h(your)e(o)n(wn)h(k)o(ernel)g(modules,)f
(it)i(is)h(best)e(to)h(recei)n(v)o(e)e(an)i(of)n(\002cial)-150
1070 y Fu(ioctl)29 b Fy(assignment,)h(so)g(if)f(you)f(accidentally)g
(get)h(somebody)e(else')-5 b(s)31 b Fu(ioctl)p Fy(')-5
b(s,)31 b(or)e(if)g(the)o(y)g(get)-150 1184 y(yours,)c(you')o(ll)e(kno)
n(w)h(something)f(is)j(wrong.)37 b(F)o(or)24 b(more)g(information,)f
(consult)h(the)g(k)o(ernel)g(source)-150 1297 y(tree)c(at)h(`)p
Fu(Documentation/ioctl-number.txt)p Fy('.)-25 1486 y
Fl(charde)o(v)-7 b(.c)-150 1695 y Fu(/*)49 b(chardev.c)-100
1809 y(*)-100 1923 y(*)g(Create)g(an)h(input/output)d(character)h
(device)-100 2036 y(*/)-150 2377 y(/*)h(Copyright)g(\(C\))g(1998-99)f
(by)i(Ori)f(Pomerantz)f(*/)-150 2831 y(/*)h(The)h(necessary)e(header)h
(files)f(*/)-150 3058 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)-150
3172 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)-150 3285 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)-150 3513 y(/*)g(Deal)h(with)
f(CONFIG_MODVERSIONS)d(*/)-150 3626 y(#if)j(CONFIG_MODVERSIONS==1)-150
3740 y(#define)g(MODVERSIONS)-150 3853 y(#include)f
(<linux/modversions.h>)-150 3967 y(#endif)p -150 4040
1200 4 v -65 4094 a Fi(2)-30 4117 y Fh(This)17 b(isn')o(t)i(e)o(xact.)
26 b(Y)-7 b(ou)18 b(w)o(on')o(t)h(be)f(able)h(to)g(pass)f(a)g
(structure,)i(for)f(e)o(xample,)g(through)h(an)e(ioctl)i(\227)e(b)o(ut)
g(you)h(will)g(be)f(able)-150 4207 y(to)f(pass)g(a)g(pointer)i(to)e
(the)h(structure.)p eop
%%Page: 45 49
45 48 bop 150 275 a Fu(/*)49 b(For)h(character)e(devices)g(*/)150
502 y(/*)h(The)h(character)e(device)h(definitions)e(are)j(here)f(*/)150
616 y(#include)f(<linux/fs.h>)150 843 y(/*)h(A)h(wrapper)f(which)f
(does)i(next)f(to)g(nothing)g(at)200 957 y(*)g(at)h(present,)e(but)h
(may)h(help)f(for)g(compatibility)200 1070 y(*)g(with)h(future)e
(versions)h(of)g(Linux)g(*/)150 1184 y(#include)f(<linux/wrapper.h>)150
1525 y(/*)h(Our)h(own)f(ioctl)g(numbers)f(*/)150 1638
y(#include)g("chardev.h")150 1979 y(/*)h(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)49 b(a)200
2092 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e(doesn't)h(-)h(so)f(I)h
(add)f(it)200 2206 y(*)g(here)h(if)f(necessary.)f(*/)150
2320 y(#ifndef)h(KERNEL_VERSION)150 2433 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))150
2547 y(#endif)150 3001 y(#if)k(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))150 3115 y(#include)f(<asm/uaccess.h>)97
b(/*)50 b(for)f(get_user)f(and)h(put_user)g(*/)150 3228
y(#endif)150 3682 y(#define)g(SUCCESS)f(0)150 4023 y(/*)h(Device)g
(Declarations)f(********************************)c(*/)p
eop
%%Page: 46 50
46 49 bop -150 275 a Fu(/*)49 b(The)h(name)f(for)g(our)g(device,)g(as)g
(it)h(will)f(appear)f(in)-100 389 y(*)h(/proc/devices)f(*/)-150
502 y(#define)h(DEVICE_NAME)e("char_dev")-150 843 y(/*)i(The)h(maximum)
e(length)h(of)g(the)h(message)e(for)h(the)h(device)e(*/)-150
957 y(#define)h(BUF_LEN)f(80)-150 1184 y(/*)h(Is)h(the)f(device)g(open)
g(right)g(now?)g(Used)g(to)g(prevent)-100 1297 y(*)g(concurent)g
(access)f(into)h(the)h(same)f(device)f(*/)-150 1411 y(static)h(int)g
(Device_Open)f(=)h(0;)-150 1638 y(/*)g(The)h(message)e(the)h(device)g
(will)g(give)g(when)g(asked)g(*/)-150 1752 y(static)g(char)g
(Message[BUF_LEN];)-150 1979 y(/*)g(How)h(far)f(did)g(the)g(process)g
(reading)f(the)i(message)e(get?)-100 2092 y(*)h(Useful)g(if)h(the)f
(message)f(is)i(larger)e(than)i(the)f(size)g(of)g(the)-100
2206 y(*)g(buffer)g(we)h(get)f(to)g(fill)g(in)h(device_read.)d(*/)-150
2320 y(static)i(char)g(*Message_Ptr;)-150 2660 y(/*)g(This)h(function)e
(is)h(called)g(whenever)f(a)i(process)e(attempts)-100
2774 y(*)h(to)h(open)f(the)g(device)g(file)g(*/)-150
2887 y(static)g(int)g(device_open\(struct)d(inode)j(*inode,)996
3001 y(struct)f(file)h(*file\))-150 3115 y({)-150 3228
y(#ifdef)g(DEBUG)-50 3342 y(printk)f(\("device_open\(\045p\)\\n",)e
(file\);)-150 3455 y(#endif)-50 3682 y(/*)j(We)h(don't)e(want)h(to)h
(talk)f(to)g(two)h(processes)e(at)h(the)-1 3796 y(*)h(same)f(time)g(*/)
-50 3910 y(if)g(\(Device_Open\))49 4023 y(return)g(-EBUSY;)p
eop
%%Page: 47 51
47 50 bop 250 162 a Fu(/*)49 b(If)h(this)f(was)g(a)g(process,)g(we)g
(would)g(have)g(had)g(to)h(be)299 275 y(*)g(more)f(careful)g(here,)g
(because)f(one)h(process)g(might)g(have)299 389 y(*)h(checked)f
(Device_Open)e(right)i(before)g(the)g(other)g(one)299
502 y(*)h(tried)f(to)g(increment)g(it.)g(However,)f(we're)h(in)g(the)
299 616 y(*)h(kernel,)f(so)g(we're)g(protected)f(against)h(context)f
(switches.)299 730 y(*)299 843 y(*)i(This)f(is)h(NOT)f(the)g(right)g
(attitude)f(to)i(take,)f(because)f(we)299 957 y(*)i(might)f(be)g
(running)g(on)g(an)h(SMP)f(box,)g(but)g(we'll)g(deal)g(with)299
1070 y(*)h(SMP)f(in)h(a)f(later)g(chapter.)299 1184 y(*/)250
1411 y(Device_Open++;)250 1638 y(/*)g(Initialize)f(the)h(message)g(*/)
250 1752 y(Message_Ptr)e(=)j(Message;)250 1979 y(MOD_INC_USE_COUNT;)250
2206 y(return)e(SUCCESS;)150 2320 y(})150 2660 y(/*)h(This)h(function)e
(is)h(called)g(when)g(a)h(process)e(closes)h(the)200
2774 y(*)g(device)g(file.)g(It)g(doesn't)g(have)g(a)h(return)e(value)h
(because)200 2887 y(*)g(it)h(cannot)f(fail.)f(Regardless)g(of)i(what)f
(else)g(happens,)f(you)200 3001 y(*)h(should)g(always)g(be)g(able)g(to)
h(close)f(a)g(device)g(\(in)g(2.0,)g(a)h(2.2)200 3115
y(*)f(device)g(file)g(could)g(be)h(impossible)d(to)j(close\).)e(*/)150
3228 y(#if)h(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))150
3342 y(static)g(int)g(device_release\(struct)d(inode)j(*inode,)1445
3455 y(struct)g(file)g(*file\))150 3569 y(#else)150 3682
y(static)g(void)g(device_release\(struct)d(inode)j(*inode,)1495
3796 y(struct)g(file)g(*file\))150 3910 y(#endif)150
4023 y({)150 4137 y(#ifdef)g(DEBUG)p eop
%%Page: 48 52
48 51 bop -50 162 a Fu(printk)48 b
(\("device_release\(\045p,\045p\)\\n",)d(inode,)k(file\);)-150
275 y(#endif)-50 502 y(/*)g(We're)g(now)g(ready)g(for)g(our)h(next)f
(caller)f(*/)-50 616 y(Device_Open)f(--;)-50 843 y(MOD_DEC_USE_COUNT;)
-150 1070 y(#if)i(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))-50
1184 y(return)f(0;)-150 1297 y(#endif)-150 1411 y(})-150
1865 y(/*)h(This)h(function)e(is)h(called)g(whenever)f(a)i(process)e
(which)-100 1979 y(*)h(has)h(already)e(opened)h(the)g(device)g(file)g
(attempts)f(to)-100 2092 y(*)h(read)h(from)f(it.)g(*/)-150
2206 y(#if)g(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))-150
2320 y(static)g(ssize_t)f(device_read\()49 2433 y(struct)h(file)g
(*file,)49 2547 y(char)g(*buffer,)g(/*)g(The)g(buffer)g(to)g(fill)h
(with)f(the)g(data)g(*/)49 2660 y(size_t)g(length,)248
b(/*)49 b(The)g(length)g(of)h(the)f(buffer)f(*/)49 2774
y(loff_t)h(*offset\))f(/*)i(offset)e(to)i(the)f(file)g(*/)-150
2887 y(#else)-150 3001 y(static)g(int)g(device_read\()49
3115 y(struct)g(inode)g(*inode,)49 3228 y(struct)g(file)g(*file,)49
3342 y(char)g(*buffer,)148 b(/*)50 b(The)f(buffer)g(to)g(fill)g(with)g
(the)g(data)h(*/)49 3455 y(int)g(length\))247 b(/*)50
b(The)f(length)g(of)g(the)g(buffer)896 3569 y(*)h(\(mustn't)e(write)h
(beyond)g(that!\))f(*/)-150 3682 y(#endif)-150 3796 y({)-50
3910 y(/*)h(Number)g(of)g(bytes)g(actually)f(written)h(to)g(the)h
(buffer)e(*/)-50 4023 y(int)h(bytes_read)f(=)h(0;)p eop
%%Page: 49 53
49 52 bop 150 162 a Fu(#ifdef)49 b(DEBUG)250 275 y
(printk\("device_read\(\045p,\045p,\045d\)\\n",)349 389
y(file,)g(buffer,)g(length\);)150 502 y(#endif)250 730
y(/*)g(If)h(we're)e(at)i(the)f(end)g(of)h(the)f(message,)f(return)h(0)
299 843 y(*)h(\(which)f(signifies)f(end)h(of)h(file\))e(*/)250
957 y(if)h(\(*Message_Ptr)e(==)j(0\))349 1070 y(return)f(0;)250
1297 y(/*)g(Actually)f(put)i(the)f(data)g(into)g(the)g(buffer)g(*/)250
1411 y(while)g(\(length)f(&&)h(*Message_Ptr\))98 b({)349
1638 y(/*)50 b(Because)e(the)h(buffer)g(is)h(in)f(the)g(user)g(data)g
(segment,)399 1752 y(*)h(not)f(the)g(kernel)g(data)g(segment,)f
(assignment)g(wouldn't)399 1865 y(*)i(work.)f(Instead,)f(we)h(have)g
(to)h(use)f(put_user)f(which)399 1979 y(*)i(copies)e(data)h(from)h(the)
f(kernel)f(data)i(segment)e(to)h(the)399 2092 y(*)h(user)f(data)g
(segment.)f(*/)349 2206 y(put_user\(*\(Message_Ptr++\),)d(buffer++\);)
349 2320 y(length)k(--;)349 2433 y(bytes_read)f(++;)250
2547 y(})150 2774 y(#ifdef)h(DEBUG)299 2887 y(printk)g(\("Read)g(\045d)
g(bytes,)g(\045d)g(left\\n",)399 3001 y(bytes_read,)f(length\);)150
3115 y(#endif)299 3342 y(/*)i(Read)f(functions)f(are)h(supposed)g(to)g
(return)g(the)g(number)349 3455 y(*)h(of)f(bytes)g(actually)g(inserted)
f(into)h(the)g(buffer)g(*/)250 3569 y(return)f(bytes_read;)150
3682 y(})150 4023 y(/*)h(This)h(function)e(is)h(called)g(when)g
(somebody)f(tries)h(to)200 4137 y(*)g(write)g(into)g(our)h(device)e
(file.)h(*/)p eop
%%Page: 50 54
50 53 bop -150 162 a Fu(#if)49 b(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))-150 275 y(static)g(ssize_t)f
(device_write\(struct)e(file)k(*file,)1245 389 y(const)f(char)g
(*buffer,)1245 502 y(size_t)f(length,)1245 616 y(loff_t)g(*offset\))
-150 730 y(#else)-150 843 y(static)h(int)g(device_write\(struct)d
(inode)j(*inode,)1046 957 y(struct)f(file)h(*file,)1046
1070 y(const)f(char)h(*buffer,)1046 1184 y(int)g(length\))-150
1297 y(#endif)-150 1411 y({)-50 1525 y(int)g(i;)-150
1752 y(#ifdef)g(DEBUG)-50 1865 y(printk)f
(\("device_write\(\045p,\045s,\045d\)",)49 1979 y(file,)h(buffer,)g
(length\);)-150 2092 y(#endif)-50 2320 y(for\(i=0;)f(i<length)g(&&)i
(i<BUF_LEN;)e(i++\))-150 2433 y(#if)h(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))49 2547 y(get_user\(Message[i],)d(buffer+i\);)
-150 2660 y(#else)49 2774 y(Message[i])i(=)i(get_user\(buffer+i\);)-150
2887 y(#endif)-50 3115 y(Message_Ptr)d(=)j(Message;)-50
3342 y(/*)f(Again,)g(return)f(the)i(number)e(of)i(input)f(characters)f
(used)h(*/)-50 3455 y(return)f(i;)-150 3569 y(})-150
3910 y(/*)h(This)h(function)e(is)h(called)g(whenever)f(a)i(process)e
(tries)h(to)-100 4023 y(*)g(do)h(an)f(ioctl)g(on)h(our)f(device)g
(file.)f(We)i(get)f(two)g(extra)-100 4137 y(*)g(parameters)f
(\(additional)g(to)i(the)f(inode)g(and)g(file)p eop
%%Page: 51 55
51 54 bop 200 162 a Fu(*)49 b(structures,)f(which)h(all)g(device)g
(functions)f(get\):)h(the)g(number)200 275 y(*)g(of)h(the)f(ioctl)g
(called)g(and)g(the)g(parameter)f(given)h(to)h(the)200
389 y(*)f(ioctl)g(function.)200 502 y(*)200 616 y(*)g(If)h(the)f(ioctl)
g(is)g(write)g(or)h(read/write)e(\(meaning)g(output)200
730 y(*)h(is)h(returned)e(to)i(the)f(calling)f(process\),)h(the)g
(ioctl)g(call)200 843 y(*)g(returns)g(the)g(output)g(of)g(this)g
(function.)200 957 y(*/)150 1070 y(int)g(device_ioctl\()349
1184 y(struct)g(inode)g(*inode,)349 1297 y(struct)g(file)g(*file,)349
1411 y(unsigned)g(int)g(ioctl_num,/*)e(The)j(number)e(of)i(the)f(ioctl)
g(*/)349 1525 y(unsigned)g(long)g(ioctl_param\))e(/*)j(The)f(parameter)
f(to)h(it)h(*/)150 1638 y({)250 1752 y(int)f(i;)250 1865
y(char)g(*temp;)150 1979 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))250 2092 y(char)g(ch;)150 2206
y(#endif)250 2433 y(/*)g(Switch)g(according)f(to)h(the)h(ioctl)e
(called)h(*/)250 2547 y(switch)f(\(ioctl_num\))g({)349
2660 y(case)h(IOCTL_SET_MSG:)449 2774 y(/*)g(Receive)g(a)g(pointer)g
(to)g(a)h(message)f(\(in)g(user)g(space\))499 2887 y(*)g(and)h(set)f
(that)g(to)g(be)h(the)f(device's)f(message.)h(*/)449
3115 y(/*)g(Get)h(the)f(parameter)f(given)h(to)g(ioctl)g(by)h(the)f
(process)f(*/)449 3228 y(temp)h(=)h(\(char)e(*\))i(ioctl_param;)449
3455 y(/*)f(Find)g(the)h(length)e(of)i(the)f(message)g(*/)150
3569 y(#if)g(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))449
3682 y(get_user\(ch,)e(temp\);)449 3796 y(for)i(\(i=0;)g(ch)g(&&)h
(i<BUF_LEN;)e(i++,)h(temp++\))549 3910 y(get_user\(ch,)e(temp\);)150
4023 y(#else)449 4137 y(for)i(\(i=0;)g(get_user\(temp\))e(&&)j
(i<BUF_LEN;)e(i++,)h(temp++\))p eop
%%Page: 52 56
52 55 bop -150 162 a Fu(;)-150 275 y(#endif)149 502 y(/*)49
b(Don't)g(reinvent)g(the)g(wheel)g(-)g(call)g(device_write)f(*/)-150
616 y(#if)h(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))149
730 y(device_write\(file,)d(\(char)j(*\))h(ioctl_param,)d(i,)j(0\);)
-150 843 y(#else)149 957 y(device_write\(inode,)c(file,)j(\(char)g(*\))
g(ioctl_param,)f(i\);)-150 1070 y(#endif)149 1184 y(break;)49
1411 y(case)h(IOCTL_GET_MSG:)149 1525 y(/*)g(Give)g(the)h(current)e
(message)h(to)g(the)g(calling)199 1638 y(*)g(process)g(-)g(the)h
(parameter)e(we)h(got)h(is)f(a)h(pointer,)199 1752 y(*)f(fill)g(it.)h
(*/)-150 1865 y(#if)f(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))149 1979 y(i)h(=)f(device_read\(file,)e
(\(char)i(*\))g(ioctl_param,)f(99,)h(0\);)-150 2092 y(#else)149
2206 y(i)h(=)f(device_read\(inode,)e(file,)h(\(char)h(*\))h
(ioctl_param,)946 2320 y(99\);)-150 2433 y(#endif)149
2547 y(/*)f(Warning)g(-)g(we)h(assume)f(here)g(the)g(buffer)g(length)f
(is)199 2660 y(*)h(100.)g(If)h(it's)f(less)g(than)g(that)g(we)h(might)e
(overflow)199 2774 y(*)h(the)h(buffer,)e(causing)h(the)g(process)f(to)i
(core)f(dump.)199 2887 y(*)199 3001 y(*)g(The)h(reason)e(we)i(only)f
(allow)g(up)g(to)h(99)f(characters)f(is)199 3115 y(*)h(that)g(the)h
(NULL)f(which)g(terminates)f(the)h(string)f(also)199
3228 y(*)h(needs)g(room.)g(*/)149 3455 y(/*)g(Put)h(a)f(zero)g(at)h
(the)f(end)g(of)h(the)f(buffer,)f(so)i(it)199 3569 y(*)f(will)g(be)h
(properly)e(terminated)g(*/)149 3682 y(put_user\('\\0',)f(\(char)i(*\))
g(ioctl_param+i\);)149 3796 y(break;)49 4023 y(case)g
(IOCTL_GET_NTH_BYTE:)149 4137 y(/*)g(This)g(ioctl)g(is)h(both)f(input)g
(\(ioctl_param\))e(and)p eop
%%Page: 53 57
53 56 bop 499 162 a Fu(*)49 b(output)g(\(the)g(return)g(value)g(of)g
(this)g(function\))f(*/)449 275 y(return)h(Message[ioctl_param];)449
389 y(break;)250 502 y(})250 730 y(return)f(SUCCESS;)150
843 y(})150 1184 y(/*)h(Module)g(Declarations)f
(***************************)c(*/)150 1525 y(/*)49 b(This)h(structure)e
(will)h(hold)g(the)g(functions)f(to)i(be)f(called)200
1638 y(*)g(when)h(a)f(process)g(does)g(something)f(to)h(the)h(device)e
(we)200 1752 y(*)h(created.)g(Since)g(a)g(pointer)g(to)g(this)g
(structure)f(is)i(kept)f(in)200 1865 y(*)g(the)h(devices)e(table,)h(it)
g(can't)g(be)h(local)f(to)200 1979 y(*)g(init_module.)f(NULL)h(is)h
(for)f(unimplemented)e(functions.)h(*/)150 2092 y(struct)h
(file_operations)e(Fops)i(=)g({)250 2206 y(NULL,)148
b(/*)50 b(seek)f(*/)250 2320 y(device_read,)250 2433
y(device_write,)250 2547 y(NULL,)148 b(/*)50 b(readdir)e(*/)250
2660 y(NULL,)148 b(/*)50 b(select)e(*/)250 2774 y(device_ioctl,)147
b(/*)49 b(ioctl)g(*/)250 2887 y(NULL,)148 b(/*)50 b(mmap)f(*/)250
3001 y(device_open,)150 3115 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))250 3228 y(NULL,)98 b(/*)50
b(flush)f(*/)150 3342 y(#endif)250 3455 y(device_release)97
b(/*)49 b(a.k.a.)g(close)g(*/)150 3569 y(};)150 3910
y(/*)g(Initialize)f(the)i(module)e(-)i(Register)e(the)i(character)e
(device)g(*/)150 4023 y(int)h(init_module\(\))150 4137
y({)p eop
%%Page: 54 58
54 57 bop -50 162 a Fu(int)49 b(ret_val;)-50 389 y(/*)g(Register)f(the)
i(character)e(device)g(\(atleast)h(try\))g(*/)-50 502
y(ret_val)f(=)i(module_register_chrdev\(MAJOR_NUM,)1494
616 y(DEVICE_NAME,)1494 730 y(&Fops\);)-50 957 y(/*)f(Negative)f
(values)h(signify)g(an)g(error)g(*/)-50 1070 y(if)g(\(ret_val)f(<)i
(0\))f({)49 1184 y(printk)g(\("\045s)g(failed)g(with)g(\045d\\n",)448
1297 y("Sorry,)f(registering)g(the)h(character)f(device)h(",)448
1411 y(ret_val\);)49 1525 y(return)g(ret_val;)-50 1638
y(})-50 1865 y(printk)f(\("\045s)h(The)h(major)f(device)f(number)h(is)g
(\045d.\\n",)348 1979 y("Registeration)e(is)j(a)f(success",)348
2092 y(MAJOR_NUM\);)-50 2206 y(printk)f(\("If)h(you)h(want)f(to)g(talk)
g(to)h(the)f(device)g(driver,\\n"\);)-50 2320 y(printk)f(\("you'll)h
(have)g(to)g(create)g(a)g(device)g(file.)g(\\n"\);)-50
2433 y(printk)f(\("We)h(suggest)g(you)g(use:\\n"\);)-50
2547 y(printk)f(\("mknod)h(\045s)g(c)h(\045d)f(0\\n",)g
(DEVICE_FILE_NAME,)348 2660 y(MAJOR_NUM\);)-50 2774 y(printk)f(\("The)h
(device)g(file)g(name)g(is)g(important,)f(because\\n"\);)-50
2887 y(printk)g(\("the)h(ioctl)g(program)g(assumes)f(that's)h
(the\\n"\);)-50 3001 y(printk)f(\("file)h(you'll)g(use.\\n"\);)-50
3228 y(return)f(0;)-150 3342 y(})-150 3682 y(/*)h(Cleanup)g(-)h
(unregister)e(the)h(appropriate)f(file)h(from)g(/proc)g(*/)-150
3796 y(void)g(cleanup_module\(\))-150 3910 y({)-50 4023
y(int)g(ret;)p eop
%%Page: 55 59
55 58 bop 250 162 a Fu(/*)49 b(Unregister)f(the)h(device)g(*/)250
275 y(ret)g(=)h(module_unregister_chrdev\(MAJOR_NU)o(M,)44
b(DEVICE_NAME\);)250 502 y(/*)49 b(If)h(there's)e(an)h(error,)g(report)
g(it)g(*/)250 616 y(if)g(\(ret)g(<)h(0\))349 730 y(printk\("Error)e(in)
h(module_unregister_chrdev:)c(\045d\\n",)k(ret\);)150
843 y(})275 1654 y Fl(charde)o(v)-7 b(.h)150 1822 y Fu(/*)49
b(chardev.h)g(-)g(the)g(header)g(file)g(with)g(the)h(ioctl)e
(definitions.)200 1936 y(*)200 2049 y(*)h(The)h(declarations)d(here)i
(have)g(to)h(be)f(in)h(a)f(header)g(file,)200 2163 y(*)g(because)g
(they)g(need)g(to)h(be)f(known)g(both)g(to)g(the)h(kernel)200
2276 y(*)f(module)g(\(in)g(chardev.c\))f(and)i(the)f(process)f(calling)
h(ioctl)200 2390 y(*)g(\(ioctl.c\))200 2504 y(*/)150
2731 y(#ifndef)g(CHARDEV_H)150 2844 y(#define)g(CHARDEV_H)150
3071 y(#include)f(<linux/ioctl.h>)150 3526 y(/*)h(The)h(major)f(device)
f(number.)h(We)g(can't)g(rely)g(on)h(dynamic)200 3639
y(*)f(registration)f(any)h(more,)g(because)g(ioctls)f(need)h(to)h(know)
200 3753 y(*)f(it.)h(*/)150 3866 y(#define)f(MAJOR_NUM)f(100)150
4207 y(/*)h(Set)h(the)f(message)f(of)i(the)f(device)g(driver)g(*/)p
eop
%%Page: 56 60
56 59 bop -150 162 a Fu(#define)49 b(IOCTL_SET_MSG)e(_IOR\(MAJOR_NUM,)g
(0,)i(char)g(*\))-150 275 y(/*)g(_IOR)h(means)e(that)h(we're)g
(creating)g(an)g(ioctl)g(command)-100 389 y(*)g(number)g(for)g(passing)
g(information)f(from)h(a)g(user)g(process)-100 502 y(*)g(to)h(the)f
(kernel)g(module.)-100 616 y(*)-100 730 y(*)g(The)h(first)f(arguments,)
f(MAJOR_NUM,)f(is)j(the)f(major)g(device)-100 843 y(*)g(number)g(we're)
g(using.)-100 957 y(*)-100 1070 y(*)g(The)h(second)e(argument)h(is)g
(the)g(number)g(of)h(the)f(command)-100 1184 y(*)g(\(there)g(could)g
(be)g(several)g(with)g(different)f(meanings\).)-100 1297
y(*)-100 1411 y(*)h(The)h(third)f(argument)f(is)h(the)h(type)f(we)g
(want)g(to)h(get)f(from)-100 1525 y(*)g(the)h(process)e(to)i(the)f
(kernel.)-100 1638 y(*/)-150 1865 y(/*)g(Get)h(the)f(message)f(of)i
(the)f(device)g(driver)g(*/)-150 1979 y(#define)g(IOCTL_GET_MSG)e
(_IOR\(MAJOR_NUM,)g(1,)i(char)g(*\))-100 2092 y(/*)g(This)g(IOCTL)g(is)
h(used)f(for)g(output,)f(to)i(get)f(the)g(message)-50
2206 y(*)g(of)h(the)f(device)g(driver.)f(However,)g(we)i(still)f(need)g
(the)-50 2320 y(*)g(buffer)g(to)g(place)g(the)h(message)e(in)h(to)h(be)
f(input,)-50 2433 y(*)g(as)h(it)f(is)h(allocated)e(by)h(the)g(process.)
-50 2547 y(*/)-150 2887 y(/*)g(Get)h(the)f(n'th)g(byte)g(of)h(the)f
(message)f(*/)-150 3001 y(#define)h(IOCTL_GET_NTH_BYTE)d
(_IOWR\(MAJOR_NUM,)h(2,)i(int\))-100 3115 y(/*)g(The)h(IOCTL)e(is)i
(used)f(for)g(both)g(input)g(and)g(output.)g(It)-50 3228
y(*)g(receives)g(from)g(the)g(user)g(a)h(number,)e(n,)i(and)f(returns)
-50 3342 y(*)g(Message[n].)f(*/)-150 3682 y(/*)h(The)h(name)f(of)g(the)
g(device)g(file)g(*/)-150 3796 y(#define)g(DEVICE_FILE_NAME)d
("char_dev")-150 4137 y(#endif)p eop
%%Page: 57 61
57 60 bop 275 972 a Fl(ioctl.c)150 1141 y Fu(/*)49 b(ioctl.c)g(-)h(the)
f(process)f(to)i(use)f(ioctl's)g(to)g(control)f(the)200
1254 y(*)h(kernel)g(module)200 1368 y(*)200 1481 y(*)g(Until)g(now)h
(we)f(could)g(have)g(used)g(cat)g(for)h(input)e(and)200
1595 y(*)h(output.)g(But)g(now)g(we)h(need)f(to)g(do)h(ioctl's,)e
(which)h(require)200 1709 y(*)g(writing)g(our)g(own)g(process.)200
1822 y(*/)150 2049 y(/*)g(Copyright)g(\(C\))g(1998)g(by)g(Ori)h
(Pomerantz)e(*/)150 2390 y(/*)h(device)g(specifics,)f(such)h(as)h
(ioctl)e(numbers)h(and)g(the)200 2504 y(*)g(major)g(device)g(file.)g
(*/)150 2617 y(#include)f("chardev.h")150 2958 y(#include)g(<fcntl.h>)
298 b(/*)49 b(open)g(*/)150 3071 y(#include)f(<unistd.h>)248
b(/*)49 b(exit)g(*/)150 3185 y(#include)f(<sys/ioctl.h>)98
b(/*)49 b(ioctl)g(*/)150 3639 y(/*)g(Functions)g(for)g(the)g(ioctl)g
(calls)g(*/)150 3866 y(ioctl_set_msg\(int)e(file_desc,)h(char)h
(*message\))150 3980 y({)250 4094 y(int)g(ret_val;)p
eop
%%Page: 58 62
58 61 bop -50 162 a Fu(ret_val)48 b(=)i(ioctl\(file_desc,)d
(IOCTL_SET_MSG,)g(message\);)-50 389 y(if)i(\(ret_val)f(<)i(0\))f({)49
502 y(printf)g(\("ioctl_set_msg)e(failed:\045d\\n",)g(ret_val\);)49
616 y(exit\(-1\);)-50 730 y(})-150 843 y(})-150 1297
y(ioctl_get_msg\(int)g(file_desc\))-150 1411 y({)-50
1525 y(int)i(ret_val;)-50 1638 y(char)g(message[100];)-50
1865 y(/*)g(Warning)g(-)g(this)g(is)h(dangerous)e(because)g(we)i(don't)
f(tell)-1 1979 y(*)h(the)f(kernel)g(how)g(far)h(it's)f(allowed)f(to)i
(write,)e(so)i(it)-1 2092 y(*)g(might)f(overflow)f(the)i(buffer.)e(In)h
(a)h(real)f(production)-1 2206 y(*)h(program,)e(we)i(would)f(have)g
(used)g(two)g(ioctls)g(-)g(one)h(to)f(tell)-1 2320 y(*)h(the)f(kernel)g
(the)g(buffer)g(length)g(and)g(another)f(to)i(give)-1
2433 y(*)g(it)g(the)f(buffer)f(to)i(fill)-1 2547 y(*/)-50
2660 y(ret_val)e(=)i(ioctl\(file_desc,)d(IOCTL_GET_MSG,)g(message\);)
-50 2887 y(if)i(\(ret_val)f(<)i(0\))f({)49 3001 y(printf)g
(\("ioctl_get_msg)e(failed:\045d\\n",)g(ret_val\);)49
3115 y(exit\(-1\);)-50 3228 y(})-50 3455 y(printf\("get_msg)g
(message:\045s\\n",)g(message\);)-150 3569 y(})-150 4023
y(ioctl_get_nth_byte\(int)f(file_desc\))-150 4137 y({)p
eop
%%Page: 59 63
59 62 bop 250 162 a Fu(int)49 b(i;)250 275 y(char)g(c;)250
502 y(printf\("get_nth_byte)d(message:"\);)250 730 y(i)j(=)h(0;)250
843 y(while)f(\(c)g(!=)g(0\))h({)349 957 y(c)g(=)g(ioctl\(file_desc,)c
(IOCTL_GET_NTH_BYTE,)h(i++\);)349 1184 y(if)j(\(c)f(<)h(0\))f({)449
1297 y(printf\()449 1411 y("ioctl_get_nth_byte)d(failed)j(at)g(the)h
(\045d'th)e(byte:\\n",)h(i\);)449 1525 y(exit\(-1\);)349
1638 y(})349 1865 y(putchar\(c\);)250 1979 y(})250 2092
y(putchar\('\\n'\);)150 2206 y(})150 2774 y(/*)g(Main)h(-)f(Call)g(the)
g(ioctl)g(functions)f(*/)150 2887 y(main\(\))150 3001
y({)250 3115 y(int)h(file_desc,)f(ret_val;)250 3228 y(char)h(*msg)g(=)g
("Message)g(passed)f(by)i(ioctl\\n";)250 3455 y(file_desc)e(=)h
(open\(DEVICE_FILE_NAME,)d(0\);)250 3569 y(if)j(\(file_desc)f(<)i(0\))f
({)349 3682 y(printf)g(\("Can't)f(open)i(device)e(file:)h(\045s\\n",)
748 3796 y(DEVICE_FILE_NAME\);)349 3910 y(exit\(-1\);)250
4023 y(})p eop
%%Page: 60 64
60 63 bop -50 162 a Fu(ioctl_get_nth_byte\(file_desc\);)-50
275 y(ioctl_get_msg\(file_desc\);)-50 389 y(ioctl_set_msg\(file_desc,)
45 b(msg\);)-50 616 y(close\(file_desc\);)-150 730 y(})p
eop
%%Page: 61 65
61 64 bop 150 813 a Fn(Chapter)44 b(6)150 1263 y Fp(Startup)51
b(P)n(arameters)275 1709 y Fy(In)18 b(man)o(y)g(of)h(the)f(pre)n(vious)
g(e)o(xamples,)g(we)h(had)f(to)h(hard-wire)f(something)f(into)i(the)g
(k)o(ernel)f(mod-)150 1823 y(ule,)i(such)f(as)i(the)f(\002le)h(name)e
(for)g Fu(/proc)h Fy(\002les)h(or)e(the)h(major)f(de)n(vice)g(number)g
(for)g(the)h(de)n(vice)f(so)h(we)150 1936 y(can)26 b(ha)n(v)o(e)g
Fu(ioctl)p Fy(')-5 b(s)26 b(to)h(it.)44 b(This)26 b(goes)g(against)g
(the)g(grain)g(of)g(the)g(Unix,)h(and)f(Linux,)g(philosophy)150
2050 y(which)20 b(is)h(to)f(write)g(\003e)o(xible)g(program)e(the)i
(user)g(can)g(customize.)275 2163 y(The)25 b(w)o(ay)g(to)h(tell)g(a)g
(program,)e(or)h(a)h(k)o(ernel)f(module,)g(something)f(it)i(needs)f
(before)g(it)h(can)f(start)150 2277 y(w)o(orking)16 b(is)j(by)f
(command)e(line)i(parameters.)23 b(In)18 b(the)g(case)h(of)e(k)o(ernel)
h(modules,)f(we)h(don')o(t)f(get)h Fu(argc)150 2391 y
Fy(and)g Fu(argv)g Fy(\227)g(instead,)g(we)h(get)f(something)f(better)
-5 b(.)24 b(W)-7 b(e)20 b(can)e(de\002ne)f(global)g(v)n(ariables)h(in)g
(the)g(k)o(ernel)150 2504 y(module)h(and)g Fu(insmod)h
Fy(will)h(\002ll)g(them)f(for)f(us.)275 2618 y(In)31
b(this)i(k)o(ernel)e(module,)i(we)g(de\002ne)e(tw)o(o)i(of)e(them:)49
b Fu(str1)32 b Fy(and)f Fu(str2)p Fy(.)60 b(All)33 b(you)e(need)g(to)
150 2731 y(do)23 b(is)h(compile)e(the)h(k)o(ernel)g(module)f(and)g
(then)h(run)g Fu(insmod)48 b(str1=xxx)h(str2=yyy)p Fy(.)33
b(When)150 2845 y Fu(init)p 355 2845 25 4 v 29 w(module)f
Fy(is)h(called,)i Fu(str1)d Fy(will)i(point)d(to)i(the)f(string)g(`)p
Fu(xxx)p Fy(')g(and)g Fu(str2)g Fy(to)g(the)h(string)150
2958 y(`)p Fu(yyy)p Fy('.)275 3072 y(In)24 b(v)o(ersion)g(2.0)g(there)h
(is)g(no)g(type)f(checking)g(on)g(these)h(ar)o(guments)2293
3042 y Fk(1)2328 3072 y Fy(.)40 b(If)25 b(the)f(\002rst)i(character)e
(of)150 3186 y Fu(str1)19 b Fy(or)g Fu(str2)g Fy(is)h(a)f(digit)g(the)g
(k)o(ernel)f(will)i(\002ll)g(the)f(v)n(ariable)f(with)h(the)h(v)n(alue)
e(of)h(the)g(inte)o(ger)m(,)e(rather)150 3299 y(than)j(a)g(pointer)f
(to)i(the)f(string.)k(If)d(a)f(real)g(life)h(situation)f(you)f(ha)n(v)o
(e)g(to)i(check)e(for)h(this.)275 3413 y(On)e(the)h(other)f(hand,)g(in)
h(v)o(ersion)f(2.2)g(you)g(use)h(the)g(macro)f Fu(MACRO)p
2255 3413 V 29 w(PARM)h Fy(to)g(tell)g Fu(insmod)f Fy(that)150
3526 y(you)25 b(e)o(xpect)f(a)i(parameters,)f(its)i(name)e
Fg(and)g(its)h(type)p Fy(.)41 b(This)26 b(solv)o(es)f(the)g(type)h
(problem)d(and)i(allo)n(ws)150 3640 y(k)o(ernel)19 b(modules)h(to)g
(recei)n(v)o(e)f(strings)h(which)g(be)o(gin)f(with)h(a)h(digit,)f(for)f
(e)o(xample.)275 3828 y Fl(param.c)p 150 4040 1200 4
v 235 4094 a Fi(1)270 4117 y Fh(There)g(can')o(t)g(be,)g(since)h(under)
g(C)e(the)i(object)g(\002le)f(only)h(has)e(the)i(location)h(of)e
(global)h(v)n(ariables,)h(not)e(their)h(type.)27 b(That)19
b(is)150 4207 y(why)e(header)h(\002les)g(are)f(necessary)1608
4456 y Fy(61)p eop
%%Page: 62 66
62 65 bop -150 162 a Fu(/*)49 b(param.c)-100 275 y(*)-100
389 y(*)g(Receive)g(command)f(line)i(parameters)d(at)j(module)f
(installation)-100 502 y(*/)-150 730 y(/*)g(Copyright)g(\(C\))g
(1998-99)f(by)i(Ori)f(Pomerantz)f(*/)-150 1411 y(/*)h(The)h(necessary)e
(header)h(files)f(*/)-150 1638 y(/*)h(Standard)g(in)g(kernel)g(modules)
f(*/)-150 1752 y(#include)g(<linux/kernel.h>)147 b(/*)49
b(We're)g(doing)g(kernel)g(work)g(*/)-150 1865 y(#include)f
(<linux/module.h>)147 b(/*)49 b(Specifically,)f(a)h(module)g(*/)-150
2092 y(/*)g(Deal)h(with)f(CONFIG_MODVERSIONS)d(*/)-150
2206 y(#if)j(CONFIG_MODVERSIONS==1)-150 2320 y(#define)g(MODVERSIONS)
-150 2433 y(#include)f(<linux/modversions.h>)-150 2547
y(#endif)-150 2887 y(#include)g(<stdio.h>)98 b(/*)50
b(I)f(need)g(NULL)g(*/)-150 3228 y(/*)g(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)49 b(a)-100
3342 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e(doesn't)h(-)h(so)f(I)h
(add)f(it)-100 3455 y(*)g(here)h(if)f(necessary.)f(*/)-150
3569 y(#ifndef)h(KERNEL_VERSION)-150 3682 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))-150
3796 y(#endif)p eop
%%Page: 63 67
63 66 bop 150 162 a Fu(/*)49 b(Emmanuel)g(Papirakis:)200
275 y(*)200 389 y(*)g(Prameter)g(names)g(are)g(now)g(\(2.2\))g(handled)
g(in)g(a)h(macro.)200 502 y(*)f(The)h(kernel)e(doesn't)h(resolve)f(the)
i(symbol)e(names)200 616 y(*)h(like)h(it)f(seems)g(to)g(have)g(once)g
(did.)200 730 y(*)200 843 y(*)g(To)h(pass)f(parameters)f(to)h(a)h
(module,)e(you)i(have)f(to)g(use)g(a)h(macro)200 957
y(*)f(defined)g(in)g(include/linux/modules.h)d(\(line)j(176\).)200
1070 y(*)g(The)h(macro)f(takes)f(two)i(parameters.)d(The)j(parameter's)
d(name)j(and)200 1184 y(*)f(it's)h(type.)e(The)i(type)f(is)g(a)h
(letter)e(in)i(double)f(quotes.)200 1297 y(*)g(For)h(example,)e("i")h
(should)g(be)g(an)h(integer)e(and)i("s")f(should)200
1411 y(*)g(be)h(a)g(string.)200 1525 y(*/)150 1865 y(char)f(*str1,)g
(*str2;)150 2206 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))150 2320 y(MODULE_PARM\(str1,)e("s"\);)150
2433 y(MODULE_PARM\(str2,)g("s"\);)150 2547 y(#endif)150
2887 y(/*)i(Initialize)f(the)i(module)e(-)i(show)f(the)g(parameters)f
(*/)150 3001 y(int)h(init_module\(\))150 3115 y({)250
3228 y(if)g(\(str1)g(==)g(NULL)g(||)h(str2)f(==)g(NULL\))g({)349
3342 y(printk\("Next)f(time,)h(do)g(insmod)g(param)g
(str1=<something>"\);)349 3455 y(printk\("str2=<something>\\n"\);)250
3569 y(})g(else)349 3682 y(printk\("Strings:\045s)e(and)i(\045s\\n",)g
(str1,)g(str2\);)150 3910 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))250 4023 y(printk\("If)f(you)h(try)g(to)h
(insmod)e(this)h(module)g(twice,"\);)250 4137 y(printk\("\(without)d
(rmmod'ing\\n"\);)p eop
%%Page: 64 68
64 67 bop -50 162 a Fu(printk\("it)48 b(first\),)g(you)h(might)g(get)g
(the)h(wrong"\);)-50 275 y(printk\("error)d(message:\\n"\);)-50
389 y(printk\("'symbol)g(for)i(parameters)f(str1)h(not)g
(found'.\\n"\);)-150 502 y(#endif)-50 730 y(return)f(0;)-150
843 y(})-150 1184 y(/*)h(Cleanup)g(*/)-150 1297 y(void)g
(cleanup_module\(\))-150 1411 y({)-150 1525 y(})p eop
%%Page: 65 69
65 68 bop 150 813 a Fn(Chapter)44 b(7)150 1263 y Fp(System)52
b(Calls)275 1709 y Fy(So)18 b(f)o(ar)m(,)g(the)g(only)f(thing)g(we')l
(v)o(e)g(done)g(w)o(as)i(to)g(use)f(well)h(de\002ned)e(k)o(ernel)g
(mechanisms)g(to)h(re)o(gister)150 1823 y Fu(/proc)31
b Fy(\002les)i(and)e(de)n(vice)g(handlers.)58 b(This)32
b(is)g(\002ne)g(if)g(you)f(w)o(ant)h(to)f(do)h(something)e(the)h(k)o
(ernel)150 1936 y(programmers)22 b(thought)h(you')l(d)g(w)o(ant,)j
(such)f(as)g(write)g(a)g(de)n(vice)f(dri)n(v)o(er)-5
b(.)38 b(But)26 b(what)e(if)i(you)d(w)o(ant)i(to)150
2050 y(do)g(something)f(unusual,)h(to)h(change)e(the)i(beha)n(vior)e
(of)h(the)g(system)h(in)g(some)f(w)o(ay?)41 b(Then,)25
b(you')l(re)150 2163 y(mostly)20 b(on)g(your)f(o)n(wn.)275
2277 y(This)k(is)h(where)f(k)o(ernel)g(programming)d(gets)j(dangerous.)
33 b(While)24 b(writing)e(the)i(e)o(xample)e(belo)n(w)-5
b(,)150 2391 y(I)29 b(killed)f(the)g Fu(open)g Fy(system)h(call.)50
b(This)28 b(meant)g(I)h(couldn')o(t)d(open)h(an)o(y)h(\002les,)j(I)e
(couldn')o(t)d(run)h(an)o(y)150 2504 y(programs,)15 b(and)h(I)h
(couldn')o(t)d Fu(shutdown)h Fy(the)i(computer)-5 b(.)22
b(I)17 b(had)f(to)g(pull)g(the)h(po)n(wer)e(switch.)24
b(Luckily)-5 b(,)150 2618 y(no)23 b(\002les)h(died.)33
b(T)-7 b(o)23 b(ensure)f(you)g(w)o(on')o(t)g(lose)h(an)o(y)g(\002les)h
(either)m(,)e(please)h(run)g Fu(sync)f Fy(right)h(before)e(you)150
2731 y(do)f(the)g Fu(insmod)g Fy(and)f(the)h Fu(rmmod)p
Fy(.)275 2845 y(F)o(or)o(get)25 b(about)h Fu(/proc)h
Fy(\002les,)j(for)o(get)25 b(about)h(de)n(vice)h(\002les.)46
b(The)o(y')l(re)25 b(just)j(minor)e(details.)46 b(The)150
2958 y Fg(r)m(eal)20 b Fy(process)g(to)g(k)o(ernel)g(communication)d
(mechanism,)i(the)h(one)f(used)h(by)g(all)h(processes,)e(is)i(system)
150 3072 y(calls.)41 b(When)25 b(a)h(process)f(requests)g(a)h(service)f
(from)f(the)h(k)o(ernel)g(\(such)f(as)i(opening)e(a)i(\002le,)h
(forking)150 3186 y(to)f(a)g(ne)n(w)g(process,)g(or)g(requesting)e
(more)h(memory\),)f(this)j(is)f(the)g(mechanism)f(used.)41
b(If)26 b(you)e(w)o(ant)150 3299 y(to)e(change)f(the)i(beha)n(viour)d
(of)i(the)g(k)o(ernel)g(in)g(interesting)f(w)o(ays,)i(this)g(is)g(the)g
(place)f(to)g(do)g(it.)32 b(By)23 b(the)150 3413 y(w)o(ay)-5
b(,)28 b(if)g(you)e(w)o(ant)i(to)f(see)h(which)f(system)g(calls)h(a)g
(program)d(uses,)k(run)e Fu(strace)49 b(<command>)150
3526 y(<arguments>)p Fy(.)275 3640 y(In)27 b(general,)h(a)g(process)f
(is)h(not)f(supposed)g(to)g(be)h(able)f(to)h(access)g(the)f(k)o(ernel.)
47 b(It)27 b(can')o(t)g(access)150 3753 y(k)o(ernel)c(memory)g(and)g
(it)i(can')o(t)f(call)g(k)o(ernel)g(functions.)35 b(The)24
b(hardw)o(are)f(of)h(the)g(CPU)h(enforces)e(this)150
3867 y(\(that')-5 b(s)24 b(the)g(reason)f(why)f(it')-5
b(s)25 b(called)f(`protected)e(mode'\).)34 b(System)23
b(calls)i(are)f(an)f(e)o(xception)f(to)i(this)150 3981
y(general)18 b(rule.)24 b(What)c(happens)d(is)j(that)f(the)g(process)g
(\002lls)h(the)f(re)o(gisters)g(with)g(the)g(appropriate)e(v)n(alues)
150 4094 y(and)30 b(then)f(calls)i(a)f(special)h(instruction)d(which)i
(jumps)f(to)i(a)f(pre)n(viously)e(de\002ned)h(location)g(in)i(the)1608
4456 y(65)p eop
%%Page: 66 70
66 69 bop -150 162 a Fy(k)o(ernel)25 b(\(of)g(course,)g(that)h
(location)e(is)j(readable)d(by)h(user)g(processes,)i(it)f(is)g(not)f
(writable)h(by)f(them\).)-150 275 y(Under)19 b(Intel)h(CPUs,)i(this)f
(is)g(done)e(by)h(means)g(of)g(interrupt)f(0x80.)24 b(The)c(hardw)o
(are)f(kno)n(ws)h(that)g(once)-150 389 y(you)27 b(jump)g(to)h(this)h
(location,)g(you)e(are)h(no)f(longer)g(running)f(in)i(restricted)f
(user)h(mode,)h(b)n(ut)f(as)h(the)-150 502 y(operating)18
b(system)j(k)o(ernel)e(\227)i(and)f(therefore)e(you')l(re)g(allo)n(wed)
i(to)g(do)g(whate)n(v)o(er)f(you)g(w)o(ant.)-25 616 y(The)26
b(location)g(in)h(the)f(k)o(ernel)g(a)h(process)g(can)f(jump)g(to)h(is)
h(called)e Fu(system)p 2266 616 25 4 v 29 w(call)p Fy(.)44
b(The)27 b(pro-)-150 730 y(cedure)22 b(at)i(that)f(location)f(checks)g
(the)i(system)f(call)g(number)m(,)f(which)g(tells)i(the)g(k)o(ernel)e
(what)h(service)-150 843 y(the)31 b(process)f(requested.)56
b(Then,)32 b(it)g(looks)e(at)h(the)g(table)g(of)g(system)g(calls)g(\()p
Fu(sys)p 2320 843 V 29 w(call)p 2549 843 V 29 w(table)p
Fy(\))-150 957 y(to)37 b(see)g(the)g(address)f(of)h(the)g(k)o(ernel)f
(function)f(to)i(call.)75 b(Then)36 b(it)h(calls)h(the)f(function,)i
(and)d(af-)-150 1070 y(ter)k(it)h(returns,)i(does)d(a)g(fe)n(w)g
(system)g(checks)g(and)f(then)h(return)e(back)i(to)g(the)g(process)f
(\(or)g(to)-150 1184 y(a)f(dif)n(ferent)d(process,)41
b(if)d(the)f(process)g(time)g(ran)g(out\).)76 b(If)37
b(you)f(w)o(ant)i(to)f(read)g(this)h(code,)i(it')-5 b(s)-150
1297 y(at)30 b(the)g(source)g(\002le)g Fu(arch/)p Fj(<)p
Fu(architecture)p Fj(>)p Fu(/kernel/entry.S)p Fy(,)24
b(after)29 b(the)h(line)h Fu(EN-)-150 1411 y(TRY\(system)p
355 1411 V 28 w(call\))p Fy(.)-25 1525 y(So,)20 b(if)h(we)g(w)o(ant)g
(to)f(change)g(the)g(w)o(ay)h(a)g(certain)f(system)h(call)g(w)o(orks,)f
(what)g(we)h(need)f(to)h(do)f(is)h(to)-150 1638 y(write)h(our)e(o)n(wn)
h(function)f(to)h(implement)f(it)i(\(usually)f(by)g(adding)f(a)h(bit)h
(of)f(our)g(o)n(wn)f(code,)h(and)g(then)-150 1752 y(calling)e(the)g
(original)f(function\))f(and)i(then)g(change)f(the)h(pointer)f(at)i
Fu(sys)p 1988 1752 V 29 w(call)p 2217 1752 V 30 w(table)e
Fy(to)i(point)e(to)-150 1865 y(our)h(function.)k(Because)c(we)h(might)f
(be)g(remo)o(v)o(ed)e(later)j(and)f(we)h(don')o(t)e(w)o(ant)h(to)h(lea)
n(v)o(e)f(the)h(system)f(in)-150 1979 y(an)24 b(unstable)f(state,)i
(it')-5 b(s)25 b(important)e(for)g Fu(cleanup)p 1402
1979 V 28 w(module)h Fy(to)g(restore)f(the)h(table)g(to)g(its)h
(original)-150 2092 y(state.)-25 2206 y(The)g(source)f(code)h(here)g
(is)i(an)e(e)o(xample)f(of)h(such)g(a)h(k)o(ernel)f(module.)39
b(W)-7 b(e)27 b(w)o(ant)f(to)f(`sp)o(y')g(on)g(a)-150
2320 y(certain)c(user)m(,)g(and)f(to)i Fu(printk)f Fy(a)g(message)h
(whene)n(v)o(er)d(that)i(user)g(opens)g(a)h(\002le.)29
b(T)-7 b(o)n(w)o(ards)21 b(this)g(end,)-150 2433 y(we)26
b(replace)f(the)h(system)g(call)g(to)g(open)e(a)i(\002le)h(with)f(our)f
(o)n(wn)g(function,)g(called)g Fu(our)p 2426 2433 V 30
w(sys)p 2606 2433 V 29 w(open)p Fy(.)-150 2547 y(This)g(function)e
(checks)h(the)g(uid)h(\(user')-5 b(s)24 b(id\))h(of)f(the)h(current)e
(process,)i(and)f(if)h(it')-5 b(s)26 b(equal)e(to)g(the)h(uid)-150
2660 y(we)c(sp)o(y)g(on,)f(it)h(calls)h Fu(printk)e Fy(to)h(display)f
(the)g(name)h(of)f(the)h(\002le)g(to)g(be)f(opened.)25
b(Then,)20 b(either)g(w)o(ay)-5 b(,)-150 2774 y(it)21
b(calls)g(the)f(original)f Fu(open)h Fy(function)f(with)h(the)g(same)g
(parameters,)f(to)i(actually)e(open)g(the)i(\002le.)-25
2887 y(The)j Fu(init)p 334 2887 V 29 w(module)g Fy(function)f(replaces)
h(the)g(appropriate)e(location)i(in)g Fu(sys)p 2347 2887
V 30 w(call)p 2577 2887 V 29 w(table)-150 3001 y Fy(and)j(k)o(eeps)h
(the)f(original)g(pointer)f(in)i(a)g(v)n(ariable.)46
b(The)28 b Fu(cleanup)p 1899 3001 V 28 w(module)f Fy(function)f(uses)i
(that)-150 3115 y(v)n(ariable)22 b(to)g(restore)h(e)n(v)o(erything)d
(back)h(to)i(normal.)31 b(This)23 b(approach)e(is)i(dangerous,)e
(because)h(of)h(the)-150 3228 y(possibility)k(of)g(tw)o(o)g(k)o(ernel)f
(modules)g(changing)f(the)j(same)f(system)g(call.)46
b(Imagine)26 b(we)i(ha)n(v)o(e)e(tw)o(o)-150 3342 y(k)o(ernel)h
(modules,)h(A)g(and)f(B.)i(A)-9 b(')k(s)28 b(open)e(system)i(call)g
(will)h(be)e(A)p 1817 3342 V 30 w(open)g(and)g(B')-5
b(s)29 b(will)f(be)g(B)p 2643 3342 V 30 w(open.)-150
3455 y(No)n(w)-5 b(,)26 b(when)f(A)i(is)f(inserted)f(into)h(the)g(k)o
(ernel,)g(the)f(system)h(call)g(is)h(replaced)e(with)g(A)p
2412 3455 V 30 w(open,)h(which)-150 3569 y(will)h(call)f(the)g
(original)e(sys)p 675 3569 V 30 w(open)h(when)g(it')-5
b(s)27 b(done.)41 b(Ne)o(xt,)27 b(B)f(is)h(inserted)e(into)h(the)g(k)o
(ernel,)g(which)-150 3682 y(replaces)c(the)h(system)g(call)h(with)f(B)p
899 3682 V 30 w(open,)f(which)h(will)h(call)f(what)g(it)g(thinks)g(is)h
(the)f(original)e(system)-150 3796 y(call,)f(A)p 76 3796
V 30 w(open,)f(when)h(it')-5 b(s)21 b(done.)-25 3910
y(No)n(w)-5 b(,)21 b(if)h(B)g(is)h(remo)o(v)o(ed)c(\002rst,)k(e)n(v)o
(erything)c(will)j(be)g(well)g(\227)g(it)h(will)f(simply)g(restore)f
(the)g(system)-150 4023 y(call)h(to)f(A)p 143 4023 V
30 w(open,)f(which)h(calls)g(the)h(original.)k(Ho)n(we)n(v)o(er)m(,)20
b(if)h(A)h(is)g(remo)o(v)o(ed)d(and)h(then)h(B)h(is)g(remo)o(v)o(ed,)
-150 4137 y(the)k(system)h(will)g(crash.)44 b(A)-9 b(')k(s)27
b(remo)o(v)n(al)e(will)i(restore)f(the)g(system)h(call)g(to)g(the)f
(original,)h(sys)p 2643 4137 V 30 w(open,)p eop
%%Page: 67 71
67 70 bop 150 162 a Fy(cutting)20 b(B)j(out)d(of)h(the)g(loop.)28
b(Then,)20 b(when)h(B)h(is)g(remo)o(v)o(ed,)d(it)i(will)h(restore)f
(the)g(system)h(call)f(to)h(what)150 275 y Fo(it)h Fy(thinks)f(is)h
(the)g(original,)e(A)p 1020 275 25 4 v 30 w(open,)h(which)g(is)h(no)f
(longer)f(in)i(memory)-5 b(.)29 b(At)23 b(\002rst)g(glance,)f(it)h
(appears)150 389 y(we)g(could)f(solv)o(e)g(this)h(particular)f(problem)
f(by)h(checking)f(if)i(the)g(system)g(call)g(is)h(equal)e(to)h(our)f
(open)150 502 y(function)g(and)h(if)h(so)g(not)g(changing)e(it)i(at)g
(all)h(\(so)f(that)f(B)i(w)o(on')o(t)e(change)f(the)i(system)g(call)g
(when)f(it')-5 b(s)150 616 y(remo)o(v)o(ed\),)19 b(b)n(ut)i(that)h
(will)g(cause)g(an)f(e)n(v)o(en)g(w)o(orse)g(problem.)27
b(When)22 b(A)g(is)g(remo)o(v)o(ed,)d(it)k(sees)f(that)g(the)150
730 y(system)i(call)g(w)o(as)h(changed)d(to)h(B)p 1151
730 V 31 w(open)f(so)i(that)g(it)h(is)f(no)g(longer)e(pointing)g(to)i
(A)p 2558 730 V 30 w(open,)f(so)h(it)h(w)o(on')o(t)150
843 y(restore)e(it)i(to)f(sys)p 671 843 V 30 w(open)e(before)h(it)h(is)
h(remo)o(v)o(ed)c(from)i(memory)-5 b(.)34 b(Unfortunately)-5
b(,)21 b(B)p 2661 843 V 30 w(open)i(will)h(still)150
957 y(try)i(to)f(call)i(A)p 571 957 V 29 w(open)e(which)g(is)i(no)e
(longer)g(there,)h(so)g(that)g(e)n(v)o(en)f(without)g(remo)o(ving)e(B)k
(the)e(system)150 1070 y(w)o(ould)19 b(crash.)275 1184
y(I)25 b(can)g(think)g(of)g(tw)o(o)g(w)o(ays)h(to)f(pre)n(v)o(ent)f
(this)h(problem.)39 b(The)25 b(\002rst)h(is)g(to)f(restore)g(the)g
(call)h(to)g(the)150 1297 y(original)c(v)n(alue,)h(sys)p
766 1297 V 30 w(open.)33 b(Unfortunately)-5 b(,)21 b(sys)p
1625 1297 V 30 w(open)h(is)i(not)f(part)g(of)g(the)g(k)o(ernel)g
(system)g(table)g(in)150 1411 y Fu(/proc/ksyms)p Fy(,)f(so)h(we)g(can')
o(t)f(access)h(it.)33 b(The)23 b(other)e(solution)h(is)i(to)f(use)g
(the)g(reference)e(count)g(to)150 1525 y(pre)n(v)o(ent)k(root)h(from)g
Fu(rmmod)p Fy('ing)f(the)h(module)g(once)g(it)h(is)h(loaded.)43
b(This)27 b(is)h(good)d(for)h(production)150 1638 y(modules,)19
b(b)n(ut)h(bad)g(for)f(an)h(educational)f(sample)h(\227)h(which)e(is)i
(why)f(I)g(didn')o(t)f(do)g(it)i(here.)275 1826 y Fl(syscall.c)150
2049 y Fu(/*)49 b(syscall.c)200 2163 y(*)200 2276 y(*)g(System)g(call)g
("stealing")f(sample)200 2390 y(*/)150 2731 y(/*)h(Copyright)g(\(C\))g
(1998-99)f(by)i(Ori)f(Pomerantz)f(*/)150 3071 y(/*)h(The)h(necessary)e
(header)h(files)f(*/)150 3299 y(/*)h(Standard)g(in)g(kernel)g(modules)f
(*/)150 3412 y(#include)g(<linux/kernel.h>)147 b(/*)49
b(We're)g(doing)g(kernel)g(work)g(*/)150 3526 y(#include)f
(<linux/module.h>)147 b(/*)49 b(Specifically,)f(a)h(module)g(*/)150
3753 y(/*)g(Deal)h(with)f(CONFIG_MODVERSIONS)d(*/)150
3866 y(#if)j(CONFIG_MODVERSIONS==1)150 3980 y(#define)g(MODVERSIONS)150
4094 y(#include)f(<linux/modversions.h>)150 4207 y(#endif)p
eop
%%Page: 68 72
68 71 bop -150 275 a Fu(#include)48 b(<sys/syscall.h>)97
b(/*)50 b(The)f(list)g(of)g(system)g(calls)g(*/)-150
502 y(/*)g(For)h(the)f(current)f(\(process\))h(structure,)f(we)h(need)
-100 616 y(*)g(this)h(to)f(know)g(who)g(the)h(current)e(user)h(is.)g
(*/)-150 730 y(#include)f(<linux/sched.h>)-150 1297 y(/*)h(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)49 b(a)-100
1411 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e(doesn't)h(-)h(so)f(I)h
(add)f(it)-100 1525 y(*)g(here)h(if)f(necessary.)f(*/)-150
1638 y(#ifndef)h(KERNEL_VERSION)-150 1752 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))-150
1865 y(#endif)-150 2320 y(#if)k(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))-150 2433 y(#include)f(<asm/uaccess.h>)-150
2547 y(#endif)-150 3001 y(/*)h(The)h(system)e(call)h(table)g(\(a)h
(table)f(of)g(functions\).)f(We)-100 3115 y(*)h(just)h(define)e(this)h
(as)h(external,)e(and)h(the)g(kernel)g(will)-100 3228
y(*)g(fill)h(it)f(up)g(for)h(us)f(when)g(we)h(are)f(insmod'ed)-100
3342 y(*/)-150 3455 y(extern)g(void)g(*sys_call_table[];)-150
3796 y(/*)g(UID)h(we)f(want)g(to)h(spy)f(on)g(-)h(will)f(be)g(filled)g
(from)g(the)-100 3910 y(*)g(command)g(line)g(*/)-150
4023 y(int)g(uid;)p eop
%%Page: 69 73
69 72 bop 150 162 a Fu(#if)49 b(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))150 275 y(MODULE_PARM\(uid,)e("i"\);)150
389 y(#endif)150 616 y(/*)i(A)h(pointer)f(to)g(the)g(original)g(system)
f(call.)h(The)g(reason)200 730 y(*)g(we)h(keep)f(this,)g(rather)g(than)
g(call)g(the)g(original)f(function)200 843 y(*)h(\(sys_open\),)f(is)i
(because)e(somebody)g(else)i(might)e(have)200 957 y(*)h(replaced)g(the)
g(system)g(call)g(before)f(us.)i(Note)f(that)g(this)200
1070 y(*)g(is)h(not)f(100\045)g(safe,)g(because)g(if)g(another)g
(module)200 1184 y(*)g(replaced)g(sys_open)f(before)h(us,)g(then)g
(when)g(we're)g(inserted)200 1297 y(*)g(we'll)g(call)g(the)h(function)e
(in)h(that)g(module)g(-)h(and)f(it)200 1411 y(*)g(might)g(be)h(removed)
e(before)h(we)g(are.)200 1525 y(*)200 1638 y(*)g(Another)g(reason)g
(for)g(this)g(is)g(that)g(we)h(can't)f(get)g(sys_open.)200
1752 y(*)g(It's)h(a)f(static)g(variable,)f(so)h(it)h(is)f(not)h
(exported.)e(*/)150 1865 y(asmlinkage)g(int)h
(\(*original_call\)\(const)d(char)j(*,)g(int,)g(int\);)150
2320 y(/*)g(For)h(some)f(reason,)f(in)i(2.2.3)f(current->uid)e(gave)i
(me)200 2433 y(*)g(zero,)g(not)h(the)f(real)g(user)g(ID.)g(I)h(tried)f
(to)g(find)g(what)g(went)200 2547 y(*)g(wrong,)g(but)g(I)h(couldn't)e
(do)i(it)f(in)h(a)f(short)g(time,)g(and)200 2660 y(*)g(I'm)h(lazy)f(-)g
(so)h(I'll)f(just)g(use)g(the)g(system)g(call)g(to)h(get)f(the)200
2774 y(*)g(uid,)h(the)f(way)g(a)h(process)e(would.)200
2887 y(*)200 3001 y(*)h(For)h(some)f(reason,)f(after)h(I)h(recompiled)e
(the)h(kernel)g(this)200 3115 y(*)g(problem)g(went)g(away.)200
3228 y(*/)150 3342 y(asmlinkage)f(int)h(\(*getuid_call\)\(\);)150
3796 y(/*)g(The)h(function)e(we'll)h(replace)f(sys_open)h(\(the)g
(function)200 3910 y(*)g(called)g(when)g(you)g(call)h(the)f(open)g
(system)g(call\))f(with.)h(To)200 4023 y(*)g(find)h(the)f(exact)g
(prototype,)f(with)h(the)g(number)g(and)g(type)200 4137
y(*)g(of)h(arguments,)e(we)h(find)g(the)h(original)e(function)g(first)p
eop
%%Page: 70 74
70 73 bop -100 162 a Fu(*)49 b(\(it's)g(at)h(fs/open.c\).)-100
275 y(*)-100 389 y(*)f(In)h(theory,)e(this)h(means)g(that)g(we're)g
(tied)g(to)h(the)-100 502 y(*)f(current)g(version)f(of)i(the)f(kernel.)
g(In)g(practice,)f(the)-100 616 y(*)h(system)g(calls)g(almost)g(never)g
(change)f(\(it)i(would)e(wreck)h(havoc)-100 730 y(*)g(and)h(require)e
(programs)h(to)g(be)g(recompiled,)f(since)h(the)g(system)-100
843 y(*)g(calls)g(are)h(the)f(interface)f(between)g(the)i(kernel)e(and)
i(the)-100 957 y(*)f(processes\).)-100 1070 y(*/)-150
1184 y(asmlinkage)f(int)h(our_sys_open\(const)e(char)i(*filename,)1245
1297 y(int)g(flags,)1245 1411 y(int)g(mode\))-150 1525
y({)-50 1638 y(int)g(i)h(=)f(0;)-50 1752 y(char)g(ch;)-50
1979 y(/*)g(Check)g(if)g(this)g(is)h(the)f(user)g(we're)g(spying)g(on)g
(*/)-50 2092 y(if)g(\(uid)g(==)h(getuid_call\(\)\))d({)-1
2206 y(/*)j(getuid_call)e(is)h(the)g(getuid)g(system)g(call,)49
2320 y(*)h(which)f(gives)g(the)g(uid)g(of)h(the)f(user)g(who)49
2433 y(*)h(ran)f(the)g(process)g(which)g(called)f(the)i(system)49
2547 y(*)g(call)f(we)g(got)h(*/)49 2774 y(/*)g(Report)e(the)i(file,)f
(if)g(relevant)f(*/)49 2887 y(printk\("Opened)f(file)j(by)f(\045d:)g
(",)h(uid\);)49 3001 y(do)g({)-150 3115 y(#if)f(LINUX_VERSION_CODE)e
(>=)i(KERNEL_VERSION\(2,2,0\))149 3228 y(get_user\(ch,)e(filename+i\);)
-150 3342 y(#else)149 3455 y(ch)i(=)h(get_user\(filename+i\);)-150
3569 y(#endif)149 3682 y(i++;)149 3796 y(printk\("\045c",)d(ch\);)49
3910 y(})j(while)f(\(ch)g(!=)g(0\);)49 4023 y(printk\("\\n"\);)-50
4137 y(})p eop
%%Page: 71 75
71 74 bop 250 275 a Fu(/*)49 b(Call)g(the)g(original)g(sys_open)f(-)i
(otherwise,)e(we)h(lose)299 389 y(*)h(the)f(ability)g(to)g(open)g
(files)g(*/)250 502 y(return)f(original_call\(filename,)e(flags,)j
(mode\);)150 616 y(})150 1070 y(/*)g(Initialize)f(the)i(module)e(-)i
(replace)e(the)i(system)e(call)h(*/)150 1184 y(int)g(init_module\(\))
150 1297 y({)250 1411 y(/*)g(Warning)g(-)g(too)g(late)h(for)f(it)g
(now,)g(but)h(maybe)e(for)299 1525 y(*)i(next)f(time...)g(*/)250
1638 y(printk\("I'm)e(dangerous.)h(I)i(hope)f(you)g(did)h(a)f("\);)250
1752 y(printk\("sync)e(before)i(you)g(insmod'ed)f(me.\\n"\);)250
1865 y(printk\("My)g(counterpart,)f(cleanup_module\(\),)g(is)i
(even"\);)250 1979 y(printk\("more)e(dangerous.)h(If\\n"\);)250
2092 y(printk\("you)f(value)i(your)g(file)g(system,)g(it)g(will)g("\);)
250 2206 y(printk\("be)f(\\"sync;)g(rmmod\\")h(\\n"\);)250
2320 y(printk\("when)e(you)i(remove)g(this)g(module.\\n"\);)250
2547 y(/*)g(Keep)g(a)h(pointer)e(to)i(the)f(original)f(function)h(in)
299 2660 y(*)h(original_call,)d(and)j(then)f(replace)f(the)h(system)g
(call)299 2774 y(*)h(in)g(the)f(system)f(call)i(table)e(with)h
(our_sys_open)f(*/)250 2887 y(original_call)f(=)j
(sys_call_table[__NR_open];)250 3001 y(sys_call_table[__NR_open])45
b(=)k(our_sys_open;)250 3228 y(/*)g(To)h(get)f(the)g(address)g(of)g
(the)g(function)g(for)g(system)299 3342 y(*)h(call)f(foo,)g(go)h(to)f
(sys_call_table[__NR_foo].)c(*/)250 3569 y(printk\("Spying)i(on)i
(UID:\045d\\n",)f(uid\);)250 3796 y(/*)h(Get)g(the)h(system)e(call)h
(for)h(getuid)e(*/)250 3910 y(getuid_call)f(=)j
(sys_call_table[__NR_getuid];)250 4137 y(return)e(0;)p
eop
%%Page: 72 76
72 75 bop -150 162 a Fu(})-150 502 y(/*)49 b(Cleanup)g(-)h(unregister)e
(the)h(appropriate)f(file)h(from)g(/proc)g(*/)-150 616
y(void)g(cleanup_module\(\))-150 730 y({)-50 843 y(/*)g(Return)g(the)g
(system)g(call)g(back)g(to)g(normal)g(*/)-50 957 y(if)g
(\(sys_call_table[__NR_open])c(!=)k(our_sys_open\))f({)49
1070 y(printk\("Somebody)f(else)i(also)g(played)g(with)g(the)g("\);)49
1184 y(printk\("open)f(system)h(call\\n"\);)49 1297 y(printk\("The)f
(system)h(may)g(be)g(left)g(in)h("\);)49 1411 y(printk\("an)e(unstable)
h(state.\\n"\);)-50 1525 y(})-50 1752 y(sys_call_table[__NR_open])c(=)k
(original_call;)-150 1865 y(})p eop
%%Page: 73 77
73 76 bop 150 813 a Fn(Chapter)44 b(8)150 1263 y Fp(Blocking)52
b(Pr)l(ocesses)275 1709 y Fy(What)24 b(do)f(you)g(do)h(when)f(somebody)
f(asks)i(you)f(for)h(something)e(you)h(can')o(t)g(do)h(right)f(a)o(w)o
(ay?)36 b(If)150 1823 y(you')l(re)16 b(a)j(human)d(being)h(and)h(you')l
(re)e(bothered)g(by)i(a)h(human)d(being,)h(the)i(only)e(thing)g(you)g
(can)h(say)h(is:)150 1936 y(`Not)24 b(right)f(no)n(w)-5
b(,)24 b(I'm)f(b)n(usy)-5 b(.)35 b Fg(Go)24 b(away!)p
Fy('.)36 b(But)24 b(if)g(you')l(re)e(a)i(k)o(ernel)g(module)e(and)h
(you')l(re)g(bothered)150 2050 y(by)g(a)g(process,)g(you)f(ha)n(v)o(e)h
(another)e(possibility)-5 b(.)33 b(Y)-9 b(ou)22 b(can)h(put)g(the)g
(process)f(to)i(sleep)f(until)g(you)f(can)150 2163 y(service)k(it.)44
b(After)26 b(all,)i(processes)e(are)g(being)g(put)g(to)g(sleep)h(by)f
(the)g(k)o(ernel)f(and)h(w)o(ok)o(en)g(up)g(all)h(the)150
2277 y(time)20 b(\(that')-5 b(s)21 b(the)f(w)o(ay)g(multiple)g
(processes)g(appear)f(to)h(run)f(on)h(the)g(same)h(time)f(on)g(a)g
(single)h(CPU\).)275 2391 y(This)k(k)o(ernel)f(module)g(is)i(an)f(e)o
(xample)f(of)h(this.)40 b(The)25 b(\002le)h(\(called)e
Fu(/proc/sleep)p Fy(\))f(can)i(only)150 2504 y(be)c(opened)e(by)i(a)g
(single)g(process)g(at)g(a)h(time.)27 b(If)21 b(the)g(\002le)h(is)g
(already)e(open,)g(the)h(k)o(ernel)f(module)g(calls)150
2618 y Fu(module)p 455 2618 25 4 v 29 w(interruptible)p
1134 2618 V 27 w(sleep)p 1411 2618 V 29 w(on)1535 2588
y Fk(1)1572 2618 y Fy(.)29 b(This)22 b(function)e(changes)g(the)i
(status)g(of)f(the)h(task)f(\(a)150 2731 y(task)27 b(is)g(the)f(k)o
(ernel)g(data)g(structure)g(which)f(holds)h(information)e(about)i(a)g
(process)g(and)g(the)g(system)150 2845 y(call)j(it')-5
b(s)30 b(in,)h(if)e(an)o(y\))f(to)h Fu(TASK)p 1102 2845
V 29 w(INTERRUPTIBLE)p Fy(,)e(which)h(means)g(that)h(the)g(task)g(will)
h(not)e(run)150 2958 y(until)23 b(it)g(is)h(w)o(ok)o(en)e(up)h(someho)n
(w)-5 b(,)21 b(and)i(adds)f(it)i(to)f Fu(WaitQ)p Fy(,)f(the)h(queue)f
(of)h(tasks)g(w)o(aiting)g(to)g(access)150 3072 y(the)e(\002le.)28
b(Then,)20 b(the)h(function)f(calls)h(the)h(scheduler)d(to)i(conte)o
(xt)f(switch)i(to)f(a)g(dif)n(ferent)f(process,)g(one)150
3186 y(which)g(has)g(some)g(use)h(for)e(the)h(CPU.)275
3299 y(When)i(a)h(process)f(is)i(done)d(with)i(the)g(\002le,)g(it)h
(closes)f(it,)g(and)f Fu(module)p 2371 3299 V 29 w(close)g
Fy(is)i(called.)32 b(That)150 3413 y(function)24 b(w)o(ak)o(es)h(up)g
(all)h(the)g(processes)f(in)g(the)g(queue)g(\(there')-5
b(s)25 b(no)f(mechanism)h(to)g(only)g(w)o(ak)o(e)g(up)150
3526 y(one)j(of)h(them\).)50 b(It)29 b(then)g(returns)f(and)g(the)h
(process)g(which)f(just)h(closed)g(the)g(\002le)g(can)g(continue)e(to)
150 3640 y(run.)38 b(In)24 b(time,)i(the)e(scheduler)g(decides)g(that)h
(that)f(process)h(has)f(had)h(enough)d(and)i(gi)n(v)o(es)g(control)g
(of)150 3753 y(the)e(CPU)h(to)f(another)f(process.)29
b(Ev)o(entually)-5 b(,)20 b(one)h(of)h(the)g(processes)g(which)f(w)o
(as)i(in)f(the)g(queue)f(will)150 3867 y(be)26 b(gi)n(v)o(en)f(control)
g(of)h(the)h(CPU)g(by)f(the)g(scheduler)-5 b(.)43 b(It)27
b(starts)g(at)g(the)f(point)g(right)f(after)h(the)h(call)f(to)150
3981 y Fu(module)p 455 3981 V 29 w(interruptible)p 1134
3981 V 27 w(sleep)p 1411 3981 V 29 w(on)1556 3950 y Fk(2)1614
3981 y Fy(.)f(It)c(can)f(then)f(proceed)g(to)h(set)h(a)g(global)e(v)n
(ariable)g(to)p 150 4040 1200 4 v 235 4101 a Fi(1)270
4125 y Fh(The)d(easiest)j(w)o(ay)f(to)f(k)o(eep)h(a)f(\002le)h(open)g
(is)f(to)g(open)h(it)f(with)h Fd(tail)39 b(-f)p Fh(.)235
4184 y Fi(2)270 4207 y Fh(This)18 b(means)i(that)g(the)h(process)f(is)f
(still)h(in)g(k)o(ernel)h(mode)e(\227)h(as)f(f)o(ar)h(as)f(the)h
(process)g(is)f(concerned,)j(it)e(issued)g(the)g Fd(open)1608
4456 y Fy(73)p eop
%%Page: 74 78
74 77 bop -150 162 a Fy(tell)22 b(all)h(the)f(other)f(processes)g(that)
h(the)g(\002le)g(is)h(still)g(open)e(and)g(go)h(on)f(with)h(its)h
(life.)30 b(When)22 b(the)f(other)-150 275 y(processes)f(get)g(a)h
(piece)f(of)g(the)g(CPU,)h(the)o(y')o(ll)e(see)i(that)f(global)g(v)n
(ariable)f(and)g(go)h(back)g(to)g(sleep.)-25 389 y(T)-7
b(o)20 b(mak)o(e)g(our)g(life)g(more)g(interesting,)f
Fu(module)p 1433 389 25 4 v 29 w(close)h Fy(doesn')o(t)f(ha)n(v)o(e)g
(a)i(monopoly)d(on)i(w)o(ak-)-150 502 y(ing)h(up)g(the)h(processes)f
(which)f(w)o(ait)j(to)e(access)h(the)g(\002le.)29 b(A)22
b(signal,)f(such)g(as)h(Ctrl-C)h(\()p Fu(SIGINT)p Fy(\))d(can)-150
616 y(also)j(w)o(ak)o(e)f(up)g(a)h(process)619 586 y
Fk(3)655 616 y Fy(.)32 b(In)22 b(that)h(case,)g(we)g(w)o(ant)f(to)h
(return)e(with)i Fu(-EINTR)f Fy(immediately)-5 b(.)29
b(This)-150 730 y(is)21 b(important)e(so)h(users)h(can,)e(for)h(e)o
(xample,)f(kill)h(the)g(process)g(before)f(it)i(recei)n(v)o(es)e(the)h
(\002le.)-25 843 y(There)h(is)i(one)f(more)f(point)h(to)g(remember)-5
b(.)30 b(Some)22 b(times)g(processes)g(don')o(t)f(w)o(ant)h(to)h
(sleep,)f(the)o(y)-150 957 y(w)o(ant)32 b(either)g(to)g(get)g(what)g
(the)o(y)g(w)o(ant)g(immediately)-5 b(,)33 b(or)f(to)g(be)g(told)g(it)h
(cannot)e(be)h(done.)60 b(Such)-150 1070 y(processes)30
b(use)h(the)f Fu(O)p 528 1070 V 30 w(NONBLOCK)f Fy(\003ag)h(when)g
(opening)e(the)j(\002le.)56 b(The)30 b(k)o(ernel)f(is)j(supposed)c(to)
-150 1184 y(respond)14 b(by)h(returning)f(with)i(the)f(error)g(code)g
Fu(-EAGAIN)g Fy(from)f(operations)g(which)h(w)o(ould)g(otherwise)-150
1297 y(block,)21 b(such)h(as)h(opening)d(the)i(\002le)h(in)f(this)g(e)o
(xample.)29 b(The)22 b(program)e(cat)p 2007 1297 V 30
w(noblock,)g(a)n(v)n(ailable)h(in)i(the)-150 1411 y(source)c(directory)
g(for)g(this)i(chapter)m(,)e(can)h(be)g(used)g(to)g(open)f(a)i(\002le)g
(with)f Fu(O)p 2032 1411 V 30 w(NONBLOCK)p Fy(.)-25 1599
y Fl(sleep.c)-150 1776 y Fu(/*)49 b(sleep.c)g(-)h(create)e(a)i(/proc)f
(file,)g(and)g(if)g(several)-100 1889 y(*)g(processes)g(try)g(to)g
(open)g(it)h(at)f(the)g(same)h(time,)e(put)i(all)-100
2003 y(*)f(but)h(one)f(to)g(sleep)g(*/)-150 2344 y(/*)g(Copyright)g
(\(C\))g(1998-99)f(by)i(Ori)f(Pomerantz)f(*/)-150 2685
y(/*)h(The)h(necessary)e(header)h(files)f(*/)-150 2912
y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)-150 3025
y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g(kernel)g
(work)g(*/)-150 3139 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)-150 3366 y(/*)g(Deal)h(with)
f(CONFIG_MODVERSIONS)d(*/)-150 3480 y(#if)j(CONFIG_MODVERSIONS==1)-150
3593 y(#define)g(MODVERSIONS)-150 3707 y(#include)f
(<linux/modversions.h>)-150 3820 y(#endif)p -150 3868
1200 4 v -150 3945 a Fh(system)20 b(call)h(and)f(the)g(system)g(call)h
(hasn')o(t)f(returned)h(yet.)29 b(The)20 b(process)g(doesn')o(t)g(kno)n
(w)h(somebody)f(else)g(used)g(the)g(CPU)g(for)-150 4035
y(most)d(of)g(the)g(time)h(between)h(the)f(moment)f(it)h(issued)f(the)h
(call)h(and)e(the)h(moment)f(it)h(returned.)-65 4094
y Fi(3)-30 4117 y Fh(This)13 b(is)h(because)h(we)f(used)g
Fd(module)p 852 4117 20 4 v 23 w(interruptible)p 1395
4117 V 22 w(sleep)p 1617 4117 V 23 w(on)p Fh(.)19 b(W)-5
b(e)13 b(could)i(ha)o(v)o(e)f(used)g Fd(module)p 2528
4117 V 23 w(sleep)p 2751 4117 V 23 w(on)-150 4207 y Fh(instead,)k(b)o
(ut)g(that)g(w)o(ould)g(ha)o(v)o(e)f(resulted)i(is)e(e)o(xtremely)i
(angry)f(users)f(whose)h(control)g(C')l(s)g(are)f(ignored.)p
eop
%%Page: 75 79
75 78 bop 150 275 a Fu(/*)49 b(Necessary)g(because)f(we)i(use)f(proc)g
(fs)g(*/)150 389 y(#include)f(<linux/proc_fs.h>)150 616
y(/*)h(For)h(putting)e(processes)g(to)i(sleep)f(and)g(waking)g(them)g
(up)g(*/)150 730 y(#include)f(<linux/sched.h>)150 843
y(#include)g(<linux/wrapper.h>)150 1297 y(/*)h(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)49 b(a)200
1411 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e(doesn't)h(-)h(so)f(I)h
(add)f(it)200 1525 y(*)g(here)h(if)f(necessary.)f(*/)150
1638 y(#ifndef)h(KERNEL_VERSION)150 1752 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))150
1865 y(#endif)150 2206 y(#if)k(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))150 2320 y(#include)f(<asm/uaccess.h>)97
b(/*)50 b(for)f(get_user)f(and)h(put_user)g(*/)150 2433
y(#endif)150 2774 y(/*)g(The)h(module's)e(file)h(functions)f
(**********************)e(*/)150 3115 y(/*)j(Here)h(we)f(keep)g(the)g
(last)g(message)g(received,)f(to)h(prove)200 3228 y(*)g(that)h(we)f
(can)g(process)g(our)g(input)g(*/)150 3342 y(#define)g(MESSAGE_LENGTH)e
(80)150 3455 y(static)i(char)g(Message[MESSAGE_LENGTH];)150
3796 y(/*)g(Since)g(we)h(use)f(the)g(file)g(operations)f(struct,)h(we)g
(can't)g(use)200 3910 y(*)g(the)h(special)e(proc)h(output)g(provisions)
f(-)i(we)f(have)g(to)g(use)200 4023 y(*)g(a)h(standard)e(read)h
(function,)g(which)f(is)i(this)f(function)f(*/)150 4137
y(#if)h(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))p
eop
%%Page: 76 80
76 79 bop -150 162 a Fu(static)49 b(ssize_t)f(module_output\()49
275 y(struct)h(file)g(*file,)148 b(/*)50 b(The)f(file)g(read)g(*/)49
389 y(char)g(*buf,)g(/*)h(The)f(buffer)g(to)g(put)g(data)g(to)h(\(in)f
(the)647 502 y(*)h(user)f(segment\))f(*/)49 616 y(size_t)h(len,)99
b(/*)49 b(The)h(length)e(of)i(the)f(buffer)g(*/)49 730
y(loff_t)g(*offset\))f(/*)i(Offset)e(in)i(the)f(file)g(-)h(ignore)e(*/)
-150 843 y(#else)-150 957 y(static)h(int)g(module_output\()49
1070 y(struct)g(inode)g(*inode,)f(/*)i(The)f(inode)g(read)g(*/)49
1184 y(struct)g(file)g(*file,)148 b(/*)50 b(The)f(file)g(read)g(*/)49
1297 y(char)g(*buf,)g(/*)h(The)f(buffer)g(to)g(put)g(data)g(to)h(\(in)f
(the)647 1411 y(*)h(user)f(segment\))f(*/)49 1525 y(int)i(len\))98
b(/*)50 b(The)f(length)g(of)g(the)g(buffer)g(*/)-150
1638 y(#endif)-150 1752 y({)-50 1865 y(static)f(int)i(finished)e(=)i
(0;)-50 1979 y(int)f(i;)-50 2092 y(char)g(message[MESSAGE_LENGTH+30];)
-50 2320 y(/*)g(Return)g(0)g(to)h(signify)e(end)i(of)f(file)g(-)h(that)
f(we)g(have)-1 2433 y(*)h(nothing)f(more)g(to)g(say)g(at)h(this)f
(point.)g(*/)-50 2547 y(if)g(\(finished\))f({)49 2660
y(finished)h(=)g(0;)49 2774 y(return)g(0;)-50 2887 y(})-50
3115 y(/*)g(If)h(you)f(don't)g(understand)f(this)h(by)g(now,)g(you're)
-1 3228 y(*)h(hopeless)e(as)i(a)f(kernel)99 b(programmer.)48
b(*/)-50 3342 y(sprintf\(message,)e("Last)j(input:\045s\\n",)f
(Message\);)-50 3455 y(for\(i=0;)g(i<len)h(&&)g(message[i];)f(i++\))49
3569 y(put_user\(message[i],)e(buf+i\);)-50 3796 y(finished)i(=)i(1;)
-50 3910 y(return)e(i;)100 b(/*)49 b(Return)g(the)g(number)g(of)g
(bytes)g("read")g(*/)-150 4023 y(})p eop
%%Page: 77 81
77 80 bop 150 275 a Fu(/*)49 b(This)h(function)e(receives)g(input)h
(from)g(the)g(user)g(when)200 389 y(*)g(the)h(user)f(writes)f(to)i(the)
f(/proc)g(file.)g(*/)150 502 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))150 616 y(static)g(ssize_t)f(module_input\()
349 730 y(struct)h(file)g(*file,)148 b(/*)50 b(The)f(file)g(itself)g
(*/)349 843 y(const)g(char)g(*buf,)248 b(/*)50 b(The)f(buffer)g(with)g
(input)g(*/)349 957 y(size_t)g(length,)347 b(/*)50 b(The)f(buffer's)f
(length)h(*/)349 1070 y(loff_t)g(*offset\))297 b(/*)50
b(offset)e(to)i(file)f(-)h(ignore)e(*/)150 1184 y(#else)150
1297 y(static)h(int)g(module_input\()349 1411 y(struct)g(inode)g
(*inode,)f(/*)i(The)f(file's)g(inode)g(*/)349 1525 y(struct)g(file)g
(*file,)148 b(/*)50 b(The)f(file)g(itself)g(*/)349 1638
y(const)g(char)g(*buf,)248 b(/*)50 b(The)f(buffer)g(with)g(the)g(input)
g(*/)349 1752 y(int)h(length\))496 b(/*)50 b(The)f(buffer's)f(length)h
(*/)150 1865 y(#endif)150 1979 y({)250 2092 y(int)g(i;)250
2320 y(/*)g(Put)g(the)h(input)e(into)i(Message,)e(where)h
(module_output)299 2433 y(*)h(will)f(later)g(be)g(able)h(to)f(use)g(it)
h(*/)250 2547 y(for\(i=0;)e(i<MESSAGE_LENGTH-1)e(&&)k(i<length;)e
(i++\))150 2660 y(#if)h(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))399 2774 y(get_user\(Message[i],)d(buf+i\);)
150 2887 y(#else)250 3001 y(Message[i])i(=)h(get_user\(buf+i\);)150
3115 y(#endif)150 3228 y(/*)g(we)h(want)f(a)h(standard,)e(zero)h
(terminated)f(string)g(*/)250 3342 y(Message[i])g(=)h('\\0';)250
3569 y(/*)g(We)h(need)f(to)g(return)g(the)g(number)g(of)g(input)299
3682 y(*)h(characters)e(used)h(*/)250 3796 y(return)f(i;)150
3910 y(})150 4137 y(/*)h(1)h(if)g(the)f(file)g(is)g(currently)f(open)h
(by)h(somebody)e(*/)p eop
%%Page: 78 82
78 81 bop -150 162 a Fu(int)49 b(Already_Open)f(=)h(0;)-150
389 y(/*)g(Queue)g(of)h(processes)e(who)h(want)g(our)g(file)h(*/)-150
502 y(static)f(struct)f(wait_queue)g(*WaitQ)h(=)h(NULL;)-150
843 y(/*)f(Called)g(when)g(the)g(/proc)g(file)g(is)h(opened)f(*/)-150
957 y(static)g(int)g(module_open\(struct)d(inode)j(*inode,)996
1070 y(struct)f(file)h(*file\))-150 1184 y({)-50 1297
y(/*)g(If)h(the)f(file's)f(flags)h(include)g(O_NONBLOCK,)f(it)h(means)
-1 1411 y(*)h(the)f(process)g(doesn't)f(want)h(to)h(wait)f(for)g(the)g
(file.)-1 1525 y(*)h(In)g(this)f(case,)f(if)i(the)f(file)g(is)h
(already)e(open,)h(we)-1 1638 y(*)h(should)f(fail)g(with)g(-EAGAIN,)f
(meaning)h("you'll)f(have)h(to)-1 1752 y(*)h(try)f(again",)g(instead)f
(of)i(blocking)e(a)i(process)e(which)-1 1865 y(*)i(would)f(rather)g
(stay)g(awake.)f(*/)-50 1979 y(if)h(\(\(file->f_flags)e(&)j
(O_NONBLOCK\))d(&&)j(Already_Open\))49 2092 y(return)f(-EAGAIN;)-50
2320 y(/*)g(This)g(is)h(the)f(correct)f(place)h(for)g
(MOD_INC_USE_COUNT)-1 2433 y(*)h(because)f(if)g(a)h(process)e(is)i(in)f
(the)g(loop,)g(which)g(is)-1 2547 y(*)h(within)f(the)g(kernel)g
(module,)f(the)h(kernel)g(module)g(must)-1 2660 y(*)h(not)f(be)h
(removed.)e(*/)-50 2774 y(MOD_INC_USE_COUNT;)-50 3001
y(/*)h(If)h(the)f(file)g(is)g(already)g(open,)g(wait)g(until)g(it)g
(isn't)g(*/)-50 3115 y(while)g(\(Already_Open\))-50 3228
y({)-150 3342 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))49 3455 y(int)h(i,)f(is_sig=0;)-150
3569 y(#endif)49 3796 y(/*)h(This)f(function)f(puts)h(the)g(current)g
(process,)99 3910 y(*)h(including)e(any)h(system)g(calls,)f(such)i(as)f
(us,)g(to)h(sleep.)99 4023 y(*)g(Execution)e(will)h(be)g(resumed)g
(right)g(after)g(the)g(function)99 4137 y(*)h(call,)f(either)f(because)
h(somebody)f(called)p eop
%%Page: 79 83
79 82 bop 399 162 a Fu(*)50 b(wake_up\(&WaitQ\))d(\(only)i
(module_close)e(does)i(that,)399 275 y(*)h(when)f(the)g(file)g(is)h
(closed\))e(or)h(when)h(a)f(signal,)g(such)399 389 y(*)h(as)f(Ctrl-C,)g
(is)g(sent)g(to)h(the)f(process)f(*/)349 502 y
(module_interruptible_sleep_on\(&WaitQ\))o(;)349 730
y(/*)i(If)f(we)h(woke)f(up)g(because)g(we)g(got)g(a)h(signal)f(we're)f
(not)399 843 y(*)i(blocking,)e(return)98 b(-EINTR)49
b(\(fail)g(the)g(system)g(call\).)399 957 y(*)h(This)f(allows)f
(processes)h(to)g(be)g(killed)g(or)h(stopped.)e(*/)150
1411 y(/*)200 1525 y(*)h(Emmanuel)g(Papirakis:)200 1638
y(*)200 1752 y(*)g(This)h(is)f(a)h(little)e(update)h(to)g(work)g(with)h
(2.2.*.)e(Signals)200 1865 y(*)h(now)h(are)f(contained)f(in)i(two)f
(words)g(\(64)g(bits\))g(and)g(are)200 1979 y(*)g(stored)g(in)h(a)f
(structure)f(that)h(contains)g(an)g(array)g(of)g(two)200
2092 y(*)g(unsigned)g(longs.)f(We)i(now)f(have)g(to)h(make)f(2)g
(checks)g(in)g(our)h(if.)200 2206 y(*)200 2320 y(*)f(Ori)h(Pomerantz:)
200 2433 y(*)200 2547 y(*)f(Nobody)g(promised)f(me)i(they'll)e(never)h
(use)h(more)f(than)g(64)200 2660 y(*)g(bits,)g(or)h(that)f(this)g(book)
g(won't)g(be)g(used)g(for)h(a)f(version)200 2774 y(*)g(of)h(Linux)f
(with)g(a)g(word)h(size)f(of)g(16)g(bits.)g(This)g(code)200
2887 y(*)g(would)g(work)g(in)h(any)f(case.)200 3001 y(*/)150
3115 y(#if)g(LINUX_VERSION_CODE)e(>=)i(KERNEL_VERSION\(2,2,0\))349
3342 y(for\(i=0;)g(i<_NSIG_WORDS)e(&&)i(!is_sig;)g(i++\))449
3455 y(is_sig)g(=)g(current->signal.sig[i])d(&)549 3569
y(\230current->blocked.sig[i];)349 3682 y(if)k(\(is_sig\))e({)150
3796 y(#else)349 3910 y(if)i(\(current->signal)d(&)i
(\230current->blocked\))e({)150 4023 y(#endif)449 4137
y(/*)i(It's)g(important)g(to)g(put)g(MOD_DEC_USE_COUNT)e(here,)p
eop
%%Page: 80 84
80 83 bop 199 162 a Fu(*)49 b(because)g(for)g(processes)f(where)h(the)g
(open)g(is)199 275 y(*)g(interrupted)f(there)h(will)g(never)g(be)g(a)h
(corresponding)199 389 y(*)f(close.)g(If)g(we)h(don't)f(decrement)f
(the)h(usage)g(count)199 502 y(*)g(here,)g(we)h(will)f(be)g(left)g
(with)g(a)h(positive)e(usage)199 616 y(*)h(count)g(which)g(we'll)g
(have)g(no)g(way)h(to)f(bring)g(down)g(to)199 730 y(*)g(zero,)g(giving)
g(us)g(an)h(immortal)e(module,)h(which)f(can)199 843
y(*)h(only)g(be)h(killed)f(by)g(rebooting)f(the)h(machine.)g(*/)149
957 y(MOD_DEC_USE_COUNT;)149 1070 y(return)g(-EINTR;)49
1184 y(})-50 1297 y(})-50 1525 y(/*)g(If)h(we)f(got)g(here,)g
(Already_Open)f(must)h(be)g(zero)g(*/)-50 1752 y(/*)g(Open)g(the)g
(file)g(*/)-50 1865 y(Already_Open)e(=)j(1;)-50 1979
y(return)e(0;)100 b(/*)49 b(Allow)g(the)g(access)g(*/)-150
2092 y(})-150 2547 y(/*)g(Called)g(when)g(the)g(/proc)g(file)g(is)h
(closed)f(*/)-150 2660 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))-150 2774 y(int)g(module_close\(struct)e
(inode)h(*inode,)h(struct)g(file)g(*file\))-150 2887
y(#else)-150 3001 y(void)g(module_close\(struct)d(inode)j(*inode,)g
(struct)f(file)h(*file\))-150 3115 y(#endif)-150 3228
y({)-50 3342 y(/*)g(Set)g(Already_Open)f(to)h(zero,)g(so)h(one)f(of)g
(the)h(processes)-1 3455 y(*)g(in)g(the)f(WaitQ)g(will)g(be)g(able)g
(to)h(set)f(Already_Open)e(back)-1 3569 y(*)j(to)g(one)f(and)g(to)g
(open)h(the)f(file.)g(All)g(the)g(other)g(processes)-1
3682 y(*)h(will)f(be)h(called)e(when)h(Already_Open)f(is)h(back)g(to)h
(one,)f(so)-1 3796 y(*)h(they'll)f(go)g(back)g(to)h(sleep.)e(*/)-50
3910 y(Already_Open)f(=)j(0;)-50 4137 y(/*)f(Wake)g(up)h(all)f(the)g
(processes)f(in)i(WaitQ,)e(so)i(if)f(anybody)p eop
%%Page: 81 85
81 84 bop 299 162 a Fu(*)50 b(is)g(waiting)e(for)h(the)h(file,)e(they)h
(can)h(have)f(it.)g(*/)250 275 y(module_wake_up\(&WaitQ\);)250
502 y(MOD_DEC_USE_COUNT;)150 730 y(#if)g(LINUX_VERSION_CODE)e(>=)i
(KERNEL_VERSION\(2,2,0\))250 843 y(return)f(0;)100 b(/*)49
b(success)g(*/)150 957 y(#endif)150 1070 y(})150 1638
y(/*)g(This)h(function)e(decides)g(whether)h(to)g(allow)g(an)h
(operation)200 1752 y(*)f(\(return)g(zero\))g(or)g(not)h(allow)e(it)i
(\(return)e(a)i(non-zero)200 1865 y(*)f(which)g(indicates)f(why)i(it)f
(is)h(not)f(allowed\).)200 1979 y(*)200 2092 y(*)g(The)h(operation)e
(can)h(be)h(one)f(of)g(the)g(following)g(values:)200
2206 y(*)g(0)h(-)g(Execute)e(\(run)h(the)h("file")e(-)i(meaningless)e
(in)h(our)g(case\))200 2320 y(*)g(2)h(-)g(Write)f(\(input)f(to)i(the)f
(kernel)g(module\))200 2433 y(*)g(4)h(-)g(Read)f(\(output)f(from)h(the)
h(kernel)e(module\))200 2547 y(*)200 2660 y(*)h(This)h(is)f(the)g(real)
g(function)g(that)g(checks)f(file)200 2774 y(*)h(permissions.)f(The)h
(permissions)f(returned)g(by)i(ls)f(-l)h(are)200 2887
y(*)f(for)h(referece)e(only,)h(and)g(can)g(be)h(overridden)e(here.)200
3001 y(*/)150 3115 y(static)h(int)g(module_permission\(struct)c(inode)k
(*inode,)g(int)g(op\))150 3228 y({)250 3342 y(/*)g(We)h(allow)e
(everybody)h(to)g(read)g(from)g(our)g(module,)g(but)299
3455 y(*)h(only)f(root)g(\(uid)g(0\))h(may)f(write)g(to)g(it)h(*/)250
3569 y(if)f(\(op)g(==)h(4)f(||)h(\(op)f(==)h(2)f(&&)h(current->euid)d
(==)i(0\)\))349 3682 y(return)g(0;)250 3910 y(/*)g(If)h(it's)f
(anything)f(else,)h(access)f(is)i(denied)f(*/)250 4023
y(return)f(-EACCES;)150 4137 y(})p eop
%%Page: 82 86
82 85 bop -150 389 a Fu(/*)49 b(Structures)f(to)i(register)e(as)i(the)f
(/proc)g(file,)g(with)-100 502 y(*)g(pointers)g(to)g(all)g(the)h
(relevant)e(functions.)g(***********)g(*/)-150 843 y(/*)h(File)h
(operations)d(for)j(our)f(proc)g(file.)g(This)g(is)g(where)-100
957 y(*)g(we)h(place)f(pointers)f(to)i(all)f(the)g(functions)f(called)h
(when)-100 1070 y(*)g(somebody)g(tries)g(to)g(do)h(something)e(to)h
(our)g(file.)g(NULL)-100 1184 y(*)g(means)g(we)h(don't)f(want)g(to)g
(deal)g(with)g(something.)f(*/)-150 1297 y(static)h(struct)f
(file_operations)f(File_Ops_4_Our_Proc_File)f(=)-50 1411
y({)49 1525 y(NULL,)99 b(/*)49 b(lseek)g(*/)49 1638 y(module_output,)97
b(/*)50 b("read")e(from)h(the)h(file)f(*/)49 1752 y(module_input,)147
b(/*)50 b("write")e(to)i(the)f(file)g(*/)49 1865 y(NULL,)99
b(/*)49 b(readdir)g(*/)49 1979 y(NULL,)99 b(/*)49 b(select)g(*/)49
2092 y(NULL,)99 b(/*)49 b(ioctl)g(*/)49 2206 y(NULL,)99
b(/*)49 b(mmap)g(*/)49 2320 y(module_open,/*)e(called)i(when)g(the)g
(/proc)g(file)g(is)h(opened)f(*/)-150 2433 y(#if)g(LINUX_VERSION_CODE)e
(>=)i(KERNEL_VERSION\(2,2,0\))49 2547 y(NULL,)149 b(/*)49
b(flush)g(*/)-150 2660 y(#endif)49 2774 y(module_close)297
b(/*)49 b(called)g(when)g(it's)g(classed)g(*/)-50 2887
y(};)-150 3342 y(/*)g(Inode)g(operations)f(for)i(our)f(proc)g(file.)g
(We)g(need)g(it)h(so)-100 3455 y(*)f(we'll)g(have)g(somewhere)g(to)g
(specify)f(the)i(file)f(operations)-100 3569 y(*)g(structure)g(we)g
(want)g(to)h(use,)f(and)g(the)g(function)f(we)i(use)f(for)-100
3682 y(*)g(permissions.)f(It's)h(also)g(possible)f(to)i(specify)e
(functions)-100 3796 y(*)h(to)h(be)f(called)g(for)g(anything)g(else)g
(which)g(could)f(be)i(done)f(to)g(an)-100 3910 y(*)g(inode)g
(\(although)f(we)i(don't)f(bother,)f(we)i(just)f(put)g(NULL\).)g(*/)
-150 4023 y(static)g(struct)f(inode_operations)f
(Inode_Ops_4_Our_Proc_File)e(=)-50 4137 y({)p eop
%%Page: 83 87
83 86 bop 349 162 a Fu(&File_Ops_4_Our_Proc_File,)349
275 y(NULL,)49 b(/*)h(create)e(*/)349 389 y(NULL,)h(/*)h(lookup)e(*/)
349 502 y(NULL,)h(/*)h(link)f(*/)349 616 y(NULL,)g(/*)h(unlink)e(*/)349
730 y(NULL,)h(/*)h(symlink)e(*/)349 843 y(NULL,)h(/*)h(mkdir)e(*/)349
957 y(NULL,)h(/*)h(rmdir)e(*/)349 1070 y(NULL,)h(/*)h(mknod)e(*/)349
1184 y(NULL,)h(/*)h(rename)e(*/)349 1297 y(NULL,)h(/*)h(readlink)e(*/)
349 1411 y(NULL,)h(/*)h(follow_link)d(*/)349 1525 y(NULL,)i(/*)h
(readpage)e(*/)349 1638 y(NULL,)h(/*)h(writepage)e(*/)349
1752 y(NULL,)h(/*)h(bmap)f(*/)349 1865 y(NULL,)g(/*)h(truncate)e(*/)349
1979 y(module_permission)f(/*)i(check)g(for)g(permissions)f(*/)250
2092 y(};)150 2320 y(/*)h(Directory)g(entry)f(*/)150
2433 y(static)h(struct)f(proc_dir_entry)g(Our_Proc_File)f(=)250
2547 y({)349 2660 y(0,)j(/*)f(Inode)g(number)g(-)g(ignore,)g(it)g(will)
g(be)h(filled)e(by)549 2774 y(*)h(proc_register[_dynamic])d(*/)349
2887 y(5,)k(/*)f(Length)g(of)g(the)h(file)f(name)g(*/)349
3001 y("sleep",)g(/*)g(The)g(file)g(name)g(*/)349 3115
y(S_IFREG)g(|)g(S_IRUGO)g(|)h(S_IWUSR,)349 3228 y(/*)g(File)f(mode)g(-)
g(this)h(is)f(a)h(regular)e(file)h(which)399 3342 y(*)h(can)f(be)g
(read)g(by)h(its)f(owner,)g(its)g(group,)g(and)g(everybody)399
3455 y(*)h(else.)f(Also,)f(its)i(owner)f(can)g(write)g(to)g(it.)399
3569 y(*)399 3682 y(*)h(Actually,)e(this)h(field)g(is)g(just)g(for)h
(reference,)d(it's)399 3796 y(*)j(module_permission)c(that)j(does)g
(the)h(actual)e(check.)h(It)399 3910 y(*)h(could)f(use)g(this)g(field,)
g(but)g(in)g(our)h(implementation)d(it)399 4023 y(*)j(doesn't,)e(for)h
(simplicity.)f(*/)349 4137 y(1,)100 b(/*)49 b(Number)g(of)g(links)g
(\(directories)f(where)g(the)p eop
%%Page: 84 88
84 87 bop 298 162 a Fu(*)50 b(file)f(is)g(referenced\))f(*/)49
275 y(0,)i(0,)99 b(/*)49 b(The)h(uid)f(and)g(gid)g(for)h(the)f(file)g
(-)h(we)f(give)448 389 y(*)g(it)h(to)f(root)g(*/)49 502
y(80,)h(/*)f(The)g(size)g(of)h(the)f(file)g(reported)f(by)i(ls.)f(*/)49
616 y(&Inode_Ops_4_Our_Proc_File,)49 730 y(/*)h(A)f(pointer)g(to)g(the)
h(inode)e(structure)h(for)99 843 y(*)h(the)f(file,)g(if)g(we)h(need)f
(it.)g(In)g(our)h(case)f(we)99 957 y(*)h(do,)f(because)f(we)i(need)f(a)
h(write)e(function.)h(*/)49 1070 y(NULL)99 b(/*)50 b(The)f(read)g
(function)f(for)h(the)h(file.)398 1184 y(*)g(Irrelevant,)d(because)i
(we)g(put)h(it)398 1297 y(*)g(in)f(the)g(inode)g(structure)f(above)h
(*/)-50 1411 y(};)-150 1865 y(/*)g(Module)g(initialization)e(and)j
(cleanup)e(****************)f(*/)-150 2206 y(/*)i(Initialize)f(the)i
(module)e(-)i(register)e(the)i(proc)f(file)g(*/)-150
2320 y(int)g(init_module\(\))-150 2433 y({)-50 2547 y(/*)g(Success)g
(if)g(proc_register_dynamic)d(is)j(a)h(success,)-1 2660
y(*)g(failure)f(otherwise)f(*/)-150 2774 y(#if)h(LINUX_VERSION_CODE)e
(>=)i(KERNEL_VERSION\(2,2,0\))-50 2887 y(return)f
(proc_register\(&proc_root,)d(&Our_Proc_File\);)-150
3001 y(#else)-50 3115 y(return)j(proc_register_dynamic\(&proc_root,)c
(&Our_Proc_File\);)-150 3228 y(#endif)-50 3455 y(/*)49
b(proc_root)f(is)i(the)f(root)g(directory)f(for)h(the)h(proc)-1
3569 y(*)g(fs)g(\(/proc\).)e(This)h(is)g(where)g(we)h(want)f(our)g
(file)g(to)g(be)-1 3682 y(*)h(located.)-1 3796 y(*/)-150
3910 y(})p eop
%%Page: 85 89
85 88 bop 150 162 a Fu(/*)49 b(Cleanup)g(-)h(unregister)e(our)h(file)g
(from)g(/proc.)g(This)g(could)200 275 y(*)g(get)h(dangerous)e(if)h
(there)g(are)g(still)g(processes)f(waiting)h(in)200 389
y(*)g(WaitQ,)g(because)g(they)g(are)g(inside)g(our)g(open)g(function,)
200 502 y(*)g(which)g(will)g(get)h(unloaded.)e(I'll)h(explain)f(how)i
(to)f(avoid)200 616 y(*)g(removal)g(of)g(a)h(kernel)f(module)f(in)i
(such)f(a)h(case)f(in)200 730 y(*)g(chapter)g(10.)g(*/)150
843 y(void)g(cleanup_module\(\))150 957 y({)250 1070
y(proc_unregister\(&proc_root,)44 b(Our_Proc_File.low_ino\);)150
1184 y(})p eop
%%Page: 86 90
86 89 bop -150 813 a Fn(Chapter)44 b(9)-150 1263 y Fp(Replacing)52
b(printk')-8 b(s)-25 1709 y Fy(In)21 b(the)h(be)o(ginning)d(\(chapter)i
(1\),)h(I)g(said)g(that)g(X)g(and)g(k)o(ernel)f(module)f(programming)f
(don')o(t)h(mix.)-150 1823 y(That')-5 b(s)26 b(true)g(while)g(de)n(v)o
(eloping)d(the)j(k)o(ernel)f(module,)h(b)n(ut)g(in)g(actual)g(use)g
(you)f(w)o(ant)h(to)h(be)f(able)f(to)-150 1936 y(send)18
b(messages)h(to)g(whiche)n(v)o(er)e(tty)888 1906 y Fk(1)944
1936 y Fy(the)i(command)d(to)j(the)g(module)e(came)h(from.)24
b(This)19 b(is)g(important)-150 2050 y(for)24 b(identifying)g(errors)g
(after)h(the)g(k)o(ernel)f(module)g(is)i(released,)g(because)e(it)i
(will)g(be)f(used)g(through)-150 2163 y(all)c(of)f(them.)-25
2277 y(The)i(w)o(ay)g(this)h(is)g(done)f(is)h(by)f(using)g
Fu(current)p Fy(,)g(a)h(pointer)e(to)i(the)f(currently)f(running)f
(task,)j(to)-150 2391 y(get)f(the)g(current)f(task')-5
b(s)23 b(tty)f(structure.)30 b(Then,)21 b(we)h(look)g(inside)g(that)g
(tty)g(structure)f(to)h(\002nd)g(a)h(pointer)-150 2504
y(to)d(a)h(string)f(write)g(function,)e(which)i(we)h(use)f(to)g(write)h
(a)f(string)g(to)h(the)f(tty)-5 b(.)-25 2692 y Fl(printk.c)-150
2879 y Fu(/*)49 b(printk.c)g(-)g(send)g(textual)g(output)g(to)g(the)g
(tty)h(you're)-100 2993 y(*)f(running)g(on,)g(regardless)f(of)i
(whether)e(it's)h(passed)-100 3106 y(*)g(through)g(X11,)g(telnet,)g
(etc.)g(*/)-150 3447 y(/*)g(Copyright)g(\(C\))g(1998)g(by)g(Ori)h
(Pomerantz)e(*/)-150 3788 y(/*)h(The)h(necessary)e(header)h(files)f(*/)
p -150 3950 1200 4 v -65 4004 a Fi(1)-30 4027 y Fc(T)p
Fh(ele)p Fc(ty)p Fh(pe,)18 b(originally)i(a)d(combination)i(k)o(e)o
(yboard\226printer)j(used)17 b(to)g(communicate)i(with)e(a)g(Unix)h
(system,)e(and)h(today)h(an)-150 4117 y(abstraction)g(for)d(the)g(te)o
(xt)h(stream)g(used)f(for)g(a)f(Unix)i(program,)f(whether)h(it')l(s)g
(a)f(physical)h(terminal,)h(an)e(xterm)h(on)e(an)h(X)g(display)l(,)-150
4207 y(a)i(netw)o(ork)i(connection)h(used)d(with)h(telnet,)h(etc.)1308
4456 y Fy(86)p eop
%%Page: 87 91
87 90 bop 150 162 a Fu(/*)49 b(Standard)g(in)g(kernel)g(modules)f(*/)
150 275 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)150 389 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)150 616 y(/*)g(Deal)h(with)f
(CONFIG_MODVERSIONS)d(*/)150 730 y(#if)j(CONFIG_MODVERSIONS==1)150
843 y(#define)g(MODVERSIONS)150 957 y(#include)f(<linux/modversions.h>)
150 1070 y(#endif)150 1297 y(/*)h(Necessary)g(here)g(*/)150
1411 y(#include)f(<linux/sched.h>)197 b(/*)49 b(For)g(current)g(*/)150
1525 y(#include)f(<linux/tty.h>)297 b(/*)49 b(For)g(the)h(tty)f
(declarations)f(*/)150 1865 y(/*)h(Print)g(the)h(string)e(to)i(the)f
(appropriate)f(tty,)h(the)g(one)200 1979 y(*)g(the)h(current)e(task)h
(uses)g(*/)150 2092 y(void)g(print_string\(char)e(*str\))150
2206 y({)250 2320 y(struct)h(tty_struct)g(*my_tty;)250
2547 y(/*)h(The)g(tty)h(for)f(the)g(current)g(task)g(*/)250
2660 y(my_tty)f(=)i(current->tty;)250 2887 y(/*)f(If)h(my_tty)e(is)i
(NULL,)f(it)g(means)g(that)g(the)g(current)g(task)299
3001 y(*)h(has)f(no)h(tty)f(you)g(can)h(print)e(to)i(\(this)f(is)g
(possible,)f(for)299 3115 y(*)i(example,)e(if)i(it's)f(a)h(daemon\).)e
(In)h(this)g(case,)g(there's)299 3228 y(*)h(nothing)f(we)g(can)g(do.)h
(*/)250 3342 y(if)f(\(my_tty)g(!=)g(NULL\))g({)349 3569
y(/*)h(my_tty->driver)d(is)i(a)h(struct)f(which)g(holds)f(the)i(tty's)
399 3682 y(*)g(functions,)e(one)h(of)g(which)g(\(write\))g(is)g(used)g
(to)399 3796 y(*)h(write)f(strings)f(to)i(the)f(tty.)g(It)g(can)h(be)f
(used)g(to)g(take)399 3910 y(*)h(a)f(string)g(either)g(from)g(the)g
(user's)g(memory)f(segment)399 4023 y(*)i(or)f(the)g(kernel's)g(memory)
f(segment.)399 4137 y(*)p eop
%%Page: 88 92
88 91 bop 99 162 a Fu(*)50 b(The)f(function's)f(first)h(parameter)f(is)
h(the)h(tty)f(to)99 275 y(*)h(write)f(to,)g(because)f(the)99
b(same)49 b(function)g(would)99 389 y(*)h(normally)e(be)h(used)h(for)f
(all)g(tty's)g(of)g(a)h(certain)e(type.)99 502 y(*)i(The)f(second)g
(parameter)f(controls)g(whether)h(the)99 616 y(*)h(function)e(receives)
g(a)i(string)f(from)g(kernel)f(memory)99 730 y(*)i(\(false,)e(0\))i(or)
f(from)g(user)g(memory)g(\(true,)g(non)g(zero\).)99 843
y(*)h(The)f(third)g(parameter)f(is)h(a)h(pointer)f(to)g(a)h(string,)99
957 y(*)g(and)f(the)g(fourth)g(parameter)f(is)h(the)h(length)e(of)99
1070 y(*)i(the)f(string.)99 1184 y(*/)49 1297 y
(\(*\(my_tty->driver\).write\)\()249 1411 y(my_tty,)f(/*)h(The)h(tty)f
(itself)g(*/)249 1525 y(0,)g(/*)g(We)h(don't)f(take)g(the)g(string)g
(from)g(user)g(space)g(*/)-150 1638 y(str,)g(/*)h(String)e(*/)-150
1752 y(strlen\(str\)\);)97 b(/*)50 b(Length)e(*/)49 1979
y(/*)i(ttys)f(were)g(originally)f(hardware)g(devices,)g(which)99
2092 y(*)i(\(usually\))e(adhered)g(strictly)h(to)g(the)g(ASCII)g
(standard.)99 2206 y(*)h(According)e(to)h(ASCII,)g(to)g(move)g(to)h(a)g
(new)f(line)g(you)99 2320 y(*)h(need)f(two)g(characters,)f(a)h
(carriage)g(return)f(and)i(a)99 2433 y(*)g(line)f(feed.)g(In)g(Unix,)g
(on)g(the)h(other)f(hand,)f(the)99 2547 y(*)i(ASCII)f(line)g(feed)g(is)
g(used)g(for)g(both)h(purposes)e(-)h(so)99 2660 y(*)h(we)f(can't)g
(just)g(use)g(\\n,)h(because)e(it)i(wouldn't)e(have)99
2774 y(*)i(a)f(carriage)g(return)f(and)i(the)f(next)g(line)g(will)99
2887 y(*)h(start)f(at)g(the)g(column)g(right)99 3001
y(*)1295 b(after)49 b(the)g(line)g(feed.)99 3115 y(*)99
3228 y(*)h(BTW,)f(this)g(is)g(the)h(reason)e(why)h(the)h(text)f(file)99
3342 y(*)100 b(is)49 b(different)f(between)h(Unix)g(and)g(Windows.)99
3455 y(*)h(In)f(CP/M)g(and)g(its)h(derivatives,)d(such)i(as)h(MS-DOS)e
(and)99 3569 y(*)i(Windows,)e(the)h(ASCII)g(standard)f(was)i(strictly)
99 3682 y(*)g(adhered)e(to,)h(and)h(therefore)e(a)h(new)h(line)f
(requires)99 3796 y(*)h(both)f(a)g(line)g(feed)h(and)f(a)g(carriage)g
(return.)99 3910 y(*/)49 4023 y(\(*\(my_tty->driver\).write\)\()149
4137 y(my_tty,)p eop
%%Page: 89 93
89 92 bop 449 162 a Fu(0,)449 275 y("\\015\\012",)449
389 y(2\);)250 502 y(})150 616 y(})150 957 y(/*)49 b(Module)g
(initialization)e(and)j(cleanup)e(******************)f(*/)150
1297 y(/*)i(Initialize)f(the)i(module)e(-)i(register)e(the)i(proc)f
(file)g(*/)150 1411 y(int)g(init_module\(\))150 1525
y({)250 1638 y(print_string\("Module)d(Inserted"\);)250
1865 y(return)i(0;)150 1979 y(})150 2320 y(/*)h(Cleanup)g(-)h
(unregister)e(our)h(file)g(from)g(/proc)g(*/)150 2433
y(void)g(cleanup_module\(\))150 2547 y({)250 2660 y
(print_string\("Module)d(Removed"\);)150 2774 y(})p eop
%%Page: 90 94
90 93 bop -150 813 a Fn(Chapter)44 b(10)-150 1263 y Fp(Scheduling)51
b(T)-19 b(asks)-25 1709 y Fy(V)-9 b(ery)23 b(often,)i(we)g(ha)n(v)o(e)f
(`housek)o(eeping')d(tasks)k(which)f(ha)n(v)o(e)g(to)g(be)h(done)e(at)i
(a)g(certain)f(time,)i(or)-150 1823 y(e)n(v)o(ery)17
b(so)i(often.)24 b(If)18 b(the)h(task)g(is)g(to)g(be)g(done)e(by)h(a)h
(process,)g(we)f(do)h(it)g(by)f(putting)g(it)h(in)g(the)f
Fu(crontab)-150 1936 y Fy(\002le)k(.)30 b(If)21 b(the)g(task)h(is)h(to)
e(be)h(done)e(by)h(a)h(k)o(ernel)f(module,)f(we)i(ha)n(v)o(e)f(tw)o(o)g
(possibilities.)30 b(The)21 b(\002rst)h(is)g(to)-150
2050 y(put)h(a)g(process)f(in)h(the)g Fu(crontab)f Fy(\002le)i(which)e
(will)h(w)o(ak)o(e)g(up)g(the)g(module)e(by)i(a)g(system)g(call)g(when)
-150 2163 y(necessary)-5 b(,)22 b(for)g(e)o(xample)f(by)i(opening)d(a)k
(\002le.)33 b(This)23 b(is)g(terribly)f(inef)n(\002cient,)g(ho)n(we)n
(v)o(er)f(\227)i(we)g(run)f(a)-150 2277 y(ne)n(w)h(process)f(of)n(f)g
(of)h Fu(crontab)p Fy(,)f(read)g(a)i(ne)n(w)e(e)o(x)o(ecutable)f(to)i
(memory)-5 b(,)21 b(and)h(all)i(this)f(just)h(to)e(w)o(ak)o(e)-150
2391 y(up)e(a)g(k)o(ernel)g(module)f(which)g(is)i(in)g(memory)d(an)o
(yw)o(ay)-5 b(.)-25 2504 y(Instead)21 b(of)h(doing)g(that,)g(we)h(can)f
(create)g(a)h(function)e(that)h(will)i(be)e(called)g(once)g(for)g(e)n
(v)o(ery)f(timer)-150 2618 y(interrupt.)27 b(The)22 b(w)o(ay)f(we)h(do)
f(this)h(is)h(we)f(create)f(a)h(task,)g(held)f(in)h(a)g
Fu(struct)48 b(tq)p 2280 2618 25 4 v 30 w(struct)p Fy(,)21
b(which)-150 2731 y(will)33 b(hold)f(a)h(pointer)e(to)i(the)f
(function.)60 b(Then,)35 b(we)e(use)g Fu(queue)p 1880
2731 V 28 w(task)g Fy(to)f(put)h(that)f(task)h(on)f(a)-150
2845 y(task)h(list)h(called)e Fu(tq)p 488 2845 V 30 w(timer)p
Fy(,)j(which)d(is)h(the)g(list)h(of)e(tasks)h(to)g(be)f(e)o(x)o(ecuted)
f(on)h(the)h(ne)o(xt)f(timer)-150 2958 y(interrupt.)26
b(Because)21 b(we)h(w)o(ant)f(the)g(function)e(to)i(k)o(eep)g(on)g
(being)f(e)o(x)o(ecuted,)f(we)i(need)g(to)g(put)f(it)i(back)-150
3072 y(on)e Fu(tq)p 59 3072 V 29 w(timer)g Fy(whene)n(v)o(er)e(it)j(is)
g(called,)f(for)g(the)g(ne)o(xt)f(timer)h(interrupt.)-25
3186 y(There')-5 b(s)28 b(one)h(more)f(point)g(we)h(need)g(to)g
(remember)e(here.)51 b(When)28 b(a)i(module)d(is)j(remo)o(v)o(ed)d(by)
-150 3299 y Fu(rmmod)p Fy(,)j(\002rst)g(its)g(reference)d(count)h(is)i
(check)o(ed.)50 b(If)29 b(it)g(is)h(zero,)g Fu(module)p
2144 3299 V 29 w(cleanup)e Fy(is)i(called.)-150 3413
y(Then,)20 b(the)g(module)f(is)j(remo)o(v)o(ed)c(from)i(memory)e(with)j
(all)g(its)h(functions.)j(Nobody)18 b(checks)i(to)h(see)g(if)-150
3526 y(the)k(timer')-5 b(s)25 b(task)g(list)h(happens)d(to)i(contain)e
(a)j(pointer)d(to)i(one)f(of)h(those)f(functions,)g(which)h(will)g(no)
-150 3640 y(longer)16 b(be)h(a)n(v)n(ailable.)23 b(Ages)18
b(later)f(\(from)f(the)h(computer')-5 b(s)16 b(perspecti)n(v)o(e,)g
(from)g(a)h(human)f(perspecti)n(v)o(e)-150 3753 y(it')-5
b(s)27 b(nothing,)d(less)j(than)e(a)h(hundredth)c(of)j(a)h(second\),)f
(the)h(k)o(ernel)f(has)g(a)h(timer)f(interrupt)f(and)h(tries)-150
3867 y(to)d(call)g(the)f(function)f(on)h(the)h(task)g(list.)30
b(Unfortunately)-5 b(,)18 b(the)k(function)e(is)i(no)f(longer)g(there.)
28 b(In)22 b(most)-150 3981 y(cases,)i(the)f(memory)e(page)h(where)h
(it)g(sat)h(is)g(unused,)e(and)g(you)g(get)h(an)g(ugly)f(error)g
(message.)33 b(But)23 b(if)-150 4094 y(some)i(other)g(code)f(is)i(no)n
(w)f(sitting)g(at)h(the)g(same)f(memory)f(location,)h(things)g(could)f
(get)h Fo(v)o(ery)g Fy(ugly)-5 b(.)1308 4456 y(90)p eop
%%Page: 91 95
91 94 bop 150 162 a Fy(Unfortunately)-5 b(,)17 b(we)j(don')o(t)f(ha)n
(v)o(e)h(an)g(easy)g(w)o(ay)g(to)h(unre)o(gister)d(a)j(task)f(from)f(a)
i(task)f(list.)275 275 y(Since)g Fu(cleanup)p 835 275
25 4 v 28 w(module)f Fy(can')o(t)g(return)g(with)h(an)g(error)f(code)g
(\(it')-5 b(s)21 b(a)f(v)n(oid)g(function\),)e(the)i(so-)150
389 y(lution)j(is)h(to)g(not)f(let)h(it)g(return)f(at)h(all.)35
b(Instead,)23 b(it)i(calls)f Fu(sleep)p 2076 389 V 29
w(on)g Fy(or)f Fu(module)p 2622 389 V 29 w(sleep)p 2901
389 V 28 w(on)3024 359 y Fk(1)3085 389 y Fy(to)150 502
y(put)j(the)h Fu(rmmod)f Fy(process)g(to)h(sleep.)44
b(Before)26 b(that,)i(it)g(informs)d(the)i(function)e(called)h(on)g
(the)h(timer)150 616 y(interrupt)20 b(to)h(stop)g(attaching)g(itself)g
(by)g(setting)h(a)f(global)g(v)n(ariable.)27 b(Then,)20
b(on)h(the)g(ne)o(xt)g(timer)g(inter)n(-)150 730 y(rupt,)c(the)h
Fu(rmmod)g Fy(process)f(will)h(be)g(w)o(ok)o(en)f(up,)h(when)f(our)g
(function)f(is)j(no)e(longer)g(in)h(the)f(queue)g(and)150
843 y(it')-5 b(s)21 b(safe)g(to)f(remo)o(v)o(e)e(the)j(module.)275
1031 y Fl(sched.c)150 1229 y Fu(/*)49 b(sched.c)g(-)h(scheduale)e(a)h
(function)g(to)g(be)h(called)e(on)200 1343 y(*)h(every)g(timer)g
(interrupt.)f(*/)150 1797 y(/*)h(Copyright)g(\(C\))g(1998)g(by)g(Ori)h
(Pomerantz)e(*/)150 2138 y(/*)h(The)h(necessary)e(header)h(files)f(*/)
150 2365 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)150
2478 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)150 2592 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)150 2819 y(/*)g(Deal)h(with)f
(CONFIG_MODVERSIONS)d(*/)150 2933 y(#if)j(CONFIG_MODVERSIONS==1)150
3046 y(#define)g(MODVERSIONS)150 3160 y(#include)f
(<linux/modversions.h>)150 3273 y(#endif)150 3500 y(/*)h(Necessary)g
(because)f(we)i(use)f(the)g(proc)g(fs)h(*/)150 3614 y(#include)e
(<linux/proc_fs.h>)150 3841 y(/*)h(We)h(scheduale)e(tasks)h(here)g(*/)
150 3955 y(#include)f(<linux/tqueue.h>)p 150 4123 1200
4 v 235 4184 a Fi(1)270 4207 y Fh(The)o(y')m(re)17 b(really)i(the)f
(same.)p eop
%%Page: 92 96
92 95 bop -150 162 a Fu(/*)49 b(We)h(also)f(need)g(the)g(ability)g(to)g
(put)g(ourselves)g(to)g(sleep)-100 275 y(*)g(and)h(wake)f(up)g(later)g
(*/)-150 389 y(#include)f(<linux/sched.h>)-150 616 y(/*)h(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)49 b(a)-100
730 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e(doesn't)h(-)h(so)f(I)h
(add)f(it)-100 843 y(*)g(here)h(if)f(necessary.)f(*/)-150
957 y(#ifndef)h(KERNEL_VERSION)-150 1070 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))-150
1184 y(#endif)-150 1638 y(/*)k(The)h(number)e(of)i(times)f(the)g(timer)
g(interrupt)f(has)h(been)-100 1752 y(*)g(called)g(so)h(far)f(*/)-150
1865 y(static)g(int)g(TimerIntrpt)f(=)h(0;)-150 2206
y(/*)g(This)h(is)f(used)g(by)g(cleanup,)g(to)g(prevent)g(the)g(module)g
(from)-100 2320 y(*)g(being)g(unloaded)g(while)g(intrpt_routine)e(is)i
(still)g(in)-100 2433 y(*)g(the)h(task)f(queue)g(*/)-150
2547 y(static)g(struct)f(wait_queue)g(*WaitQ)h(=)h(NULL;)-150
2774 y(static)f(void)g(intrpt_routine\(void)d(*\);)-150
3115 y(/*)j(The)h(task)f(queue)g(structure)f(for)h(this)g(task,)g(from)
g(tqueue.h)f(*/)-150 3228 y(static)h(struct)f(tq_struct)h(Task)g(=)g({)
-50 3342 y(NULL,)148 b(/*)50 b(Next)f(item)g(in)g(list)g(-)h
(queue_task)e(will)h(do)398 3455 y(*)h(this)f(for)g(us)g(*/)-50
3569 y(0,)298 b(/*)50 b(A)f(flag)g(meaning)g(we)g(haven't)g(been)g
(inserted)398 3682 y(*)h(into)f(a)g(task)g(queue)g(yet)g(*/)-50
3796 y(intrpt_routine,)e(/*)i(The)g(function)g(to)g(run)g(*/)-50
3910 y(NULL)198 b(/*)50 b(The)f(void*)g(parameter)f(for)h(that)g
(function)f(*/)-150 4023 y(};)p eop
%%Page: 93 97
93 96 bop 150 389 a Fu(/*)49 b(This)h(function)e(will)h(be)g(called)g
(on)g(every)g(timer)200 502 y(*)g(interrupt.)f(Notice)h(the)g(void*)g
(pointer)g(-)g(task)g(functions)200 616 y(*)g(can)h(be)f(used)g(for)g
(more)h(than)f(one)g(purpose,)f(each)h(time)200 730 y(*)g(getting)g(a)h
(different)e(parameter.)g(*/)150 843 y(static)h(void)g
(intrpt_routine\(void)d(*irrelevant\))150 957 y({)250
1070 y(/*)j(Increment)f(the)h(counter)g(*/)250 1184 y(TimerIntrpt++;)
250 1411 y(/*)g(If)h(cleanup)e(wants)h(us)g(to)h(die)f(*/)250
1525 y(if)g(\(WaitQ)g(!=)g(NULL\))349 1638 y(wake_up\(&WaitQ\);)147
b(/*)49 b(Now)g(cleanup_module)f(can)h(return)g(*/)250
1752 y(else)349 1865 y(/*)h(Put)f(ourselves)f(back)h(in)h(the)f(task)g
(queue)g(*/)349 1979 y(queue_task\(&Task,)e(&tq_timer\);)150
2092 y(})150 2660 y(/*)i(Put)h(data)f(into)g(the)g(proc)g(fs)h(file.)e
(*/)150 2774 y(int)h(procfile_read\(char)e(*buffer,)1047
2887 y(char)i(**buffer_location,)d(off_t)j(offset,)1047
3001 y(int)g(buffer_length,)e(int)i(zero\))150 3115 y({)250
3228 y(int)g(len;)99 b(/*)49 b(The)g(number)g(of)h(bytes)e(actually)h
(used)g(*/)250 3455 y(/*)g(This)g(is)h(static)e(so)i(it)f(will)g(still)
g(be)h(in)f(memory)299 3569 y(*)h(when)f(we)h(leave)e(this)i(function)e
(*/)250 3682 y(static)g(char)h(my_buffer[80];)250 3910
y(static)f(int)i(count)e(=)i(1;)250 4137 y(/*)f(We)h(give)f(all)g(of)g
(our)h(information)d(in)j(one)f(go,)g(so)h(if)p eop
%%Page: 94 98
94 97 bop -1 162 a Fu(*)50 b(the)f(anybody)g(asks)g(us)g(if)h(we)f
(have)g(more)g(information)-1 275 y(*)h(the)f(answer)g(should)g(always)
f(be)i(no.)-1 389 y(*/)-50 502 y(if)f(\(offset)g(>)g(0\))49
616 y(return)g(0;)-50 843 y(/*)g(Fill)g(the)g(buffer)g(and)g(get)h(its)
f(length)g(*/)-50 957 y(len)g(=)h(sprintf\(my_buffer,)647
1070 y("Timer)f(was)g(called)g(\045d)g(times)g(so)g(far\\n",)647
1184 y(TimerIntrpt\);)-50 1297 y(count++;)-50 1525 y(/*)g(Tell)g(the)g
(function)g(which)g(called)f(us)i(where)f(the)-1 1638
y(*)h(buffer)f(is)g(*/)-50 1752 y(*buffer_location)d(=)k(my_buffer;)-50
1979 y(/*)f(Return)g(the)g(length)g(*/)-50 2092 y(return)f(len;)-150
2206 y(})-150 2547 y(struct)h(proc_dir_entry)e(Our_Proc_File)g(=)-50
2660 y({)49 2774 y(0,)j(/*)f(Inode)g(number)g(-)g(ignore,)g(it)g(will)g
(be)h(filled)e(by)249 2887 y(*)h(proc_register_dynamic)d(*/)49
3001 y(5,)k(/*)f(Length)g(of)g(the)h(file)f(name)g(*/)49
3115 y("sched",)g(/*)g(The)g(file)g(name)g(*/)49 3228
y(S_IFREG)g(|)g(S_IRUGO,)49 3342 y(/*)h(File)f(mode)g(-)g(this)h(is)f
(a)h(regular)e(file)h(which)g(can)99 3455 y(*)h(be)f(read)g(by)h(its)f
(owner,)g(its)g(group,)g(and)g(everybody)99 3569 y(*)h(else)f(*/)49
3682 y(1,)100 b(/*)49 b(Number)g(of)g(links)g(\(directories)f(where)298
3796 y(*)i(the)f(file)g(is)h(referenced\))d(*/)49 3910
y(0,)j(0,)99 b(/*)49 b(The)h(uid)f(and)g(gid)g(for)h(the)f(file)g(-)h
(we)f(give)448 4023 y(*)g(it)h(to)f(root)g(*/)49 4137
y(80,)h(/*)f(The)g(size)g(of)h(the)f(file)g(reported)f(by)i(ls.)f(*/)p
eop
%%Page: 95 99
95 98 bop 349 162 a Fu(NULL,)49 b(/*)h(functions)e(which)h(can)g(be)g
(done)g(on)h(the)698 275 y(*)g(inode)e(\(linking,)h(removing,)f(etc.\))
h(-)g(we)h(don't)698 389 y(*)g(support)e(any.)h(*/)349
502 y(procfile_read,)349 616 y(/*)h(The)f(read)g(function)f(for)i(this)
f(file,)g(the)g(function)f(called)399 730 y(*)i(when)f(somebody)f
(tries)h(to)g(read)g(something)g(from)g(it.)g(*/)349
843 y(NULL)349 957 y(/*)h(We)f(could)g(have)g(here)g(a)h(function)e(to)
i(fill)f(the)399 1070 y(*)h(file's)e(inode,)h(to)h(enable)e(us)i(to)f
(play)g(with)399 1184 y(*)h(permissions,)d(ownership,)h(etc.)h(*/)250
1297 y(};)150 1638 y(/*)g(Initialize)f(the)i(module)e(-)i(register)e
(the)i(proc)f(file)g(*/)150 1752 y(int)g(init_module\(\))150
1865 y({)250 1979 y(/*)g(Put)g(the)h(task)f(in)g(the)g(tq_timer)g(task)
g(queue,)f(so)i(it)299 2092 y(*)g(will)f(be)h(executed)e(at)h(next)g
(timer)g(interrupt)f(*/)250 2206 y(queue_task\(&Task,)e(&tq_timer\);)
250 2433 y(/*)j(Success)g(if)g(proc_register_dynamic)d(is)j(a)h
(success,)299 2547 y(*)g(failure)f(otherwise)f(*/)150
2660 y(#if)h(LINUX_VERSION_CODE)e(>)i(KERNEL_VERSION\(2,2,0\))250
2774 y(return)f(proc_register\(&proc_root,)d(&Our_Proc_File\);)150
2887 y(#else)250 3001 y(return)j(proc_register_dynamic\(&proc_root,)c
(&Our_Proc_File\);)150 3115 y(#endif)150 3228 y(})150
3569 y(/*)49 b(Cleanup)g(*/)150 3682 y(void)g(cleanup_module\(\))150
3796 y({)250 3910 y(/*)g(Unregister)f(our)h(/proc)g(file)g(*/)250
4023 y(proc_unregister\(&proc_root,)44 b(Our_Proc_File.low_ino\);)p
eop
%%Page: 96 100
96 99 bop -50 162 a Fu(/*)49 b(Sleep)g(until)g(intrpt_routine)e(is)i
(called)g(one)g(last)-1 275 y(*)h(time.)f(This)g(is)g(necessary,)f
(because)h(otherwise)f(we'll)-1 389 y(*)i(deallocate)e(the)h(memory)g
(holding)f(intrpt_routine)g(and)-1 502 y(*)i(Task)f(while)g(tq_timer)f
(still)h(references)f(them.)-1 616 y(*)i(Notice)f(that)g(here)g(we)g
(don't)g(allow)g(signals)g(to)-1 730 y(*)h(interrupt)e(us.)-1
843 y(*)-1 957 y(*)i(Since)f(WaitQ)g(is)g(now)h(not)f(NULL,)g(this)g
(automatically)-1 1070 y(*)h(tells)f(the)g(interrupt)f(routine)h(it's)g
(time)g(to)g(die.)g(*/)-100 1184 y(sleep_on\(&WaitQ\);)-150
1297 y(})p eop
%%Page: 97 101
97 100 bop 150 813 a Fn(Chapter)44 b(11)150 1263 y Fp(Interrupt)50
b(Handlers)275 1709 y Fy(Except)30 b(for)h(the)g(last)h(chapter)m(,)g
(e)n(v)o(erything)d(we)j(did)f(in)g(the)g(k)o(ernel)g(so)g(f)o(ar)h
(we')l(v)o(e)e(done)g(as)i(a)150 1823 y(response)18 b(to)h(a)h(process)
e(asking)h(for)f(it,)i(either)e(by)h(dealing)f(with)h(a)h(special)f
(\002le,)g(sending)f(an)h Fu(ioctl)p Fy(,)150 1936 y(or)i(issuing)h(a)g
(system)f(call.)30 b(But)22 b(the)f(job)g(of)g(the)h(k)o(ernel)f(isn')o
(t)g(just)h(to)g(respond)d(to)j(process)f(requests.)150
2050 y(Another)g(job,)i(which)g(is)g(e)n(v)o(ery)f(bit)h(as)h
(important,)d(is)j(to)f(speak)f(to)h(the)g(hardw)o(are)f(connected)f
(to)i(the)150 2163 y(machine.)275 2277 y(There)29 b(are)i(tw)o(o)g
(types)f(of)h(interaction)e(between)h(the)g(CPU)i(and)e(the)h(rest)g
(of)f(the)h(computer')-5 b(s)150 2391 y(hardw)o(are.)32
b(The)23 b(\002rst)h(type)f(is)h(when)e(the)h(CPU)h(gi)n(v)o(es)f
(orders)f(to)h(the)h(hardw)o(are,)e(the)h(other)f(is)i(when)150
2504 y(the)31 b(hardw)o(are)f(needs)g(to)i(tell)f(the)h(CPU)g
(something.)56 b(The)31 b(second,)h(called)f(interrupts,)h(is)h(much)
150 2618 y(harder)20 b(to)h(implement)f(because)g(it)i(has)f(to)g(be)g
(dealt)g(with)g(when)g(con)m(v)o(enient)d(for)i(the)h(hardw)o(are,)f
(not)150 2731 y(the)26 b(CPU.)h(Hardw)o(are)e(de)n(vices)g(typically)g
(ha)n(v)o(e)g(a)i(v)o(ery)d(small)j(amount)d(of)i(ram,)h(and)e(if)h
(you)f(don')o(t)150 2845 y(read)20 b(their)g(information)d(when)j(a)n
(v)n(ailable,)f(it)i(is)g(lost.)275 2958 y(Under)34 b(Linux,)39
b(hardw)o(are)34 b(interrupts)h(are)g(called)h(IRQs)h(\(short)e(for)g
Fo(I)p Fy(nterrupt)f Fo(R)p Fy(e)p Fo(q)p Fy(uests\))3092
2928 y Fk(1)3129 2958 y Fy(.)150 3072 y(There)28 b(are)h(tw)o(o)g
(types)g(of)f(IRQs,)k(short)d(and)f(long.)50 b(A)30 b(short)e(IRQ)i(is)
g(one)e(which)g(is)i(e)o(xpected)d(to)150 3186 y(tak)o(e)21
b(a)h Fo(v)o(ery)f Fy(short)g(period)f(of)h(time,)g(during)f(which)h
(the)g(rest)h(of)f(the)g(machine)f(will)i(be)f(block)o(ed)f(and)150
3299 y(no)27 b(other)g(interrupts)f(will)i(be)f(handled.)46
b(A)28 b(long)e(IRQ)i(is)h(one)d(which)h(can)h(tak)o(e)f(longer)m(,)g
(and)g(dur)n(-)150 3413 y(ing)f(which)g(other)g(interrupts)f(may)h
(occur)g(\(b)n(ut)g(not)g(interrupts)f(from)h(the)g(same)h(de)n
(vice\).)43 b(If)26 b(at)h(all)150 3526 y(possible,)20
b(it')-5 b(s)21 b(better)f(to)g(declare)g(an)g(interrupt)e(handler)h
(to)h(be)h(long.)275 3640 y(When)e(the)g(CPU)i(recei)n(v)o(es)d(an)i
(interrupt,)e(it)i(stops)g(whate)n(v)o(er)d(it')-5 b(s)21
b(doing)d(\(unless)h(it')-5 b(s)21 b(processing)150 3753
y(a)28 b(more)f(important)f(interrupt,)h(in)h(which)f(case)h(it)g(will)
h(deal)e(with)h(this)g(one)f(only)g(when)g(the)g(more)150
3867 y(important)15 b(one)i(is)h(done\),)d(sa)n(v)o(es)j(certain)e
(parameters)g(on)g(the)h(stack)g(and)g(calls)g(the)g(interrupt)f
(handler)-5 b(.)150 3981 y(This)26 b(means)f(that)h(certain)f(things)g
(are)g(not)g(allo)n(wed)g(in)h(the)f(interrupt)f(handler)g(itself,)k
(because)d(the)p 150 4123 1200 4 v 235 4184 a Fi(1)270
4207 y Fh(This)16 b(is)h(standard)i(nomencalture)h(on)d(the)h(Intel)g
(architecture)j(where)d(Linux)f(originated.)1608 4456
y Fy(97)p eop
%%Page: 98 102
98 101 bop -150 162 a Fy(system)23 b(is)g(in)g(an)g(unkno)n(wn)d
(state.)32 b(The)23 b(solution)e(to)i(this)g(problem)e(is)j(for)e(the)g
(interrupt)f(handler)g(to)-150 275 y(do)g(what)h(needs)f(to)h(be)f
(done)g(immediately)-5 b(,)20 b(usually)h(read)g(something)f(from)h
(the)g(hardw)o(are)f(or)i(send)-150 389 y(something)16
b(to)i(the)f(hardw)o(are,)f(and)h(then)g(schedule)g(the)g(handling)f
(of)h(the)g(ne)n(w)h(information)d(at)j(a)f(later)-150
502 y(time)22 b(\(this)h(is)g(called)f(the)h(`bottom)d(half)5
b('\))21 b(and)h(return.)30 b(The)22 b(k)o(ernel)f(is)j(then)d
(guaranteed)f(to)j(call)g(the)-150 616 y(bottom)18 b(half)i(as)g(soon)f
(as)h(possible)f(\227)h(and)f(when)g(it)h(does,)g(e)n(v)o(erything)c
(allo)n(wed)j(in)h(k)o(ernel)f(modules)-150 730 y(will)i(be)f(allo)n
(wed.)-25 843 y(The)33 b(w)o(ay)h(to)g(implement)f(this)h(is)h(to)f
(call)g Fu(request)p 1651 843 25 4 v 29 w(irq)g Fy(to)g(get)g(your)f
(interrupt)f(handler)-150 957 y(called)40 b(when)f(the)h(rele)n(v)n
(ant)f(IRQ)h(is)h(recei)n(v)o(ed)d(\(there)h(are)h(16)f(of)h(them)f(on)
h(Intel)f(platforms\).)-150 1070 y(This)f(function)e(recei)n(v)o(es)h
(the)h(IRQ)g(number)m(,)i(the)e(name)f(of)h(the)g(function,)i(\003ags,)
j(a)38 b(name)f(for)-150 1184 y Fu(/proc/interrupts)19
b Fy(and)i(a)h(parameter)e(to)i(pass)g(to)g(the)g(interrupt)e(handler)
-5 b(.)28 b(The)21 b(\003ags)h(can)g(in-)-150 1297 y(clude)g
Fu(SA)p 158 1297 V 29 w(SHIRQ)g Fy(to)g(indicate)g(you')l(re)f(willing)
h(to)g(share)g(the)g(IRQ)h(with)g(other)e(interrupt)g(handlers)-150
1411 y(\(usually)d(because)g(a)i(number)d(of)h(hardw)o(are)g(de)n
(vices)g(sit)i(on)f(the)g(same)g(IRQ\))g(and)f Fu(SA)p
2377 1411 V 30 w(INTERRUPT)-150 1525 y Fy(to)25 b(indicate)g(this)h(is)
g(a)f(f)o(ast)h(interrupt.)38 b(This)26 b(function)d(will)j(only)f
(succeed)f(if)i(there)e(isn')o(t)h(already)f(a)-150 1638
y(handler)19 b(on)h(this)g(IRQ,)h(or)f(if)g(you')l(re)e(both)i(willing)
g(to)g(share.)-25 1752 y(Then,)41 b(from)c(within)h(the)h(interrupt)d
(handler)m(,)41 b(we)e(communicate)d(with)i(the)g(hardw)o(are)f(and)
-150 1865 y(then)24 b(use)g Fu(queue)p 408 1865 V 29
w(task)p 637 1865 V 29 w(irq)g Fy(with)g Fu(tq)p 1112
1865 V 30 w(immediate)f Fy(and)h Fu(mark)p 1960 1865
V 29 w(bh\(BH)p 2239 1865 V 29 w(IMMEDIATE\))e Fy(to)-150
1979 y(schedule)15 b(the)g(bottom)f(half.)23 b(The)16
b(reason)e(we)i(can')o(t)f(use)g(the)h(standard)e Fu(queue)p
2167 1979 V 29 w(task)h Fy(in)h(v)o(ersion)e(2.0)-150
2092 y(is)25 b(that)e(the)h(interrupt)e(might)h(happen)f(right)h(in)h
(the)f(middle)g(of)h(somebody)d(else')-5 b(s)25 b Fu(queue)p
2569 2092 V 29 w(task)2793 2062 y Fk(2)2829 2092 y Fy(.)-150
2206 y(W)-7 b(e)17 b(need)f Fu(mark)p 354 2206 V 29 w(bh)h
Fy(because)e(earlier)h(v)o(ersions)f(of)h(Linux)g(only)f(had)h(an)g
(array)f(of)h(32)g(bottom)f(halv)o(es,)-150 2320 y(and)27
b(no)n(w)g(one)h(of)f(them)g(\()p Fu(BH)p 740 2320 V
30 w(IMMEDIATE)p Fy(\))f(is)j(used)e(for)g(the)h(link)o(ed)f(list)i(of)
e(bottom)g(halv)o(es)g(for)-150 2433 y(dri)n(v)o(ers)19
b(which)h(didn')o(t)e(get)i(a)h(bottom)e(half)h(entry)f(assigned)h(to)g
(them.)-150 2741 y Fm(11.1)119 b(K)m(eyboards)30 b(on)g(the)g(Intel)g
(Ar)n(chitectur)n(e)-25 2941 y Fo(W)-5 b(ar)o(ning:)21
b(The)c(r)o(est)e(of)g(this)i(chapter)e(is)i(completely)d(Intel)j
(speci\002c.)24 b(If)16 b(y)n(ou')n(r)o(e)e(not)i(running)-150
3055 y(on)k(an)h(Intel)g(platf)n(orm,)e(it)h(will)h(not)f(w)o(ork.)25
b(Don't)20 b(e)o(v)o(en)g(try)g(to)g(compile)g(the)h(code)f(her)o(e.)
-25 3168 y Fy(I)28 b(had)f(a)h(problem)e(with)j(writing)e(the)h(sample)
f(code)h(for)f(this)h(chapter)-5 b(.)48 b(On)28 b(one)f(hand,)h(for)g
(an)-150 3282 y(e)o(xample)c(to)h(be)h(useful)f(it)h(has)f(to)h(run)e
(on)h(e)n(v)o(erybody')-5 b(s)23 b(computer)g(with)j(meaningful)d
(results.)41 b(On)-150 3396 y(the)26 b(other)e(hand,)i(the)f(k)o(ernel)
g(already)f(includes)h(de)n(vice)g(dri)n(v)o(ers)f(for)h(all)h(of)f
(the)h(common)d(de)n(vices,)-150 3509 y(and)29 b(those)g(de)n(vice)f
(dri)n(v)o(ers)g(w)o(on')o(t)g(coe)o(xist)h(with)g(what)g(I'm)g(going)e
(to)j(write.)52 b(The)28 b(solution)h(I')l(v)o(e)-150
3623 y(found)20 b(w)o(as)i(to)g(write)g(something)e(for)h(the)g(k)o(e)o
(yboard)e(interrupt,)h(and)h(disable)h(the)f(re)o(gular)f(k)o(e)o
(yboard)-150 3736 y(interrupt)15 b(handler)g(\002rst.)24
b(Since)16 b(it)h(is)h(de\002ned)d(as)i(a)g(static)g(symbol)e(in)i(the)
f(k)o(ernel)g(source)f(\002les)i(\(specif-)-150 3850
y(ically)-5 b(,)19 b Fu(drivers/char/keyboard.c)p Fy(\),)c(there)j(is)i
(no)f(w)o(ay)g(to)g(restore)g(it.)25 b(Before)19 b(insmod'ing)-150
3963 y(this)i(code,)e(do)h(on)g(another)e(terminal)i
Fu(sleep)49 b(120)g(;)g(reboot)20 b Fy(if)h(you)e(v)n(alue)g(your)g
(\002le)i(system.)p -150 4040 1200 4 v -65 4094 a Fi(2)-30
4117 y Fd(queue)p 174 4117 20 4 v 23 w(task)p 357 4117
V 23 w(irq)j Fh(is)h(protected)j(from)d(this)h(by)f(a)g(global)i(lock)f
(\227)f(in)g(2.2)g(there)h(is)f(no)g Fd(queue)p 2407
4117 V 24 w(task)p 2591 4117 V 23 w(irq)f Fh(and)-150
4207 y Fd(queue)p 54 4207 V 23 w(task)16 b Fh(is)h(protected)j(by)d(a)g
(lock.)p eop
%%Page: 99 103
99 102 bop 275 162 a Fy(This)18 b(code)f(binds)g(itself)i(to)f(IRQ)h
(1,)f(which)f(is)i(the)f(IRQ)h(of)f(the)g(k)o(e)o(yboard)d(controlled)h
(under)h(Intel)150 275 y(architectures.)42 b(Then,)27
b(when)f(it)h(recei)n(v)o(es)f(a)h(k)o(e)o(yboard)d(interrupt,)i(it)h
(reads)f(the)h(k)o(e)o(yboard')-5 b(s)24 b(status)150
389 y(\(that')-5 b(s)22 b(the)g(purpose)e(of)i(the)g
Fu(inb\(0x64\))p Fy(\))e(and)i(the)g(scan)g(code,)f(which)h(is)h(the)f
(v)n(alue)f(returned)f(by)150 502 y(the)e(k)o(e)o(yboard.)j(Then,)d(as)
g(soon)f(as)i(the)e(k)o(ernel)g(think)g(it')-5 b(s)19
b(feasible,)f(it)h(runs)e Fu(got)p 2515 502 25 4 v 29
w(char)h Fy(which)f(gi)n(v)o(es)150 616 y(the)29 b(code)g(of)f(the)h(k)
o(e)o(y)g(used)g(\(the)f(\002rst)i(se)n(v)o(en)f(bits)g(of)g(the)g
(scan)g(code\))f(and)h(whether)f(it)i(has)f(been)150
730 y(pressed)20 b(\(if)g(the)g(8th)g(bit)g(is)h(zero\))f(or)g
(released)f(\(if)i(it')-5 b(s)21 b(one\).)275 918 y Fl(intr)o(pt.c)150
1141 y Fu(/*)49 b(intrpt.c)g(-)g(An)h(interrupt)e(handler.)g(*/)150
1481 y(/*)h(Copyright)g(\(C\))g(1998)g(by)g(Ori)h(Pomerantz)e(*/)150
1936 y(/*)h(The)h(necessary)e(header)h(files)f(*/)150
2163 y(/*)h(Standard)g(in)g(kernel)g(modules)f(*/)150
2276 y(#include)g(<linux/kernel.h>)147 b(/*)49 b(We're)g(doing)g
(kernel)g(work)g(*/)150 2390 y(#include)f(<linux/module.h>)147
b(/*)49 b(Specifically,)f(a)h(module)g(*/)150 2617 y(/*)g(Deal)h(with)f
(CONFIG_MODVERSIONS)d(*/)150 2731 y(#if)j(CONFIG_MODVERSIONS==1)150
2844 y(#define)g(MODVERSIONS)150 2958 y(#include)f
(<linux/modversions.h>)150 3071 y(#endif)150 3299 y(#include)g
(<linux/sched.h>)150 3412 y(#include)g(<linux/tqueue.h>)150
3639 y(/*)h(We)h(want)f(an)g(interrupt)g(*/)150 3753
y(#include)f(<linux/interrupt.h>)150 3980 y(#include)g(<asm/io.h>)p
eop
%%Page: 100 104
100 103 bop -150 162 a Fu(/*)49 b(In)h(2.2.3)f
(/usr/include/linux/version.h)44 b(includes)49 b(a)-100
275 y(*)g(macro)g(for)h(this,)e(but)i(2.0.35)e(doesn't)h(-)h(so)f(I)h
(add)f(it)-100 389 y(*)g(here)h(if)f(necessary.)f(*/)-150
502 y(#ifndef)h(KERNEL_VERSION)-150 616 y(#define)g
(KERNEL_VERSION\(a,b,c\))c(\(\(a\)*65536+\(b\)*256+\(c\)\))-150
730 y(#endif)-150 1184 y(/*)k(Bottom)g(Half)g(-)h(this)f(will)g(get)g
(called)g(by)g(the)h(kernel)-100 1297 y(*)f(as)h(soon)f(as)g(it's)g
(safe)h(to)f(do)g(everything)f(normally)-100 1411 y(*)h(allowed)g(by)g
(kernel)g(modules.)f(*/)-150 1525 y(static)h(void)g(got_char\(void)e
(*scancode\))-150 1638 y({)-50 1752 y(printk\("Scan)g(Code)i(\045x)h
(\045s.\\n",)49 1865 y(\(int\))f(*\(\(char)g(*\))g(scancode\))f(&)i
(0x7F,)49 1979 y(*\(\(char)f(*\))g(scancode\))f(&)i(0x80)f(?)h
("Released")e(:)h("Pressed"\);)-150 2092 y(})-150 2433
y(/*)g(This)h(function)e(services)g(keyboard)g(interrupts.)g(It)i
(reads)-100 2547 y(*)f(the)h(relevant)e(information)g(from)h(the)g
(keyboard)f(and)i(then)-100 2660 y(*)f(scheduales)f(the)i(bottom)e
(half)h(to)h(run)f(when)g(the)g(kernel)-100 2774 y(*)g(considers)g(it)g
(safe.)g(*/)-150 2887 y(void)g(irq_handler\(int)e(irq,)697
3001 y(void)i(*dev_id,)697 3115 y(struct)g(pt_regs)f(*regs\))-150
3228 y({)-50 3342 y(/*)h(This)g(variables)f(are)i(static)e(because)h
(they)g(need)g(to)g(be)-1 3455 y(*)h(accessible)e(\(through)g
(pointers\))g(to)i(the)f(bottom)-1 3569 y(*)h(half)f(routine.)f(*/)-50
3682 y(static)g(unsigned)h(char)g(scancode;)-50 3796
y(static)f(struct)h(tq_struct)f(task)h(=)249 3910 y({NULL,)f(0,)i
(got_char,)e(&scancode};)-50 4023 y(unsigned)g(char)h(status;)p
eop
%%Page: 101 105
101 104 bop 250 162 a Fu(/*)49 b(Read)g(keyboard)f(status)h(*/)250
275 y(status)f(=)i(inb\(0x64\);)250 389 y(scancode)e(=)i(inb\(0x60\);)
250 616 y(/*)f(Scheduale)f(bottom)h(half)g(to)g(run)h(*/)150
730 y(#if)f(LINUX_VERSION_CODE)e(>)i(KERNEL_VERSION\(2,2,0\))250
843 y(queue_task\(&task,)d(&tq_immediate\);)150 957 y(#else)250
1070 y(queue_task_irq\(&task,)g(&tq_immediate\);)150
1184 y(#endif)250 1297 y(mark_bh\(IMMEDIATE_BH\);)150
1411 y(})150 1865 y(/*)j(Initialize)f(the)i(module)e(-)i(register)e
(the)i(IRQ)f(handler)f(*/)150 1979 y(int)h(init_module\(\))150
2092 y({)250 2206 y(/*)g(Since)g(the)g(keyboard)g(handler)f(won't)h
(co-exist)f(with)299 2320 y(*)i(another)f(handler,)f(such)h(as)g(us,)h
(we)f(have)g(to)h(disable)299 2433 y(*)g(it)g(\(free)e(its)i(IRQ\))f
(before)f(we)i(do)f(anything.)f(Since)h(we)299 2547 y(*)h(don't)f(know)
g(where)g(it)g(is,)h(there's)e(no)i(way)f(to)299 2660
y(*)h(reinstate)e(it)i(later)f(-)g(so)h(the)f(computer)f(will)h(have)g
(to)299 2774 y(*)h(be)g(rebooted)e(when)h(we're)g(done.)299
2887 y(*/)250 3001 y(free_irq\(1,)e(NULL\);)250 3228
y(/*)i(Request)g(IRQ)g(1,)g(the)h(keyboard)e(IRQ,)h(to)g(go)h(to)f(our)
299 3342 y(*)h(irq_handler.)e(*/)250 3455 y(return)g(request_irq\()349
3569 y(1,)100 b(/*)49 b(The)g(number)g(of)g(the)h(keyboard)e(IRQ)h(on)h
(PCs)f(*/)349 3682 y(irq_handler,)98 b(/*)49 b(our)g(handler)g(*/)349
3796 y(SA_SHIRQ,)349 3910 y(/*)h(SA_SHIRQ)e(means)h(we're)g(willing)f
(to)i(have)f(othe)399 4023 y(*)h(handlers)e(on)h(this)h(IRQ.)399
4137 y(*)p eop
%%Page: 102 106
102 105 bop 99 162 a Fu(*)50 b(SA_INTERRUPT)d(can)j(be)f(used)g(to)g
(make)h(the)99 275 y(*)g(handler)e(into)h(a)h(fast)f(interrupt.)99
389 y(*/)49 502 y("test_keyboard_irq_handler",)c(NULL\);)-150
616 y(})-150 957 y(/*)k(Cleanup)g(*/)-150 1070 y(void)g
(cleanup_module\(\))-150 1184 y({)-50 1297 y(/*)g(This)g(is)h(only)f
(here)g(for)g(completeness.)e(It's)i(totally)-1 1411
y(*)h(irrelevant,)e(since)h(we)g(don't)g(have)g(a)h(way)f(to)g(restore)
-1 1525 y(*)h(the)f(normal)g(keyboard)f(interrupt)g(so)i(the)f
(computer)-1 1638 y(*)h(is)g(completely)d(useless)i(and)g(has)g(to)h
(be)f(rebooted.)f(*/)-50 1752 y(free_irq\(1,)f(NULL\);)-150
1865 y(})p eop
%%Page: 103 107
103 106 bop eop
%%Page: 104 108
104 107 bop -150 813 a Fn(Chapter)44 b(12)-150 1263 y
Fp(Symmetrical)52 b(Multi\226Pr)l(ocessing)-25 1709 y
Fy(One)28 b(of)g(the)g(easiest)i(\(read,)f(cheapest\))e(w)o(ays)i(to)f
(impro)o(v)o(e)f(hardw)o(are)g(performance)e(is)k(to)g(put)-150
1823 y(more)h(than)g(one)g(CPU)h(on)f(the)h(board.)54
b(This)31 b(can)f(be)g(done)g(either)g(making)f(the)h(dif)n(ferent)f
(CPUs)-150 1936 y(tak)o(e)20 b(on)f(dif)n(ferent)f(jobs)i
(\(asymmetrical)e(multi\226processing\))f(or)i(by)h(making)e(them)h
(all)i(run)e(in)g(paral-)-150 2050 y(lel,)24 b(doing)e(the)i(same)f
(job)g(\(symmetrical)f(multi\226processing,)f(a.k.a.)34
b(SMP\).)23 b(Doing)g(asymmetrical)-150 2163 y(multi\226processing)e
(ef)n(fecti)n(v)o(ely)g(requires)h(specialized)g(kno)n(wledge)f(about)h
(the)i(tasks)f(the)g(computer)-150 2277 y(should)f(do,)h(which)g(is)h
(una)n(v)n(ailable)e(in)h(a)g(general)f(purpose)g(operating)f(system)i
(such)g(as)h(Linux.)33 b(On)-150 2391 y(the)20 b(other)g(hand,)e
(symmetrical)i(multi\226processing)d(is)22 b(relati)n(v)o(ely)d(easy)h
(to)g(implement.)-25 2504 y(By)28 b(relati)n(v)o(ely)f(easy)-5
b(,)29 b(I)f(mean)f(e)o(xactly)g(that)h(\227)h(not)f(that)g(it')-5
b(s)29 b Fg(r)m(eally)f Fy(easy)-5 b(.)48 b(In)27 b(a)i(symmetrical)
-150 2618 y(multi\226processing)g(en)m(vironment,)i(the)g(CPUs)i(share)
e(the)h(same)f(memory)-5 b(,)32 b(and)f(as)h(a)g(result)f(code)-150
2731 y(running)20 b(in)i(one)f(CPU)i(can)e(af)n(fect)h(the)g(memory)e
(used)h(by)h(another)-5 b(.)29 b(Y)-9 b(ou)21 b(can)g(no)h(longer)e(be)
i(certain)-150 2845 y(that)j(a)g(v)n(ariable)e(you')l(v)o(e)g(set)i(to)
g(a)g(certain)f(v)n(alue)g(in)h(the)g(pre)n(vious)e(line)i(still)h(has)
f(that)f(v)n(alue)g(\227)i(the)-150 2958 y(other)17 b(CPU)i(might)f(ha)
n(v)o(e)f(played)g(with)h(it)h(while)f(you)f(weren')o(t)g(looking.)22
b(Ob)o(viously)-5 b(,)16 b(it')-5 b(s)19 b(impossible)-150
3072 y(to)h(program)e(lik)o(e)j(this.)-25 3186 y(In)e(the)h(case)g(of)f
(process)g(programming)d(this)21 b(normally)d(isn')o(t)h(an)g(issue,)i
(because)e(a)h(process)f(will)-150 3299 y(normally)j(only)g(run)h(on)g
(one)g(CPU)h(at)g(a)g(time)1209 3269 y Fk(1)1246 3299
y Fy(.)35 b(The)23 b(k)o(ernel,)g(on)g(the)h(other)e(hand,)h(could)f
(be)i(called)-150 3413 y(by)c(dif)n(ferent)e(processes)i(running)e(on)i
(dif)n(ferent)f(CPUs.)-25 3526 y(In)25 b(v)o(ersion)f(2.0.x,)g(this)i
(isn')o(t)f(a)h(problem)d(because)i(the)g(entire)g(k)o(ernel)g(is)h(in)
f(one)g(big)g(spinlock.)-150 3640 y(This)d(means)g(that)g(if)g(one)f
(CPU)i(is)g(in)f(the)g(k)o(ernel)f(and)g(another)f(CPU)j(w)o(ants)g(to)
f(get)g(in,)g(for)f(e)o(xample)-150 3753 y(because)f(of)h(a)g(system)g
(call,)g(it)h(has)f(to)g(w)o(ait)g(until)g(the)g(\002rst)g(CPU)h(is)g
(done.)k(This)20 b(mak)o(es)h(Linux)f(SMP)-150 3867 y(safe)-16
3837 y Fk(2)21 3867 y Fy(,)g(b)n(ut)h(terriably)e(inef)n(\002cient.)p
-150 4033 1200 4 v -65 4094 a Fi(1)-30 4117 y Fh(The)d(e)o(xception)k
(is)d(threaded)i(processes,)f(which)g(can)g(run)f(on)g(se)n(v)o(eral)i
(CPUs)e(at)g(once.)-65 4184 y Fi(2)-30 4207 y Fh(Meaning)h(it)g(is)f
(safe)g(to)h(use)f(it)g(with)h(SMP)1288 4456 y Fy(104)p
eop
%%Page: 105 109
105 108 bop 275 162 a Fy(In)19 b(v)o(ersion)g(2.2.x,)g(se)n(v)o(eral)g
(CPUs)i(can)f(be)g(in)g(the)h(k)o(ernel)e(at)h(the)h(same)f(time.)25
b(This)20 b(is)h(something)150 275 y(module)g(writers)h(need)f(to)h(be)
g(a)o(w)o(are)f(of.)30 b(I)22 b(got)g(somebody)e(to)i(gi)n(v)o(e)f(me)h
(access)g(to)h(an)e(SMP)i(box,)e(so)150 389 y(hopefully)d(the)i(ne)o
(xt)g(v)o(ersion)f(of)g(this)i(book)e(will)i(include)e(more)g
(information.)p eop
%%Page: 106 110
106 109 bop -150 813 a Fn(Chapter)44 b(13)-150 1263 y
Fp(Common)52 b(Pitfalls)-25 1709 y Fy(Before)18 b(I)h(send)f(you)g(on)h
(your)e(w)o(ay)i(to)g(go)g(out)f(into)h(the)g(w)o(orld)f(and)g(write)h
(k)o(ernel)f(modules,)g(there)-150 1823 y(are)i(a)h(fe)n(w)f(things)g
(I)g(need)f(to)i(w)o(arn)f(you)f(about.)24 b(If)c(I)g(f)o(ail)h(to)f(w)
o(arn)g(you)g(and)f(something)g(bad)g(happen,)-150 1936
y(please)i(report)f(the)h(problem)e(to)i(me)g(for)g(a)g(full)g(refund)e
(of)i(the)g(amount)e(I)j(got)e(paid)h(for)f(your)g(cop)o(y)g(of)-150
2050 y(the)g(book.)-46 2246 y(1.)41 b Fo(Using)26 b(standard)g
(libraries)g Fy(Y)-9 b(ou)25 b(can')o(t)g(do)g(that.)42
b(In)25 b(a)i(k)o(ernel)e(module)f(you)h(can)g(only)g(use)58
2360 y(k)o(ernel)19 b(functions,)f(which)i(are)g(the)g(functions)f(you)
h(can)f(see)i(in)g Fu(/proc/ksyms)p Fy(.)-46 2540 y(2.)41
b Fo(Disabling)21 b(interrupts)h Fy(Y)-9 b(ou)21 b(might)g(need)f(to)i
(do)f(this)h(for)f(a)h(short)f(time)g(and)g(that)h(is)g(OK,)g(b)n(ut)58
2654 y(if)27 b(you)f(don')o(t)g(enable)g(them)h(afterw)o(ards,)g(your)f
(system)h(will)h(be)f(stuck)g(and)g(you')o(ll)f(ha)n(v)o(e)g(to)58
2767 y(po)n(wer)19 b(it)i(of)n(f.)-46 2947 y(3.)41 b
Fo(Sticking)30 b(y)n(our)f(head)i(inside)g(a)f(lar)o(ge)f(car)o(ni)o(v)
o(or)o(e)g Fy(I)h(probably)e(don')o(t)g(ha)n(v)o(e)i(to)g(w)o(arn)f
(you)58 3061 y(about)19 b(this,)h(b)n(ut)g(I)h(\002gured)e(I)h(will)h
(an)o(yw)o(ay)-5 b(,)18 b(just)j(in)f(case.)1288 4456
y(106)p eop
%%Page: 107 111
107 110 bop 150 813 a Fn(A)l(ppendix)42 b(A)150 1263
y Fp(Changes)52 b(between)e(2.0)i(and)g(2.2)275 1709
y Fy(I)30 b(don')o(t)e(kno)n(w)h(the)h(entire)g(k)o(ernel)f(well)i
(enough)d(do)i(document)e(all)i(of)g(the)g(changes.)54
b(In)30 b(the)150 1823 y(course)c(of)g(con)m(v)o(erting)d(the)k(e)o
(xamples)e(\(or)h(actually)-5 b(,)26 b(adapting)f(Emmanuel)g(P)o
(apirakis')-5 b(s)26 b(changes\))150 1936 y(I)e(came)g(across)g(the)g
(follo)n(wing)f(dif)n(ferences.)35 b(I)24 b(listed)h(all)f(of)g(them)g
(here)f(together)g(to)h(help)g(module)150 2050 y(programmers,)j
(especially)h(those)f(who)h(learned)f(from)g(pre)n(vious)f(v)o(ersions)
h(of)h(this)h(book)d(and)i(are)150 2163 y(most)20 b(f)o(amiliar)g(with)
g(the)h(techniques)d(I)j(use,)f(con)m(v)o(ert)e(to)j(the)f(ne)n(w)g(v)o
(ersion.)275 2277 y(An)153 b(additional)g(resource)f(for)h(people)g
(who)g(wish)h(to)g(con)m(v)o(ert)150 2391 y(to)30 b(2.2)f(is)i(in)f
Fu(http://www.atnf.csiro.au/\230rgooch/l)o(inux/)o(docs/)o(portin)o(g-)
150 2504 y(to-2.2.html)p Fy(.)254 2697 y(1.)41 b Fo(asm/uaccess.h)20
b Fy(If)g(you)f(need)h Fu(put)p 1428 2697 25 4 v 29 w(user)g
Fy(or)g Fu(get)p 1917 2697 V 30 w(user)g Fy(you)f(ha)n(v)o(e)g(to)i
(#include)d(it.)254 2876 y(2.)41 b Fo(get)p 470 2876
V 28 w(user)23 b Fy(In)f(v)o(ersion)f(2.2,)g Fu(get)p
1328 2876 V 30 w(user)h Fy(recei)n(v)o(es)f(both)g(the)h(pointer)f
(into)h(user)g(memory)e(and)358 2990 y(the)g(v)n(ariable)f(in)h(k)o
(ernel)g(memory)e(to)i(\002ll)i(with)e(the)g(information.)j(The)d
(reason)f(for)h(this)g(is)h(that)358 3103 y Fu(get)p
513 3103 V 29 w(user)e Fy(can)g(no)n(w)g(read)g(tw)o(o)g(or)h(four)e
(bytes)h(at)h(a)g(time)f(if)h(the)f(v)n(ariable)f(we)i(read)f(is)h(tw)o
(o)g(or)358 3217 y(four)f(bytes)h(long.)254 3396 y(3.)41
b Fo(\002le)p 469 3396 V 30 w(operations)36 b Fy(This)i(structure)f(no)
n(w)g(has)h(a)g(\003ush)g(function)e(between)h(the)h
Fu(open)f Fy(and)358 3509 y Fu(close)19 b Fy(functions.)254
3688 y(4.)41 b Fo(close)24 b(in)h(\002le)p 758 3688 V
30 w(operations)f Fy(In)g(v)o(ersion)f(2.2,)i(the)f(close)h(function)d
(returns)i(an)g(inte)o(ger)m(,)g(so)g(it')-5 b(s)358
3801 y(allo)n(wed)19 b(to)h(f)o(ail.)254 3980 y(5.)41
b Fo(r)o(ead)25 b(and)i(write)f(in)g(\002le)p 1122 3980
V 30 w(operations)g Fy(The)f(headers)h(for)f(these)h(functions)f
(changed.)41 b(The)o(y)358 4094 y(no)n(w)21 b(return)g
Fu(ssize)p 997 4094 V 29 w(t)h Fy(instead)f(of)h(an)g(inte)o(ger)m(,)e
(and)i(their)f(parameter)g(list)i(is)g(dif)n(ferent.)28
b(The)358 4207 y(inode)19 b(is)i(no)f(longer)f(a)h(parameter)m(,)e(and)
i(on)g(the)g(other)f(hand)g(the)i(of)n(fset)e(into)h(the)g(\002le)h
(is.)1588 4456 y(107)p eop
%%Page: 108 112
108 111 bop -46 162 a Fy(6.)41 b Fo(pr)o(oc)p 224 162
25 4 v 28 w(r)o(egister)p 524 162 V 29 w(dynamic)21 b
Fy(This)h(function)e(no)h(longer)f(e)o(xists.)30 b(Instead,)21
b(you)g(call)h(the)f(re)o(gular)58 275 y Fu(proc)p 263
275 V 29 w(register)e Fy(and)h(put)f(zero)h(in)g(the)h(inode)e(\002eld)
h(of)g(the)g(structure.)-46 455 y(7.)41 b Fo(Signals)23
b Fy(The)g(signals)h(in)g(the)f(task)h(structure)e(are)i(no)f(longer)f
(a)i(32)f(bit)g(inte)o(ger)m(,)g(b)n(ut)g(an)g(array)58
569 y(of)p 152 569 V 49 w Fu(NSIG)p 382 569 V 29 w(WORDS)d
Fy(inte)o(gers.)-46 749 y(8.)41 b Fo(queue)p 275 749
V 30 w(task)p 453 749 V 29 w(ir)o(q)20 b Fy(Ev)o(en)e(if)i(you)e(w)o
(ant)i(to)f(scheduale)g(a)h(task)f(to)h(happen)e(from)g(inside)h(an)h
(inter)n(-)58 862 y(rupt)f(handler)m(,)f(you)i(use)g
Fu(queue)p 1031 862 V 29 w(task)p Fy(,)g(not)g Fu(queue)p
1678 862 V 28 w(task)p 1906 862 V 30 w(irq)p Fy(.)-46
1042 y(9.)41 b Fo(Module)25 b(P)o(arameters)f Fy(Y)-9
b(ou)24 b(no)g(longer)f(just)i(declare)f(module)g(parameters)f(as)j
(global)d(v)n(ari-)58 1156 y(ables.)i(In)20 b(2.2)g(you)g(ha)n(v)o(e)g
(to)g(also)h(use)g Fu(MODULE)p 1488 1156 V 28 w(PARM)g
Fy(to)f(declare)g(their)g(type.)25 b(This)c(is)g(a)g(big)58
1270 y(impro)o(v)o(ement,)f(because)i(it)h(allo)n(ws)g(the)g(module)e
(to)i(recei)n(v)o(e)f(string)g(parameters)g(which)g(start)58
1383 y(with)e(a)h(digits,)f(for)f(e)o(xample,)g(without)g(getting)h
(confused.)-88 1563 y(10.)41 b Fo(Symmetrical)24 b(Multi\226Pr)o
(ocessing)g Fy(The)h(k)o(ernel)f(is)i(no)f(longer)e(inside)i(one)g
(huge)f(spinlock,)58 1677 y(which)19 b(means)h(that)g(k)o(ernel)g
(modules)f(ha)n(v)o(e)g(to)i(be)f(a)o(w)o(are)g(of)g(SMP)-9
b(.)p eop
%%Page: 109 113
109 112 bop 150 813 a Fn(A)l(ppendix)42 b(B)150 1263
y Fp(Wher)l(e)50 b(Fr)l(om)j(Her)l(e?)275 1709 y Fy(I)22
b(could)f(easily)h(ha)n(v)o(e)f(squeezed)g(a)h(fe)n(w)g(more)f
(chapters)g(into)h(this)g(book.)29 b(I)22 b(could)f(ha)n(v)o(e)g(added)
g(a)150 1823 y(chapter)d(about)h(creating)f(ne)n(w)i(\002le)g(systems,)
g(or)f(about)g(adding)f(ne)n(w)h(protocols)f(stacks)i(\(as)g(if)g
(there')-5 b(s)150 1936 y(a)26 b(need)g(for)f(that)h(\227)h(you')l(d)d
(ha)n(v)o(e)i(to)g(dig)f(under)g(ground)f(to)i(\002nd)g(a)g(protocol)f
(stack)h(not)g(supported)150 2050 y(by)21 b(Linux\).)28
b(I)22 b(could)e(ha)n(v)o(e)h(added)g(e)o(xplanations)e(of)i(the)h(k)o
(ernel)f(mechanisms)f(we)i(ha)n(v)o(en')o(t)e(touched)150
2163 y(upon,)f(such)g(as)i(bootstrapping)d(or)i(the)g(disk)g(interf)o
(ace.)275 2277 y(Ho)n(we)n(v)o(er)m(,)29 b(I)g(chose)f(not)h(to.)51
b(My)29 b(purpose)e(in)i(writing)f(this)i(book)d(w)o(as)j(to)f(pro)o
(vide)e(initiation)150 2391 y(into)543 b(the)g(mysteries)g(of)g(k)o
(ernel)150 2504 y(module)26 b(programming)e(and)i(to)h(teach)g(the)h
(common)d(techniques)h(for)g(that)i(purpose.)44 b(F)o(or)27
b(people)150 2618 y(seriously)h(interested)h(in)g(k)o(ernel)f
(programming,)g(I)h(recommend)d(the)j(list)h(of)f(k)o(ernel)f
(resources)g(in)150 2731 y Fu(http://jungla.dit.upm.es/\230jmseyas/l)o
(inux/k)o(ernel)o(/hack)o(ers-)150 2845 y(docs.html)p
Fy(.)h(Also,)23 b(as)f(Linus)g(said,)h(the)f(best)g(w)o(ay)g(is)h(to)f
(learn)g(the)g(k)o(ernel)f(is)i(to)f(read)f(the)h(source)150
2958 y(code)d(yourself.)275 3072 y(If)27 b(you')l(re)f(interested)h(in)
i(more)e(e)o(xamples)f(of)i(short)f(k)o(ernel)h(modules,)g(I)g
(recommend)d(Phrack)150 3186 y(magazine.)38 b(Ev)o(en)24
b(if)i(you')l(re)d(not)i(interested)f(in)h(security)-5
b(,)25 b(and)g(as)h(a)f(programmer)e(you)h(should)g(be,)150
3299 y(the)30 b(k)o(ernel)g(modules)f(there)h(are)g(good)f(e)o(xamples)
g(of)h(what)g(you)f(can)h(do)g(inside)g(the)g(k)o(ernel,)i(and)150
3413 y(the)o(y')l(re)18 b(short)i(enough)e(not)i(to)h(require)e(too)g
(much)h(ef)n(fort)f(to)h(understand.)275 3526 y(I)25
b(hope)g(I)g(ha)n(v)o(e)g(helped)g(you)f(in)i(your)e(quest)i(to)f
(become)g(a)h(better)f(programmer)m(,)e(or)i(at)h(least)g(to)150
3640 y(ha)n(v)o(e)k(fun)h(through)e(technology)-5 b(.)54
b(And,)33 b(if)f(you)e(do)h(write)g(useful)f(k)o(ernel)h(modules,)h(I)f
(hope)f(you)150 3753 y(publish)19 b(them)h(under)f(the)h(GPL,)g(so)h(I)
f(can)g(use)h(them)f(too.)1588 4456 y(109)p eop
%%Page: 110 114
110 113 bop -150 813 a Fn(A)l(ppendix)42 b(C)-150 1263
y Fp(Goods)52 b(and)g(Ser)n(vices)-25 1709 y Fy(I)28
b(hope)f(nobody)f(minds)h(the)h(shameless)h(promotions)d(here.)48
b(The)o(y)27 b(are)h(all)g(things)g(which)g(are)-150
1823 y(lik)o(ely)20 b(to)g(be)h(of)e(use)i(to)f(be)o(ginning)e(Linux)h
(K)n(ernel)g(Module)h(programmers.)-150 2124 y Fm(C.1)120
b(Getting)30 b(this)g(Book)f(in)i(Print)-25 2323 y Fy(The)21
b(Coriolis)h(group)e(is)j(going)e(to)h(print)f(this)i(book)d(sometimes)
i(in)g(the)g(summer)f(of)h('99.)29 b(If)22 b(this)-150
2437 y(is)k(already)e(summer)m(,)g(and)h(you)f(w)o(ant)h(this)g(book)f
(in)h(print,)g(you)f(can)h(go)f(easy)h(on)g(your)e(printer)h(and)-150
2550 y(b)n(uy)c(it)h(in)f(a)h(nice,)e(bound)g(form.)1288
4456 y(110)p eop
%%Page: 111 115
111 114 bop 150 813 a Fn(A)l(ppendix)42 b(D)150 1263
y Fp(Sho)n(wing)52 b(Y)-23 b(our)52 b(A)-5 b(ppr)l(eciation)275
1709 y Fy(This)31 b(is)h(a)g(free)f(document.)56 b(Y)-9
b(ou)31 b(ha)n(v)o(e)g(no)g(obligations)e(be)o(yond)g(those)i(gi)n(v)o
(en)f(in)i(the)f(GNU)150 1823 y(Public)23 b(License)f(\(Appendix)f
(E\).)33 b(Ho)n(we)n(v)o(er)m(,)21 b(if)i(you)f(w)o(ant)h(to)g(do)g
(something)e(in)i(return)f(for)g(getting)150 1936 y(this)f(book,)d
(there)i(are)g(a)h(fe)n(w)f(things)g(you)f(could)g(do.)275
2167 y Fv(\017)41 b Fy(Send)19 b(me)i(a)f(postcard)f(to)358
2280 y Fu(Ori)49 b(Pomerantz)358 2394 y(Apt.)98 b(#1032)358
2507 y(2355)49 b(N)g(Hwy)h(360)358 2621 y(Grand)e(Prairie)358
2735 y(TX)h(75050)358 2848 y(USA)358 2962 y Fy(If)20
b(you)f(w)o(ant)h(to)h(recei)n(v)o(e)e(a)h(thank-you)e(from)h(me,)h
(include)f(your)g(e-mail)h(address.)275 3187 y Fv(\017)41
b Fy(Contrib)n(ute)21 b(mone)o(y)-5 b(,)21 b(or)h(better)g(yet,)h
(time,)g(to)g(the)g(free)f(softw)o(are)g(community)-5
b(.)30 b(Write)23 b(a)g(pro-)358 3301 y(gram)i(or)h(a)h(document)e(and)
g(publish)h(it)h(under)e(the)h(GPL.)h(T)-6 b(each)26
b(other)g(people)f(ho)n(w)h(to)g(use)358 3414 y(free)19
b(softw)o(are,)h(such)g(as)h(Linux)e(or)h(Perl.)275 3639
y Fv(\017)41 b Fy(Explain)24 b(to)i(people)f(ho)n(w)h(being)e
(sel\002sh)j(is)g Fg(not)f Fy(incompatible)e(with)i(li)n(ving)f(in)h(a)
g(society)g(or)358 3753 y(with)20 b(helping)e(other)h(people.)24
b(I)c(enjo)o(yed)f(writing)g(this)h(document,)e(and)h(I)h(belie)n(v)o
(e)f(publishing)358 3866 y(it)28 b(will)h(contrib)n(ute)e(to)h(me)h(in)
f(the)g(future.)48 b(At)29 b(the)f(same)g(time,)i(I)f(wrote)e(a)i(book)
e(which,)i(if)358 3980 y(you)d(got)h(this)h(f)o(ar)m(,)h(helps)e(you.)
46 b(Remember)26 b(that)i(happ)o(y)e(people)g(are)i(usually)e(more)h
(useful)358 4094 y(to)e(oneself)f(than)g(unhapp)o(y)f(people,)i(and)f
(able)h(people)f(are)h Fg(way)g Fy(better)g(than)f(people)g(of)h(lo)n
(w)358 4207 y(ability)-5 b(.)1588 4456 y(111)p eop
%%Page: 112 116
112 115 bop -25 162 a Fv(\017)41 b Fo(Be)19 b(happy)p
Fy(.)25 b(If)19 b(I)g(get)g(to)g(meet)g(you,)f(it)h(will)h(mak)o(e)e
(the)h(encounter)e(better)i(for)f(me,)h(it)g(will)h(mak)o(e)58
275 y(you)f(more)g(useful)h(for)f(me)i(;-\).)p eop
%%Page: 113 117
113 116 bop 150 813 a Fn(A)l(ppendix)42 b(E)150 1263
y Fp(The)51 b(GNU)h(General)f(Public)h(License)275 1709
y Fy(Printed)22 b(belo)n(w)g(is)i(the)f(GNU)h(General)e(Public)h
(License)f(\(the)h Fg(GPL)g Fy(or)g Fg(copyleft)p Fy(\),)g(under)e
(which)150 1823 y(this)g(book)e(is)i(licensed.)265 2049
y Fn(GNU)44 b(GENERAL)f(PUBLIC)h(LICENSE)1302 2163 y
Fy(V)-9 b(ersion)19 b(2,)h(June)g(1991)275 2276 y(Cop)o(yright)660
2273 y(c)637 2276 y Fv(\015)p Fy(1989,)27 b(1991)e(Free)h(Softw)o(are)g
(F)o(oundation,)f(Inc.)43 b(675)26 b(Mass)h(A)-6 b(v)o(e,)27
b(Cambridge,)150 2390 y(MA)33 b(02139,)g(USA)f(Ev)o(eryone)e(is)j
(permitted)e(to)i(cop)o(y)e(and)h(distrib)n(ute)f(v)o(erbatim)g(copies)
h(of)g(this)150 2504 y(license)20 b(document,)e(b)n(ut)i(changing)f(it)
h(is)i(not)d(allo)n(wed.)1454 2617 y(P)t Fh(R)t(E)t(A)t(M)t(B)t(L)t(E)
275 2731 y Fy(The)26 b(licenses)h(for)f(most)g(softw)o(are)h(are)f
(designed)f(to)i(tak)o(e)g(a)o(w)o(ay)f(your)f(freedom)g(to)i(share)f
(and)150 2844 y(change)j(it.)54 b(By)31 b(contrast,)g(the)f(GNU)g
(General)f(Public)h(License)g(is)g(intended)f(to)h(guarantee)e(your)150
2958 y(freedom)15 b(to)h(share)g(and)g(change)f(free)h(softw)o
(are\226to)f(mak)o(e)h(sure)g(the)g(softw)o(are)g(is)i(free)e(for)f
(all)i(its)h(users.)150 3071 y(This)27 b(General)e(Public)h(License)h
(applies)f(to)g(most)h(of)f(the)g(Free)h(Softw)o(are)f(F)o(oundation')
-5 b(s)24 b(softw)o(are)150 3185 y(and)i(to)g(an)o(y)f(other)g(program)
f(whose)i(authors)f(commit)g(to)i(using)e(it.)43 b(\(Some)26
b(other)f(Free)h(Softw)o(are)150 3299 y(F)o(oundation)18
b(softw)o(are)i(is)i(co)o(v)o(ered)c(by)i(the)h(GNU)f(Library)g
(General)f(Public)i(License)f(instead.\))25 b(Y)-9 b(ou)150
3412 y(can)20 b(apply)f(it)i(to)f(your)f(programs,)f(too.)275
3526 y(When)23 b(we)h(speak)f(of)h(free)f(softw)o(are,)h(we)g(are)f
(referring)f(to)h(freedom,)g(not)g(price.)35 b(Our)23
b(General)150 3639 y(Public)h(Licenses)h(are)f(designed)f(to)i(mak)o(e)
e(sure)i(that)f(you)g(ha)n(v)o(e)f(the)i(freedom)d(to)j(distrib)n(ute)f
(copies)150 3753 y(of)f(free)h(softw)o(are)f(\(and)g(char)o(ge)f(for)h
(this)h(service)f(if)h(you)f(wish\),)i(that)e(you)g(recei)n(v)o(e)g
(source)g(code)g(or)150 3866 y(can)i(get)g(it)h(if)g(you)e(w)o(ant)h
(it,)i(that)e(you)g(can)g(change)e(the)j(softw)o(are)e(or)h(use)h
(pieces)f(of)g(it)h(in)f(ne)n(w)g(free)150 3980 y(programs;)18
b(and)i(that)g(you)g(kno)n(w)f(you)g(can)h(do)g(these)g(things.)275
4094 y(T)-7 b(o)29 b(protect)f(your)g(rights,)i(we)g(need)e(to)h(mak)o
(e)g(restrictions)f(that)h(forbid)f(an)o(yone)f(to)i(den)o(y)e(you)150
4207 y(these)j(rights)f(or)g(to)g(ask)h(you)e(to)i(surrender)d(the)j
(rights.)52 b(These)29 b(restrictions)g(translate)h(to)f(certain)1588
4456 y(113)p eop
%%Page: 114 118
114 117 bop -150 162 a Fy(responsibilities)20 b(for)f(you)g(if)i(you)e
(distrib)n(ute)h(copies)g(of)g(the)g(softw)o(are,)f(or)h(if)h(you)e
(modify)g(it.)-25 275 y(F)o(or)e(e)o(xample,)g(if)h(you)g(distrib)n
(ute)f(copies)h(of)g(such)g(a)g(program,)e(whether)h(gratis)i(or)e(for)
h(a)g(fee,)g(you)-150 389 y(must)27 b(gi)n(v)o(e)f(the)g(recipients)h
(all)g(the)g(rights)f(that)h(you)f(ha)n(v)o(e.)44 b(Y)-9
b(ou)26 b(must)g(mak)o(e)h(sure)f(that)h(the)o(y)-5 b(,)27
b(too,)-150 502 y(recei)n(v)o(e)f(or)h(can)g(get)g(the)g(source)f
(code.)45 b(And)27 b(you)f(must)h(sho)n(w)g(them)f(these)i(terms)f(so)g
(the)o(y)g(kno)n(w)-150 616 y(their)20 b(rights.)-25
730 y(W)-7 b(e)19 b(protect)f(your)f(rights)h(with)h(tw)o(o)g(steps:)25
b(\(1\))18 b(cop)o(yright)e(the)j(softw)o(are,)f(and)g(\(2\))g(of)n
(fer)f(you)h(this)-150 843 y(license)i(which)g(gi)n(v)o(es)g(you)f(le)o
(gal)g(permission)h(to)g(cop)o(y)-5 b(,)19 b(distrib)n(ute)g(and/or)g
(modify)g(the)h(softw)o(are.)-25 957 y(Also,)33 b(for)d(each)g(author')
-5 b(s)29 b(protection)g(and)h(ours,)i(we)f(w)o(ant)g(to)f(mak)o(e)g
(certain)g(that)h(e)n(v)o(eryone)-150 1070 y(understands)21
b(that)h(there)g(is)h(no)f(w)o(arranty)f(for)h(this)h(free)f(softw)o
(are.)31 b(If)22 b(the)h(softw)o(are)f(is)h(modi\002ed)e(by)-150
1184 y(someone)g(else)h(and)f(passed)h(on,)g(we)g(w)o(ant)g(its)g
(recipients)g(to)g(kno)n(w)e(that)i(what)g(the)o(y)f(ha)n(v)o(e)g(is)i
(not)f(the)-150 1297 y(original,)d(so)i(that)g(an)o(y)f(problems)f
(introduced)f(by)i(others)g(will)i(not)e(re\003ect)h(on)f(the)g
(original)g(authors')-150 1411 y(reputations.)-25 1525
y(Finally)-5 b(,)15 b(an)o(y)g(free)g(program)e(is)k(threatened)d
(constantly)g(by)h(softw)o(are)g(patents.)24 b(W)-7 b(e)16
b(wish)g(to)g(a)n(v)n(oid)-150 1638 y(the)23 b(danger)e(that)i
(redistrib)n(utors)e(of)i(a)g(free)f(program)f(will)i(indi)n(vidually)e
(obtain)h(patent)g(licenses,)h(in)-150 1752 y(ef)n(fect)29
b(making)f(the)h(program)e(proprietary)-5 b(.)50 b(T)-7
b(o)29 b(pre)n(v)o(ent)f(this,)k(we)d(ha)n(v)o(e)g(made)g(it)h(clear)f
(that)g(an)o(y)-150 1865 y(patent)20 b(must)g(be)g(licensed)g(for)f(e)n
(v)o(eryone')-5 b(s)18 b(free)i(use)h(or)f(not)f(licensed)h(at)h(all.)
-25 1979 y(The)e(precise)h(terms)g(and)g(conditions)f(for)g(cop)o
(ying,)g(distrib)n(ution)g(and)g(modi\002cation)g(follo)n(w)-5
b(.)671 2092 y(G)t(N)t(U)25 b(G)t(E)t(N)t(E)t(R)t(A)t(L)g(P)t(U)t(B)t
(L)t(I)t(C)h(L)t(I)t(C)t(E)t(N)t(S)t(E)-274 2206 y(T)t(E)t(R)t(M)t(S)f
(A)t(N)t(D)g(C)t(O)t(N)t(D)t(I)t(T)t(I)t(O)t(N)t(S)h(F)t(O)t(R)f(C)t(O)
t(P)t(Y)t(I)t(N)t(G)t(,)h(D)t(I)t(S)t(T)t(R)t(I)t(B)s(U)t(T)t(I)t(O)t
(N)g(A)t(N)t(D)f(M)t(O)t(D)t(I)t(F)t(I)t(C)t(A)-5 b(T)t(I)t(O)t(N)-46
2403 y(0.)41 b(This)25 b(License)h(applies)f(to)h(an)o(y)f(program)f
(or)h(other)g(w)o(ork)g(which)g(contains)g(a)h(notice)f(placed)58
2517 y(by)c(the)h(cop)o(yright)e(holder)g(saying)h(it)i(may)e(be)h
(distrib)n(uted)f(under)g(the)g(terms)h(of)g(this)g(General)58
2630 y(Public)k(License.)43 b(The)26 b(`Program',)f(belo)n(w)-5
b(,)27 b(refers)f(to)g(an)o(y)g(such)g(program)e(or)i(w)o(ork,)h(and)f
(a)58 2744 y(`w)o(ork)17 b(based)h(on)g(the)h(Program')e(means)h
(either)g(the)g(Program)f(or)i(an)o(y)e(deri)n(v)n(ati)n(v)o(e)g(w)o
(ork)h(under)58 2857 y(cop)o(yright)g(la)o(w:)27 b(that)21
b(is)g(to)g(say)-5 b(,)21 b(a)g(w)o(ork)f(containing)f(the)i(Program)e
(or)i(a)g(portion)e(of)i(it,)g(either)58 2971 y(v)o(erbatim)16
b(or)i(with)g(modi\002cations)e(and/or)h(translated)g(into)h(another)e
(language.)23 b(\(Hereinafter)m(,)58 3085 y(translation)f(is)i
(included)e(without)g(limitation)h(in)g(the)h(term)f
(`modi\002cation'.\))31 b(Each)23 b(licensee)58 3198
y(is)e(addressed)e(as)i(`you'.)58 3345 y(Acti)n(vities)k(other)e(than)i
(cop)o(ying,)f(distrib)n(ution)f(and)h(modi\002cation)f(are)i(not)f(co)
o(v)o(ered)f(by)h(this)58 3459 y(License;)d(the)o(y)f(are)h(outside)f
(its)i(scope.)27 b(The)21 b(act)g(of)g(running)d(the)j(Program)f(is)i
(not)e(restricted,)58 3572 y(and)28 b(the)h(output)e(from)h(the)h
(Program)e(is)j(co)o(v)o(ered)d(only)h(if)h(its)h(contents)e
(constitute)g(a)h(w)o(ork)58 3686 y(based)23 b(on)g(the)h(Program)e
(\(independent)f(of)j(ha)n(ving)f(been)g(made)g(by)g(running)f(the)i
(Program\).)58 3799 y(Whether)19 b(that)h(is)i(true)d(depends)g(on)h
(what)g(the)g(Program)f(does.)-46 3980 y(1.)41 b(Y)-9
b(ou)24 b(may)h(cop)o(y)g(and)g(distrib)n(ute)g(v)o(erbatim)f(copies)h
(of)g(the)h(Program')-5 b(s)24 b(source)h(code)f(as)i(you)58
4094 y(recei)n(v)o(e)15 b(it,)i(in)g(an)o(y)f(medium,)f(pro)o(vided)f
(that)j(you)e(conspicuously)f(and)i(appropriately)e(publish)58
4207 y(on)j(each)h(cop)o(y)g(an)g(appropriate)e(cop)o(yright)g(notice)i
(and)g(disclaimer)g(of)g(w)o(arranty;)g(k)o(eep)g(intact)p
eop
%%Page: 115 119
115 118 bop 358 162 a Fy(all)21 b(the)f(notices)g(that)h(refer)e(to)i
(this)g(License)f(and)g(to)g(the)h(absence)e(of)i(an)o(y)e(w)o
(arranty;)h(and)f(gi)n(v)o(e)358 275 y(an)o(y)g(other)g(recipients)h
(of)g(the)g(Program)f(a)h(cop)o(y)g(of)g(this)g(License)g(along)f(with)
i(the)f(Program.)358 437 y(Y)-9 b(ou)17 b(may)h(char)o(ge)e(a)j(fee)f
(for)f(the)h(physical)f(act)i(of)e(transferring)f(a)j(cop)o(y)-5
b(,)17 b(and)g(you)h(may)f(at)i(your)358 550 y(option)g(of)n(fer)g(w)o
(arranty)f(protection)h(in)h(e)o(xchange)e(for)i(a)g(fee.)254
759 y(2.)41 b(Y)-9 b(ou)19 b(may)h(modify)f(your)g(cop)o(y)g(or)h
(copies)g(of)g(the)h(Program)e(or)h(an)o(y)f(portion)g(of)h(it,)h(thus)
f(form-)358 873 y(ing)30 b(a)i(w)o(ork)e(based)h(on)f(the)i(Program,)g
(and)e(cop)o(y)g(and)h(distrib)n(ute)f(such)h(modi\002cations)f(or)358
986 y(w)o(ork)c(under)f(the)i(terms)f(of)h(Section)f(1)h(abo)o(v)o(e,)f
(pro)o(vided)e(that)j(you)f(also)h(meet)g(all)g(of)f(these)358
1100 y(conditions:)441 1333 y(a.)41 b(Y)-9 b(ou)25 b(must)h(cause)f
(the)h(modi\002ed)e(\002les)i(to)g(carry)f(prominent)e(notices)i
(stating)h(that)f(you)540 1446 y(changed)19 b(the)h(\002les)h(and)f
(the)g(date)g(of)g(an)o(y)f(change.)440 1607 y(b)m(.)40
b(Y)-9 b(ou)18 b(must)h(cause)g(an)o(y)f(w)o(ork)g(that)h(you)f
(distrib)n(ute)h(or)f(publish,)g(that)h(in)g(whole)f(or)h(in)g(part)540
1721 y(contains)h(or)h(is)g(deri)n(v)o(ed)e(from)h(the)h(Program)e(or)i
(an)o(y)f(part)g(thereof,)g(to)h(be)f(licensed)h(as)g(a)540
1835 y(whole)f(at)h(no)e(char)o(ge)g(to)h(all)h(third)f(parties)g
(under)e(the)j(terms)f(of)g(this)h(License.)441 1996
y(c.)41 b(If)19 b(the)g(modi\002ed)e(program)g(normally)g(reads)i
(commands)e(interacti)n(v)o(ely)g(when)h(run,)g(you)540
2109 y(must)f(cause)f(it,)i(when)e(started)g(running)e(for)i(such)g
(interacti)n(v)o(e)f(use)i(in)g(the)f(most)h(ordinary)540
2223 y(w)o(ay)-5 b(,)28 b(to)f(print)g(or)f(display)h(an)f
(announcement)e(including)h(an)i(appropriate)e(cop)o(yright)540
2337 y(notice)c(and)f(a)h(notice)g(that)g(there)f(is)i(no)e(w)o
(arranty)g(\(or)g(else,)i(saying)e(that)h(you)f(pro)o(vide)f(a)540
2450 y(w)o(arranty\))k(and)g(that)h(users)g(may)f(redistrib)n(ute)g
(the)h(program)e(under)g(these)i(conditions,)540 2564
y(and)30 b(telling)g(the)g(user)g(ho)n(w)f(to)h(vie)n(w)g(a)h(cop)o(y)e
(of)h(this)g(License.)54 b(\(Exception:)43 b(if)31 b(the)540
2677 y(Program)16 b(itself)j(is)f(interacti)n(v)o(e)f(b)n(ut)g(does)h
(not)f(normally)f(print)h(such)g(an)h(announcement,)540
2791 y(your)h(w)o(ork)h(based)f(on)h(the)g(Program)f(is)i(not)f
(required)f(to)h(print)f(an)i(announcement.\))358 3024
y(These)j(requirements)f(apply)h(to)h(the)g(modi\002ed)e(w)o(ork)i(as)g
(a)g(whole.)39 b(If)25 b(identi\002able)f(sections)358
3137 y(of)j(that)h(w)o(ork)g(are)g(not)f(deri)n(v)o(ed)g(from)g(the)h
(Program,)g(and)f(can)h(be)g(reasonably)e(considered)358
3251 y(independent)c(and)j(separate)f(w)o(orks)h(in)g(themselv)o(es,)g
(then)g(this)h(License,)f(and)g(its)h(terms,)g(do)358
3364 y(not)e(apply)g(to)i(those)f(sections)g(when)f(you)g(distrib)n
(ute)h(them)g(as)h(separate)e(w)o(orks.)40 b(But)25 b(when)358
3478 y(you)j(distrib)n(ute)g(the)h(same)g(sections)g(as)g(part)g(of)f
(a)i(whole)e(which)g(is)i(a)f(w)o(ork)g(based)f(on)h(the)358
3592 y(Program,)22 b(the)i(distrib)n(ution)e(of)i(the)f(whole)h(must)f
(be)h(on)f(the)h(terms)f(of)h(this)g(License,)g(whose)358
3705 y(permissions)16 b(for)h(other)g(licensees)h(e)o(xtend)e(to)i(the)
f(entire)g(whole,)h(and)f(thus)g(to)h(each)f(and)g(e)n(v)o(ery)358
3819 y(part)i(re)o(gardless)g(of)h(who)g(wrote)f(it.)358
3980 y(Thus,)35 b(it)e(is)h(not)e(the)h(intent)f(of)g(this)i(section)e
(to)h(claim)g(rights)f(or)g(contest)h(your)e(rights)h(to)358
4094 y(w)o(ork)e(written)h(entirely)g(by)g(you;)36 b(rather)m(,)c(the)f
(intent)g(is)i(to)e(e)o(x)o(ercise)f(the)i(right)e(to)i(control)358
4207 y(the)20 b(distrib)n(ution)f(of)h(deri)n(v)n(ati)n(v)o(e)e(or)i
(collecti)n(v)o(e)f(w)o(orks)h(based)g(on)f(the)i(Program.)p
eop
%%Page: 116 120
116 119 bop 58 162 a Fy(In)27 b(addition,)h(mere)g(aggre)o(gation)d(of)
i(another)g(w)o(ork)g(not)g(based)h(on)f(the)h(Program)e(with)j(the)58
275 y(Program)22 b(\(or)h(with)h(a)g(w)o(ork)f(based)g(on)g(the)h
(Program\))e(on)h(a)h(v)n(olume)f(of)g(a)h(storage)f(or)h(distri-)58
389 y(b)n(ution)19 b(medium)g(does)h(not)g(bring)f(the)h(other)f(w)o
(ork)h(under)e(the)j(scope)e(of)h(this)h(License.)-46
571 y(3.)41 b(Y)-9 b(ou)18 b(may)i(cop)o(y)e(and)h(distrib)n(ute)g(the)
h(Program)e(\(or)h(a)h(w)o(ork)f(based)g(on)g(it,)h(under)e(Section)h
(2\))g(in)58 685 y(object)j(code)h(or)f(e)o(x)o(ecutable)g(form)g
(under)f(the)j(terms)f(of)g(Sections)g(1)g(and)f(2)i(abo)o(v)o(e)d(pro)
o(vided)58 798 y(that)f(you)f(also)i(do)e(one)h(of)g(the)g(follo)n
(wing:)141 997 y(a.)41 b(Accompan)o(y)16 b(it)j(with)g(the)f(complete)f
(corresponding)e(machine-readable)g(source)i(code,)240
1111 y(which)33 b(must)g(be)g(distrib)n(uted)f(under)f(the)i(terms)g
(of)g(Sections)g(1)g(and)f(2)h(abo)o(v)o(e)f(on)g(a)240
1224 y(medium)19 b(customarily)g(used)h(for)f(softw)o(are)h
(interchange;)e(or)m(,)140 1372 y(b)m(.)40 b(Accompan)o(y)14
b(it)j(with)f(a)h(written)f(of)n(fer)m(,)f(v)n(alid)h(for)f(at)i(least)
g(three)f(years,)g(to)g(gi)n(v)o(e)g(an)o(y)f(third)240
1486 y(party)-5 b(,)33 b(for)e(a)h(char)o(ge)e(no)h(more)f(than)h(your)
g(cost)h(of)f(physically)f(performing)e(source)240 1599
y(distrib)n(ution,)k(a)f(complete)f(machine-readable)e(cop)o(y)i(of)g
(the)h(corresponding)c(source)240 1713 y(code,)20 b(to)h(be)g(distrib)n
(uted)f(under)f(the)i(terms)f(of)h(Sections)f(1)h(and)f(2)h(abo)o(v)o
(e)e(on)i(a)g(medium)240 1827 y(customarily)e(used)h(for)f(softw)o(are)
h(interchange;)e(or)m(,)141 1974 y(c.)41 b(Accompan)o(y)14
b(it)j(with)f(the)g(information)e(you)h(recei)n(v)o(ed)g(as)i(to)f(the)
g(of)n(fer)f(to)h(distrib)n(ute)g(cor)n(-)240 2088 y(responding)23
b(source)h(code.)40 b(\(This)25 b(alternati)n(v)o(e)f(is)i(allo)n(wed)f
(only)f(for)h(noncommercial)240 2202 y(distrib)n(ution)d(and)g(only)g
(if)h(you)f(recei)n(v)o(ed)f(the)h(program)f(in)i(object)f(code)g(or)g
(e)o(x)o(ecutable)240 2315 y(form)d(with)i(such)f(an)g(of)n(fer)m(,)e
(in)j(accord)e(with)h(Subsection)f(b)h(abo)o(v)o(e.\))58
2514 y(The)i(source)f(code)h(for)g(a)h(w)o(ork)f(means)g(the)h
(preferred)d(form)h(of)h(the)h(w)o(ork)f(for)g(making)f(mod-)58
2628 y(i\002cations)i(to)h(it.)37 b(F)o(or)23 b(an)h(e)o(x)o(ecutable)e
(w)o(ork,)i(complete)e(source)h(code)h(means)f(all)h(the)g(source)58
2742 y(code)h(for)h(all)h(modules)f(it)h(contains,)g(plus)f(an)o(y)g
(associated)g(interf)o(ace)g(de\002nition)f(\002les,)k(plus)58
2855 y(the)23 b(scripts)h(used)f(to)h(control)e(compilation)g(and)h
(installation)g(of)g(the)h(e)o(x)o(ecutable.)33 b(Ho)n(we)n(v)o(er)m(,)
58 2969 y(as)23 b(a)h(special)f(e)o(xception,)f(the)h(source)f(code)h
(distrib)n(uted)f(need)g(not)h(include)f(an)o(ything)f(that)j(is)58
3082 y(normally)j(distrib)n(uted)h(\(in)h(either)g(source)f(or)h
(binary)f(form\))g(with)h(the)g(major)g(components)58
3196 y(\(compiler)m(,)21 b(k)o(ernel,)h(and)g(so)h(on\))e(of)i(the)f
(operating)f(system)i(on)f(which)g(the)h(e)o(x)o(ecutable)d(runs,)58
3309 y(unless)g(that)g(component)e(itself)j(accompanies)d(the)i(e)o(x)o
(ecutable.)58 3457 y(If)i(distrib)n(ution)f(of)i(e)o(x)o(ecutable)d(or)
i(object)g(code)g(is)i(made)e(by)g(of)n(fering)e(access)j(to)g(cop)o(y)
f(from)58 3571 y(a)f(designated)e(place,)i(then)g(of)n(fering)d(equi)n
(v)n(alent)i(access)h(to)g(cop)o(y)f(the)h(source)f(code)h(from)f(the)
58 3684 y(same)26 b(place)g(counts)g(as)h(distrib)n(ution)e(of)h(the)g
(source)g(code,)h(e)n(v)o(en)e(though)g(third)g(parties)i(are)58
3798 y(not)19 b(compelled)g(to)h(cop)o(y)g(the)g(source)f(along)h(with)
g(the)g(object)g(code.)-46 3980 y(4.)41 b(Y)-9 b(ou)19
b(may)g(not)h(cop)o(y)-5 b(,)18 b(modify)-5 b(,)18 b(sublicense,)h(or)h
(distrib)n(ute)g(the)g(Program)e(e)o(xcept)h(as)i(e)o(xpressly)58
4094 y(pro)o(vided)g(under)i(this)h(License.)37 b(An)o(y)23
b(attempt)h(otherwise)g(to)g(cop)o(y)-5 b(,)23 b(modify)-5
b(,)23 b(sublicense)h(or)58 4207 y(distrib)n(ute)k(the)h(Program)e(is)j
(v)n(oid,)g(and)f(will)g(automatically)f(terminate)g(your)f(rights)i
(under)p eop
%%Page: 117 121
117 120 bop 358 162 a Fy(this)23 b(License.)33 b(Ho)n(we)n(v)o(er)m(,)
21 b(parties)i(who)g(ha)n(v)o(e)f(recei)n(v)o(ed)f(copies,)i(or)g
(rights,)g(from)f(you)g(under)358 275 y(this)f(License)f(will)h(not)g
(ha)n(v)o(e)e(their)i(licenses)g(terminated)e(so)i(long)f(as)h(such)f
(parties)h(remain)e(in)358 389 y(full)h(compliance.)254
605 y(5.)41 b(Y)-9 b(ou)22 b(are)h(not)g(required)e(to)j(accept)e(this)
i(License,)g(since)f(you)f(ha)n(v)o(e)h(not)g(signed)f(it.)35
b(Ho)n(we)n(v)o(er)m(,)358 719 y(nothing)18 b(else)i(grants)g(you)f
(permission)g(to)h(modify)e(or)i(distrib)n(ute)f(the)h(Program)e(or)i
(its)h(deri)n(v)n(a-)358 832 y(ti)n(v)o(e)26 b(w)o(orks.)43
b(These)26 b(actions)g(are)h(prohibited)d(by)i(la)o(w)h(if)f(you)g(do)g
(not)g(accept)g(this)h(License.)358 946 y(Therefore,)18
b(by)i(modifying)e(or)j(distrib)n(uting)e(the)i(Program)e(\(or)h(an)o
(y)g(w)o(ork)g(based)g(on)g(the)h(Pro-)358 1059 y(gram\),)k(you)g
(indicate)g(your)f(acceptance)g(of)h(this)i(License)e(to)h(do)f(so,)i
(and)e(all)h(its)h(terms)e(and)358 1173 y(conditions)18
b(for)i(cop)o(ying,)e(distrib)n(uting)h(or)h(modifying)e(the)i(Program)
e(or)i(w)o(orks)g(based)g(on)g(it.)254 1389 y(6.)41 b(Each)29
b(time)h(you)e(redistrib)n(ute)h(the)h(Program)e(\(or)h(an)o(y)g(w)o
(ork)g(based)h(on)f(the)h(Program\),)g(the)358 1503 y(recipient)14
b(automatically)g(recei)n(v)o(es)h(a)h(license)f(from)g(the)g(original)
g(licensor)f(to)i(cop)o(y)-5 b(,)15 b(distrib)n(ute)358
1617 y(or)23 b(modify)g(the)h(Program)e(subject)i(to)g(these)g(terms)g
(and)g(conditions.)35 b(Y)-9 b(ou)23 b(may)g(not)h(impose)358
1730 y(an)o(y)f(further)f(restrictions)h(on)g(the)h(recipients')f(e)o
(x)o(ercise)g(of)g(the)h(rights)f(granted)g(herein.)34
b(Y)-9 b(ou)358 1844 y(are)20 b(not)g(responsible)e(for)i(enforcing)e
(compliance)g(by)i(third)g(parties)g(to)g(this)h(License.)254
2060 y(7.)41 b(If,)35 b(as)e(a)f(consequence)e(of)j(a)f(court)g
(judgment)e(or)i(alle)o(gation)f(of)h(patent)g(infringement)e(or)358
2174 y(for)d(an)o(y)g(other)g(reason)g(\(not)g(limited)g(to)h(patent)f
(issues\),)j(conditions)d(are)g(imposed)g(on)g(you)358
2287 y(\(whether)f(by)h(court)g(order)m(,)h(agreement)e(or)h
(otherwise\))g(that)h(contradict)e(the)i(conditions)e(of)358
2401 y(this)k(License,)i(the)o(y)e(do)f(not)h(e)o(xcuse)g(you)f(from)g
(the)h(conditions)f(of)g(this)i(License.)54 b(If)30 b(you)358
2514 y(cannot)20 b(distrib)n(ute)h(so)h(as)h(to)e(satisfy)h
(simultaneously)e(your)h(obligations)e(under)i(this)h(License)358
2628 y(and)27 b(an)o(y)f(other)h(pertinent)g(obligations,)g(then)g(as)h
(a)h(consequence)c(you)i(may)g(not)g(distrib)n(ute)358
2742 y(the)g(Program)f(at)i(all.)47 b(F)o(or)27 b(e)o(xample,)h(if)f(a)
h(patent)f(license)g(w)o(ould)g(not)g(permit)g(ro)o(yalty-free)358
2855 y(redistrib)n(ution)d(of)h(the)h(Program)e(by)i(all)g(those)g(who)
f(recei)n(v)o(e)g(copies)g(directly)g(or)h(indirectly)358
2969 y(through)21 b(you,)h(then)h(the)g(only)g(w)o(ay)g(you)f(could)g
(satisfy)i(both)e(it)i(and)f(this)g(License)g(w)o(ould)g(be)358
3082 y(to)d(refrain)f(entirely)g(from)g(distrib)n(ution)g(of)h(the)h
(Program.)358 3247 y(If)27 b(an)o(y)g(portion)f(of)h(this)h(section)f
(is)i(held)e(in)m(v)n(alid)f(or)i(unenforceable)c(under)i(an)o(y)h
(particular)358 3361 y(circumstance,)i(the)h(balance)e(of)h(the)g
(section)g(is)i(intended)c(to)j(apply)e(and)h(the)g(section)g(as)h(a)
358 3474 y(whole)19 b(is)i(intended)e(to)h(apply)g(in)g(other)f
(circumstances.)358 3639 y(It)d(is)h(not)e(the)h(purpose)e(of)i(this)h
(section)e(to)h(induce)f(you)g(to)h(infringe)f(an)o(y)g(patents)g(or)h
(other)f(prop-)358 3753 y(erty)24 b(right)h(claims)g(or)g(to)h(contest)
f(v)n(alidity)f(of)h(an)o(y)f(such)h(claims;)j(this)e(section)f(has)g
(the)g(sole)358 3866 y(purpose)20 b(of)h(protecting)f(the)h(inte)o
(grity)g(of)g(the)h(free)f(softw)o(are)g(distrib)n(ution)g(system,)h
(which)f(is)358 3980 y(implemented)g(by)i(public)g(license)h
(practices.)35 b(Man)o(y)22 b(people)h(ha)n(v)o(e)g(made)g(generous)f
(contri-)358 4094 y(b)n(utions)g(to)h(the)g(wide)g(range)f(of)h(softw)o
(are)f(distrib)n(uted)g(through)f(that)i(system)h(in)f(reliance)f(on)
358 4207 y(consistent)i(application)g(of)g(that)h(system;)j(it)e(is)f
(up)g(to)g(the)g(author/donor)c(to)26 b(decide)e(if)h(he)g(or)p
eop
%%Page: 118 122
118 121 bop 58 162 a Fy(she)23 b(is)h(willing)e(to)i(distrib)n(ute)e
(softw)o(are)h(through)d(an)o(y)j(other)f(system)h(and)f(a)i(licensee)f
(cannot)58 275 y(impose)c(that)h(choice.)58 421 y(This)28
b(section)h(is)g(intended)e(to)i(mak)o(e)f(thoroughly)e(clear)i(what)h
(is)g(belie)n(v)o(ed)e(to)i(be)f(a)h(conse-)58 534 y(quence)18
b(of)i(the)h(rest)f(of)g(this)h(License.)-46 711 y(8.)41
b(If)24 b(the)h(distrib)n(ution)e(and/or)g(use)i(of)f(the)h(Program)e
(is)j(restricted)e(in)g(certain)g(countries)g(either)58
825 y(by)19 b(patents)g(or)h(by)f(cop)o(yrighted)e(interf)o(aces,)i
(the)g(original)g(cop)o(yright)e(holder)i(who)g(places)h(the)58
938 y(Program)f(under)h(this)i(License)f(may)f(add)h(an)g(e)o(xplicit)g
(geographical)d(distrib)n(ution)i(limitation)58 1052
y(e)o(xcluding)13 b(those)j(countries,)g(so)g(that)h(distrib)n(ution)e
(is)i(permitted)e(only)g(in)h(or)g(among)f(countries)58
1165 y(not)k(thus)i(e)o(xcluded.)i(In)d(such)g(case,)g(this)h(License)f
(incorporates)e(the)j(limitation)e(as)i(if)g(written)58
1279 y(in)f(the)g(body)f(of)h(this)h(License.)-46 1456
y(9.)41 b(The)20 b(Free)h(Softw)o(are)f(F)o(oundation)e(may)i(publish)g
(re)n(vised)g(and/or)f(ne)n(w)h(v)o(ersions)g(of)g(the)h(Gen-)58
1570 y(eral)g(Public)g(License)h(from)e(time)i(to)g(time.)29
b(Such)21 b(ne)n(w)h(v)o(ersions)e(will)j(be)e(similar)h(in)g(spirit)f
(to)58 1683 y(the)f(present)f(v)o(ersion,)g(b)n(ut)h(may)g(dif)n(fer)f
(in)h(detail)h(to)f(address)g(ne)n(w)g(problems)e(or)i(concerns.)58
1829 y(Each)27 b(v)o(ersion)f(is)j(gi)n(v)o(en)e(a)h(distinguishing)e
(v)o(ersion)h(number)-5 b(.)46 b(If)28 b(the)g(Program)e(speci\002es)i
(a)58 1942 y(v)o(ersion)20 b(number)g(of)i(this)h(License)e(which)h
(applies)f(to)i(it)f(and)g(`an)o(y)f(later)h(v)o(ersion',)e(you)h(ha)n
(v)o(e)58 2056 y(the)e(option)g(of)h(follo)n(wing)e(the)i(terms)g(and)f
(conditions)f(either)i(of)g(that)g(v)o(ersion)e(or)i(of)f(an)o(y)g
(later)58 2169 y(v)o(ersion)g(published)g(by)h(the)g(Free)g(Softw)o
(are)g(F)o(oundation.)j(If)e(the)f(Program)f(does)h(not)g(specify)58
2283 y(a)g(v)o(ersion)e(number)g(of)h(this)i(License,)e(you)g(may)g
(choose)g(an)o(y)g(v)o(ersion)f(e)n(v)o(er)h(published)f(by)i(the)58
2396 y(Free)g(Softw)o(are)f(F)o(oundation.)-88 2574 y(10.)41
b(If)16 b(you)g(wish)h(to)g(incorporate)d(parts)j(of)g(the)f(Program)g
(into)g(other)g(free)g(programs)f(whose)i(distri-)58
2687 y(b)n(ution)e(conditions)f(are)i(dif)n(ferent,)f(write)i(to)f(the)
g(author)f(to)h(ask)g(for)g(permission.)22 b(F)o(or)16
b(softw)o(are)58 2801 y(which)26 b(is)h(cop)o(yrighted)d(by)i(the)h
(Free)f(Softw)o(are)g(F)o(oundation,)g(write)g(to)h(the)g(Free)f(Softw)
o(are)58 2914 y(F)o(oundation;)17 b(we)j(sometimes)f(mak)o(e)g(e)o
(xceptions)g(for)f(this.)26 b(Our)19 b(decision)g(will)h(be)g(guided)e
(by)58 3028 y(the)j(tw)o(o)h(goals)f(of)g(preserving)f(the)h(free)g
(status)h(of)f(all)h(deri)n(v)n(ati)n(v)o(es)e(of)h(our)g(free)g(softw)
o(are)g(and)58 3141 y(of)e(promoting)f(the)i(sharing)g(and)f(reuse)h
(of)g(softw)o(are)g(generally)-5 b(.)1026 3349 y(N)t(O)25
b(W)-6 b(A)t(R)t(R)t(A)t(N)t(T)t(Y)-88 3526 y(11.)41
b(BECA)-5 b(USE)25 b(THE)e(PR)m(OGRAM)i(IS)f(LICENSED)f(FREE)i(OF)f
(CHARGE,)g(THERE)g(IS)g(NO)58 3639 y(W)-10 b(ARRANTY)30
b(FOR)f(THE)g(PR)m(OGRAM,)g(T)o(O)g(THE)f(EXTENT)h(PERMITTED)f(BY)h
(AP-)58 3753 y(PLICABLE)i(LA)-7 b(W)f(.)32 b(EXCEPT)g(WHEN)g(O)m(THER)
-5 b(WISE)32 b(ST)-8 b(A)f(TED)31 b(IN)h(WRITING)g(THE)58
3866 y(COPYRIGHT)45 b(HOLDERS)h(AND/OR)g(O)m(THER)f(P)-8
b(AR)j(TIES)45 b(PR)m(O)l(VIDE)g(THE)g(PR)m(O-)58 3980
y(GRAM)20 b(`)-7 b(AS)20 b(IS')g(WITHOUT)g(W)-10 b(ARRANTY)21
b(OF)f(ANY)g(KIND,)g(EITHER)f(EXPRESSED)58 4094 y(OR)36
b(IMPLIED,)e(INCLUDING,)h(B)o(UT)i(NO)m(T)e(LIMITED)f(T)o(O,)h(THE)h
(IMPLIED)f(W)-10 b(AR-)58 4207 y(RANTIES)43 b(OF)h(MERCHANT)-8
b(ABILITY)43 b(AND)h(FITNESS)g(FOR)g(A)g(P)-8 b(AR)j(TICULAR)p
eop
%%Page: 119 123
119 122 bop 358 162 a Fy(PURPOSE.)25 b(THE)g(ENTIRE)f(RISK)h(AS)h(T)o
(O)e(THE)h(Q)o(U)m(ALITY)e(AND)i(PERFORMANCE)358 275
y(OF)17 b(THE)f(PR)m(OGRAM)h(IS)g(WITH)f(Y)n(OU.)g(SHOULD)h(THE)f(PR)m
(OGRAM)h(PR)m(O)l(VE)f(DEFEC-)358 389 y(TIVE,)21 b(Y)n(OU)h(ASSUME)g
(THE)h(COST)f(OF)h(ALL)f(NECESSAR)-5 b(Y)23 b(SER)-7
b(VICING,)22 b(REP)-8 b(AIR)358 502 y(OR)21 b(CORRECTION.)212
714 y(12.)41 b(IN)21 b(NO)i(EVENT)e(UNLESS)h(REQ)o(UIRED)g(BY)h
(APPLICABLE)f(LA)-7 b(W)22 b(OR)g(A)m(GREED)g(T)o(O)358
828 y(IN)32 b(WRITING)h(WILL)f(ANY)h(COPYRIGHT)g(HOLDER,)g(OR)g(ANY)g
(O)m(THER)f(P)-8 b(AR)j(TY)358 942 y(WHO)22 b(MA)-9 b(Y)21
b(MODIFY)h(AND/OR)g(REDISTRIB)o(UTE)f(THE)h(PR)m(OGRAM)g(AS)g(PERMIT)-8
b(-)358 1055 y(TED)21 b(ABO)l(VE,)g(BE)g(LIABLE)g(T)o(O)g(Y)n(OU)g(FOR)
h(D)m(AMA)m(GES,)e(INCLUDING)g(ANY)i(GEN-)358 1169 y(ERAL,)j(SPECIAL,)h
(INCIDENT)-8 b(AL)24 b(OR)j(CONSEQ)o(UENTIAL)e(D)m(AMA)m(GES)f(ARISING)
358 1282 y(OUT)15 b(OF)h(THE)g(USE)g(OR)g(IN)m(ABILITY)f(T)o(O)g(USE)h
(THE)g(PR)m(OGRAM)g(\(INCLUDING)f(B)o(UT)358 1396 y(NO)m(T)28
b(LIMITED)g(T)o(O)g(LOSS)i(OF)f(D)m(A)-9 b(T)h(A)29 b(OR)h(D)m(A)-9
b(T)h(A)28 b(BEING)h(RENDERED)g(IN)m(A)m(CCU-)358 1509
y(RA)-9 b(TE)18 b(OR)i(LOSSES)f(SUST)-8 b(AINED)18 b(BY)i(Y)n(OU)e(OR)i
(THIRD)f(P)-8 b(AR)j(TIES)19 b(OR)h(A)f(F)-6 b(AILURE)358
1623 y(OF)28 b(THE)f(PR)m(OGRAM)h(T)o(O)f(OPERA)-9 b(TE)27
b(WITH)h(ANY)g(O)m(THER)f(PR)m(OGRAMS\),)h(EVEN)358 1737
y(IF)22 b(SUCH)h(HOLDER)f(OR)h(O)m(THER)f(P)-8 b(AR)j(TY)23
b(HAS)f(BEEN)g(AD)m(VISED)g(OF)g(THE)g(POSSI-)358 1850
y(BILITY)d(OF)i(SUCH)g(D)m(AMA)m(GES.)942 2071 y(E)t(N)t(D)k(O)t(F)g(T)
t(E)t(R)t(M)t(S)h(A)t(N)t(D)f(C)t(O)t(N)t(D)t(I)t(T)t(I)t(O)t(N)t(S)410
2184 y(A)t Fh(P)t(P)t(E)t(N)t(D)t(I)t(X)t Fy(:)30 b(H)t
Fh(O)r(W)24 b(T)s(O)h Fy(A)t Fh(P)t(P)t(L)m(Y)g Fy(T)t
Fh(H)t(E)t(S)t(E)f Fy(T)t Fh(E)t(R)t(M)t(S)h(T)s(O)f
Fy(Y)r Fh(O)t(U)t(R)h Fy(N)t Fh(E)t(W)f Fy(P)t Fh(R)q(O)t(G)t(R)t(A)t
(M)t(S)275 2298 y Fy(If)k(you)f(de)n(v)o(elop)f(a)j(ne)n(w)f(program,)f
(and)h(you)f(w)o(ant)i(it)g(to)f(be)g(of)g(the)g(greatest)g(possible)g
(use)g(to)150 2412 y(the)i(public,)g(the)g(best)g(w)o(ay)f(to)h(achie)n
(v)o(e)f(this)h(is)g(to)g(mak)o(e)f(it)h(free)f(softw)o(are)h(which)f
(e)n(v)o(eryone)e(can)150 2525 y(redistrib)n(ute)19 b(and)h(change)f
(under)g(these)h(terms.)275 2639 y(T)-7 b(o)22 b(do)g(so,)h(attach)f
(the)g(follo)n(wing)f(notices)h(to)g(the)h(program.)29
b(It)22 b(is)i(safest)f(to)f(attach)g(them)g(to)h(the)150
2752 y(start)e(of)g(each)f(source)g(\002le)i(to)f(most)f(ef)n(fecti)n
(v)o(ely)f(con)m(v)o(e)o(y)g(the)h(e)o(xclusion)g(of)g(w)o(arranty;)g
(and)g(each)h(\002le)150 2866 y(should)e(ha)n(v)o(e)h(at)g(least)h(the)
g(`cop)o(yright')c(line)j(and)g(a)h(pointer)e(to)h(where)f(the)i(full)f
(notice)f(is)j(found.)358 3087 y Fb(one)17 b(line)h(to)f(gi)n(v)o(e)g
(the)h(program')-5 b(s)16 b(name)h(and)g(a)h(brief)g(idea)f(of)h(what)f
(it)i(does.)24 b Fy(Cop)o(yright)381 3197 y(c)358 3200
y Fv(\015)p Fy(19yy)18 b Fb(name)i(of)g(author)358 3363
y Fy(This)25 b(program)e(is)k(free)e(softw)o(are;)i(you)e(can)g
(redistrib)n(ute)f(it)i(and/or)f(modify)e(it)j(under)358
3476 y(the)e(terms)h(of)f(the)g(GNU)h(General)f(Public)g(License)g(as)h
(published)e(by)h(the)h(Free)f(Soft-)358 3590 y(w)o(are)d(F)o
(oundation;)f(either)h(v)o(ersion)f(2)h(of)g(the)h(License,)f(or)g
(\(at)g(your)g(option\))e(an)o(y)i(later)358 3704 y(v)o(ersion.)358
3866 y(This)35 b(program)e(is)j(distrib)n(uted)e(in)i(the)f(hope)f
(that)i(it)g(will)g(be)f(useful,)j(b)n(ut)d(WITH-)358
3980 y(OUT)45 b(ANY)h(W)-10 b(ARRANTY)i(;)48 b(without)d(e)n(v)o(en)f
(the)i(implied)f(w)o(arranty)f(of)i(MER-)358 4094 y(CHANT)-8
b(ABILITY)29 b(or)g(FITNESS)h(FOR)h(A)f(P)-8 b(AR)j(TICULAR)31
b(PURPOSE.)f(See)g(the)358 4207 y(GNU)20 b(General)g(Public)g(License)g
(for)f(more)g(details.)p eop
%%Page: 120 124
120 123 bop 58 162 a Fy(Y)-9 b(ou)26 b(should)g(ha)n(v)o(e)h(recei)n(v)
o(ed)e(a)j(cop)o(y)e(of)h(the)g(GNU)h(General)e(Public)h(License)g
(along)58 275 y(with)j(this)h(program;)i(if)e(not,)h(write)e(to)h(the)f
(Free)g(Softw)o(are)g(F)o(oundation,)g(Inc.,)i(675)58
389 y(Mass)21 b(A)-6 b(v)o(e,)19 b(Cambridge,)f(MA)j(02139,)d(USA.)-25
585 y(Also)i(add)g(information)e(on)h(ho)n(w)h(to)g(contact)g(you)f(by)
h(electronic)f(and)h(paper)f(mail.)-25 699 y(If)i(the)h(program)e(is)j
(interacti)n(v)o(e,)e(mak)o(e)g(it)i(output)e(a)h(short)g(notice)f(lik)
o(e)h(this)h(when)e(it)i(starts)g(in)f(an)-150 813 y(interacti)n(v)o(e)
d(mode:)58 1009 y Fa(Gnomovision)43 b(version)g(69,)i(Copyright)e
(\(C\))h(19yy)g(name)g(of)h(author)58 1123 y(Gnomovision)e(comes)h
(with)g(ABSOLUTELY)f(NO)h(WARRANTY;)g(for)58 1236 y(details)f(type)h
(show)h(w.)89 b(This)44 b(is)h(free)f(software,)f(and)h(you)h(are)58
1350 y(welcome)e(to)i(redistribute)e(it)h(under)g(certain)g
(conditions;)f(type)58 1463 y(show)h(c)g(for)h(details.)-25
1660 y Fy(The)22 b(hypothetical)f(commands)h(sho)n(w)h(w)g(and)g(sho)n
(w)g(c)h(should)e(sho)n(w)h(the)g(appropriate)e(parts)i(of)-150
1774 y(the)j(General)f(Public)g(License.)41 b(Of)26 b(course,)g(the)f
(commands)f(you)h(use)h(may)f(be)h(called)f(something)-150
1887 y(other)d(than)g(sho)n(w)h(w)g(and)f(sho)n(w)h(c;)h(the)o(y)f
(could)e(e)n(v)o(en)h(be)h(mouse-clicks)e(or)i(menu)f(items\226whate)n
(v)o(er)-150 2001 y(suits)f(your)e(program.)-25 2114
y(Y)-9 b(ou)25 b(should)f(also)i(get)g(your)e(emplo)o(yer)g(\(if)h(you)
g(w)o(ork)g(as)h(a)g(programmer\))d(or)i(your)f(school,)i(if)-150
2228 y(an)o(y)-5 b(,)22 b(to)g(sign)h(a)g(`cop)o(yright)d(disclaimer')i
(for)g(the)g(program,)f(if)i(necessary)-5 b(.)31 b(Here)22
b(is)i(a)f(sample;)g(alter)-150 2342 y(the)d(names:)58
2538 y(Y)-9 b(o)o(yodyne,)14 b(Inc.,)i(hereby)f(disclaims)i(all)g(cop)o
(yright)e(interest)h(in)h(the)f(program)f(Gnomo-)58 2652
y(vision)k(\(which)h(mak)o(es)g(passes)h(at)f(compilers\))f(written)h
(by)g(James)g(Hack)o(er)-5 b(.)58 2798 y Fb(signature)19
b(of)h(T)-7 b(y)20 b(Coon)p Fy(,)f(1)i(April)f(1989)58
2912 y(T)-7 b(y)20 b(Coon,)f(President)h(of)g(V)-5 b(ice)-25
3109 y(This)25 b(General)f(Public)g(License)h(does)f(not)h(permit)f
(incorporating)e(your)h(program)g(into)h(propri-)-150
3222 y(etary)18 b(programs.)23 b(If)c(your)f(program)e(is)k(a)g
(subroutine)d(library)-5 b(,)17 b(you)h(may)g(consider)g(it)i(more)e
(useful)g(to)-150 3336 y(permit)j(linking)f(proprietary)f(applications)
h(with)h(the)h(library)-5 b(.)26 b(If)c(this)f(is)i(what)e(you)f(w)o
(ant)i(to)f(do,)g(use)-150 3449 y(the)f(GNU)h(Library)e(General)g
(Public)h(License)g(instead)g(of)g(this)h(License.)p
eop
%%Page: 121 125
121 124 bop 150 633 a Fp(Index)150 1051 y Fy(/de)n(v)-5
b(,)19 b(12,)h(13)150 1165 y(/proc)f(\002le)i(system,)f(25)150
1279 y(/proc/interrupts,)d(98)150 1394 y(/proc/ksyms,)h(106)150
1508 y(/proc/meminfo,)f(25)150 1622 y(/proc/modules,)h(8,)i(14,)f(25)
150 1736 y(/proc)482 1850 y(using)h(for)f(input,)h(32)p
155 1964 25 4 v 180 1964 a(IO,)g(44)p 155 2078 V 180
2078 a(IOR,)g(44)p 155 2193 V 180 2193 a(IO)m(W)-8 b(,)21
b(44)p 155 2307 V 180 2307 a(IO)m(WR,)g(44)p 155 2421
V 180 2421 a(NSIG)p 379 2421 V 29 w(W)o(ORDS,)h(108)p
155 2535 V 185 2535 V 210 2535 a(KERNEL)p 543 2535 V
572 2535 V 59 w(,)f(7)p 155 2649 V 185 2649 V 210 2649
a(NO)p 335 2649 V 30 w(VERSION)p 725 2649 V 754 2649
V 59 w(,)g(8)p 155 2764 V 185 2764 V 210 2764 a(SMP)p
381 2764 V 411 2764 V 60 w(,)f(7)150 2878 y(2.0.x)f(k)o(ernel,)g(24)150
2992 y(2.2)h(changes,)e(107)150 3106 y(2.2.x)h(k)o(ernel,)g(24)150
3314 y(access)482 3428 y(sequential,)g(13)150 3542 y(ar)o(gc,)g(61)150
3656 y(ar)o(gv)-5 b(,)18 b(61)150 3771 y(asm/uaccess.h,)h(107)150
3979 y(BH)p 270 3979 V 30 w(IMMEDIA)-9 b(TE,)18 b(98)150
4093 y(blocking)g(processes,)i(73)150 4207 y(blocking,)e(ho)n(w)i(to)g
(a)n(v)n(oid,)g(74)1795 1051 y(bottom)f(half,)h(98)1795
1165 y(b)n(usy)-5 b(,)20 b(73)1795 1364 y(calls)2127
1478 y(system,)h(65)1795 1592 y(character)e(de)n(vice)h(\002les,)h(12)
1795 1705 y(charde)n(v)-5 b(.c,)18 b(source)h(\002le,)i(14,)e(44)1795
1819 y(charde)n(v)-5 b(.h,)17 b(source)j(\002le,)g(55)1795
1933 y(cleanup)p 2060 1933 V 28 w(module,)f(5,)h(14)1795
2047 y(cleanup)p 2060 2047 V 28 w(module)2127 2160 y(general)f
(purpose,)g(13)1795 2274 y(close,)h(107)1795 2388 y(compilation)2127
2501 y(conditional,)e(24)1795 2615 y(compiling,)h(6)1795
2729 y(conditional)g(compilation,)f(24)1795 2843 y(con\002g.h,)h(7)1795
2956 y(CONFIG)p 2109 2956 V 30 w(MOD)m(VERSIONS,)h(7)1795
3070 y(con\002guration)2127 3184 y(k)o(ernel,)g(7)1795
3297 y(console,)f(8)1795 3411 y(cop)o(ying)g(Linux,)g(120)1795
3525 y(cop)o(yright,)f(113\226120)1795 3639 y(CPU)2127
3752 y(multiple,)i(104)1795 3866 y(crontab,)f(90)1795
3980 y(ctrl-c,)h(74)1795 4093 y(current)f(pointer)m(,)g(33)1795
4207 y(current)g(task,)h(86)1588 4456 y(121)p eop
%%Page: 122 126
122 125 bop -150 162 a Fy(de\002ning)19 b(ioctls,)h(57)-150
276 y(de)n(v)o(elopment)d(v)o(ersion)182 390 y(k)o(ernel,)i(23)-150
504 y(de)n(vice)g(\002les)182 618 y(block,)g(13)-150
732 y(de)n(vice)g(\002les)182 846 y(character)m(,)f(12,)i(13)-150
960 y(de)n(vice)f(\002les)182 1074 y(input)h(to,)g(43)-150
1188 y(de)n(vice)f(number)182 1302 y(major)m(,)g(13)-150
1416 y(de)n(vices)182 1530 y(physical,)g(12)-150 1644
y(DOS,)i(2)-150 1856 y(EA)m(GAIN,)e(74)-150 1971 y(EINTR,)h(74)-150
2085 y(elf)p -57 2085 25 4 v 29 w(i386,)g(9)-150 2200
y(ENTR)-5 b(Y\(system)p 386 2200 V 28 w(call\),)21 b(66)-150
2314 y(entry)-5 b(.S,)19 b(66)-150 2526 y(\002le)i(system)f(re)o
(gistration,)f(32)-150 2641 y(\002le)i(system)182 2755
y(/proc,)e(25)-150 2869 y(\002le)p -39 2869 V 30 w(operations)g
(structure,)g(13,)g(32)-150 2983 y(\002le)p -39 2983
V 30 w(operations)182 3097 y(structure,)g(107)-150 3211
y(\003ush,)h(107)-150 3326 y(Free)g(Softw)o(are)g(F)o(oundation,)d(113)
-150 3538 y(General)j(Public)f(License,)h(113\226120)-150
3653 y(get)p -43 3653 V 29 w(user)m(,)g(33,)f(107)-150
3767 y(GNU)16 3881 y(General)h(Public)g(License,)f(113\226120)-150
4094 y(handlers)182 4207 y(interrupt,)g(97)1495 162 y(hard)h(disk)1827
275 y(partitions)g(of,)f(12)1495 389 y(hard)h(wiring,)f(61)1495
502 y(header)g(\002le)i(for)f(ioctls,)g(57)1495 616 y(hello)g(w)o
(orld,)f(5)1495 730 y(hello.c,)g(source)h(\002le,)h(5)1495
843 y(housek)o(eeping,)d(90)1495 1027 y(IDE)1827 1141
y(hard)i(disk,)g(12)1495 1254 y(inb,)g(99)1495 1368 y(init)p
1611 1368 V 30 w(module,)f(5)1495 1481 y(init)p 1611
1481 V 30 w(module)1827 1595 y(general)g(purpose,)g(13)1495
1709 y(inode,)g(25)1495 1822 y(inode)p 1686 1822 V 29
w(operations)f(structure,)h(32)1495 1936 y(input)h(to)g(de)n(vice)f
(\002les,)i(43)1495 2049 y(Input)1827 2163 y(using)f(/proc)f(for)m(,)g
(32)1495 2276 y(insmod,)g(8,)h(61,)g(65)1495 2390 y(intel)h
(architecture)1827 2504 y(k)o(e)o(yboard,)d(98)1495 2617
y(interrupt)h(0x80,)g(66)1495 2731 y(interrupt)g(handlers,)g(97)1495
2844 y(interruptibe)p 1890 2844 V 28 w(sleep)p 2089 2844
V 29 w(on,)h(73)1495 2958 y(interrupts,)f(108)1495 3071
y(interrupts)1827 3185 y(disabling,)g(106)1495 3299 y(intrpt.c,)g
(source)h(\002le,)g(99)1495 3412 y(ioctl,)g(43)1495 3526
y(ioctl.c,)g(source)f(\002le,)i(57)1495 3639 y(ioctl)1827
3753 y(de\002ning,)e(57)1495 3866 y(ioctl)1827 3980 y(header)g(\002le)i
(for)m(,)e(57)1495 4094 y(ioctl)1827 4207 y(of)n(\002cial)h
(assignment,)f(44)p eop
%%Page: 123 127
123 126 bop 150 162 a Fy(ioctl)482 275 y(using)20 b(in)g(a)h(process,)e
(60)150 389 y(irqs,)h(108)150 597 y(k)o(ernel)f(con\002guration,)f(7)
150 711 y(k)o(ernel)h(v)o(ersions,)g(23)150 825 y(KERNEL)p
483 825 25 4 v 29 w(VERSION,)i(24)150 939 y(k)o(ernel)p
363 939 V 29 w(v)o(ersion,)d(8)150 1053 y(k)o(e)o(yboard,)f(98)150
1168 y(ksyms)482 1281 y(proc)i(\002le,)i(106)150 1489
y(ld,)f(9)150 1603 y(libraries)482 1716 y(standard,)f(106)150
1830 y(LINUX,)h(7)150 1945 y(Linux)316 2059 y(cop)o(yright,)e(120)150
2173 y(LINUX)p 414 2173 V 29 w(VERSION)p 803 2173 V 30
w(CODE,)i(24)150 2380 y(MA)m(CR)m(O)p 453 2380 V 30 w(P)-8
b(ARM,)21 b(61)150 2494 y(major)e(de)n(vice)h(number)m(,)e(13)150
2609 y(major)h(number)m(,)f(12)150 2723 y(mak)o(e\002le,)i(6)150
2837 y(Mak)o(e\002le,)g(source)f(\002le,)i(7,)f(11)150
2951 y(mark)p 327 2951 V 28 w(bh,)g(98)150 3065 y(memory)e(se)o
(gments,)i(33)150 3180 y(minor)f(number)m(,)f(12)150
3294 y(mknod,)g(13)150 3408 y(MOD)p 349 3408 V 30 w(DEC)p
545 3408 V 30 w(USE)p 732 3408 V 29 w(COUNT)-6 b(,)21
b(14)150 3522 y(MOD)p 349 3522 V 30 w(INC)p 522 3522
V 29 w(USE)p 708 3522 V 30 w(COUNT)-6 b(,)20 b(14,)g(67)150
3636 y(mod)p 304 3636 V 29 w(use)p 444 3636 V 29 w(count)p
659 3636 V 28 w(,)h(14)150 3750 y(modem,)e(12,)g(43)150
3865 y(MODULE,)h(7)150 3979 y(Module)f(P)o(arameters,)g(108)150
4093 y(module.h,)f(8)150 4207 y(module)p 406 4207 V 28
w(cleanup,)h(91)1795 162 y(module)p 2051 162 V 28 w(interruptibe)p
2469 162 V 28 w(sleep)p 2668 162 V 29 w(on,)h(73)1795
277 y(MODULE)p 2156 277 V 29 w(P)-8 b(ARM,)21 b(108)1795
393 y(module)p 2051 393 V 28 w(permissions,)e(33)1795
509 y(module)p 2051 509 V 28 w(re)o(gister)p 2328 509
V 29 w(chrde)n(v)-5 b(,)18 b(13)1795 625 y(module)p 2051
625 V 28 w(sleep)p 2250 625 V 30 w(on,)h(74,)h(91)1795
740 y(module)p 2051 740 V 28 w(w)o(ak)o(e)p 2253 740
V 30 w(up,)f(74)1795 856 y(modv)o(ersions.h,)e(7)1795
972 y(multi)j(tasking,)g(73)1795 1088 y(multi-processing,)e(104)1795
1203 y(multiple)i(source)f(\002les,)i(8)1795 1319 y(multitasking,)e(74)
1795 1554 y(non)h(blocking,)e(74)1795 1670 y(number)2127
1783 y(major)i(\(of)f(de)n(vice)h(dri)n(v)o(er\),)e(12)1795
1899 y(number)2127 2012 y(major)i(\(of)f(physical)g(de)n(vice\),)g(12)
1795 2247 y(O)p 1860 2247 V 30 w(NONBLOCK,)i(74)1795
2363 y(of)n(\002cial)f(ioctl)h(assignment,)e(44)1795
2479 y(open)2127 2592 y(system)i(call,)f(66)1795 2827
y(param.c,)f(source)g(\002le,)i(61)1795 2943 y(P)o(arameters)2127
3056 y(Module,)e(108)1795 3172 y(parameters)2127 3286
y(startup,)h(61)1795 3401 y(partition)2127 3515 y(of)g(hard)g(disk,)f
(12)1795 3631 y(permissions,)g(33)1795 3746 y(physical)g(de)n(vices,)h
(12)1795 3862 y(pointer)2127 3976 y(current,)f(33)1795
4091 y(printk,)g(8)1795 4207 y(printk.c,)g(source)g(\002le,)i(86)p
eop
%%Page: 124 128
124 127 bop -150 162 a Fy(printk)182 275 y(replacing,)19
b(86)-150 389 y(proc)g(\002le)i(system,)f(25)-150 503
y(proc)182 617 y(using)g(for)f(input,)h(32)-150 731 y(proc)p
4 731 25 4 v 28 w(dir)p 125 731 V 30 w(entry)f(structure,)g(32)-150
844 y(proc)p 4 844 V 28 w(re)o(gister)m(,)g(25,)h(108)-150
958 y(proc)p 4 958 V 28 w(re)o(gister)p 281 958 V 29
w(dynamic,)e(25,)i(108)-150 1072 y(processes)182 1186
y(blocking,)e(73)-150 1300 y(processes)182 1413 y(killing,)h(74)-150
1527 y(processes)182 1641 y(putting)g(to)h(sleep,)h(73)-150
1755 y(processes)182 1868 y(w)o(aking)e(up,)h(74)-150
1982 y(processing)182 2096 y(multi,)g(104)-150 2209 y(procfs.c,)f
(source)g(\002le,)i(26,)e(33)-150 2323 y(put)p -38 2323
V 29 w(user)m(,)g(33,)h(107)-150 2437 y(putting)f(processes)h(to)g
(sleep,)g(73)-150 2639 y(queue)p 55 2639 V 28 w(task,)g(90,)g(98,)f
(108)-150 2753 y(queue)p 55 2753 V 28 w(task)p 217 2753
V 30 w(irq,)h(98,)f(108)-150 2955 y(read,)g(107)-150
3069 y(read)182 3183 y(in)h(the)h(k)o(ernel,)e(33)-150
3297 y(reference)g(count,)f(14,)i(91)-150 3411 y(refund)e(polic)o(y)-5
b(,)19 b(106)-150 3524 y(re)o(gistration)182 3638 y(\002le)i(system,)f
(32)-150 3752 y(replacing)f(printk')-5 b(s,)19 b(86)-150
3866 y(request)p 96 3866 V 29 w(irq,)g(98)-150 3980 y(rmmod,)f(8,)i
(65,)g(67,)f(91)-150 4094 y(rmmod)182 4207 y(pre)n(v)o(enting,)e(14)
1495 162 y(root,)j(8)1495 401 y(SA)p 1606 401 V 30 w(INTERR)m(UPT)-6
b(,)20 b(98)1495 517 y(SA)p 1606 517 V 30 w(SHIRQ,)h(98)1495
633 y(salut)g(mundi,)e(5)1495 749 y(sched.c,)g(source)h(\002le,)h(91)
1495 865 y(scheduler)m(,)e(74)1495 981 y(scheduling)g(tasks,)h(90)1495
1097 y(se)o(gment)1827 1211 y(memory)-5 b(,)18 b(33)1495
1327 y(sel\002shness,)j(111)1495 1443 y(sequential)f(access,)g(13)1495
1559 y(serial)h(port,)e(43)1495 1675 y(shutdo)n(wn,)g(65)1495
1791 y(SIGINT)-6 b(,)20 b(74)1495 1907 y(signal,)g(74)1495
2023 y(signals,)g(108)1495 2139 y(sleep.c,)g(source)f(\002le,)i(74)1495
2255 y(sleep)1827 2368 y(putting)e(processes)h(to,)g(73)1495
2484 y(sleep)p 1671 2484 V 30 w(on,)f(74,)h(91)1495 2600
y(SMP)-9 b(,)21 b(104,)e(108)1495 2716 y(source)h(\002les)1827
2830 y(multiple,)g(8)1495 2946 y(source)1827 3059 y(charde)n(v)-5
b(.c,)18 b(14,)h(44)1495 3175 y(source)1827 3289 y(charde)n(v)-5
b(.h,)17 b(55)1495 3405 y(source)1827 3518 y(hello.c,)j(5)1495
3634 y(source)1827 3748 y(intrpt.c,)f(99)1495 3864 y(source)1827
3978 y(ioctl.c,)h(57)1495 4094 y(source)1827 4207 y(Mak)o(e\002le,)g
(7,)g(11)p eop
%%Page: 125 129
125 128 bop 150 162 a Fy(source)482 275 y(param.c,)19
b(61)150 392 y(source)482 505 y(printk.c,)g(86)150 622
y(source)482 735 y(procfs.c,)g(26,)g(33)150 852 y(source)482
966 y(sched.c,)g(91)150 1082 y(source)482 1196 y(sleep.c,)h(74)150
1312 y(source)482 1426 y(start.c,)g(9)150 1542 y(source)482
1656 y(stop.c,)g(10)150 1772 y(source)482 1886 y(syscall.c,)g(67)150
2002 y(ssize)p 316 2002 25 4 v 30 w(t,)h(107)150 2119
y(stable)f(v)o(ersion)482 2232 y(k)o(ernel,)f(23)150
2349 y(standard)g(libraries,)h(106)150 2465 y(start.c,)g(source)g
(\002le,)g(9)150 2582 y(startup)g(parameters,)e(61)150
2698 y(stop.c,)i(source)f(\002le,)i(10)150 2815 y(strace,)f(65)150
2931 y(struct)g(\002le)p 466 2931 V 30 w(operations,)f(13,)g(32)150
3048 y(struct)h(inode)p 546 3048 V 29 w(operations,)e(32)150
3164 y(struct)i(proc)p 509 3164 V 29 w(dir)p 631 3164
V 29 w(entry)-5 b(,)18 b(32)150 3281 y(struct)i(tq)p
425 3281 V 30 w(struct,)g(90)150 3397 y(struct)482 3511
y(tty)-5 b(,)20 b(86)150 3628 y(structure)482 3741 y(task,)g(73)150
3858 y(Symmetrical)f(Multi\226Processing,)f(108)150 3974
y(symmetrical)h(multi\226processing,)f(104)150 4091 y(sync,)i(65)150
4207 y(sys)p 261 4207 V 30 w(call)p 411 4207 V 30 w(table,)g(66)1795
162 y(sys)p 1906 162 V 30 w(open,)f(67)1795 277 y(syscall.c,)h(source)g
(\002le,)g(67)1795 393 y(system)h(calls,)f(65)1795 509
y(system)p 2031 509 V 30 w(call,)g(66)1795 743 y(task,)h(90)1795
859 y(task)g(structure,)e(73)1795 974 y(task)2127 1088
y(current,)g(86)1795 1204 y(T)-8 b(ASK)p 2009 1204 V
30 w(INTERR)m(UPTIBLE,)20 b(73)1795 1319 y(tasks)2127
1433 y(scheduling,)f(90)1795 1549 y(terminal,)h(12)1795
1664 y(terminal)2127 1778 y(virtual,)g(8)1795 1894 y(tq)p
1865 1894 V 30 w(immediate,)f(98)1795 2009 y(tq)p 1865
2009 V 30 w(struct)h(struct,)g(90)1795 2125 y(tq)p 1865
2125 V 30 w(timer)m(,)f(90)1795 2241 y(tty)p 1888 2241
V 30 w(struct,)h(86)1795 2356 y(type)g(checking,)e(61)1795
2590 y(uaccess.h)2127 2704 y(asm,)j(107)1795 2938 y(v)o(ersion.h,)d(8)
1795 3054 y(v)o(ersions)i(supported,)d(24)1795 3170 y(v)o(ersions)2127
3283 y(k)o(ernel,)j(107)1795 3399 y(virtual)g(terminal,)f(8)1795
3633 y(w)o(aking)h(up)f(processes,)h(74)1795 3749 y(write,)g(107)1795
3864 y(write)2127 3978 y(in)h(the)f(k)o(ernel,)f(33)1795
4094 y(write)2127 4207 y(to)i(de)n(vice)e(\002les,)i(43)p
eop
%%Page: 126 130
126 129 bop -150 162 a Fy(X)182 275 y(why)19 b(you)h(should)f(a)n(v)n
(oid,)h(8)-150 389 y(xterm)f(-C,)i(8)p eop
%%Trailer
end
userdict /end-hook known{end-hook}if
%%EOF
